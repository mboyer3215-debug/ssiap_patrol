<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSIAP Patrol - Gestion Poste de S√©curit√©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Poppins', 'sans-serif'] },
                    colors: { primary: { 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca' }, accent: { 500: '#8b5cf6', 600: '#7c3aed' } }
                }
            }
        }
    </script>
    <style>
        *{box-sizing:border-box}body{font-family:'Poppins',sans-serif}.gradient-bg{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)}.gradient-header{background:linear-gradient(90deg,#6366f1 0%,#8b5cf6 100%)}.gradient-success{background:linear-gradient(90deg,#10b981 0%,#34d399 100%)}.gradient-warning{background:linear-gradient(90deg,#f59e0b 0%,#fbbf24 100%)}.gradient-danger{background:linear-gradient(90deg,#ef4444 0%,#f87171 100%)}.dark .gradient-bg{background:linear-gradient(135deg,#1e1b4b 0%,#312e81 100%)}.dark body{background:#0f172a;color:#e2e8f0}.card{background:white;border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,0.08);overflow:hidden}.dark .card{background:#1e293b;box-shadow:0 4px 20px rgba(0,0,0,0.3)}.sidebar{width:280px;background:white;height:100vh;position:fixed;left:0;top:0;z-index:50;transition:transform 0.3s}.dark .sidebar{background:#1e293b}.nav-link{display:flex;align-items:center;gap:12px;padding:14px 20px;margin:4px 12px;border-radius:12px;color:#64748b;font-weight:500;transition:all 0.2s;cursor:pointer}.nav-link:hover{background:#f1f5f9;color:#6366f1}.nav-link.active{background:linear-gradient(90deg,#6366f1,#8b5cf6);color:white;box-shadow:0 4px 15px rgba(99,102,241,0.4)}.dark .nav-link:hover{background:#334155}.btn{padding:10px 20px;border-radius:10px;font-weight:600;transition:all 0.2s;display:inline-flex;align-items:center;gap:8px;cursor:pointer;border:none}.btn-primary{background:linear-gradient(90deg,#6366f1,#8b5cf6);color:white}.btn-primary:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(99,102,241,0.4)}.btn-success{background:linear-gradient(90deg,#10b981,#34d399);color:white}.btn-danger{background:linear-gradient(90deg,#ef4444,#f87171);color:white}.btn-warning{background:linear-gradient(90deg,#f59e0b,#fbbf24);color:white}.btn-secondary{background:#f1f5f9;color:#475569}.dark .btn-secondary{background:#334155;color:#e2e8f0}.btn-sm{padding:6px 12px;font-size:13px}.btn-icon{width:36px;height:36px;padding:0;display:flex;align-items:center;justify-content:center;border-radius:10px}.btn-scan{background:linear-gradient(90deg,#3b82f6,#60a5fa);color:white}.btn-scan:hover{transform:scale(1.05);box-shadow:0 4px 15px rgba(59,130,246,0.4)}.input{width:100%;padding:12px 16px;border:2px solid #e2e8f0;border-radius:10px;font-size:15px;transition:all 0.2s;background:white}.input:focus{outline:none;border-color:#6366f1;box-shadow:0 0 0 3px rgba(99,102,241,0.1)}.dark .input{background:#0f172a;border-color:#334155;color:white}.badge{padding:4px 12px;border-radius:20px;font-size:12px;font-weight:600}.badge-success{background:#dcfce7;color:#16a34a}.badge-warning{background:#fef3c7;color:#d97706}.badge-danger{background:#fee2e2;color:#dc2626}.badge-info{background:#dbeafe;color:#2563eb}.badge-purple{background:#f3e8ff;color:#9333ea}.dark .badge-success{background:#166534;color:#bbf7d0}.dark .badge-warning{background:#92400e;color:#fde68a}.dark .badge-danger{background:#991b1b;color:#fecaca}.dark .badge-info{background:#1e40af;color:#bfdbfe}.dark .badge-purple{background:#581c87;color:#e9d5ff}.stat-card{padding:20px;border-radius:16px;text-align:center}.stat-card .icon{width:50px;height:50px;border-radius:12px;display:flex;align-items:center;justify-content:center;margin:0 auto 12px;font-size:20px}.stat-card .value{font-size:28px;font-weight:700}.stat-card .label{font-size:13px;color:#64748b;margin-top:4px}.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:100;padding:20px;backdrop-filter:blur(4px)}.modal-content{background:white;border-radius:20px;max-width:700px;width:100%;max-height:90vh;overflow-y:auto;animation:modalIn 0.3s}.dark .modal-content{background:#1e293b}@keyframes modalIn{from{opacity:0;transform:scale(0.95) translateY(-20px)}to{opacity:1;transform:scale(1) translateY(0)}}.modal-header{padding:24px 24px 0}.modal-body{padding:24px}.modal-footer{padding:0 24px 24px;display:flex;gap:12px;justify-content:flex-end}.fade-in{animation:fadeIn 0.4s ease-out}@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}@media(max-width:1024px){.sidebar{transform:translateX(-100%)}.sidebar.open{transform:translateX(0)}.main-content{margin-left:0!important}}@media print{.no-print{display:none!important}.sidebar{display:none!important}.main-content{margin-left:0!important}}::-webkit-scrollbar{width:8px;height:8px}::-webkit-scrollbar-track{background:#f1f5f9}::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:4px}.mobile-nav-btn{transition:all 0.2s}.mobile-nav-btn:active{transform:scale(0.95)}.mobile-nav-btn.active{color:#6366f1}.mobile-nav-btn.active i{color:#6366f1}.point-control-card{background:white;border-radius:12px;padding:12px;margin-bottom:10px;box-shadow:0 2px 8px rgba(0,0,0,0.08);transition:all 0.2s}.dark .point-control-card{background:#1e293b}.point-control-card.validated{background:linear-gradient(135deg,#dcfce7,#bbf7d0);border-left:4px solid #10b981}.dark .point-control-card.validated{background:linear-gradient(135deg,#166534,#15803d)}.point-control-card.pending{background:white;border-left:4px solid #e2e8f0}.dark .point-control-card.pending{background:#1e293b;border-left-color:#334155}.point-name-clickable{cursor:pointer;transition:color 0.2s}.point-name-clickable:hover{color:#6366f1;text-decoration:underline}.screen-hidden{display:none!important}.pin-input{letter-spacing:8px;font-size:24px;text-align:center;font-weight:bold}
    </style>
</head>
<body class="bg-gray-50 dark:bg-slate-900">

<div id="loginScreen" class="gradient-bg min-h-screen flex items-center justify-center p-4">
    <div class="card p-8 w-full max-w-md fade-in">
        <div class="text-center mb-8">
            <div class="w-20 h-20 gradient-header rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg"><i class="fas fa-shield-alt text-white text-3xl"></i></div>
            <h1 class="text-2xl font-bold text-gray-800 dark:text-white">SSIAP Patrol</h1>
            <p class="text-gray-500 mt-1">Syst√®me de gestion du poste de s√©curit√©</p>
        </div>
        <div class="space-y-5">
            <div><label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Agent</label><select id="loginAgent" class="input"><option value="">S√©lectionner un agent...</option></select></div>
            <div><label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Code PIN</label><div class="relative"><input type="password" id="loginPassword" class="input pr-12" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="6" inputmode="numeric"><button type="button" onclick="togglePasswordVisibility()" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700"><i id="eyeIcon" class="fas fa-eye text-xl"></i></button></div></div>
            <div id="loginError" class="text-red-500 text-sm font-medium hidden"></div>
            <button onclick="login()" class="btn btn-primary w-full justify-center py-3"><i class="fas fa-sign-in-alt"></i> Se connecter</button>
        </div>
    </div>
</div>

<div id="loginRondier" class="gradient-bg min-h-screen flex items-center justify-center p-4 screen-hidden">
    <div class="card p-6 w-full max-w-md fade-in">
        <div class="text-center mb-6">
            <div class="w-16 h-16 bg-orange-500 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg"><i class="fas fa-walking text-white text-2xl"></i></div>
            <h1 class="text-xl font-bold text-gray-800 dark:text-white">Connexion Rondier</h1>
            <p class="text-gray-500 text-sm mt-1">S√©lectionnez votre nom pour commencer</p>
        </div>
        <div id="rondierLoading" class="text-center py-8"><i class="fas fa-sync-alt fa-spin text-3xl text-primary-500 mb-4"></i><p class="text-gray-500">Chargement des agents en poste...</p></div>
        <div id="rondierContent" class="space-y-4 hidden">
            <div id="rondierStep1"><p class="text-sm text-gray-600 dark:text-gray-400 mb-3 text-center">üë§ Qui √™tes-vous ?</p><div id="rondierAgentsList" class="space-y-2 max-h-64 overflow-y-auto"></div></div>
            <div id="rondierStep2" class="hidden">
                <div id="selectedAgentInfo" class="bg-primary-50 dark:bg-primary-900/30 p-4 rounded-xl mb-4"></div>
                <div class="space-y-4">
                    <div><label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2"><i class="fas fa-lock mr-1"></i> Code PIN</label><div class="relative"><input type="password" id="rondierPinInput" class="input pin-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4" inputmode="numeric" onkeyup="if(event.key==='Enter')validerPinRondier()"><button type="button" onclick="toggleRondierPinVisibility()" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700"><i id="rondierEyeIcon" class="fas fa-eye text-xl"></i></button></div></div>
                    <div id="rondierPinError" class="text-red-500 text-sm font-medium text-center hidden"></div>
                    <div class="flex gap-2"><button onclick="retourSelectionAgent()" class="btn btn-secondary flex-1"><i class="fas fa-arrow-left"></i> Retour</button><button onclick="validerPinRondier()" class="btn btn-primary flex-1"><i class="fas fa-sign-in-alt"></i> Connexion</button></div>
                </div>
            </div>
            <div id="rondierNoAgent" class="text-center py-6 hidden">
                <div class="w-16 h-16 bg-yellow-100 dark:bg-yellow-900/50 rounded-full flex items-center justify-center mx-auto mb-4"><i class="fas fa-exclamation-triangle text-yellow-600 text-2xl"></i></div>
                <p class="text-gray-600 dark:text-gray-400 font-medium">Aucun rondier SSIAP 1 en poste</p>
                <p class="text-gray-500 text-sm mt-2">Faites votre prise de poste au PC S√©curit√© d'abord.</p>
                <button onclick="rechargerAgentsRondier()" class="btn btn-secondary mt-4"><i class="fas fa-sync-alt"></i> Actualiser</button>
            </div>
        </div>
    </div>
</div>

<div id="mainApp" class="screen-hidden">
    <aside class="sidebar no-print" id="sidebar">
        <div class="p-6 border-b border-gray-100 dark:border-slate-700">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 gradient-header rounded-xl flex items-center justify-center shadow-lg"><i class="fas fa-shield-alt text-white text-xl"></i></div>
                <div><div class="font-bold text-lg text-gray-800 dark:text-white">SSIAP Patrol</div><div class="text-xs text-gray-500" id="userBadge"></div><div class="text-xs" id="firebaseStatus"></div></div>
            </div>
        </div>
        <nav class="py-4 pb-48 overflow-y-auto" id="navMenu" style="max-height:calc(100vh - 120px)"></nav>
        <div class="absolute bottom-0 left-0 right-0 p-4 border-t border-gray-100 dark:border-slate-700 space-y-2 bg-white dark:bg-slate-800" id="sidebarActions"></div>
    </aside>
    <header id="mobileHeader" class="lg:hidden fixed top-0 left-0 right-0 bg-white dark:bg-slate-800 shadow-md z-40 p-4 flex items-center justify-between no-print">
        <button onclick="toggleSidebar()" class="btn btn-icon btn-secondary"><i class="fas fa-bars"></i></button>
        <div class="font-bold text-gray-800 dark:text-white">SSIAP Patrol</div>
        <button onclick="logout()" class="btn btn-icon btn-secondary"><i class="fas fa-sign-out-alt"></i></button>
    </header>
    <header id="rondierHeader" class="lg:hidden fixed top-0 left-0 right-0 gradient-header text-white z-40 p-3 hidden no-print">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3"><div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center"><i class="fas fa-walking"></i></div><div><div class="font-semibold text-sm" id="rondierHeaderName">Rondier</div><div class="text-xs opacity-80">En service</div></div></div>
            <button onclick="logout()" class="btn btn-sm bg-white/20 hover:bg-white/30 text-white border-0"><i class="fas fa-sign-out-alt"></i></button>
        </div>
    </header>
    <div id="sidebarOverlay" class="fixed inset-0 bg-black/50 z-40 hidden lg:hidden" onclick="toggleSidebar()"></div>
    <main class="main-content lg:ml-[280px] min-h-screen pt-20 lg:pt-0 pb-20 lg:pb-0"><div class="p-6" id="mainContent"></div></main>
    <nav id="mobileNavBar" class="lg:hidden fixed bottom-0 left-0 right-0 bg-white dark:bg-slate-800 border-t border-gray-200 dark:border-slate-700 z-50 hidden">
        <div class="flex justify-around items-center h-16">
            <button onclick="navigate('rondes')" id="mobileNavRondes" class="mobile-nav-btn flex flex-col items-center justify-center flex-1 h-full text-gray-500 dark:text-gray-400"><i class="fas fa-route text-xl mb-1"></i><span class="text-xs font-medium">Rondes</span></button>
            <button onclick="navigate('materiels')" id="mobileNavMateriels" class="mobile-nav-btn flex flex-col items-center justify-center flex-1 h-full text-gray-500 dark:text-gray-400"><i class="fas fa-fire-extinguisher text-xl mb-1"></i><span class="text-xs font-medium">Mat√©riels</span></button>
            <button onclick="navigate('consignes')" id="mobileNavConsignes" class="mobile-nav-btn flex flex-col items-center justify-center flex-1 h-full text-gray-500 dark:text-gray-400"><i class="fas fa-file-alt text-xl mb-1"></i><span class="text-xs font-medium">Consignes</span></button>
        </div>
    </nav>
</div>

<div id="modalContainer"></div>

<script>
const DB={agents:[
    {id:3,nom:'Boyer',prenom:'Michel',qualification:'Administrateur',entreprise:'SecuriPlus',actif:true,email:'admin@securiplus.fr',codePin:'123456',dateDebutContrat:'2018-12-01'},
    {id:1,nom:'Martin',prenom:'Jean-Pierre',qualification:'SSIAP 2',entreprise:'SecuriPlus',actif:true,dateDebutContrat:'2020-06-01'},
    {id:2,nom:'Dupont',prenom:'Alain',qualification:'SSIAP 1',entreprise:'SecuriPlus',actif:true,dateDebutContrat:'2019-04-01'},
    {id:4,nom:'Dubois',prenom:'Marie',qualification:'SSIAP 2',entreprise:'SecuriPlus',actif:true,dateDebutContrat:'2021-02-01'},
    {id:5,nom:'Garcia',prenom:'Pierre',qualification:'SSIAP 1',entreprise:'SecuriPlus',actif:true,dateDebutContrat:'2020-10-01'},
    {id:6,nom:'Leroy',prenom:'Fran√ßois',qualification:'SSIAP 3',entreprise:'SecuriPlus',actif:true,dateDebutContrat:'2017-08-01'}
],materiels:[
    {id:1,nom:'Extincteur CO2 5kg - Hall',type:'Extincteur',localisation:'B√¢timent Principal > RDC > Hall',statut:'Op√©rationnel',codeQR:'MAT-EXT-001'},
    {id:2,nom:'RIA DN25 - Couloir 2√®me',type:'RIA',localisation:'B√¢timent Principal > 2√®me √©tage',statut:'Op√©rationnel',codeQR:'MAT-RIA-001'},
    {id:3,nom:'D√©tecteur Optique B05',type:'D√©tecteur',localisation:'B√¢timent Principal > 2√®me √©tage',statut:'√Ä v√©rifier',codeQR:'MAT-DET-001'},
    {id:4,nom:'PCF Escalier A',type:'Porte CF',localisation:'B√¢timent Principal > RDC',statut:'Op√©rationnel',codeQR:'MAT-PCF-001'},
    {id:5,nom:'Extincteur Eau 6L - Cuisine',type:'Extincteur',localisation:'B√¢timent Annexe > 1er √©tage',statut:'En maintenance',codeQR:'MAT-EXT-002'}
],prisesPoste:[],rondes:[],evenements:[],mainCourante:[],consignes:[
    {id:1,titre:'Visite commission de s√©curit√©',niveau:'Particuli√®re',priorite:'Haute',contenu:'Commission de s√©curit√© pr√©vue le 15 octobre 2025.',active:true},
    {id:2,titre:'Contr√¥le acc√®s livraisons',niveau:'Courante',priorite:'Normale',contenu:'V√©rifier syst√©matiquement les bons de livraison.',active:true}
]};

let currentUser=null,currentView='dashboard',modalConfirmCallback=null,html5QrScanner=null,currentScanningPointId=null,currentScanningRondeId=null,selectedRondierAgentId=null;

let configEtablissement={nom:"√âtablissement",batiments:[{id:'bat1',nom:'B√¢timent Principal',secteurs:[{id:'bat1-ss',nom:'Sous-sol',zones:['Parking souterrain','Local technique','Chaufferie','Archives']},{id:'bat1-rdc',nom:'RDC',zones:['Hall d\'entr√©e','Accueil','Salle de r√©union A','Sanitaires RDC','Couloir principal']},{id:'bat1-r1',nom:'1er √©tage',zones:['Bureaux 101-110','Salle de pause','Sanitaires R+1','Couloir R+1']},{id:'bat1-r2',nom:'2√®me √©tage',zones:['Bureaux 201-210','Salle de r√©union B','Sanitaires R+2','Couloir R+2']}]},{id:'bat2',nom:'B√¢timent Annexe',secteurs:[{id:'bat2-rdc',nom:'RDC',zones:['Entrep√¥t','Quai de livraison','Bureau logistique']},{id:'bat2-r1',nom:'1er √©tage',zones:['Atelier','Vestiaires','R√©fectoire']}]},{id:'bat3',nom:'Ext√©rieurs',secteurs:[{id:'bat3-ext',nom:'Zones ext√©rieures',zones:['Parking visiteurs','Parking personnel','Voie pompiers','Espaces verts']}]}]};

const categoriesRondeSpecifique=[{id:'extincteurs',nom:'Extincteurs',icon:'fa-fire-extinguisher',types:['Extincteur']},{id:'ria',nom:'RIA',icon:'fa-tint',types:['RIA']},{id:'pcf',nom:'Portes coupe-feu',icon:'fa-door-closed',types:['Porte CF']},{id:'detecteurs',nom:'D√©tecteurs',icon:'fa-bell',types:['D√©tecteur']}];

const statutsMat=['Op√©rationnel','D√©faillant','En Maintenance','Hors Service'];

const firebaseConfig={apiKey:"AIzaSyBXK-4-9HBcTKCPQBdRzDSwTc55vRXWNOk",authDomain:"ssiap-patrol.firebaseapp.com",projectId:"ssiap-patrol",storageBucket:"ssiap-patrol.firebasestorage.app",messagingSenderId:"582750096370",appId:"1:582750096370:web:025f700bc1bf9194afb96b"};

let db=null,firestoreEnabled=false,donneesChargees=false;

try{if(typeof firebase!=='undefined'){firebase.initializeApp(firebaseConfig);db=firebase.firestore();firestoreEnabled=true;updateFirebaseStatus(true)}}catch(e){updateFirebaseStatus(false)}

function updateFirebaseStatus(c){setTimeout(()=>{const el=document.getElementById('firebaseStatus');if(el)el.innerHTML=c?'<span class="text-green-600"><i class="fas fa-cloud"></i> Firebase connect√©</span>':'<span class="text-red-600"><i class="fas fa-cloud-slash"></i> Hors ligne</span>'},100)}

function sauvegarderVersFirebase(){if(!firestoreEnabled||!db||!donneesChargees)return;db.collection('ssiap-patrol').doc('data').set({version:'1.0',date:new Date().toISOString(),agents:DB.agents,materiels:DB.materiels,prisesPoste:DB.prisesPoste,rondes:DB.rondes,evenements:DB.evenements,mainCourante:DB.mainCourante,consignes:DB.consignes,configEtablissement:configEtablissement}).catch(e=>console.error('Erreur:',e))}

function chargerDepuisFirebase(cb){if(!firestoreEnabled||!db){donneesChargees=true;if(cb)cb();return}db.collection('ssiap-patrol').doc('data').get().then(doc=>{if(doc.exists){const d=doc.data();DB.agents=d.agents||DB.agents;DB.materiels=d.materiels||DB.materiels;DB.prisesPoste=d.prisesPoste||[];DB.rondes=d.rondes||[];DB.evenements=d.evenements||[];DB.mainCourante=d.mainCourante||[];DB.consignes=d.consignes||DB.consignes;if(d.configEtablissement)configEtablissement=d.configEtablissement}donneesChargees=true;if(cb)cb()}).catch(()=>{donneesChargees=true;if(cb)cb()})}

function activerSyncTempsReel(){if(!firestoreEnabled||!db)return;db.collection('ssiap-patrol').doc('data').onSnapshot(doc=>{if(doc.exists){const d=doc.data();DB.agents=d.agents||DB.agents;DB.materiels=d.materiels||DB.materiels;DB.prisesPoste=d.prisesPoste||[];DB.rondes=d.rondes||[];DB.evenements=d.evenements||[];DB.mainCourante=d.mainCourante||[];DB.consignes=d.consignes||DB.consignes;if(d.configEtablissement)configEtablissement=d.configEtablissement;if(currentUser&&currentView&&views[currentView]){const c=document.getElementById('mainContent');if(c)c.innerHTML='<div class="fade-in">'+views[currentView]()+'</div>'}}})}

const formatDate=d=>d?new Date(d).toLocaleDateString('fr-FR'):'-';
const formatTime=d=>d?new Date(d).toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'}):'-';
const formatDateTime=d=>d?`${formatDate(d)} ${formatTime(d)}`:'-';
const genId=()=>Date.now()+Math.random();

function getAgentsEnPoste(){return DB.prisesPoste.filter(p=>!p.finPoste).map(p=>{const a=DB.agents.find(x=>x.id===p.agentId);return a?{...a,prisePosteId:p.id,poste:p.poste,heureDebut:p.heureDebut}:null}).filter(Boolean)}
function getChefDePoste(){return getAgentsEnPoste().find(a=>a.poste==='Chef de poste')}

function addMainCourante(type,desc,agentId){const a=DB.agents.find(x=>x.id===agentId);DB.mainCourante.unshift({id:genId(),date:new Date().toISOString(),type,description:desc,agent:a?`${a.prenom} ${a.nom}`:'Syst√®me',agentId});sauvegarderVersFirebase()}

function genererCodePin(date){if(!date)return'0000';const d=new Date(date);const base=d.getFullYear()*10000+(d.getMonth()+1)*100+d.getDate();return((base*9301+49297)%10000).toString().padStart(4,'0')}
function obtenirCodePin(a){return a.qualification==='Administrateur'?a.codePin||'123456':genererCodePin(a.dateDebutContrat)}

function masquerTousLesEcrans(){document.getElementById('loginScreen').classList.add('screen-hidden');document.getElementById('loginRondier').classList.add('screen-hidden');document.getElementById('mainApp').classList.add('screen-hidden')}
function afficherEcran(id){masquerTousLesEcrans();document.getElementById(id).classList.remove('screen-hidden')}

function initLoginPrincipal(){const sel=document.getElementById('loginAgent');const agents=[...DB.agents.filter(a=>a.actif)].sort((a,b)=>{const o={'Administrateur':0,'SSIAP 3':1,'SSIAP 2':2,'SSIAP 1':3};return(o[a.qualification]??4)-(o[b.qualification]??4)});sel.innerHTML='<option value="">S√©lectionner un agent...</option>'+agents.map(a=>`<option value="${a.id}">${a.prenom} ${a.nom} - ${a.qualification}</option>`).join('')}

function togglePasswordVisibility(){const i=document.getElementById('loginPassword'),ic=document.getElementById('eyeIcon');if(i.type==='password'){i.type='text';ic.classList.replace('fa-eye','fa-eye-slash')}else{i.type='password';ic.classList.replace('fa-eye-slash','fa-eye')}}
function toggleRondierPinVisibility(){const i=document.getElementById('rondierPinInput'),ic=document.getElementById('rondierEyeIcon');if(i.type==='password'){i.type='text';ic.classList.replace('fa-eye','fa-eye-slash')}else{i.type='password';ic.classList.replace('fa-eye-slash','fa-eye')}}

function showLoginError(m){const el=document.getElementById('loginError');el.textContent=m;el.classList.remove('hidden')}

function login(){const id=parseInt(document.getElementById('loginAgent').value),pwd=document.getElementById('loginPassword').value;if(!id)return showLoginError('S√©lectionnez un agent');const a=DB.agents.find(x=>x.id===id);if(!a)return showLoginError('Agent non trouv√©');if(pwd!==obtenirCodePin(a))return showLoginError('Code PIN incorrect');currentUser={...a};document.getElementById('userBadge').innerHTML=`<span class="badge badge-purple">${currentUser.qualification}</span> ${currentUser.prenom} ${currentUser.nom}`;afficherEcran('mainApp');initApp()}

function afficherLoginPrincipal(){const url=new URL(window.location.href);url.searchParams.delete('mode');window.history.replaceState({},document.title,url.toString());afficherEcran('loginScreen');initLoginPrincipal();document.getElementById('loginPassword').value='';document.getElementById('loginError').classList.add('hidden')}

function afficherLoginRondier(){afficherEcran('loginRondier');selectedRondierAgentId=null;resetRondierLoginSteps();document.getElementById('rondierLoading').classList.remove('hidden');document.getElementById('rondierContent').classList.add('hidden');chargerDepuisFirebase(()=>{document.getElementById('rondierLoading').classList.add('hidden');document.getElementById('rondierContent').classList.remove('hidden');afficherListeAgentsRondier()})}

function resetRondierLoginSteps(){document.getElementById('rondierStep1')?.classList.remove('hidden');document.getElementById('rondierStep2')?.classList.add('hidden');document.getElementById('rondierPinError')?.classList.add('hidden');const p=document.getElementById('rondierPinInput');if(p){p.value='';p.classList.remove('border-red-500')}}

function afficherListeAgentsRondier(){const agents=getAgentsEnPoste().filter(a=>a.qualification==='SSIAP 1');const list=document.getElementById('rondierAgentsList'),no=document.getElementById('rondierNoAgent'),s1=document.getElementById('rondierStep1');if(!agents.length){list.innerHTML='';no.classList.remove('hidden');s1?.classList.add('hidden')}else{no.classList.add('hidden');s1?.classList.remove('hidden');list.innerHTML=agents.map(a=>`<button onclick="selectionnerAgentRondier(${a.id})" class="w-full p-4 bg-gray-50 dark:bg-slate-700 hover:bg-primary-50 dark:hover:bg-slate-600 rounded-xl flex items-center gap-4 transition-all border-2 border-transparent hover:border-primary-500"><div class="w-12 h-12 gradient-header rounded-full flex items-center justify-center text-white font-bold text-lg">${a.prenom.charAt(0)}${a.nom.charAt(0)}</div><div class="flex-1 text-left"><div class="font-semibold text-gray-800 dark:text-white">${a.prenom} ${a.nom}</div><div class="text-sm text-gray-500">En poste depuis ${formatTime(a.heureDebut)}</div></div><i class="fas fa-chevron-right text-gray-400"></i></button>`).join('')}}

function selectionnerAgentRondier(id){const a=DB.agents.find(x=>x.id===id);if(!a)return showToast('Agent non trouv√©','error');const pp=DB.prisesPoste.find(p=>p.agentId===id&&!p.finPoste);if(!pp){showToast('Cet agent n\'est plus en poste','error');rechargerAgentsRondier();return}selectedRondierAgentId=id;document.getElementById('rondierStep1').classList.add('hidden');document.getElementById('rondierStep2').classList.remove('hidden');document.getElementById('selectedAgentInfo').innerHTML=`<div class="flex items-center gap-3"><div class="w-14 h-14 gradient-header rounded-full flex items-center justify-center text-white font-bold text-xl">${a.prenom.charAt(0)}${a.nom.charAt(0)}</div><div><div class="font-bold text-gray-800 dark:text-white text-lg">${a.prenom} ${a.nom}</div><div class="text-sm text-gray-600 dark:text-gray-400">${a.qualification}</div></div></div>`;setTimeout(()=>document.getElementById('rondierPinInput')?.focus(),100)}

function retourSelectionAgent(){selectedRondierAgentId=null;resetRondierLoginSteps()}

function validerPinRondier(){const p=document.getElementById('rondierPinInput'),err=document.getElementById('rondierPinError'),pin=p?.value||'';if(!selectedRondierAgentId)return showToast('S√©lectionnez un agent','error');const a=DB.agents.find(x=>x.id===selectedRondierAgentId);if(!a)return showToast('Agent non trouv√©','error');const pp=DB.prisesPoste.find(x=>x.agentId===selectedRondierAgentId&&!x.finPoste);if(!pp){showToast('Agent plus en poste','error');retourSelectionAgent();rechargerAgentsRondier();return}if(pin!==obtenirCodePin(a)){err.textContent='‚ùå Code PIN incorrect';err.classList.remove('hidden');p.classList.add('border-red-500');if(navigator.vibrate)navigator.vibrate([100,50,100]);p.animate([{transform:'translateX(0)'},{transform:'translateX(-10px)'},{transform:'translateX(10px)'},{transform:'translateX(-10px)'},{transform:'translateX(0)'}],{duration:400});return}currentUser={...a};document.getElementById('userBadge').innerHTML=`<span class="badge badge-purple">${currentUser.qualification}</span> ${currentUser.prenom} ${currentUser.nom}`;afficherEcran('mainApp');initApp();if(navigator.vibrate)navigator.vibrate(200);showToast(`‚úÖ Bienvenue ${currentUser.prenom} !`)}

function rechargerAgentsRondier(){showToast('üîÑ Actualisation...','info');afficherLoginRondier()}

function logout(){currentUser=null;selectedRondierAgentId=null;if(detecterModeRondier())afficherLoginRondier();else afficherLoginPrincipal()}

const menuItems=[{id:'dashboard',icon:'fa-tachometer-alt',label:'Tableau de bord',ssiap1:false,ssiap2:true,ssiap3:true,admin:true},{id:'prisePoste',icon:'fa-user-clock',label:'Prise de Poste',ssiap1:false,ssiap2:true,ssiap3:false,admin:false},{id:'rondes',icon:'fa-route',label:'Rondes',ssiap1:true,ssiap2:true,ssiap3:true,admin:true},{id:'mainCourante',icon:'fa-clipboard-list',label:'Main Courante',ssiap1:false,ssiap2:true,ssiap3:true,admin:true},{id:'materiels',icon:'fa-fire-extinguisher',label:'Mat√©riels',ssiap1:true,ssiap2:true,ssiap3:true,admin:true},{id:'consignes',icon:'fa-file-alt',label:'Consignes',ssiap1:true,ssiap2:true,ssiap3:true,admin:true},{id:'agents',icon:'fa-users',label:'Agents',ssiap1:false,ssiap2:false,ssiap3:true,admin:true},{id:'administration',icon:'fa-cogs',label:'Administration',ssiap1:false,ssiap2:false,ssiap3:false,admin:true}];

function initApp(){renderNav();renderSidebarActions();updateMobileUI();navigate(currentUser?.qualification==='SSIAP 1'?'rondes':'dashboard')}

function renderNav(){const q=currentUser?.qualification;document.getElementById('navMenu').innerHTML=menuItems.filter(m=>{if(q==='Administrateur')return m.admin;if(q==='SSIAP 3')return m.ssiap3;if(q==='SSIAP 2')return m.ssiap2;if(q==='SSIAP 1')return m.ssiap1;return false}).map(m=>`<div class="nav-link ${currentView===m.id?'active':''}" onclick="navigate('${m.id}')"><i class="fas ${m.icon} w-5"></i><span>${m.label}</span></div>`).join('')}

function renderSidebarActions(){const q=currentUser?.qualification;let h='';if(q==='Administrateur')h+=`<button onclick="sauvegarderVersFirebase();sauvegarderDonnees()" class="btn btn-success w-full justify-center btn-sm"><i class="fas fa-cloud-upload-alt"></i> Sauvegarder</button>`;h+=`<button onclick="logout()" class="btn btn-secondary w-full justify-center"><i class="fas fa-sign-out-alt"></i> D√©connexion</button>`;document.getElementById('sidebarActions').innerHTML=h}

function updateMobileUI(){const nav=document.getElementById('mobileNavBar'),mh=document.getElementById('mobileHeader'),rh=document.getElementById('rondierHeader'),rn=document.getElementById('rondierHeaderName');if(currentUser?.qualification==='SSIAP 1'){nav?.classList.remove('hidden');mh?.classList.add('hidden');rh?.classList.remove('hidden');if(rn)rn.textContent=`${currentUser.prenom} ${currentUser.nom}`;['rondes','materiels','consignes'].forEach(id=>{const btn=document.getElementById('mobileNav'+id.charAt(0).toUpperCase()+id.slice(1));if(btn)btn.classList.toggle('active',currentView===id)})}else{nav?.classList.add('hidden');mh?.classList.remove('hidden');rh?.classList.add('hidden')}}

function navigate(v){currentView=v;renderNav();updateMobileUI();const c=document.getElementById('mainContent');c.innerHTML='<div class="fade-in">'+(views[v]?.()|| '')+'</div>';const sb=document.getElementById('sidebar'),ov=document.getElementById('sidebarOverlay');if(sb?.classList.contains('open')){sb.classList.remove('open');ov?.classList.add('hidden')}if(v==='dashboard')setTimeout(()=>{const qr=document.getElementById('qrCodeAccess');if(qr&&typeof QRCode!=='undefined'){qr.innerHTML='';new QRCode(qr,{text:window.location.href.split('?')[0]+'?mode=rondier',width:120,height:120})}},100)}

function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open');document.getElementById('sidebarOverlay').classList.toggle('hidden')}

const views={dashboard:renderDashboard,prisePoste:renderPrisePoste,rondes:renderRondes,mainCourante:renderMainCourante,materiels:renderMateriels,consignes:renderConsignes,agents:renderAgents,administration:renderAdministration};

function renderDashboard(){const ap=getAgentsEnPoste(),chef=getChefDePoste(),eq=ap.filter(a=>a.poste!=='Chef de poste'),rc=DB.rondes.filter(r=>!r.heureFin),te=DB.mainCourante.filter(m=>new Date(m.date).toDateString()===new Date().toDateString());return`<div class="gradient-header text-white p-6 rounded-2xl mb-6 shadow-lg flex flex-wrap items-center justify-between gap-4"><div><h1 class="text-2xl font-bold">Tableau de bord SSIAP</h1><p class="opacity-90">${new Date().toLocaleDateString('fr-FR',{weekday:'long',year:'numeric',month:'long',day:'numeric'})}</p></div><div class="bg-white p-3 rounded-xl no-print"><div id="qrCodeAccess"></div><p class="text-center text-xs text-gray-600 mt-2"><i class="fas fa-mobile-alt mr-1"></i>Acc√®s Rondier</p></div></div><div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6"><div class="stat-card bg-white dark:bg-slate-800"><div class="icon bg-green-100 dark:bg-green-900 text-green-600"><i class="fas fa-users"></i></div><div class="value text-gray-800 dark:text-white">${ap.length}</div><div class="label">Agents en poste</div></div><div class="stat-card bg-white dark:bg-slate-800"><div class="icon bg-blue-100 dark:bg-blue-900 text-blue-600"><i class="fas fa-route"></i></div><div class="value text-gray-800 dark:text-white">${rc.length}</div><div class="label">Rondes en cours</div></div><div class="stat-card bg-white dark:bg-slate-800"><div class="icon bg-red-100 dark:bg-red-900 text-red-600"><i class="fas fa-exclamation-triangle"></i></div><div class="value text-gray-800 dark:text-white">${DB.evenements.filter(e=>e.statut!=='Termin√©').length}</div><div class="label">√âv√©nements actifs</div></div><div class="stat-card bg-white dark:bg-slate-800"><div class="icon bg-purple-100 dark:bg-purple-900 text-purple-600"><i class="fas fa-clipboard-list"></i></div><div class="value text-gray-800 dark:text-white">${te.length}</div><div class="label">Actions aujourd'hui</div></div></div><div class="grid lg:grid-cols-2 gap-6"><div class="card"><div class="gradient-success text-white p-4 font-semibold"><i class="fas fa-users mr-2"></i>√âquipe en poste</div><div class="p-4">${chef?`<div class="flex items-center gap-3 p-3 bg-yellow-50 dark:bg-yellow-900/30 rounded-xl mb-3"><div class="w-10 h-10 bg-yellow-500 rounded-xl flex items-center justify-center text-white"><i class="fas fa-crown"></i></div><div><div class="font-semibold">Chef de Poste</div><div class="text-sm text-gray-600">${chef.prenom} ${chef.nom} ‚Ä¢ depuis ${formatTime(chef.heureDebut)}</div></div></div>`:'<p class="text-gray-500 text-center py-2">Aucun chef de poste</p>'}${eq.length?eq.map(a=>`<div class="flex items-center gap-3 p-3 hover:bg-gray-50 dark:hover:bg-slate-700 rounded-xl"><div class="w-10 h-10 bg-primary-500 rounded-xl flex items-center justify-center text-white font-semibold">${a.prenom[0]}${a.nom[0]}</div><div><div class="font-medium">${a.prenom} ${a.nom}</div><div class="text-sm text-gray-500">${a.qualification} ‚Ä¢ depuis ${formatTime(a.heureDebut)}</div></div></div>`).join(''):'<p class="text-gray-500 text-center py-4">Aucun √©quipier</p>'}</div></div><div class="card"><div class="gradient-warning text-white p-4 font-semibold"><i class="fas fa-file-alt mr-2"></i>Consignes actives</div><div class="p-4 space-y-3">${DB.consignes.filter(c=>c.active).slice(0,3).map(c=>`<div class="flex items-center gap-3 p-3 bg-purple-50 dark:bg-purple-900/30 rounded-xl"><i class="fas fa-file-alt text-purple-500"></i><div class="flex-1"><div class="font-medium">${c.titre}</div><div class="text-sm text-gray-500">${c.contenu.substring(0,60)}...</div></div></div>`).join('')||'<p class="text-gray-500 text-center py-4">Aucune consigne</p>'}</div></div></div>`}

function renderRondes(){const is1=currentUser?.qualification==='SSIAP 1',stats={total:DB.rondes.length,enCours:DB.rondes.filter(r=>!r.heureFin).length,terminees:DB.rondes.filter(r=>r.heureFin).length,anomalies:DB.rondes.filter(r=>r.anomalies?.length).length},mes=DB.rondes.filter(r=>!r.heureFin&&r.agentId===currentUser?.id);return is1?renderRondesMobile(mes,stats):renderRondesDesktop(stats)}

function renderRondesDesktop(s){return`<div class="flex flex-wrap items-center justify-between gap-4 mb-6"><h1 class="text-2xl font-bold text-gray-800 dark:text-white"><i class="fas fa-route mr-2 text-primary-500"></i>Gestion des Rondes</h1></div><div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6"><div class="stat-card bg-white dark:bg-slate-800 flex items-center gap-4"><div class="w-4 h-4 rounded-full bg-blue-500"></div><div><div class="text-xs text-gray-500">Total</div><div class="text-2xl font-bold">${s.total}</div></div></div><div class="stat-card bg-white dark:bg-slate-800 flex items-center gap-4"><div class="w-4 h-4 rounded-full bg-orange-500 animate-pulse"></div><div><div class="text-xs text-gray-500">En cours</div><div class="text-2xl font-bold text-orange-600">${s.enCours}</div></div></div><div class="stat-card bg-white dark:bg-slate-800 flex items-center gap-4"><div class="w-4 h-4 rounded-full bg-green-500"></div><div><div class="text-xs text-gray-500">Termin√©es</div><div class="text-2xl font-bold text-green-600">${s.terminees}</div></div></div><div class="stat-card bg-white dark:bg-slate-800 flex items-center gap-4"><div class="w-4 h-4 rounded-full bg-red-500"></div><div><div class="text-xs text-gray-500">Anomalies</div><div class="text-2xl font-bold text-red-600">${s.anomalies}</div></div></div></div><div class="card"><div class="p-4 space-y-3">${DB.rondes.length?DB.rondes.slice(0,10).map(r=>{const a=DB.agents.find(x=>x.id===r.agentId),pts=r.pointsControle?.filter(p=>p.valide).length||0,tot=r.pointsControle?.length||0;return`<div class="flex flex-wrap items-center justify-between gap-4 p-4 bg-gray-50 dark:bg-slate-700 rounded-xl"><div class="flex-1"><div class="flex items-center gap-2 mb-1"><span class="badge ${r.heureFin?'badge-success':'badge-warning'}">${r.heureFin?'Termin√©e':'En cours'}</span></div><div class="font-medium">${r.nom||r.type}</div><div class="text-sm text-gray-500">${a?.prenom||''} ${a?.nom||''} ‚Ä¢ ${formatDateTime(r.heureDebut)}</div>${tot>0?`<div class="text-xs text-gray-400 mt-1">${pts}/${tot} points valid√©s</div>`:''}</div><button onclick="voirRonde(${r.id})" class="btn btn-secondary btn-sm"><i class="fas fa-eye"></i></button></div>`}).join(''):'<p class="text-gray-500 text-center py-8">Aucune ronde</p>'}</div></div>`}

function renderRondesMobile(mes,s){if(mes.length>0){const r=mes[0],pv=r.pointsControle?.filter(p=>p.valide).length||0,tot=r.pointsControle?.length||0,prog=tot>0?Math.round((pv/tot)*100):0,dur=Math.round((new Date()-new Date(r.heureDebut))/60000);return`<div class="space-y-4"><div class="bg-gradient-to-r from-yellow-400 to-orange-500 text-white p-4 rounded-2xl shadow-lg"><div class="flex items-center gap-3 mb-3"><div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center animate-pulse"><i class="fas fa-walking text-2xl"></i></div><div class="flex-1"><div class="font-bold text-lg">${r.nom||r.type}</div><div class="text-sm opacity-90">${r.zone||'Toutes zones'} ‚Ä¢ ${dur} min</div></div></div><div class="bg-white/20 rounded-full h-3 mb-2"><div class="bg-white h-3 rounded-full transition-all" style="width:${prog}%"></div></div><div class="flex justify-between text-sm"><span>${pv}/${tot} points valid√©s</span><span>${prog}%</span></div></div><div class="card"><div class="p-4 border-b border-gray-100 dark:border-slate-700"><h3 class="font-semibold flex items-center gap-2"><i class="fas fa-list-check text-blue-500"></i> Points de contr√¥le</h3></div><div class="p-3 space-y-2 max-h-[50vh] overflow-y-auto">${r.pointsControle.map((p,i)=>renderPointControleCard(r.id,p,i)).join('')}</div></div><button onclick="terminerRonde(${r.id})" class="w-full btn btn-success py-4 text-lg justify-center"><i class="fas fa-flag-checkered"></i> Terminer la ronde</button></div>`}return`<div class="flex flex-col items-center justify-center min-h-[60vh] space-y-6"><button onclick="nouvelleRondeMobile()" class="w-full max-w-sm gradient-header text-white p-8 rounded-3xl shadow-2xl flex flex-col items-center gap-4 active:scale-95 transition-transform"><div class="w-20 h-20 bg-white/20 rounded-full flex items-center justify-center"><i class="fas fa-play text-4xl"></i></div><div class="text-center"><div class="text-2xl font-bold">Nouvelle Ronde</div><div class="text-sm opacity-80 mt-1">Appuyez pour commencer</div></div></button><div class="grid grid-cols-2 gap-4 w-full max-w-sm"><div class="card p-4 text-center"><div class="text-3xl font-bold text-green-600">${s.terminees}</div><div class="text-xs text-gray-500 uppercase">Termin√©es</div></div><div class="card p-4 text-center"><div class="text-3xl font-bold text-red-600">${s.anomalies}</div><div class="text-xs text-gray-500 uppercase">Anomalies</div></div></div></div>`}

function renderPointControleCard(rid,p,i){const v=p.valide,mat=p.materielId?DB.materiels.find(m=>m.id===p.materielId):null;return`<div class="point-control-card ${v?'validated':'pending'}"><div class="flex items-center gap-3"><div class="flex-shrink-0">${v?'<div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center text-white"><i class="fas fa-check"></i></div>':'<div class="w-10 h-10 bg-gray-200 dark:bg-slate-600 rounded-full flex items-center justify-center text-gray-400"><i class="fas fa-circle"></i></div>'}</div><div class="flex-1 min-w-0 ${mat?'point-name-clickable':''}" ${mat?`onclick="ouvrirFicheMateriel(${mat.id})"`:''}><div class="font-medium text-gray-800 dark:text-white truncate">${p.nom}${mat?' <i class="fas fa-external-link-alt text-xs text-blue-500 ml-1"></i>':''}</div><div class="text-xs text-gray-500 truncate">${p.chemin||p.localisation||''}</div>${v?`<div class="text-xs text-green-600 mt-1"><i class="fas fa-check-circle"></i> Valid√© √† ${formatTime(p.heureValidation)}</div>`:''}</div><div class="flex gap-2 flex-shrink-0">${!v?`<button onclick="scannerPoint(${rid},'${p.id}')" class="btn btn-scan btn-icon" title="Scanner"><i class="fas fa-qrcode"></i></button>`:''}<button onclick="signalerAnomalie(${rid},${i})" class="btn btn-warning btn-icon" title="Anomalie"><i class="fas fa-exclamation-triangle"></i></button></div></div></div>`}

function scannerPoint(rid,pid){currentScanningRondeId=rid;currentScanningPointId=pid;const r=DB.rondes.find(x=>x.id===rid),p=r?.pointsControle.find(x=>x.id==pid);if(!p)return showToast('Point non trouv√©','error');showModal(`Scanner: ${p.nom}`,`<div class="space-y-4"><div class="bg-blue-50 dark:bg-blue-900/30 p-3 rounded-lg text-center"><div class="font-semibold text-blue-700 dark:text-blue-300">${p.nom}</div><div class="text-sm text-blue-600 dark:text-blue-400 font-mono">${p.qrCode||'Aucun code'}</div></div><div id="qr-reader" style="width:100%;min-height:250px"></div><div id="qr-reader-results" class="text-center text-sm text-gray-500"></div><div class="flex gap-2"><button onclick="demarrerScan()" id="btnStartScan" class="btn btn-primary flex-1"><i class="fas fa-camera"></i> Activer cam√©ra</button><button onclick="arreterScan()" id="btnStopScan" class="btn btn-secondary flex-1 hidden"><i class="fas fa-stop"></i> Arr√™ter</button></div><div class="border-t border-gray-200 pt-4"><button onclick="validerManuellement(${rid},'${pid}')" class="btn btn-success w-full"><i class="fas fa-check"></i> Valider manuellement</button><p class="text-xs text-gray-500 text-center mt-2">Si le QR code est illisible</p></div></div>`,null,'Fermer')}

function demarrerScan(){const qr=document.getElementById('qr-reader'),res=document.getElementById('qr-reader-results'),bs=document.getElementById('btnStartScan'),bt=document.getElementById('btnStopScan');if(!qr||typeof Html5Qrcode==='undefined'){res.innerHTML='<span class="text-red-500">Scanner non disponible</span>';return}bs.classList.add('hidden');bt.classList.remove('hidden');res.innerHTML='<span class="text-blue-500"><i class="fas fa-spinner fa-spin mr-1"></i>Initialisation...</span>';html5QrScanner=new Html5Qrcode("qr-reader");html5QrScanner.start({facingMode:"environment"},{fps:10,qrbox:{width:250,height:250}},(txt)=>{res.innerHTML='<span class="text-green-500"><i class="fas fa-check-circle mr-1"></i>Code: '+txt+'</span>';arreterScan();validerParScan(currentScanningRondeId,currentScanningPointId,txt)},()=>{}).catch(()=>{res.innerHTML='<span class="text-red-500">Erreur cam√©ra</span>';bs.classList.remove('hidden');bt.classList.add('hidden')})}

function arreterScan(){if(html5QrScanner){html5QrScanner.stop().catch(()=>{});html5QrScanner=null}document.getElementById('btnStartScan')?.classList.remove('hidden');document.getElementById('btnStopScan')?.classList.add('hidden')}

function validerParScan(rid,pid,code){const r=DB.rondes.find(x=>x.id===rid);if(!r)return;const p=r.pointsControle.find(x=>x.id==pid);if(!p)return;const att=(p.qrCode||'').toLowerCase(),rec=code.toLowerCase(),ok=!att||att===rec||att.includes(rec)||rec.includes(att);if(ok){p.valide=true;p.heureValidation=new Date().toISOString();p.codeScanne=code;sauvegarderVersFirebase();closeModal();if(navigator.vibrate)navigator.vibrate(200);showToast(`‚úÖ ${p.nom} valid√© !`);navigate('rondes')}else{showToast('‚ùå Code QR incorrect !','error');if(navigator.vibrate)navigator.vibrate([100,50,100,50,100])}}

function validerManuellement(rid,pid){const r=DB.rondes.find(x=>x.id===rid);if(!r)return;const p=r.pointsControle.find(x=>x.id==pid);if(!p)return;p.valide=true;p.heureValidation=new Date().toISOString();p.validationManuelle=true;sauvegarderVersFirebase();closeModal();if(navigator.vibrate)navigator.vibrate(200);showToast(`‚úÖ ${p.nom} valid√©`);navigate('rondes')}

function signalerAnomalie(rid,idx){const r=DB.rondes.find(x=>x.id===rid);if(!r)return;const p=r.pointsControle[idx];showModal(`‚ö†Ô∏è Anomalie - ${p.nom}`,`<div class="space-y-4"><div class="bg-orange-50 dark:bg-orange-900/30 p-3 rounded-lg"><div class="font-semibold text-orange-700">${p.nom}</div><div class="text-sm text-gray-600">${p.chemin||''}</div></div><div><label class="block text-sm font-semibold mb-2">Type d'anomalie</label><select id="typeAnomalie" class="input"><option value="dysfonctionnement">Dysfonctionnement</option><option value="degradation">D√©gradation</option><option value="obstacle">Obstacle / Acc√®s bloqu√©</option><option value="manquant">√âl√©ment manquant</option><option value="securite">Probl√®me de s√©curit√©</option><option value="autre">Autre</option></select></div><div><label class="block text-sm font-semibold mb-2">Description *</label><textarea id="descAnomalie" class="input" rows="3" placeholder="D√©crivez le probl√®me..."></textarea></div><div><label class="block text-sm font-semibold mb-2">Gravit√©</label><div class="flex gap-2"><label class="flex-1 text-center"><input type="radio" name="gravite" value="faible" class="hidden peer"><div class="p-2 rounded-lg border-2 cursor-pointer peer-checked:border-yellow-500 peer-checked:bg-yellow-50"><i class="fas fa-exclamation text-yellow-500"></i><div class="text-xs">Faible</div></div></label><label class="flex-1 text-center"><input type="radio" name="gravite" value="moyenne" class="hidden peer" checked><div class="p-2 rounded-lg border-2 cursor-pointer peer-checked:border-orange-500 peer-checked:bg-orange-50"><i class="fas fa-exclamation-triangle text-orange-500"></i><div class="text-xs">Moyenne</div></div></label><label class="flex-1 text-center"><input type="radio" name="gravite" value="critique" class="hidden peer"><div class="p-2 rounded-lg border-2 cursor-pointer peer-checked:border-red-500 peer-checked:bg-red-50"><i class="fas fa-radiation text-red-500"></i><div class="text-xs">Critique</div></div></label></div></div></div>`,()=>{const desc=document.getElementById('descAnomalie').value.trim();if(!desc)return showToast('D√©crivez l\'anomalie','error');if(!r.anomalies)r.anomalies=[];r.anomalies.push({id:genId(),pointIndex:idx,pointNom:p.nom,type:document.getElementById('typeAnomalie').value,description:desc,gravite:document.querySelector('input[name="gravite"]:checked')?.value||'moyenne',date:new Date().toISOString(),agentId:currentUser?.id});addMainCourante('Anomalie',`${p.nom}: ${desc}`,currentUser?.id);sauvegarderVersFirebase();closeModal();if(navigator.vibrate)navigator.vibrate([100,50,100]);showToast('‚ö†Ô∏è Anomalie signal√©e','warning');navigate('rondes')},'Signaler')}

function ouvrirFicheMateriel(id){const m=DB.materiels.find(x=>x.id===id);if(!m)return;const sc={'Op√©rationnel':'success','D√©faillant':'danger','En Maintenance':'warning','Hors Service':'danger'}[m.statut]||'secondary';showModal('Fiche Mat√©riel',`<div class="space-y-4"><div class="flex items-center justify-between"><h3 class="text-xl font-bold">${m.nom}</h3><span class="badge badge-${sc}">${m.statut}</span></div><div class="grid grid-cols-2 gap-4"><div class="bg-gray-50 dark:bg-slate-700 p-3 rounded-lg"><div class="text-xs text-gray-500 uppercase mb-1">Type</div><div class="font-medium">${m.type}</div></div><div class="bg-gray-50 dark:bg-slate-700 p-3 rounded-lg"><div class="text-xs text-gray-500 uppercase mb-1">Localisation</div><div class="font-medium">${m.localisation||'-'}</div></div></div><div class="border-t pt-4"><label class="block text-sm font-semibold mb-2">Modifier le statut</label><select id="nouveauStatut" class="input">${statutsMat.map(s=>`<option value="${s}" ${s===m.statut?'selected':''}>${s}</option>`).join('')}</select></div><div><label class="block text-sm font-semibold mb-2">Observation</label><textarea id="observationMat" class="input" rows="2" placeholder="Remarques..."></textarea></div></div>`,()=>{const ns=document.getElementById('nouveauStatut').value,obs=document.getElementById('observationMat').value,old=m.statut;if(ns!==old){m.statut=ns;m.observation=obs;m.dateModification=new Date().toISOString();addMainCourante('Mat√©riel',`${m.nom}: ${old} ‚Üí ${ns}`,currentUser?.id);sauvegarderVersFirebase();showToast('‚úÖ Statut mis √† jour')}closeModal();navigate('rondes')},'Enregistrer')}

function nouvelleRondeMobile(){const ep=DB.prisesPoste.find(p=>p.agentId===currentUser?.id&&!p.finPoste);if(!ep){showModal('‚ö†Ô∏è Prise de poste requise',`<div class="text-center space-y-4"><div class="w-20 h-20 bg-yellow-100 rounded-full flex items-center justify-center mx-auto"><i class="fas fa-desktop text-yellow-600 text-3xl"></i></div><p class="text-gray-600">Effectuez votre <strong>prise de poste</strong> au <strong>PC S√©curit√©</strong> avant de d√©marrer une ronde.</p></div>`,null,'Compris');return}showModal('Nouvelle Ronde',`<div class="space-y-4"><button onclick="closeModal();choisirZoneRonde()" class="w-full p-5 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-2xl flex items-center gap-4"><div class="w-14 h-14 bg-white/20 rounded-xl flex items-center justify-center"><i class="fas fa-building text-2xl"></i></div><div class="text-left flex-1"><div class="font-bold text-lg">Ronde Globale</div><div class="text-sm opacity-80">Par zone/secteur</div></div></button><button onclick="closeModal();choisirCategorieRonde()" class="w-full p-5 bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-2xl flex items-center gap-4"><div class="w-14 h-14 bg-white/20 rounded-xl flex items-center justify-center"><i class="fas fa-fire-extinguisher text-2xl"></i></div><div class="text-left flex-1"><div class="font-bold text-lg">Ronde Sp√©cifique</div><div class="text-sm opacity-80">Par type de mat√©riel</div></div></button></div>`,null,'Annuler')}

function choisirZoneRonde(){showModal('Choisir la zone',`<div class="space-y-3"><button onclick="closeModal();demarrerRondeGlobale('√âtablissement complet')" class="w-full p-4 bg-gradient-to-r from-purple-500 to-indigo-600 text-white rounded-xl flex items-center gap-3"><i class="fas fa-building text-2xl"></i><div class="text-left flex-1"><div class="font-bold">√âtablissement complet</div></div></button><div class="border-t pt-2"><p class="text-xs text-gray-500 text-center mb-2">Ou choisissez un b√¢timent :</p></div>${configEtablissement.batiments.map(b=>`<button onclick="closeModal();choisirSecteur('${b.id}')" class="w-full p-4 bg-gray-50 dark:bg-slate-700 hover:bg-blue-50 rounded-xl flex items-center gap-3 transition-colors"><i class="fas fa-building text-blue-600"></i><div class="flex-1 text-left"><div class="font-medium">${b.nom}</div><div class="text-xs text-gray-500">${b.secteurs.length} secteur(s)</div></div></button>`).join('')}</div>`,null,'Retour')}

function choisirSecteur(bid){const b=configEtablissement.batiments.find(x=>x.id===bid);if(!b)return;showModal(b.nom,`<div class="space-y-3"><button onclick="closeModal();demarrerRondeGlobale('${b.nom}','${bid}')" class="w-full p-4 bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-xl"><div class="font-bold">Tout le b√¢timent</div></button><div class="border-t pt-2"><p class="text-xs text-gray-500 text-center mb-2">Ou un secteur :</p></div>${b.secteurs.map(s=>`<button onclick="closeModal();demarrerRondeGlobale('${b.nom} > ${s.nom}','${bid}','${s.id}')" class="w-full p-4 bg-gray-50 dark:bg-slate-700 hover:bg-green-50 rounded-xl flex items-center gap-3"><i class="fas fa-layer-group text-green-600"></i><div class="flex-1 text-left"><div class="font-medium">${s.nom}</div><div class="text-xs text-gray-500">${s.zones.length} zone(s)</div></div></button>`).join('')}</div>`,null,'Retour')}

function demarrerRondeGlobale(nom,bid=null,sid=null){let pts=[];if(!bid){configEtablissement.batiments.forEach(b=>{b.secteurs.forEach(s=>{s.zones.forEach(z=>{pts.push({id:genId(),nom:z,chemin:`${b.nom} > ${s.nom}`,qrCode:`ZONE-${b.id}-${s.id}-${z.replace(/\s+/g,'-').toUpperCase()}`.substring(0,50),valide:false})})})})}else if(!sid){const b=configEtablissement.batiments.find(x=>x.id===bid);b?.secteurs.forEach(s=>{s.zones.forEach(z=>{pts.push({id:genId(),nom:z,chemin:`${b.nom} > ${s.nom}`,qrCode:`ZONE-${bid}-${s.id}-${z.replace(/\s+/g,'-').toUpperCase()}`.substring(0,50),valide:false})})})}else{const b=configEtablissement.batiments.find(x=>x.id===bid),s=b?.secteurs.find(x=>x.id===sid);s?.zones.forEach(z=>{pts.push({id:genId(),nom:z,chemin:`${b.nom} > ${s.nom}`,qrCode:`ZONE-${bid}-${sid}-${z.replace(/\s+/g,'-').toUpperCase()}`.substring(0,50),valide:false})})}if(!pts.length)return showToast('Aucun point','error');DB.rondes.push({id:genId(),type:'Ronde de s√©curit√©',nom:`Ronde ${nom}`,zone:nom,agentId:currentUser?.id,heureDebut:new Date().toISOString(),pointsControle:pts,anomalies:[]});addMainCourante('D√©but ronde',`${nom} - ${pts.length} points`,currentUser?.id);sauvegarderVersFirebase();showToast(`üöÄ Ronde d√©marr√©e ! ${pts.length} points`);navigate('rondes')}

function choisirCategorieRonde(){showModal('Type de mat√©riel',`<div class="space-y-2 max-h-96 overflow-y-auto">${categoriesRondeSpecifique.map(c=>{const n=DB.materiels.filter(m=>c.types.some(t=>m.type.includes(t))).length;return`<button onclick="closeModal();demarrerRondeSpecifique('${c.id}')" class="w-full p-4 bg-gray-50 dark:bg-slate-700 hover:bg-orange-50 rounded-xl flex items-center gap-3 ${!n?'opacity-50':''}"><i class="fas ${c.icon} text-orange-600"></i><div class="flex-1 text-left"><div class="font-medium">${c.nom}</div><div class="text-xs text-gray-500">${n} mat√©riel(s)</div></div></button>`}).join('')}</div>`,null,'Retour')}

function demarrerRondeSpecifique(cid){const c=categoriesRondeSpecifique.find(x=>x.id===cid);if(!c)return;const mats=DB.materiels.filter(m=>c.types.some(t=>m.type.includes(t)));if(!mats.length)return showToast('Aucun mat√©riel','error');const pts=mats.map(m=>({id:genId(),nom:m.nom,materielId:m.id,localisation:m.localisation,qrCode:m.codeQR||`MAT-${m.id}`,valide:false}));DB.rondes.push({id:genId(),type:`Ronde ${c.nom}`,nom:`${c.nom} - √âtablissement`,zone:'Tout l\'√©tablissement',agentId:currentUser?.id,heureDebut:new Date().toISOString(),pointsControle:pts,anomalies:[],isSpecifique:true,categorieId:cid});addMainCourante('D√©but ronde',`${c.nom} - ${pts.length} mat√©riels`,currentUser?.id);sauvegarderVersFirebase();showToast(`üöÄ Ronde d√©marr√©e ! ${pts.length} ${c.nom.toLowerCase()}`);navigate('rondes')}

function terminerRonde(id){const r=DB.rondes.find(x=>x.id===id);if(!r)return;const pv=r.pointsControle?.filter(p=>p.valide).length||0,tot=r.pointsControle?.length||0,ok=pv===tot;showModal('Terminer la ronde',`<div class="space-y-4"><div class="bg-${ok?'green':'orange'}-50 p-4 rounded-lg"><div class="font-bold text-${ok?'green':'orange'}-700">${ok?'‚úÖ Tous les points valid√©s':`‚ö†Ô∏è ${tot-pv} point(s) non valid√©(s)`}</div><div class="text-sm">${pv}/${tot} points</div></div>${r.anomalies?.length?`<div class="bg-red-50 p-4 rounded-lg"><div class="font-bold text-red-700 mb-2">‚ö†Ô∏è ${r.anomalies.length} anomalie(s)</div><ul class="text-sm space-y-1">${r.anomalies.map(a=>`<li>‚Ä¢ ${a.pointNom}: ${a.description}</li>`).join('')}</ul></div>`:''}<div><label class="block text-sm font-semibold mb-2">Observation finale</label><textarea id="obsFin" class="input" rows="2" placeholder="Remarques..."></textarea></div></div>`,()=>{r.heureFin=new Date().toISOString();r.observationFin=document.getElementById('obsFin').value;const dur=Math.round((new Date(r.heureFin)-new Date(r.heureDebut))/60000);addMainCourante('Fin ronde',`${r.nom} - ${pv}/${tot} pts, ${dur} min`,r.agentId);sauvegarderVersFirebase();closeModal();showToast('‚úÖ Ronde termin√©e');navigate('rondes')})}

function voirRonde(id){const r=DB.rondes.find(x=>x.id===id);if(!r)return;const a=DB.agents.find(x=>x.id===r.agentId),pv=r.pointsControle?.filter(p=>p.valide).length||0,tot=r.pointsControle?.length||0;showModal('D√©tails Ronde',`<div class="space-y-4"><div class="flex items-center justify-between"><h3 class="text-xl font-bold">${r.nom||r.type}</h3><span class="badge ${r.heureFin?'badge-success':'badge-warning'}">${r.heureFin?'Termin√©e':'En cours'}</span></div><div class="grid grid-cols-2 gap-4"><div class="bg-gray-50 dark:bg-slate-700 p-3 rounded-lg"><div class="text-xs text-gray-500 uppercase mb-1">Agent</div><div class="font-medium">${a?.prenom||''} ${a?.nom||''}</div></div><div class="bg-gray-50 dark:bg-slate-700 p-3 rounded-lg"><div class="text-xs text-gray-500 uppercase mb-1">Points</div><div class="font-medium">${pv}/${tot}</div></div></div><div class="bg-gray-50 dark:bg-slate-700 p-3 rounded-lg"><div class="text-xs text-gray-500 uppercase mb-1">P√©riode</div><div class="font-medium">${formatDateTime(r.heureDebut)} ‚Üí ${r.heureFin?formatDateTime(r.heureFin):'En cours'}</div></div>${r.anomalies?.length?`<div class="bg-red-50 p-4 rounded-lg"><div class="font-bold text-red-700 mb-2">Anomalies (${r.anomalies.length})</div>${r.anomalies.map(x=>`<div class="text-sm">‚Ä¢ ${x.pointNom}: ${x.description}</div>`).join('')}</div>`:''}</div>`,null,'Fermer')}

function renderPrisePoste(){const ap=getAgentsEnPoste();return`<div class="flex flex-wrap items-center justify-between gap-4 mb-6"><h1 class="text-2xl font-bold"><i class="fas fa-user-clock mr-2 text-primary-500"></i>Prise de Poste</h1><button onclick="showModalPrisePoste()" class="btn btn-primary"><i class="fas fa-plus"></i> Nouvelle</button></div><div class="card"><div class="gradient-success text-white p-4 font-semibold">Agents en poste (${ap.length})</div><div class="p-4">${ap.length?ap.map(a=>`<div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-slate-700 rounded-xl mb-2"><div><div class="font-medium">${a.prenom} ${a.nom}</div><div class="text-sm text-gray-500">${a.qualification} - ${a.poste}</div></div><button onclick="finPoste(${a.prisePosteId})" class="btn btn-danger btn-sm"><i class="fas fa-stop"></i></button></div>`).join(''):'<p class="text-gray-500 text-center py-8">Aucun agent en poste</p>'}</div></div>`}

function showModalPrisePoste(){const dispo=DB.agents.filter(a=>a.actif&&!getAgentsEnPoste().find(p=>p.id===a.id)),chef=getChefDePoste();showModal('Nouvelle Prise de Poste',`<div class="space-y-4"><div><label class="block text-sm font-semibold mb-2">Agent</label><select id="ppAgent" class="input"><option value="">S√©lectionner...</option>${dispo.map(a=>`<option value="${a.id}">${a.prenom} ${a.nom} - ${a.qualification}</option>`).join('')}</select></div><div><label class="block text-sm font-semibold mb-2">Poste</label><select id="ppPoste" class="input">${!chef?'<option value="Chef de poste">Chef de poste</option>':''}<option value="Chef d'√âquipe">Chef d'√âquipe</option><option value="√âquipier">√âquipier</option></select></div></div>`,()=>{const id=parseInt(document.getElementById('ppAgent').value);if(!id)return showToast('S√©lectionnez un agent','error');const poste=document.getElementById('ppPoste').value;DB.prisesPoste.push({id:genId(),agentId:id,poste,heureDebut:new Date().toISOString()});const a=DB.agents.find(x=>x.id===id);addMainCourante('Prise de Poste',`${poste} - ${a.prenom} ${a.nom}`,id);sauvegarderVersFirebase();closeModal();showToast('Prise de poste enregistr√©e');navigate('prisePoste')})}

function finPoste(id){showConfirm('Confirmer la fin de poste ?',()=>{const pp=DB.prisesPoste.find(p=>p.id===id);if(pp){pp.finPoste=new Date().toISOString();const a=DB.agents.find(x=>x.id===pp.agentId);addMainCourante('Fin de Poste',`${a?.prenom} ${a?.nom}`,pp.agentId);sauvegarderVersFirebase();showToast('Fin de poste enregistr√©e');navigate('prisePoste')}})}

function renderMainCourante(){return`<div class="mb-6"><h1 class="text-2xl font-bold"><i class="fas fa-clipboard-list mr-2 text-primary-500"></i>Main Courante</h1></div><div class="card"><div class="p-4 space-y-2">${DB.mainCourante.slice(0,20).map(m=>`<div class="p-3 bg-gray-50 dark:bg-slate-700 rounded-lg"><div class="flex justify-between"><span class="badge badge-info">${m.type}</span><span class="text-sm text-gray-500">${formatDateTime(m.date)}</span></div><div class="mt-1">${m.description}</div><div class="text-xs text-gray-500 mt-1">${m.agent}</div></div>`).join('')||'<p class="text-gray-500 text-center py-8">Aucun √©v√©nement</p>'}</div></div>`}

function renderMateriels(){return`<div class="mb-6"><h1 class="text-2xl font-bold"><i class="fas fa-fire-extinguisher mr-2 text-primary-500"></i>Mat√©riels</h1></div><div class="card"><div class="p-4 space-y-2">${DB.materiels.map(m=>{const sc={'Op√©rationnel':'success','D√©faillant':'danger','En Maintenance':'warning','Hors Service':'danger'}[m.statut]||'secondary';return`<div class="p-3 bg-gray-50 dark:bg-slate-700 rounded-lg flex items-center justify-between cursor-pointer hover:bg-gray-100" onclick="ouvrirFicheMateriel(${m.id})"><div><div class="font-medium">${m.nom}</div><div class="text-sm text-gray-500">${m.localisation||'-'}</div></div><span class="badge badge-${sc}">${m.statut}</span></div>`}).join('')}</div></div>`}

function renderConsignes(){return`<div class="mb-6"><h1 class="text-2xl font-bold"><i class="fas fa-file-alt mr-2 text-primary-500"></i>Consignes</h1></div><div class="card"><div class="p-4 space-y-3">${DB.consignes.filter(c=>c.active).map(c=>`<div class="p-4 bg-purple-50 dark:bg-purple-900/30 rounded-xl"><div class="flex items-center gap-2 mb-2"><span class="badge ${c.niveau==='Particuli√®re'?'badge-warning':'badge-info'}">${c.niveau}</span><span class="badge badge-purple">${c.priorite}</span></div><div class="font-semibold">${c.titre}</div><p class="text-sm text-gray-600 mt-1">${c.contenu}</p></div>`).join('')||'<p class="text-gray-500 text-center py-8">Aucune consigne</p>'}</div></div>`}

function renderAgents(){return`<div class="mb-6"><h1 class="text-2xl font-bold"><i class="fas fa-users mr-2 text-primary-500"></i>Agents</h1></div><div class="card"><div class="p-4 space-y-2">${DB.agents.map(a=>`<div class="p-3 bg-gray-50 dark:bg-slate-700 rounded-lg flex items-center justify-between"><div class="flex items-center gap-3"><div class="w-10 h-10 gradient-header rounded-full flex items-center justify-center text-white font-bold">${a.prenom[0]}${a.nom[0]}</div><div><div class="font-medium">${a.prenom} ${a.nom}</div><div class="text-sm text-gray-500">${a.qualification}</div></div></div><span class="badge ${a.actif?'badge-success':'badge-danger'}">${a.actif?'Actif':'Inactif'}</span></div>`).join('')}</div></div>`}

function renderAdministration(){return`<div class="mb-6"><h1 class="text-2xl font-bold"><i class="fas fa-cogs mr-2 text-primary-500"></i>Administration</h1></div><div class="card p-8 text-center"><i class="fas fa-cogs text-6xl text-gray-300 mb-4"></i><p class="text-gray-500">Module d'administration</p></div>`}

function showModal(t,c,onC,txt='Confirmer'){modalConfirmCallback=onC;document.getElementById('modalContainer').innerHTML=`<div class="modal-overlay" onclick="if(event.target===this)closeModal()"><div class="modal-content"><div class="modal-header"><h2 class="text-xl font-bold">${t}</h2></div><div class="modal-body">${c}</div><div class="modal-footer"><button onclick="closeModal()" class="btn btn-secondary">Annuler</button>${onC?`<button onclick="executeModalConfirm()" class="btn btn-primary">${txt}</button>`:`<button onclick="closeModal()" class="btn btn-primary">${txt}</button>`}</div></div></div>`}

async function executeModalConfirm(){if(modalConfirmCallback)await modalConfirmCallback()}
function showConfirm(m,onY){showModal('Confirmation',`<p class="text-gray-600">${m}</p>`,()=>{closeModal();onY()})}
function closeModal(){if(html5QrScanner){html5QrScanner.stop().catch(()=>{});html5QrScanner=null}currentScanningPointId=null;currentScanningRondeId=null;document.getElementById('modalContainer').innerHTML=''}
function showToast(m,t='success'){const el=document.createElement('div');el.className=`fixed bottom-20 lg:bottom-4 right-4 px-5 py-3 rounded-xl text-white font-medium shadow-lg fade-in z-50 ${t==='error'?'bg-red-500':t==='warning'?'bg-orange-500':'gradient-success'}`;el.innerHTML=`<i class="fas ${t==='error'?'fa-times-circle':t==='warning'?'fa-exclamation-triangle':'fa-check-circle'} mr-2"></i>${m}`;document.body.appendChild(el);setTimeout(()=>el.remove(),3000)}
function sauvegarderDonnees(){const b=new Blob([JSON.stringify({version:'1.0',date:new Date().toISOString(),data:DB},null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='ssiap-patrol-backup-'+new Date().toISOString().split('T')[0]+'.json';a.click();showToast('Sauvegarde t√©l√©charg√©e')}
function detecterModeRondier(){return new URLSearchParams(window.location.search).get('mode')==='rondier'}

function demarrerApplication(){if(detecterModeRondier())afficherLoginRondier();else{afficherEcran('loginScreen');initLoginPrincipal()}}

if(firestoreEnabled){chargerDepuisFirebase(()=>{activerSyncTempsReel();demarrerApplication()})}else{donneesChargees=true;demarrerApplication()}
</script>
</body>
</html>
