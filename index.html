<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSIAP Patrol - Gestion S√©curit√© Incendie</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Poppins', 'sans-serif'] },
                    colors: { primary: { 50: '#eef2ff', 100: '#e0e7ff', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca' } }
                }
            }
        }
    </script>
    <style>
        * { box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background: #f8fafc; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .gradient-header { background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 100%); }
        .gradient-success { background: linear-gradient(90deg, #10b981 0%, #34d399 100%); }
        .gradient-warning { background: linear-gradient(90deg, #f59e0b 0%, #fbbf24 100%); }
        .gradient-danger { background: linear-gradient(90deg, #ef4444 0%, #f87171 100%); }
        .gradient-info { background: linear-gradient(90deg, #3b82f6 0%, #60a5fa 100%); }
        
        .card { background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); overflow: hidden; }
        
        .sidebar { width: 280px; background: white; height: 100vh; position: fixed; left: 0; top: 0; z-index: 50; transition: transform 0.3s; box-shadow: 4px 0 20px rgba(0,0,0,0.1); }
        
        .nav-link { display: flex; align-items: center; gap: 12px; padding: 14px 20px; margin: 4px 12px; border-radius: 12px; color: #64748b; font-weight: 500; transition: all 0.2s; cursor: pointer; }
        .nav-link:hover { background: #f1f5f9; color: #6366f1; }
        .nav-link.active { background: linear-gradient(90deg, #6366f1, #8b5cf6); color: white; box-shadow: 0 4px 15px rgba(99,102,241,0.4); }
        
        .btn { padding: 10px 20px; border-radius: 10px; font-weight: 600; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; cursor: pointer; border: none; font-size: 14px; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: linear-gradient(90deg, #6366f1, #8b5cf6); color: white; }
        .btn-primary:hover { box-shadow: 0 4px 15px rgba(99,102,241,0.4); }
        .btn-success { background: linear-gradient(90deg, #10b981, #34d399); color: white; }
        .btn-danger { background: linear-gradient(90deg, #ef4444, #f87171); color: white; }
        .btn-warning { background: linear-gradient(90deg, #f59e0b, #fbbf24); color: white; }
        .btn-secondary { background: #f1f5f9; color: #475569; }
        .btn-sm { padding: 6px 12px; font-size: 13px; }
        .btn-icon { width: 36px; height: 36px; padding: 0; display: flex; align-items: center; justify-content: center; }
        
        .input { width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 15px; transition: all 0.2s; background: white; }
        .input:focus { outline: none; border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99,102,241,0.1); }
        
        .badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; display: inline-block; }
        .badge-success { background: #dcfce7; color: #16a34a; }
        .badge-warning { background: #fef3c7; color: #d97706; }
        .badge-danger { background: #fee2e2; color: #dc2626; }
        .badge-info { background: #dbeafe; color: #2563eb; }
        .badge-purple { background: #f3e8ff; color: #9333ea; }
        .badge-gray { background: #f1f5f9; color: #64748b; }
        
        .stat-card { padding: 20px; border-radius: 16px; text-align: center; background: white; }
        .stat-card .icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 12px; font-size: 20px; }
        .stat-card .value { font-size: 28px; font-weight: 700; color: #1e293b; }
        .stat-card .label { font-size: 13px; color: #64748b; margin-top: 4px; }
        
        .table { width: 100%; }
        .table th { padding: 14px 16px; text-align: left; font-weight: 600; color: #64748b; font-size: 13px; text-transform: uppercase; border-bottom: 2px solid #e2e8f0; }
        .table td { padding: 14px 16px; border-bottom: 1px solid #f1f5f9; }
        .table tr:hover td { background: #f8fafc; }
        
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 100; padding: 20px; backdrop-filter: blur(4px); }
        .modal-content { background: white; border-radius: 20px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; animation: modalIn 0.3s; }
        @keyframes modalIn { from { opacity: 0; transform: scale(0.95) translateY(-20px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        .modal-header { padding: 20px 24px 0; }
        .modal-body { padding: 20px 24px; }
        .modal-footer { padding: 0 24px 20px; display: flex; gap: 12px; justify-content: flex-end; }
        
        .status-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }
        .status-dot.green { background: #10b981; box-shadow: 0 0 8px #10b981; animation: pulse 2s infinite; }
        .status-dot.orange { background: #f59e0b; box-shadow: 0 0 8px #f59e0b; animation: pulse 2s infinite; }
        .status-dot.red { background: #ef4444; box-shadow: 0 0 8px #ef4444; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .search-filters { display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 16px; padding: 16px; background: #f8fafc; border-radius: 12px; }
        .search-filters .input { max-width: 200px; }
        
        .qr-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 16px; }
        .qr-card { padding: 16px; border: 2px solid #e2e8f0; border-radius: 12px; text-align: center; background: white; }
        
        #qr-reader { width: 100%; min-height: 250px; }
        #qr-reader video { width: 100% !important; border-radius: 12px; }
        
        @media (max-width: 1024px) { 
            .sidebar { transform: translateX(-100%); } 
            .sidebar.open { transform: translateX(0); } 
            .main-content { margin-left: 0 !important; } 
        }
        
        @media print {
            .no-print { display: none !important; }
            .sidebar { display: none !important; }
            .main-content { margin-left: 0 !important; padding: 10px !important; }
            body { font-size: 11px !important; background: white !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .card { box-shadow: none !important; border: 1px solid #ccc !important; page-break-inside: avoid; margin-bottom: 10px; }
            .table { font-size: 11px !important; }
            .table th, .table td { padding: 6px 8px !important; font-size: 11px !important; }
            .badge { font-size: 9px !important; padding: 2px 6px !important; }
            h1 { font-size: 16px !important; margin-bottom: 10px !important; }
            .stat-card { display: none !important; }
            .search-filters { display: none !important; }
            .gradient-header, .gradient-success, .gradient-warning, .gradient-info { 
                background: #f3f4f6 !important; 
                color: #1f2937 !important; 
            }
        }
        
        .mobile-nav-btn { transition: all 0.2s; }
        .mobile-nav-btn.active { color: #6366f1; }
    </style>
</head>
<body>

<!-- Login Screen -->
<div id="loginScreen" class="gradient-bg min-h-screen flex items-center justify-center p-4">
    <div class="card p-8 w-full max-w-md fade-in">
        <div class="text-center mb-8">
            <div class="w-20 h-20 gradient-header rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
                <i class="fas fa-shield-alt text-white text-3xl"></i>
            </div>
            <h1 class="text-2xl font-bold text-gray-800">SSIAP Patrol</h1>
            <p class="text-gray-500 mt-1">Syst√®me de gestion des rondes</p>
        </div>
        <div class="space-y-5">
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Agent</label>
                <select id="loginAgent" class="input"><option value="">S√©lectionner...</option></select>
            </div>
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Code PIN</label>
                <input type="password" id="loginPassword" class="input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="6" inputmode="numeric">
            </div>
            <div id="loginError" class="text-red-500 text-sm font-medium hidden"></div>
            <button onclick="login()" class="btn btn-primary w-full justify-center py-3">
                <i class="fas fa-sign-in-alt"></i> Se connecter
            </button>
            <div class="pt-4 border-t">
                <button onclick="accederModeRondier()" class="btn btn-secondary w-full justify-center">
                    <i class="fas fa-mobile-alt"></i> Acc√®s Rondier Mobile
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Login Rondier -->
<div id="loginRondier" class="gradient-bg min-h-screen flex items-center justify-center p-4 hidden">
    <div class="card p-6 w-full max-w-md fade-in">
        <div class="text-center mb-6">
            <div class="w-16 h-16 bg-orange-500 rounded-2xl flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-walking text-white text-2xl"></i>
            </div>
            <h1 class="text-xl font-bold">Connexion Rondier</h1>
        </div>
        <div id="rondierLoading" class="text-center py-8">
            <i class="fas fa-sync-alt fa-spin text-3xl text-primary-500 mb-4"></i>
            <p class="text-gray-500">Chargement...</p>
        </div>
        <div id="rondierContent" class="space-y-4 hidden">
            <div id="rondierAgentsList" class="space-y-2"></div>
            <div id="rondierNoAgent" class="text-center py-6 hidden">
                <i class="fas fa-exclamation-triangle text-yellow-600 text-3xl mb-3"></i>
                <p class="font-medium">Aucun rondier en poste</p>
                <p class="text-sm text-gray-500 mt-2">Contactez le PC S√©curit√©</p>
                <button onclick="rechargerAgentsRondier()" class="btn btn-secondary mt-4">
                    <i class="fas fa-sync-alt"></i> Actualiser
                </button>
            </div>
        </div>
        <div class="mt-4 pt-4 border-t">
            <button onclick="retourLogin()" class="btn btn-secondary w-full justify-center">
                <i class="fas fa-arrow-left"></i> Retour
            </button>
        </div>
    </div>
</div>

<!-- Main App -->
<div id="mainApp" class="hidden">
    <!-- Sidebar -->
    <aside class="sidebar no-print" id="sidebar">
        <div class="p-6 border-b border-gray-100">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 gradient-header rounded-xl flex items-center justify-center shadow-lg">
                    <i class="fas fa-shield-alt text-white text-xl"></i>
                </div>
                <div>
                    <div class="font-bold text-lg">SSIAP Patrol</div>
                    <div class="text-xs text-gray-500" id="userBadge"></div>
                    <div class="text-xs mt-1" id="firebaseStatus"></div>
                </div>
            </div>
        </div>
        <nav class="py-4 overflow-y-auto" id="navMenu" style="max-height: calc(100vh - 200px);"></nav>
        <div class="absolute bottom-0 left-0 right-0 p-4 border-t bg-white space-y-2" id="sidebarActions"></div>
    </aside>

    <!-- Mobile Header -->
    <header id="mobileHeader" class="lg:hidden fixed top-0 left-0 right-0 bg-white shadow-md z-40 p-4 flex items-center justify-between no-print">
        <button onclick="toggleSidebar()" class="btn btn-icon btn-secondary"><i class="fas fa-bars"></i></button>
        <div class="font-bold">SSIAP Patrol</div>
        <button onclick="forcerSync()" class="btn btn-icon btn-secondary"><i class="fas fa-sync-alt"></i></button>
    </header>

    <!-- Rondier Header -->
    <header id="rondierHeader" class="lg:hidden fixed top-0 left-0 right-0 gradient-header text-white z-40 p-3 hidden no-print">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
                    <i class="fas fa-walking"></i>
                </div>
                <div>
                    <div class="font-semibold text-sm" id="rondierHeaderName">Rondier</div>
                    <div class="text-xs opacity-80">En service</div>
                </div>
            </div>
            <button onclick="logout()" class="btn btn-sm bg-white/20 text-white">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </div>
    </header>

    <!-- Sidebar Overlay -->
    <div id="sidebarOverlay" class="fixed inset-0 bg-black/50 z-40 hidden lg:hidden" onclick="toggleSidebar()"></div>

    <!-- Main Content -->
    <main class="main-content lg:ml-[280px] min-h-screen pt-20 lg:pt-6 pb-24 lg:pb-6">
        <div class="p-4 lg:p-6" id="mainContent"></div>
    </main>

    <!-- Mobile Nav Bar -->
    <nav id="mobileNavBar" class="lg:hidden fixed bottom-0 left-0 right-0 bg-white border-t z-50 hidden no-print">
        <div class="flex justify-around items-center h-16">
            <button onclick="navigate('rondes')" id="mobileNavRondes" class="mobile-nav-btn flex flex-col items-center justify-center flex-1 h-full text-gray-500">
                <i class="fas fa-route text-xl mb-1"></i>
                <span class="text-xs">Rondes</span>
            </button>
            <button onclick="navigate('materiels')" id="mobileNavMateriels" class="mobile-nav-btn flex flex-col items-center justify-center flex-1 h-full text-gray-500">
                <i class="fas fa-fire-extinguisher text-xl mb-1"></i>
                <span class="text-xs">Mat√©riels</span>
            </button>
            <button onclick="navigate('consignes')" id="mobileNavConsignes" class="mobile-nav-btn flex flex-col items-center justify-center flex-1 h-full text-gray-500">
                <i class="fas fa-file-alt text-xl mb-1"></i>
                <span class="text-xs">Consignes</span>
            </button>
        </div>
    </nav>
</div>

<!-- Modal Container -->
<div id="modalContainer"></div>

<script>
// ==================== CONFIGURATION ====================

const AGENTS_PAR_DEFAUT = [
    { id: 7, nom: 'Admin', prenom: 'Syst√®me', qualification: 'Administrateur', entreprise: 'SecuriPlus', actif: true, codePin: '321518', dateDebutContrat: '2020-01-01', email: 'admin@securiplus.fr', telephone: '0600000000' },
    { id: 1, nom: 'Martin', prenom: 'Jean-Pierre', qualification: 'SSIAP 2', entreprise: 'SecuriPlus', actif: true, dateDebutContrat: '2020-06-01', email: 'jp.martin@securiplus.fr', telephone: '0612345678' },
    { id: 2, nom: 'Dupont', prenom: 'Alain', qualification: 'SSIAP 1', entreprise: 'SecuriPlus', actif: true, dateDebutContrat: '2019-04-01', email: 'a.dupont@securiplus.fr', telephone: '0623456789' },
    { id: 3, nom: 'Boyer', prenom: 'Michel', qualification: 'SSIAP 1', entreprise: 'SecuriPlus', actif: true, dateDebutContrat: '2018-12-01', email: 'm.boyer@securiplus.fr', telephone: '0634567890' },
    { id: 4, nom: 'Dubois', prenom: 'Marie', qualification: 'SSIAP 2', entreprise: 'SecuriPlus', actif: true, dateDebutContrat: '2021-02-01', email: 'm.dubois@securiplus.fr', telephone: '0645678901' },
    { id: 5, nom: 'Garcia', prenom: 'Pierre', qualification: 'SSIAP 1', entreprise: 'SecuriPlus', actif: true, dateDebutContrat: '2020-10-01', email: 'p.garcia@securiplus.fr', telephone: '0656789012' },
    { id: 6, nom: 'Leroy', prenom: 'Fran√ßois', qualification: 'SSIAP 3', entreprise: 'SecuriPlus', actif: true, dateDebutContrat: '2017-08-01', email: 'f.leroy@securiplus.fr', telephone: '0667890123' }
];

const MATERIELS_PAR_DEFAUT = [
    { id: 1, nom: 'Extincteur CO2 5kg - Hall', type: 'Extincteur', localisation: 'B√¢timent Principal > RDC > Hall d\'entr√©e', statut: 'Op√©rationnel', derniereMaint: '2025-01-15', prochaineMaint: '2026-01-15', codeQR: 'MAT-EXT-001' },
    { id: 2, nom: 'Extincteur Eau 6L - Accueil', type: 'Extincteur', localisation: 'B√¢timent Principal > RDC > Accueil', statut: 'Op√©rationnel', derniereMaint: '2025-01-15', prochaineMaint: '2026-01-15', codeQR: 'MAT-EXT-002' },
    { id: 3, nom: 'RIA DN25 - Couloir RDC', type: 'RIA', localisation: 'B√¢timent Principal > RDC > Couloir', statut: 'Op√©rationnel', derniereMaint: '2025-02-01', prochaineMaint: '2026-02-01', codeQR: 'MAT-RIA-001' },
    { id: 4, nom: 'RIA DN25 - 1er √©tage', type: 'RIA', localisation: 'B√¢timent Principal > 1er √©tage > Couloir', statut: 'Op√©rationnel', derniereMaint: '2025-02-01', prochaineMaint: '2026-02-01', codeQR: 'MAT-RIA-002' },
    { id: 5, nom: 'D√©tecteur Optique - Hall', type: 'D√©tecteur', localisation: 'B√¢timent Principal > RDC > Hall d\'entr√©e', statut: 'Op√©rationnel', codeQR: 'MAT-DET-001' },
    { id: 6, nom: 'Porte CF - Escalier A', type: 'Porte CF', localisation: 'B√¢timent Principal > RDC > Escalier A', statut: 'Op√©rationnel', codeQR: 'MAT-PCF-001' },
    { id: 7, nom: 'BAES - Couloir RDC', type: 'BAES', localisation: 'B√¢timent Principal > RDC > Couloir', statut: 'Op√©rationnel', codeQR: 'MAT-BAES-001' },
    { id: 8, nom: 'Extincteur Poudre - Entrep√¥t', type: 'Extincteur', localisation: 'B√¢timent Annexe > RDC > Entrep√¥t', statut: 'Op√©rationnel', derniereMaint: '2025-01-20', prochaineMaint: '2026-01-20', codeQR: 'MAT-EXT-003' }
];

const DB = {
    agents: JSON.parse(JSON.stringify(AGENTS_PAR_DEFAUT)),
    materiels: JSON.parse(JSON.stringify(MATERIELS_PAR_DEFAUT)),
    prisesPoste: [],
    rondes: [],
    evenements: [],
    mainCourante: [],
    consignes: [
        { id: 1, titre: 'Visite commission de s√©curit√©', niveau: 'Particuli√®re', destinataire: 'Tout le monde', priorite: 'Haute', contenu: 'Commission de s√©curit√© pr√©vue le 15 mars 2026. V√©rifier tous les √©quipements de s√©curit√©.', dateDebut: '2026-02-01', dateFin: '2026-03-15', active: true },
        { id: 2, titre: 'Contr√¥le acc√®s livraisons', niveau: 'Permanente', destinataire: 'Tout le monde', priorite: 'Normale', contenu: 'V√©rifier syst√©matiquement les bons de livraison et l\'identit√© des livreurs.', dateDebut: '2025-01-01', dateFin: null, active: true }
    ]
};

let currentUser = null;
let currentView = 'dashboard';
let modalConfirmCallback = null;
let html5QrScanner = null;
let adminTab = 'sync';

// Filtres
let filtresRondes = { texte: '', statut: '', type: '' };
let filtresMainCourante = { texte: '', type: '', dateDebut: '', dateFin: '' };
let filtresMateriels = { texte: '', type: '', statut: '' };
let filtresEvenements = { texte: '', type: '', statut: '' };
let filtresAgents = { texte: '', qualification: '' };
let filtresConsignes = { texte: '', niveau: '', priorite: '' };

// Configuration √©tablissement
let configEtablissement = {
    nom: "√âtablissement Principal",
    batiments: [
        { id: 'bat1', nom: 'B√¢timent Principal', secteurs: [
            { id: 'bat1-ss', nom: 'Sous-sol', zones: ['Parking', 'Local technique', 'Archives'] },
            { id: 'bat1-rdc', nom: 'RDC', zones: ['Hall d\'entr√©e', 'Accueil', 'Couloir', 'Sanitaires'] },
            { id: 'bat1-r1', nom: '1er √©tage', zones: ['Bureaux 101-105', 'Salle de r√©union', 'Couloir', 'Sanitaires'] },
            { id: 'bat1-r2', nom: '2√®me √©tage', zones: ['Bureaux 201-210', 'Open space', 'Couloir', 'Sanitaires'] }
        ]},
        { id: 'bat2', nom: 'B√¢timent Annexe', secteurs: [
            { id: 'bat2-rdc', nom: 'RDC', zones: ['Entrep√¥t', 'Quai livraison', 'Bureau logistique'] },
            { id: 'bat2-r1', nom: '1er √©tage', zones: ['Atelier', 'Vestiaires', 'R√©fectoire'] }
        ]},
        { id: 'bat3', nom: 'Ext√©rieurs', secteurs: [
            { id: 'bat3-ext', nom: 'Zones ext√©rieures', zones: ['Parking visiteurs', 'Parking personnel', 'Voie pompiers'] }
        ]}
    ]
};

let typesRondes = ['Ronde de s√©curit√©', 'Ronde Extincteurs', 'Ronde RIA', 'Ronde BAES', 'Ouverture', 'Fermeture', 'Ronde technique'];

const categoriesRonde = [
    { id: 'extincteurs', nom: 'Extincteurs', icon: 'fa-fire-extinguisher', types: ['Extincteur'] },
    { id: 'ria', nom: 'RIA', icon: 'fa-tint', types: ['RIA'] },
    { id: 'baes', nom: 'BAES', icon: 'fa-lightbulb', types: ['BAES'] },
    { id: 'pcf', nom: 'Portes CF', icon: 'fa-door-closed', types: ['Porte CF'] },
    { id: 'detecteurs', nom: 'D√©tecteurs', icon: 'fa-bell', types: ['D√©tecteur'] }
];

const typesEvenement = ['Alarme Incendie', 'Secours √† personne', 'Incident', 'Intrusion', 'Probl√®me technique', 'Incivilit√©', 'Autre'];

// ==================== FIREBASE ====================

const firebaseConfig = {
    apiKey: "AIzaSyBXK-4-9HBcTKCPQBdRzDSwTc55vRXWNOk",
    authDomain: "ssiap-patrol.firebaseapp.com",
    projectId: "ssiap-patrol",
    storageBucket: "ssiap-patrol.firebasestorage.app",
    messagingSenderId: "582750096370",
    appId: "1:582750096370:web:025f700bc1bf9194afb96b"
};

let db = null;
let firestoreEnabled = false;
let unsubscribeSync = null;
let isUpdatingFromFirebase = false;
let lastSyncTime = 0;

try {
    firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
    firestoreEnabled = true;
    console.log('‚úÖ Firebase initialis√©');
} catch (e) {
    console.error('‚ùå Firebase init error:', e);
}

function updateFirebaseStatus(connected) {
    const el = document.getElementById('firebaseStatus');
    if (el) {
        el.innerHTML = connected ? 
            '<span class="text-green-600 text-xs"><i class="fas fa-cloud"></i> Connect√©</span>' : 
            '<span class="text-red-600 text-xs"><i class="fas fa-cloud-slash"></i> Hors ligne</span>';
    }
}

function sauvegarderVersFirebase() {
    if (isUpdatingFromFirebase) return Promise.resolve();
    if (!firestoreEnabled || !db) return Promise.resolve();
    
    console.log('üíæ Sauvegarde - Rondes:', DB.rondes.length, 'MC:', DB.mainCourante.length);
    
    const saveData = {
        version: '2.1',
        date: new Date().toISOString(),
        agents: DB.agents,
        materiels: DB.materiels,
        prisesPoste: DB.prisesPoste,
        rondes: DB.rondes,
        evenements: DB.evenements,
        mainCourante: DB.mainCourante,
        consignes: DB.consignes,
        configEtablissement,
        typesRondes
    };
    
    return db.collection('ssiap-patrol').doc('data').set(saveData)
        .then(() => {
            console.log('‚úÖ Sauvegard√©!');
            updateFirebaseStatus(true);
        })
        .catch(err => {
            console.error('‚ùå Erreur:', err);
            updateFirebaseStatus(false);
        });
}

function chargerDepuisFirebase(callback) {
    if (!firestoreEnabled || !db) { 
        if (callback) callback(); 
        return; 
    }
    
    db.collection('ssiap-patrol').doc('data').get()
        .then(doc => {
            if (doc.exists) {
                const data = doc.data();
                if (data.agents?.length) DB.agents = data.agents;
                if (data.materiels?.length) DB.materiels = data.materiels;
                DB.prisesPoste = data.prisesPoste || [];
                DB.rondes = data.rondes || [];
                DB.evenements = data.evenements || [];
                DB.mainCourante = data.mainCourante || [];
                if (data.consignes?.length) DB.consignes = data.consignes;
                if (data.configEtablissement) configEtablissement = data.configEtablissement;
                if (data.typesRondes?.length) typesRondes = data.typesRondes;
                console.log('‚úÖ Charg√© - Rondes:', DB.rondes.length);
                updateFirebaseStatus(true);
            }
            if (callback) callback();
        })
        .catch(err => {
            console.error('‚ùå Erreur:', err);
            updateFirebaseStatus(false);
            if (callback) callback();
        });
}

function activerSyncTempsReel() {
    if (!firestoreEnabled || !db) return;
    if (unsubscribeSync) unsubscribeSync();
    
    unsubscribeSync = db.collection('ssiap-patrol').doc('data').onSnapshot(
        (doc) => {
            const now = Date.now();
            if (now - lastSyncTime < 3000) return;
            lastSyncTime = now;
            
            if (doc.exists && !isUpdatingFromFirebase) {
                isUpdatingFromFirebase = true;
                const data = doc.data();
                
                if (data.agents?.length) DB.agents = data.agents;
                if (data.materiels?.length) DB.materiels = data.materiels;
                DB.prisesPoste = data.prisesPoste || [];
                DB.rondes = data.rondes || [];
                DB.evenements = data.evenements || [];
                DB.mainCourante = data.mainCourante || [];
                if (data.consignes?.length) DB.consignes = data.consignes;
                if (data.configEtablissement) configEtablissement = data.configEtablissement;
                if (data.typesRondes?.length) typesRondes = data.typesRondes;
                
                if (currentUser && currentView && views[currentView]) {
                    const c = document.getElementById('mainContent');
                    if (c) c.innerHTML = '<div class="fade-in">' + views[currentView]() + '</div>';
                }
                
                updateFirebaseStatus(true);
                setTimeout(() => { isUpdatingFromFirebase = false; }, 2000);
            }
        },
        (error) => {
            console.error('‚ùå Sync error:', error);
            updateFirebaseStatus(false);
        }
    );
}

function forcerSync() {
    showToast('üîÑ Synchronisation...', 'info');
    sauvegarderVersFirebase().then(() => {
        setTimeout(() => {
            chargerDepuisFirebase(() => {
                navigate(currentView);
                showToast('‚úÖ Synchronis√©!');
            });
        }, 500);
    });
}

// ==================== UTILITAIRES ====================

const formatDate = d => d ? new Date(d).toLocaleDateString('fr-FR') : '-';
const formatTime = d => d ? new Date(d).toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'}) : '-';
const formatDateTime = d => d ? `${formatDate(d)} ${formatTime(d)}` : '-';
const genId = () => Date.now() + Math.floor(Math.random() * 1000);

function getAgentsEnPoste() {
    return DB.prisesPoste.filter(p => !p.finPoste).map(p => {
        const agent = DB.agents.find(a => a.id === p.agentId);
        return agent ? { ...agent, prisePosteId: p.id, poste: p.poste, heureDebut: p.heureDebut } : null;
    }).filter(Boolean);
}

function getChefDePoste() { 
    return getAgentsEnPoste().find(a => a.poste === 'Chef de poste'); 
}

function addMainCourante(type, description, agentId, extra = {}) {
    const agent = DB.agents.find(a => a.id === agentId);
    const entree = { 
        id: genId(), 
        date: new Date().toISOString(), 
        type, 
        description, 
        agent: agent ? `${agent.prenom} ${agent.nom}` : 'Syst√®me', 
        agentId, 
        ...extra 
    };
    DB.mainCourante.unshift(entree);
    return entree;
}

function getStatutCouleurRonde(ronde) {
    if (!ronde.anomalies?.length) return 'green';
    if (ronde.anomalies.some(a => a.horsService)) return 'red';
    return 'orange';
}

function getBadgeClass(couleur) {
    return couleur === 'green' ? 'badge-success' : couleur === 'orange' ? 'badge-warning' : 'badge-danger';
}

function getMainCouranteBadgeClass(type) {
    if (['Alarme', 'Secours', 'Incident', 'Intrusion', 'Anomalie'].some(t => type.includes(t))) return 'badge-danger';
    if (['Termin√©', 'Fin', 'OK'].some(t => type.includes(t))) return 'badge-success';
    if (['Prise', 'D√©part', 'Ronde', 'En cours'].some(t => type.includes(t))) return 'badge-warning';
    return 'badge-info';
}

// ==================== LOGIN ====================

function initLogin() {
    const sel = document.getElementById('loginAgent');
    if (!sel) return;
    
    const agentsTries = [...DB.agents.filter(a => a.actif)].sort((a, b) => {
        const ordre = { 'Administrateur': 0, 'SSIAP 3': 1, 'SSIAP 2': 2, 'SSIAP 1': 3 };
        return (ordre[a.qualification] ?? 4) - (ordre[b.qualification] ?? 4);
    });
    
    sel.innerHTML = '<option value="">S√©lectionner un agent...</option>' + 
        agentsTries.map(a => `<option value="${a.id}">${a.prenom} ${a.nom} - ${a.qualification}</option>`).join('');
}

function genererCodePin(dateDebutContrat) {
    if (!dateDebutContrat) return '0000';
    const d = new Date(dateDebutContrat);
    const base = d.getFullYear() * 10000 + (d.getMonth() + 1) * 100 + d.getDate();
    return ((base * 9301 + 49297) % 10000).toString().padStart(4, '0');
}

function obtenirCodePin(agent) {
    if (agent.qualification === 'Administrateur') return agent.codePin || '321518';
    return genererCodePin(agent.dateDebutContrat);
}

function login() {
    const agentId = document.getElementById('loginAgent').value;
    const pwd = document.getElementById('loginPassword').value;
    
    if (!agentId) return showLoginError('S√©lectionnez un agent');
    
    const agent = DB.agents.find(a => String(a.id) === agentId);
    if (!agent) return showLoginError('Agent non trouv√©');
    if (pwd !== obtenirCodePin(agent)) return showLoginError('Code PIN incorrect');
    
    currentUser = { ...agent };
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('mainApp').classList.remove('hidden');
    document.getElementById('userBadge').innerHTML = `<span class="badge badge-purple">${currentUser.qualification}</span>`;
    
    initApp();
}

function showLoginError(msg) { 
    const el = document.getElementById('loginError'); 
    el.textContent = msg; 
    el.classList.remove('hidden');
    setTimeout(() => el.classList.add('hidden'), 3000);
}

function logout() {
    currentUser = null;
    if (unsubscribeSync) unsubscribeSync();
    document.getElementById('mainApp').classList.add('hidden');
    
    if (detecterModeRondier()) {
        afficherLoginRondier(true);
    } else {
        document.getElementById('loginScreen').classList.remove('hidden');
        document.getElementById('loginRondier').classList.add('hidden');
        document.getElementById('loginPassword').value = '';
    }
}

function detecterModeRondier() { 
    return new URLSearchParams(window.location.search).get('mode') === 'rondier'; 
}

function accederModeRondier() { afficherLoginRondier(true); }

function retourLogin() {
    document.getElementById('loginRondier').classList.add('hidden');
    document.getElementById('loginScreen').classList.remove('hidden');
}

function afficherLoginRondier(forceReload) {
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('loginRondier').classList.remove('hidden');
    document.getElementById('mainApp').classList.add('hidden');
    
    if (forceReload) {
        document.getElementById('rondierLoading').classList.remove('hidden');
        document.getElementById('rondierContent').classList.add('hidden');
        chargerDepuisFirebase(() => afficherAgentsRondier());
    } else {
        afficherAgentsRondier();
    }
}

function afficherAgentsRondier() {
    document.getElementById('rondierLoading').classList.add('hidden');
    document.getElementById('rondierContent').classList.remove('hidden');
    
    const agentsEnPoste = getAgentsEnPoste().filter(a => a.qualification === 'SSIAP 1');
    const listContainer = document.getElementById('rondierAgentsList');
    const noAgent = document.getElementById('rondierNoAgent');
    
    if (agentsEnPoste.length === 0) {
        listContainer.innerHTML = '';
        noAgent.classList.remove('hidden');
    } else {
        noAgent.classList.add('hidden');
        listContainer.innerHTML = agentsEnPoste.map(a => `
            <button onclick="loginRondier(${a.id})" class="w-full p-4 bg-gray-50 hover:bg-primary-50 rounded-xl flex items-center gap-4 border-2 border-transparent hover:border-primary-500 transition-all">
                <div class="w-12 h-12 gradient-header rounded-full flex items-center justify-center text-white font-bold">${a.prenom[0]}${a.nom[0]}</div>
                <div class="flex-1 text-left">
                    <div class="font-semibold">${a.prenom} ${a.nom}</div>
                    <div class="text-sm text-gray-500">En poste depuis ${formatTime(a.heureDebut)}</div>
                </div>
                <i class="fas fa-chevron-right text-gray-400"></i>
            </button>
        `).join('');
    }
}

function rechargerAgentsRondier() { 
    showToast('üîÑ Actualisation...', 'info'); 
    afficherLoginRondier(true); 
}

function loginRondier(agentId) {
    const agent = DB.agents.find(a => a.id === agentId);
    if (!agent) return showToast('Agent non trouv√©', 'error');
    
    currentUser = { ...agent };
    document.getElementById('loginRondier').classList.add('hidden');
    document.getElementById('mainApp').classList.remove('hidden');
    document.getElementById('userBadge').innerHTML = `<span class="badge badge-purple">${currentUser.qualification}</span>`;
    
    initApp();
    showToast(`Bienvenue ${currentUser.prenom} !`);
}

// ==================== NAVIGATION ====================

const menuItems = [
    { id: 'dashboard', icon: 'fa-tachometer-alt', label: 'Tableau de bord', roles: ['SSIAP 2', 'SSIAP 3', 'Administrateur'] },
    { id: 'prisePoste', icon: 'fa-user-clock', label: 'Prise de Poste', roles: ['SSIAP 2', 'SSIAP 3', 'Administrateur'] },
    { id: 'rondes', icon: 'fa-route', label: 'Rondes', roles: ['SSIAP 1', 'SSIAP 2', 'SSIAP 3', 'Administrateur'] },
    { id: 'mainCourante', icon: 'fa-clipboard-list', label: 'Main Courante', roles: ['SSIAP 2', 'SSIAP 3', 'Administrateur'] },
    { id: 'evenements', icon: 'fa-exclamation-triangle', label: '√âv√©nements', roles: ['SSIAP 2', 'SSIAP 3', 'Administrateur'] },
    { id: 'materiels', icon: 'fa-fire-extinguisher', label: 'Mat√©riels', roles: ['SSIAP 1', 'SSIAP 2', 'SSIAP 3', 'Administrateur'] },
    { id: 'consignes', icon: 'fa-file-alt', label: 'Consignes', roles: ['SSIAP 1', 'SSIAP 2', 'SSIAP 3', 'Administrateur'] },
    { id: 'agents', icon: 'fa-users', label: 'Agents', roles: ['SSIAP 3', 'Administrateur'] },
    { id: 'administration', icon: 'fa-cogs', label: 'Administration', roles: ['SSIAP 3', 'Administrateur'] }
];

function initApp() { 
    renderNav(); 
    renderSidebarActions(); 
    updateMobileNav();
    activerSyncTempsReel();
    navigate(currentUser?.qualification === 'SSIAP 1' ? 'rondes' : 'dashboard'); 
}

function renderSidebarActions() {
    document.getElementById('sidebarActions').innerHTML = `
        <button onclick="forcerSync()" class="btn btn-success w-full justify-center btn-sm mb-2">
            <i class="fas fa-sync-alt"></i> Synchroniser
        </button>
        <button onclick="logout()" class="btn btn-secondary w-full justify-center">
            <i class="fas fa-sign-out-alt"></i> D√©connexion
        </button>
    `;
}

function renderNav() {
    const qual = currentUser?.qualification;
    document.getElementById('navMenu').innerHTML = menuItems
        .filter(m => m.roles.includes(qual))
        .map(m => `
            <div class="nav-link ${currentView === m.id ? 'active' : ''}" onclick="navigate('${m.id}')">
                <i class="fas ${m.icon} w-5"></i>
                <span>${m.label}</span>
            </div>
        `).join('');
}

function navigate(view) {
    currentView = view;
    renderNav();
    updateMobileNav();
    
    const c = document.getElementById('mainContent');
    c.innerHTML = '<div class="fade-in">' + (views[view]?.() || '<p>Vue non disponible</p>') + '</div>';
    
    const sidebar = document.getElementById('sidebar');
    if (sidebar?.classList.contains('open')) {
        sidebar.classList.remove('open');
        document.getElementById('sidebarOverlay')?.classList.add('hidden');
    }
    
    // G√©n√©rer QR codes apr√®s rendu
    if (view === 'dashboard') {
        setTimeout(() => genererQRCodeDashboard(), 300);
    }
    
    if (view === 'administration' && adminTab === 'qrcodes') {
        setTimeout(() => genererQRCodesAdmin(), 300);
    }
}

function toggleSidebar() { 
    document.getElementById('sidebar').classList.toggle('open'); 
    document.getElementById('sidebarOverlay').classList.toggle('hidden'); 
}

function updateMobileNav() {
    const mobileNav = document.getElementById('mobileNavBar');
    const mobileHeader = document.getElementById('mobileHeader');
    const rondierHeader = document.getElementById('rondierHeader');
    
    if (currentUser?.qualification === 'SSIAP 1') {
        mobileNav?.classList.remove('hidden');
        mobileHeader?.classList.add('hidden');
        rondierHeader?.classList.remove('hidden');
        document.getElementById('rondierHeaderName').textContent = `${currentUser.prenom} ${currentUser.nom}`;
        
        ['rondes', 'materiels', 'consignes'].forEach(id => {
            const btn = document.getElementById('mobileNav' + id.charAt(0).toUpperCase() + id.slice(1));
            if (btn) btn.classList.toggle('active', currentView === id);
        });
    } else {
        mobileNav?.classList.add('hidden');
        mobileHeader?.classList.remove('hidden');
        rondierHeader?.classList.add('hidden');
    }
}

// ==================== VIEWS ====================

const views = {
    dashboard: renderDashboard,
    prisePoste: renderPrisePoste,
    rondes: renderRondes,
    mainCourante: renderMainCourante,
    evenements: renderEvenements,
    materiels: renderMateriels,
    consignes: renderConsignes,
    agents: renderAgents,
    administration: renderAdministration
};

// ==================== DASHBOARD ====================

function renderDashboard() {
    const agentsPoste = getAgentsEnPoste();
    const chef = getChefDePoste();
    const rondesEnCours = DB.rondes.filter(r => !r.heureFin);
    const evtsEnCours = DB.evenements.filter(e => e.statut !== 'Termin√©');
    const todayEvents = DB.mainCourante.filter(m => new Date(m.date).toDateString() === new Date().toDateString());
    const consignesActives = DB.consignes.filter(c => c.active && (!c.dateFin || new Date(c.dateFin) >= new Date()));

    return `
        <div class="gradient-header text-white p-6 rounded-2xl mb-6 shadow-lg">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <div>
                    <h1 class="text-2xl font-bold">Tableau de bord SSIAP</h1>
                    <p class="opacity-90">${new Date().toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}</p>
                </div>
                <div class="bg-white p-3 rounded-xl no-print">
                    <div id="qrCodeAccess" class="min-w-[100px] min-h-[100px] flex items-center justify-center">
                        <i class="fas fa-spinner fa-spin text-gray-300 text-2xl"></i>
                    </div>
                    <p class="text-center text-xs text-gray-600 mt-1">Acc√®s Rondier</p>
                </div>
            </div>
        </div>
        
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="stat-card">
                <div class="icon bg-green-100 text-green-600"><i class="fas fa-users"></i></div>
                <div class="value">${agentsPoste.length}</div>
                <div class="label">Agents en poste</div>
            </div>
            <div class="stat-card">
                <div class="icon bg-blue-100 text-blue-600"><i class="fas fa-route"></i></div>
                <div class="value">${rondesEnCours.length}</div>
                <div class="label">Rondes en cours</div>
            </div>
            <div class="stat-card">
                <div class="icon bg-red-100 text-red-600"><i class="fas fa-exclamation-triangle"></i></div>
                <div class="value">${evtsEnCours.length}</div>
                <div class="label">√âv√©nements actifs</div>
            </div>
            <div class="stat-card">
                <div class="icon bg-purple-100 text-purple-600"><i class="fas fa-clipboard-list"></i></div>
                <div class="value">${todayEvents.length}</div>
                <div class="label">Actions aujourd'hui</div>
            </div>
        </div>
        
        <div class="grid lg:grid-cols-2 gap-6">
            <div class="card">
                <div class="gradient-success text-white p-4 font-semibold rounded-t-2xl">
                    <i class="fas fa-users mr-2"></i>√âquipe en poste
                </div>
                <div class="p-4">
                    ${chef ? `
                        <div class="flex items-center gap-3 p-3 bg-yellow-50 rounded-xl mb-3">
                            <div class="w-10 h-10 bg-yellow-500 rounded-xl flex items-center justify-center text-white">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div>
                                <div class="font-semibold">Chef de Poste</div>
                                <div class="text-sm text-gray-600">${chef.prenom} ${chef.nom} ‚Ä¢ depuis ${formatTime(chef.heureDebut)}</div>
                            </div>
                        </div>
                    ` : '<p class="text-gray-500 text-center py-2">Aucun chef de poste</p>'}
                    ${agentsPoste.filter(a => a.poste !== 'Chef de poste').map(a => `
                        <div class="flex items-center gap-3 p-3 hover:bg-gray-50 rounded-xl">
                            <div class="w-10 h-10 bg-primary-500 rounded-xl flex items-center justify-center text-white font-semibold">${a.prenom[0]}${a.nom[0]}</div>
                            <div>
                                <div class="font-medium">${a.prenom} ${a.nom}</div>
                                <div class="text-sm text-gray-500">${a.qualification} ‚Ä¢ ${a.poste}</div>
                            </div>
                        </div>
                    `).join('') || ''}
                </div>
            </div>
            
            <div class="card">
                <div class="gradient-warning text-white p-4 font-semibold rounded-t-2xl">
                    <i class="fas fa-file-alt mr-2"></i>Consignes actives (${consignesActives.length})
                </div>
                <div class="p-4 space-y-3 max-h-64 overflow-y-auto">
                    ${consignesActives.length ? consignesActives.slice(0, 5).map(c => `
                        <div class="p-3 bg-orange-50 rounded-xl cursor-pointer hover:bg-orange-100" onclick="voirConsigne(${c.id})">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="badge ${c.niveau === 'Particuli√®re' ? 'badge-warning' : 'badge-info'}">${c.niveau}</span>
                                <span class="badge ${c.priorite === 'Haute' || c.priorite === 'Urgente' ? 'badge-danger' : 'badge-gray'}">${c.priorite}</span>
                            </div>
                            <div class="font-medium text-sm">${c.titre}</div>
                        </div>
                    `).join('') : '<p class="text-gray-500 text-center py-4">Aucune consigne active</p>'}
                </div>
            </div>
        </div>
    `;
}

function genererQRCodeDashboard() {
    const qrDiv = document.getElementById('qrCodeAccess');
    if (qrDiv && typeof QRCode !== 'undefined') {
        qrDiv.innerHTML = '';
        try {
            new QRCode(qrDiv, { 
                text: window.location.href.split('?')[0] + '?mode=rondier', 
                width: 100, 
                height: 100,
                correctLevel: QRCode.CorrectLevel.M
            });
        } catch(e) {
            qrDiv.innerHTML = '<span class="text-gray-400 text-xs">QR indisponible</span>';
        }
    }
}

// ==================== PRISE DE POSTE ====================

function renderPrisePoste() {
    const agentsPoste = getAgentsEnPoste();
    
    return `
        <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
            <h1 class="text-2xl font-bold text-gray-800">
                <i class="fas fa-user-clock mr-2 text-primary-500"></i>Prise de Poste
            </h1>
            <div class="flex gap-2 no-print">
                <button onclick="showModalPrisePoste()" class="btn btn-primary">
                    <i class="fas fa-plus mr-2"></i>Nouvelle
                </button>
                <button onclick="window.print()" class="btn btn-primary">
                    <i class="fas fa-print mr-2"></i>Imprimer
                </button>
            </div>
        </div>
        
        <div class="card">
            <div class="gradient-success text-white p-4 font-semibold">
                Agents en poste (${agentsPoste.length})
            </div>
            <div class="p-4">
                ${agentsPoste.length ? `
                    <div class="overflow-x-auto">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Agent</th>
                                    <th>Qualification</th>
                                    <th>Poste</th>
                                    <th>D√©but</th>
                                    <th class="no-print">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${agentsPoste.map(a => `
                                    <tr>
                                        <td class="font-medium">${a.prenom} ${a.nom}</td>
                                        <td><span class="badge badge-info">${a.qualification}</span></td>
                                        <td><span class="badge ${a.poste === 'Chef de poste' ? 'badge-warning' : 'badge-success'}">${a.poste}</span></td>
                                        <td>${formatDateTime(a.heureDebut)}</td>
                                        <td class="no-print">
                                            <button onclick="finPoste(${a.prisePosteId})" class="btn btn-danger btn-sm">
                                                <i class="fas fa-stop mr-1"></i>Fin
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                ` : '<p class="text-gray-500 text-center py-8">Aucun agent en poste</p>'}
            </div>
        </div>
    `;
}

function showModalPrisePoste() {
    const agentsActifs = DB.agents.filter(a => a.actif && !getAgentsEnPoste().find(p => p.id === a.id));
    const hasChef = getChefDePoste();
    
    if (agentsActifs.length === 0) {
        showToast('Tous les agents sont d√©j√† en poste', 'warning');
        return;
    }
    
    showModal('Nouvelle Prise de Poste', `
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-semibold mb-2">Agent</label>
                <select id="ppAgent" class="input">
                    ${agentsActifs.map(a => `<option value="${a.id}">${a.prenom} ${a.nom} - ${a.qualification}</option>`).join('')}
                </select>
            </div>
            <div>
                <label class="block text-sm font-semibold mb-2">Poste</label>
                <select id="ppPoste" class="input">
                    ${!hasChef ? '<option value="Chef de poste">Chef de poste</option>' : ''}
                    <option value="Chef d'√©quipe">Chef d'√©quipe</option>
                    <option value="√âquipier">√âquipier</option>
                </select>
            </div>
        </div>
    `, () => {
        const agentId = parseInt(document.getElementById('ppAgent').value);
        const poste = document.getElementById('ppPoste').value;
        
        if (!agentId) return showToast('S√©lectionnez un agent', 'error');
        
        const pp = { 
            id: genId(), 
            agentId, 
            poste, 
            heureDebut: new Date().toISOString(), 
            finPoste: null
        };
        DB.prisesPoste.push(pp);
        
        const agent = DB.agents.find(a => a.id === agentId);
        addMainCourante('Prise de Poste', `${poste} - ${agent.prenom} ${agent.nom}`, agentId);
        
        sauvegarderVersFirebase();
        closeModal();
        showToast('‚úÖ Prise de poste enregistr√©e');
        navigate('prisePoste');
    });
}

function finPoste(id) {
    showConfirm('Confirmer la fin de poste ?', () => {
        const pp = DB.prisesPoste.find(p => p.id === id);
        if (pp) {
            pp.finPoste = new Date().toISOString();
            const agent = DB.agents.find(a => a.id === pp.agentId);
            addMainCourante('Fin de Poste', `${agent.prenom} ${agent.nom}`, pp.agentId);
            sauvegarderVersFirebase();
            closeModal();
            showToast('‚úÖ Fin de poste enregistr√©e');
            navigate('prisePoste');
        }
    });
}

// ==================== RONDES ====================

function renderRondes() {
    const isSsiap1 = currentUser?.qualification === 'SSIAP 1';
    const mesRondesEnCours = DB.rondes.filter(r => !r.heureFin && r.agentId === currentUser?.id);
    const stats = { 
        total: DB.rondes.length, 
        enCours: DB.rondes.filter(r => !r.heureFin).length, 
        terminees: DB.rondes.filter(r => r.heureFin).length,
        anomalies: DB.rondes.filter(r => r.anomalies?.length > 0).length
    };
    
    if (isSsiap1) return renderRondesMobile(mesRondesEnCours, stats);
    
    let rondesFiltrees = DB.rondes.filter(r => {
        const matchTexte = !filtresRondes.texte || (r.nom || '').toLowerCase().includes(filtresRondes.texte.toLowerCase());
        const matchStatut = !filtresRondes.statut || 
            (filtresRondes.statut === 'En cours' && !r.heureFin) || 
            (filtresRondes.statut === 'Termin√©e' && r.heureFin);
        const matchType = !filtresRondes.type || r.type === filtresRondes.type;
        return matchTexte && matchStatut && matchType;
    }).sort((a, b) => new Date(b.heureDebut) - new Date(a.heureDebut));
    
    return `
        <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-route mr-2 text-primary-500"></i>Gestion des Rondes
                </h1>
                <p class="text-sm text-gray-500">${stats.total} rondes ‚Ä¢ ${stats.enCours} en cours</p>
            </div>
            <button onclick="window.print()" class="btn btn-primary no-print">
                <i class="fas fa-print mr-2"></i>Imprimer
            </button>
        </div>
        
        <div class="search-filters no-print">
            <input type="text" class="input" placeholder="üîç Rechercher..." value="${filtresRondes.texte}" 
                onchange="filtresRondes.texte = this.value; navigate('rondes')">
            <select class="input" onchange="filtresRondes.statut = this.value; navigate('rondes')">
                <option value="">Tous statuts</option>
                <option value="En cours" ${filtresRondes.statut === 'En cours' ? 'selected' : ''}>En cours</option>
                <option value="Termin√©e" ${filtresRondes.statut === 'Termin√©e' ? 'selected' : ''}>Termin√©e</option>
            </select>
            <select class="input" onchange="filtresRondes.type = this.value; navigate('rondes')">
                <option value="">Tous types</option>
                ${typesRondes.map(t => `<option value="${t}" ${filtresRondes.type === t ? 'selected' : ''}>${t}</option>`).join('')}
            </select>
            <button onclick="filtresRondes = {texte:'', statut:'', type:''}; navigate('rondes')" class="btn btn-secondary btn-sm">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6 no-print">
            <div class="stat-card"><div class="text-2xl font-bold text-blue-600">${stats.total}</div><div class="text-xs text-gray-500">Total</div></div>
            <div class="stat-card"><div class="text-2xl font-bold text-orange-600">${stats.enCours}</div><div class="text-xs text-gray-500">En cours</div></div>
            <div class="stat-card"><div class="text-2xl font-bold text-green-600">${stats.terminees}</div><div class="text-xs text-gray-500">Termin√©es</div></div>
            <div class="stat-card"><div class="text-2xl font-bold text-red-600">${stats.anomalies}</div><div class="text-xs text-gray-500">Avec anomalies</div></div>
        </div>
        
        <div class="card">
            <div class="p-4 space-y-3">
                ${rondesFiltrees.length ? rondesFiltrees.slice(0, 50).map(r => {
                    const agent = DB.agents.find(a => a.id === r.agentId);
                    const pts = r.pointsControle?.filter(p => p.valide).length || 0;
                    const total = r.pointsControle?.length || 0;
                    const pct = total > 0 ? Math.round((pts / total) * 100) : 0;
                    const couleur = getStatutCouleurRonde(r);
                    const hasHS = r.anomalies?.some(a => a.horsService);
                    const hasAnomalies = r.anomalies?.length > 0;
                    
                    return `
                        <div class="flex flex-wrap items-center justify-between gap-4 p-4 bg-gray-50 rounded-xl ${hasHS ? 'border-l-4 border-red-500' : hasAnomalies ? 'border-l-4 border-orange-500' : ''}">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2 mb-1 flex-wrap">
                                    <span class="badge ${r.heureFin ? getBadgeClass(couleur) : 'badge-warning'}">${r.heureFin ? 'Termin√©e' : 'En cours'}</span>
                                    <span class="badge badge-info">${r.type}</span>
                                    ${hasHS ? '<span class="badge badge-danger"><i class="fas fa-ban mr-1"></i>HS</span>' : ''}
                                    ${hasAnomalies && !hasHS ? `<span class="badge badge-warning">${r.anomalies.length} anomalie(s)</span>` : ''}
                                </div>
                                <div class="font-medium text-gray-800">${r.nom || r.type}</div>
                                <div class="text-sm text-gray-500">${agent?.prenom || ''} ${agent?.nom || ''} ‚Ä¢ ${formatDateTime(r.heureDebut)}</div>
                                ${total > 0 ? `
                                    <div class="mt-2 flex items-center gap-2 no-print">
                                        <div class="flex-1 bg-gray-200 rounded-full h-2 max-w-xs">
                                            <div class="h-2 rounded-full" style="width:${pct}%; background-color: ${couleur === 'green' ? '#10b981' : couleur === 'orange' ? '#f59e0b' : '#ef4444'}"></div>
                                        </div>
                                        <span class="text-xs text-gray-500">${pts}/${total}</span>
                                    </div>
                                ` : ''}
                            </div>
                            <div class="flex gap-2 no-print">
                                <button onclick="voirRonde(${r.id})" class="btn btn-secondary btn-sm">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('') : '<p class="text-gray-500 text-center py-8">Aucune ronde trouv√©e</p>'}
            </div>
        </div>
    `;
}

function renderRondesMobile(mesRondesEnCours, stats) {
    if (mesRondesEnCours.length > 0) {
        const r = mesRondesEnCours[0];
        const pts = r.pointsControle?.filter(p => p.valide).length || 0;
        const total = r.pointsControle?.length || 0;
        const pct = total > 0 ? Math.round((pts / total) * 100) : 0;
        
        return `
            <div class="space-y-4">
                <div class="bg-gradient-to-r from-yellow-400 to-orange-500 text-white p-5 rounded-2xl shadow-lg">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center animate-pulse">
                            <i class="fas fa-walking text-2xl"></i>
                        </div>
                        <div class="flex-1">
                            <div class="font-bold text-lg">${r.nom || r.type}</div>
                            <div class="text-sm opacity-90">${r.zone || '√âtablissement'}</div>
                        </div>
                    </div>
                    
                    <div class="bg-white/20 rounded-full h-4 mb-2">
                        <div class="bg-white h-4 rounded-full transition-all" style="width:${pct}%"></div>
                    </div>
                    <div class="text-sm text-center mb-4">${pts}/${total} points valid√©s</div>
                    
                    <button onclick="scannerPointControle(${r.id})" class="w-full bg-white text-orange-600 font-bold py-5 rounded-xl flex items-center justify-center gap-3 mb-3 shadow-lg">
                        <i class="fas fa-qrcode text-2xl"></i>
                        <span class="text-lg">Scanner un point</span>
                    </button>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="voirPointsRonde(${r.id})" class="bg-white/20 text-white font-bold py-3 rounded-xl">
                            <i class="fas fa-list mr-2"></i>Points
                        </button>
                        <button onclick="terminerRonde(${r.id})" class="bg-white/20 text-white font-bold py-3 rounded-xl border-2 border-white/50">
                            <i class="fas fa-flag-checkered mr-2"></i>Terminer
                        </button>
                    </div>
                </div>
                
                <button onclick="signalerAnomalieMobile(${r.id})" class="w-full card p-4 flex items-center gap-4 text-left">
                    <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-exclamation-triangle text-red-500 text-xl"></i>
                    </div>
                    <div class="flex-1">
                        <div class="font-semibold">Signaler une anomalie</div>
                        <div class="text-xs text-gray-500">Hors point de contr√¥le</div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-300"></i>
                </button>
                
                <button onclick="forcerSync()" class="w-full card p-3 flex items-center justify-center gap-2 text-primary-500">
                    <i class="fas fa-sync-alt"></i> Synchroniser
                </button>
            </div>
        `;
    }
    
    return `
        <div class="flex flex-col items-center justify-center min-h-[60vh] space-y-6">
            <button onclick="nouvelleRondeMobile()" class="w-full max-w-sm gradient-header text-white p-8 rounded-3xl shadow-2xl flex flex-col items-center gap-4">
                <div class="w-20 h-20 bg-white/20 rounded-full flex items-center justify-center">
                    <i class="fas fa-play text-4xl"></i>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold">Nouvelle Ronde</div>
                    <div class="text-sm opacity-80 mt-1">Appuyez pour commencer</div>
                </div>
            </button>
            
            <div class="grid grid-cols-2 gap-4 w-full max-w-sm">
                <div class="card p-4 text-center">
                    <div class="text-3xl font-bold text-green-600">${stats.terminees}</div>
                    <div class="text-xs text-gray-500">Termin√©es</div>
                </div>
                <div class="card p-4 text-center">
                    <div class="text-3xl font-bold text-blue-600">${stats.total}</div>
                    <div class="text-xs text-gray-500">Total</div>
                </div>
            </div>
            
            <button onclick="forcerSync()" class="btn btn-secondary">
                <i class="fas fa-sync-alt mr-2"></i>Synchroniser
            </button>
        </div>
    `;
}

function nouvelleRondeMobile() {
    if (!DB.prisesPoste.find(p => p.agentId === currentUser?.id && !p.finPoste)) {
        showModal('‚ö†Ô∏è Prise de poste requise', `
            <div class="text-center space-y-4">
                <i class="fas fa-user-clock text-yellow-500 text-4xl"></i>
                <p>Vous devez effectuer votre prise de poste au PC S√©curit√© avant de commencer une ronde.</p>
            </div>
        `, null, 'Compris');
        return;
    }
    
    showModal('Nouvelle Ronde', `
        <div class="space-y-4">
            <button onclick="closeModal(); choisirZoneRonde()" class="w-full p-5 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-2xl flex items-center gap-4">
                <div class="w-14 h-14 bg-white/20 rounded-xl flex items-center justify-center">
                    <i class="fas fa-building text-2xl"></i>
                </div>
                <div class="text-left flex-1">
                    <div class="font-bold text-lg">Ronde Globale</div>
                    <div class="text-sm opacity-80">Par zone / secteur</div>
                </div>
                <i class="fas fa-chevron-right"></i>
            </button>
            
            <button onclick="closeModal(); choisirCategorieRonde()" class="w-full p-5 bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-2xl flex items-center gap-4">
                <div class="w-14 h-14 bg-white/20 rounded-xl flex items-center justify-center">
                    <i class="fas fa-fire-extinguisher text-2xl"></i>
                </div>
                <div class="text-left flex-1">
                    <div class="font-bold text-lg">Ronde Sp√©cifique</div>
                    <div class="text-sm opacity-80">Par type de mat√©riel</div>
                </div>
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    `, null, 'Annuler');
}

function choisirZoneRonde() {
    showModal('Choisir le niveau', `
        <div class="space-y-3">
            <button onclick="closeModal(); demarrerRondeZone('√âtablissement complet', null, null)" class="w-full p-4 bg-gradient-to-r from-purple-500 to-indigo-600 text-white rounded-xl flex items-center gap-3">
                <i class="fas fa-building text-2xl"></i>
                <div class="flex-1 text-left"><div class="font-bold">√âtablissement complet</div></div>
            </button>
            <div class="border-t my-2"></div>
            ${configEtablissement.batiments.map(bat => `
                <button onclick="closeModal(); choisirSecteur('${bat.id}')" class="w-full p-4 bg-gray-50 rounded-xl flex items-center gap-3 hover:bg-blue-50">
                    <i class="fas fa-building text-blue-600"></i>
                    <div class="flex-1 text-left">
                        <div class="font-medium">${bat.nom}</div>
                        <div class="text-xs text-gray-500">${bat.secteurs.length} secteur(s)</div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-300"></i>
                </button>
            `).join('')}
        </div>
    `, null, 'Retour');
}

function choisirSecteur(batimentId) {
    const bat = configEtablissement.batiments.find(b => b.id === batimentId);
    if (!bat) return;
    
    showModal(bat.nom, `
        <div class="space-y-3">
            <button onclick="closeModal(); demarrerRondeZone('${bat.nom}', '${batimentId}', null)" class="w-full p-4 bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-xl">
                <i class="fas fa-layer-group mr-2"></i>Tout le b√¢timent
            </button>
            <div class="border-t my-2"></div>
            ${bat.secteurs.map(s => `
                <button onclick="closeModal(); demarrerRondeZone('${bat.nom} > ${s.nom}', '${batimentId}', '${s.id}')" class="w-full p-4 bg-gray-50 rounded-xl flex items-center gap-3 hover:bg-green-50">
                    <i class="fas fa-layer-group text-green-600"></i>
                    <div class="flex-1 text-left">
                        <div class="font-medium">${s.nom}</div>
                        <div class="text-xs text-gray-500">${s.zones.length} zone(s)</div>
                    </div>
                </button>
            `).join('')}
        </div>
    `, null, 'Retour');
}

function demarrerRondeZone(nom, batimentId, secteurId) {
    let points = [];
    
    const ajouterZones = (bat, sect) => {
        sect.zones.forEach(zone => {
            const qr = `ZONE-${bat.id}-${sect.id}-${zone.toUpperCase().replace(/[^A-Z0-9]/g, '')}`;
            points.push({ 
                id: genId(), 
                nom: zone, 
                chemin: `${bat.nom} > ${sect.nom}`, 
                qrCode: qr, 
                valide: false,
                heureValidation: null,
                statut: null
            });
        });
    };
    
    if (!batimentId) {
        configEtablissement.batiments.forEach(bat => {
            bat.secteurs.forEach(sect => ajouterZones(bat, sect));
        });
    } else if (!secteurId) {
        const bat = configEtablissement.batiments.find(b => b.id === batimentId);
        bat?.secteurs.forEach(sect => ajouterZones(bat, sect));
    } else {
        const bat = configEtablissement.batiments.find(b => b.id === batimentId);
        const sect = bat?.secteurs.find(s => s.id === secteurId);
        if (bat && sect) ajouterZones(bat, sect);
    }
    
    if (points.length === 0) {
        showToast('Aucun point de contr√¥le', 'error');
        return;
    }
    
    const ronde = {
        id: genId(),
        type: 'Ronde de s√©curit√©',
        nom: `Ronde ${nom}`,
        zone: nom,
        agentId: currentUser.id,
        heureDebut: new Date().toISOString(),
        heureFin: null,
        pointsControle: points,
        anomalies: []
    };
    
    DB.rondes.push(ronde);
    addMainCourante('D√©part Ronde', `${ronde.nom} - ${points.length} points`, currentUser.id);
    sauvegarderVersFirebase();
    
    showToast(`üöÄ Ronde d√©marr√©e ! ${points.length} points`);
    navigate('rondes');
}

function choisirCategorieRonde() {
    showModal('Type de mat√©riel', `
        <div class="space-y-2 max-h-96 overflow-y-auto">
            ${categoriesRonde.map(cat => {
                const count = DB.materiels.filter(m => cat.types.some(t => m.type.includes(t))).length;
                return `
                    <button onclick="closeModal(); demarrerRondeMateriels('${cat.id}')" class="w-full p-4 bg-gray-50 rounded-xl flex items-center gap-3 hover:bg-orange-50 ${count === 0 ? 'opacity-50' : ''}">
                        <i class="fas ${cat.icon} text-orange-600 text-xl"></i>
                        <div class="flex-1 text-left">
                            <div class="font-medium">${cat.nom}</div>
                            <div class="text-xs text-gray-500">${count} mat√©riel(s)</div>
                        </div>
                    </button>
                `;
            }).join('')}
        </div>
    `, null, 'Retour');
}

function demarrerRondeMateriels(catId) {
    const cat = categoriesRonde.find(c => c.id === catId);
    if (!cat) return;
    
    const materiels = DB.materiels.filter(m => cat.types.some(t => m.type.includes(t)));
    if (materiels.length === 0) {
        showToast('Aucun mat√©riel de ce type', 'error');
        return;
    }
    
    const points = materiels.map(m => ({
        id: genId(),
        nom: m.nom,
        materielId: m.id,
        localisation: m.localisation,
        qrCode: m.codeQR || `MAT-${m.id}`,
        valide: false,
        heureValidation: null,
        statut: null
    }));
    
    const ronde = {
        id: genId(),
        type: `Ronde ${cat.nom}`,
        nom: `${cat.nom} - √âtablissement`,
        zone: '√âtablissement',
        agentId: currentUser.id,
        heureDebut: new Date().toISOString(),
        heureFin: null,
        pointsControle: points,
        anomalies: []
    };
    
    DB.rondes.push(ronde);
    addMainCourante('D√©part Ronde', `${ronde.nom} - ${points.length} points`, currentUser.id);
    sauvegarderVersFirebase();
    
    showToast(`üöÄ Ronde d√©marr√©e ! ${points.length} points`);
    navigate('rondes');
}

// ==================== SCANNER QR ====================

function scannerPointControle(rondeId) {
    const r = DB.rondes.find(x => x.id === rondeId);
    if (!r) return;
    
    const pointsRestants = r.pointsControle.filter(p => !p.valide);
    
    showModal('Scanner un point', `
        <div class="space-y-4">
            <div id="qr-reader" style="width:100%;"></div>
            <div id="qr-reader-results" class="text-center text-sm min-h-[24px]"></div>
            
            <div class="flex gap-2">
                <button onclick="demarrerScanQR(${rondeId})" id="btnStartScan" class="btn btn-primary flex-1">
                    <i class="fas fa-camera mr-2"></i>D√©marrer cam√©ra
                </button>
                <button onclick="arreterScanQR()" id="btnStopScan" class="btn btn-danger flex-1 hidden">
                    <i class="fas fa-stop mr-2"></i>Arr√™ter
                </button>
            </div>
            
            <div class="border-t pt-4">
                <label class="block text-sm font-semibold mb-2">Saisie manuelle du code</label>
                <div class="flex gap-2">
                    <input type="text" id="qrCodeManuel" class="input flex-1" placeholder="Ex: MAT-EXT-001">
                    <button onclick="validerQRManuel(${rondeId})" class="btn btn-success">
                        <i class="fas fa-check"></i>
                    </button>
                </div>
            </div>
            
            <div class="border-t pt-4">
                <p class="text-sm font-semibold mb-2">Ou cliquer sur un point (${pointsRestants.length} restants)</p>
                <div class="space-y-2 max-h-40 overflow-y-auto">
                    ${pointsRestants.map(p => `
                        <button onclick="ouvrirValidationPoint(${rondeId}, ${p.id})" class="w-full p-3 bg-gray-50 rounded-lg flex items-center gap-3 text-left hover:bg-blue-50">
                            <i class="fas fa-circle text-gray-300 text-xs"></i>
                            <div class="flex-1">
                                <div class="font-medium text-sm">${p.nom}</div>
                                <div class="text-xs text-gray-400">${p.chemin || p.localisation || ''}</div>
                            </div>
                            <i class="fas fa-chevron-right text-gray-300"></i>
                        </button>
                    `).join('')}
                </div>
            </div>
        </div>
    `, null, 'Fermer');
}

function demarrerScanQR(rondeId) {
    const qrReader = document.getElementById('qr-reader');
    const resultsDiv = document.getElementById('qr-reader-results');
    const btnStart = document.getElementById('btnStartScan');
    const btnStop = document.getElementById('btnStopScan');
    
    if (!qrReader || typeof Html5Qrcode === 'undefined') {
        resultsDiv.innerHTML = '<span class="text-red-500">Scanner non disponible</span>';
        return;
    }
    
    btnStart.classList.add('hidden');
    btnStop.classList.remove('hidden');
    resultsDiv.innerHTML = '<span class="text-blue-500"><i class="fas fa-spinner fa-spin mr-1"></i>D√©marrage cam√©ra...</span>';
    
    if (html5QrScanner) {
        try { html5QrScanner.stop(); } catch(e) {}
        html5QrScanner = null;
    }
    
    html5QrScanner = new Html5Qrcode("qr-reader");
    
    html5QrScanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: { width: 250, height: 250 } },
        (decodedText) => {
            resultsDiv.innerHTML = `<span class="text-green-600 font-bold"><i class="fas fa-check-circle mr-1"></i>${decodedText}</span>`;
            if (navigator.vibrate) navigator.vibrate(200);
            
            html5QrScanner.stop().then(() => {
                html5QrScanner = null;
                btnStart.classList.remove('hidden');
                btnStop.classList.add('hidden');
                setTimeout(() => validerQRCode(rondeId, decodedText), 500);
            }).catch(() => {
                setTimeout(() => validerQRCode(rondeId, decodedText), 500);
            });
        },
        () => {}
    ).then(() => {
        resultsDiv.innerHTML = '<span class="text-green-500"><i class="fas fa-camera mr-1"></i>Pointez vers un QR code</span>';
    }).catch((err) => {
        resultsDiv.innerHTML = `<span class="text-red-500">${err}</span>`;
        btnStart.classList.remove('hidden');
        btnStop.classList.add('hidden');
    });
}

function arreterScanQR() {
    if (html5QrScanner) {
        html5QrScanner.stop().then(() => {
            html5QrScanner = null;
            document.getElementById('btnStartScan')?.classList.remove('hidden');
            document.getElementById('btnStopScan')?.classList.add('hidden');
        }).catch(() => {});
    }
}

function validerQRCode(rondeId, code) {
    const r = DB.rondes.find(x => x.id === rondeId);
    if (!r) {
        showToast('Ronde non trouv√©e', 'error');
        return;
    }
    
    const codeNorm = code.trim().toUpperCase();
    const point = r.pointsControle.find(p => (p.qrCode || '').trim().toUpperCase() === codeNorm);
    
    if (!point) {
        showToast('Code QR non reconnu', 'error');
        return;
    }
    
    if (point.valide) {
        showToast('Point d√©j√† valid√©', 'warning');
        return;
    }
    
    closeModal();
    setTimeout(() => ouvrirValidationPoint(rondeId, point.id), 400);
}

function validerQRManuel(rondeId) {
    const code = document.getElementById('qrCodeManuel')?.value?.trim();
    if (!code) {
        showToast('Entrez un code', 'error');
        return;
    }
    validerQRCode(rondeId, code);
}

function ouvrirValidationPoint(rondeId, pointId) {
    closeModal();
    
    setTimeout(() => {
        const r = DB.rondes.find(x => x.id === rondeId);
        if (!r) return;
        const point = r.pointsControle.find(p => p.id === pointId);
        if (!point) return;
        
        showModal(`${point.nom}`, `
            <div class="space-y-4">
                <div class="bg-blue-50 p-4 rounded-xl">
                    <div class="font-semibold text-blue-800">${point.nom}</div>
                    <div class="text-sm text-gray-600">${point.chemin || point.localisation || ''}</div>
                    <div class="text-xs text-gray-400 mt-1 font-mono">${point.qrCode}</div>
                </div>
                
                <div class="border-t pt-4">
                    <div class="font-semibold mb-3">√âtat du point</div>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="validerPoint(${rondeId}, ${pointId}, 'OK')" class="p-4 bg-green-100 rounded-xl text-center hover:ring-2 hover:ring-green-500 transition-all">
                            <i class="fas fa-check-circle text-green-600 text-2xl mb-2"></i>
                            <div class="text-sm font-medium text-green-700">Conforme</div>
                        </button>
                        <button onclick="validerPoint(${rondeId}, ${pointId}, 'Anomalie')" class="p-4 bg-orange-100 rounded-xl text-center hover:ring-2 hover:ring-orange-500 transition-all">
                            <i class="fas fa-exclamation-triangle text-orange-600 text-2xl mb-2"></i>
                            <div class="text-sm font-medium text-orange-700">Anomalie</div>
                        </button>
                        <button onclick="validerPoint(${rondeId}, ${pointId}, 'HS')" class="p-4 bg-red-100 rounded-xl text-center hover:ring-2 hover:ring-red-500 transition-all">
                            <i class="fas fa-ban text-red-600 text-2xl mb-2"></i>
                            <div class="text-sm font-medium text-red-700">Hors Service</div>
                        </button>
                    </div>
                </div>
            </div>
        `, null, 'Annuler');
    }, 400);
}

function validerPoint(rondeId, pointId, statut) {
    const r = DB.rondes.find(x => x.id === rondeId);
    if (!r) return;
    const point = r.pointsControle.find(p => p.id === pointId);
    if (!point) return;
    
    if (statut === 'OK') {
        point.valide = true;
        point.heureValidation = new Date().toISOString();
        point.statut = 'OK';
        
        sauvegarderVersFirebase();
        closeModal();
        showToast(`‚úÖ ${point.nom} valid√© !`);
        if (navigator.vibrate) navigator.vibrate(200);
        navigate('rondes');
    } else {
        const horsService = statut === 'HS';
        const couleur = horsService ? 'red' : 'orange';
        
        closeModal();
        setTimeout(() => {
            showModal(horsService ? 'üö´ Hors Service' : '‚ö†Ô∏è Anomalie', `
                <div class="space-y-4">
                    <div class="bg-${couleur}-50 p-4 rounded-xl">
                        <div class="font-semibold text-${couleur}-700">${point.nom}</div>
                        <div class="text-sm text-gray-600">${point.chemin || point.localisation || ''}</div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Description de l'anomalie *</label>
                        <textarea id="anomalieDesc" class="input" rows="3" placeholder="D√©crivez le probl√®me..."></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Photos (optionnel)</label>
                        <div class="flex gap-2 mb-2">
                            <button type="button" onclick="ajouterPhoto()" class="btn btn-secondary flex-1">
                                <i class="fas fa-camera mr-2"></i>Prendre photo
                            </button>
                            <button type="button" onclick="ajouterPhotoGalerie()" class="btn btn-secondary flex-1">
                                <i class="fas fa-images mr-2"></i>Galerie
                            </button>
                        </div>
                        <input type="file" id="anomaliePhotoInput" accept="image/*" capture="environment" class="hidden" onchange="traiterPhotos(this)" multiple>
                        <input type="file" id="anomaliePhotoGalerie" accept="image/*" class="hidden" onchange="traiterPhotos(this)" multiple>
                        <div id="photosPreview" class="flex flex-wrap gap-2 mt-2"></div>
                        <p class="text-xs text-gray-500 mt-1">Vous pouvez ajouter plusieurs photos</p>
                    </div>
                    ${horsService && point.materielId ? `
                        <div class="bg-red-100 p-3 rounded-lg text-sm text-red-700">
                            <i class="fas fa-info-circle mr-1"></i>
                            Le mat√©riel sera marqu√© Hors Service.
                        </div>
                    ` : ''}
                </div>
            `, () => {
                const desc = document.getElementById('anomalieDesc').value.trim();
                if (!desc) {
                    showToast('Description requise', 'error');
                    return;
                }
                
                point.valide = true;
                point.heureValidation = new Date().toISOString();
                point.statut = statut;
                
                const photos = [];
                document.querySelectorAll('#photosPreview img').forEach(img => {
                    photos.push(img.src);
                });
                
                if (!r.anomalies) r.anomalies = [];
                r.anomalies.push({
                    id: genId(),
                    pointId,
                    pointNom: point.nom,
                    description: desc,
                    photos: photos,
                    horsService,
                    date: new Date().toISOString(),
                    agentId: currentUser.id
                });
                
                if (horsService && point.materielId) {
                    const mat = DB.materiels.find(m => m.id === point.materielId);
                    if (mat) {
                        mat.statut = 'Hors Service';
                        mat.observation = desc;
                        mat.dateHS = new Date().toISOString();
                    }
                }
                
                addMainCourante('Anomalie Ronde', `${horsService ? 'üî¥ HS' : 'üü†'} - ${point.nom}: ${desc}`, currentUser.id);
                sauvegarderVersFirebase();
                
                closeModal();
                showToast(horsService ? 'üö´ Hors Service signal√©' : '‚ö†Ô∏è Anomalie signal√©e', horsService ? 'error' : 'warning');
                if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
                navigate('rondes');
            }, 'Enregistrer');
        }, 400);
    }
}

function ajouterPhoto() {
    document.getElementById('anomaliePhotoInput')?.click();
}

function ajouterPhotoGalerie() {
    document.getElementById('anomaliePhotoGalerie')?.click();
}

function traiterPhotos(input) {
    const preview = document.getElementById('photosPreview');
    if (!input.files || input.files.length === 0 || !preview) return;
    
    Array.from(input.files).forEach(file => {
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const maxSize = 800;
                let width = img.width;
                let height = img.height;
                
                if (width > height && width > maxSize) {
                    height = (height * maxSize) / width;
                    width = maxSize;
                } else if (height > maxSize) {
                    width = (width * maxSize) / height;
                    height = maxSize;
                }
                
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                
                const compressed = canvas.toDataURL('image/jpeg', 0.7);
                
                const photoId = 'photo-' + Date.now() + Math.random().toString(36).substr(2, 5);
                const div = document.createElement('div');
                div.id = photoId;
                div.className = 'relative';
                div.innerHTML = `
                    <img src="${compressed}" class="w-20 h-20 object-cover rounded-lg">
                    <button type="button" onclick="supprimerPhotoPreview('${photoId}')" class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-xs hover:bg-red-600">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                preview.appendChild(div);
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    });
    
    input.value = '';
}

function supprimerPhotoPreview(photoId) {
    const el = document.getElementById(photoId);
    if (el) el.remove();
}

function signalerAnomalieMobile(rondeId) {
    const r = DB.rondes.find(x => x.id === rondeId);
    if (!r) return;
    
    showModal('Signaler une anomalie', `
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-semibold mb-2">Localisation</label>
                <input type="text" id="anomalieLoc" class="input" placeholder="O√π se trouve l'anomalie ?">
            </div>
            <div>
                <label class="block text-sm font-semibold mb-2">Description *</label>
                <textarea id="anomalieDesc" class="input" rows="3" placeholder="D√©crivez le probl√®me..."></textarea>
            </div>
            <div>
                <label class="block text-sm font-semibold mb-2">Photos (optionnel)</label>
                <div class="flex gap-2 mb-2">
                    <button type="button" onclick="ajouterPhoto()" class="btn btn-secondary flex-1">
                        <i class="fas fa-camera mr-2"></i>Prendre photo
                    </button>
                    <button type="button" onclick="ajouterPhotoGalerie()" class="btn btn-secondary flex-1">
                        <i class="fas fa-images mr-2"></i>Galerie
                    </button>
                </div>
                <input type="file" id="anomaliePhotoInput" accept="image/*" capture="environment" class="hidden" onchange="traiterPhotos(this)" multiple>
                <input type="file" id="anomaliePhotoGalerie" accept="image/*" class="hidden" onchange="traiterPhotos(this)" multiple>
                <div id="photosPreview" class="flex flex-wrap gap-2 mt-2"></div>
            </div>
        </div>
    `, () => {
        const loc = document.getElementById('anomalieLoc')?.value || 'Non pr√©cis√©';
        const desc = document.getElementById('anomalieDesc')?.value?.trim();
        
        if (!desc) {
            showToast('Description requise', 'error');
            return;
        }
        
        const photos = [];
        document.querySelectorAll('#photosPreview img').forEach(img => {
            photos.push(img.src);
        });
        
        if (!r.anomalies) r.anomalies = [];
        r.anomalies.push({
            id: genId(),
            localisation: loc,
            description: desc,
            photos: photos,
            horsService: false,
            date: new Date().toISOString(),
            agentId: currentUser.id
        });
        
        addMainCourante('Anomalie Ronde', `${r.nom} - ${loc}: ${desc}`, currentUser.id);
        sauvegarderVersFirebase();
        
        closeModal();
        showToast('‚ö†Ô∏è Anomalie signal√©e');
        navigate('rondes');
    }, 'Signaler');
}

function voirPointsRonde(rondeId) {
    const r = DB.rondes.find(x => x.id === rondeId);
    if (!r) return;
    
    const valides = r.pointsControle.filter(p => p.valide);
    const nonValides = r.pointsControle.filter(p => !p.valide);
    
    showModal('Points de contr√¥le', `
        <div class="space-y-4 max-h-[60vh] overflow-y-auto">
            ${nonValides.length ? `
                <div>
                    <h3 class="text-sm font-bold text-red-600 mb-2">
                        <i class="fas fa-times-circle mr-1"></i>√Ä valider (${nonValides.length})
                    </h3>
                    <div class="space-y-2">
                        ${nonValides.map(p => `
                            <button onclick="ouvrirValidationPoint(${rondeId}, ${p.id})" class="w-full p-3 bg-red-50 rounded-lg flex items-center gap-3 text-left hover:bg-red-100">
                                <i class="fas fa-circle text-red-400 text-xs"></i>
                                <div class="flex-1">
                                    <div class="font-medium text-sm">${p.nom}</div>
                                    <div class="text-xs text-gray-500">${p.chemin || ''}</div>
                                </div>
                            </button>
                        `).join('')}
                    </div>
                </div>
            ` : ''}
            
            ${valides.length ? `
                <div>
                    <h3 class="text-sm font-bold text-green-600 mb-2">
                        <i class="fas fa-check-circle mr-1"></i>Valid√©s (${valides.length})
                    </h3>
                    <div class="space-y-2">
                        ${valides.map(p => {
                            const a = r.anomalies?.find(x => x.pointId === p.id);
                            const c = a ? (a.horsService ? 'red' : 'orange') : 'green';
                            return `
                                <div class="p-3 bg-${c}-50 rounded-lg flex items-center gap-3">
                                    <i class="fas fa-${a?.horsService ? 'ban' : a ? 'exclamation-triangle' : 'check-circle'} text-${c}-500"></i>
                                    <div class="flex-1">
                                        <div class="font-medium text-sm">${p.nom}</div>
                                        <div class="text-xs text-gray-500">${formatTime(p.heureValidation)}</div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            ` : ''}
        </div>
    `, null, 'Fermer');
}

function terminerRonde(rondeId) {
    const r = DB.rondes.find(x => x.id === rondeId);
    if (!r) return;
    
    const pts = r.pointsControle.filter(p => p.valide).length;
    const total = r.pointsControle.length;
    const tousValides = pts === total;
    const hasHS = r.anomalies?.some(a => a.horsService);
    const hasAnomalies = r.anomalies?.length > 0;
    
    const couleur = hasHS ? 'red' : hasAnomalies ? 'orange' : tousValides ? 'green' : 'orange';
    
    showModal('Terminer la ronde', `
        <div class="space-y-4">
            <div class="bg-${couleur}-50 p-4 rounded-lg">
                <div class="font-bold text-${couleur}-700">
                    ${hasHS ? 'üö´ Mat√©riel(s) Hors Service' : hasAnomalies ? '‚ö†Ô∏è Anomalies signal√©es' : tousValides ? '‚úÖ Tous les points valid√©s' : `‚ö†Ô∏è ${total - pts} point(s) non valid√©(s)`}
                </div>
                <div class="text-sm mt-1">${pts}/${total} points contr√¥l√©s</div>
            </div>
            
            ${hasHS ? `
                <div class="bg-red-100 p-4 rounded-lg">
                    <div class="font-bold text-red-700 mb-2">Mat√©riels HS :</div>
                    <ul class="text-sm text-red-600">
                        ${r.anomalies.filter(a => a.horsService).map(a => `<li>‚Ä¢ ${a.pointNom}</li>`).join('')}
                    </ul>
                </div>
            ` : ''}
            
            <div>
                <label class="block text-sm font-semibold mb-2">Observation (optionnel)</label>
                <textarea id="obsFin" class="input" rows="3" placeholder="Commentaire de fin de ronde..."></textarea>
            </div>
        </div>
    `, () => {
        r.heureFin = new Date().toISOString();
        r.observationFin = document.getElementById('obsFin').value;
        
        const duree = Math.round((new Date(r.heureFin) - new Date(r.heureDebut)) / 60000);
        const statutFinal = hasHS ? 'üî¥ HS' : hasAnomalies ? 'üü†' : 'üü¢ OK';
        
        addMainCourante('Fin Ronde', `${statutFinal} ${r.nom} (${pts}/${total}, ${duree}min)`, r.agentId);
        sauvegarderVersFirebase();
        
        closeModal();
        showToast('‚úÖ Ronde termin√©e');
        navigate('rondes');
    });
}

function voirRonde(id) {
    const r = DB.rondes.find(x => x.id === id);
    if (!r) return;
    
    const agent = DB.agents.find(a => a.id === r.agentId);
    const pts = r.pointsControle?.filter(p => p.valide).length || 0;
    const total = r.pointsControle?.length || 0;
    const couleur = getStatutCouleurRonde(r);
    
    showModal('D√©tails de la ronde', `
        <div class="space-y-4 max-h-[70vh] overflow-y-auto">
            <div class="flex items-center justify-between flex-wrap gap-2">
                <h3 class="text-xl font-bold">${r.nom || r.type}</h3>
                <span class="badge ${r.heureFin ? getBadgeClass(couleur) : 'badge-warning'}">${r.heureFin ? 'Termin√©e' : 'En cours'}</span>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-gray-50 p-3 rounded-lg">
                    <div class="text-xs text-gray-500">Agent</div>
                    <div class="font-medium">${agent?.prenom || ''} ${agent?.nom || ''}</div>
                </div>
                <div class="bg-gray-50 p-3 rounded-lg">
                    <div class="text-xs text-gray-500">Points</div>
                    <div class="font-medium">${pts}/${total}</div>
                </div>
                <div class="bg-gray-50 p-3 rounded-lg">
                    <div class="text-xs text-gray-500">D√©but</div>
                    <div class="font-medium">${formatDateTime(r.heureDebut)}</div>
                </div>
                <div class="bg-gray-50 p-3 rounded-lg">
                    <div class="text-xs text-gray-500">Fin</div>
                    <div class="font-medium">${r.heureFin ? formatDateTime(r.heureFin) : '-'}</div>
                </div>
            </div>
            
            ${r.anomalies?.length ? `
                <div class="bg-${r.anomalies.some(a => a.horsService) ? 'red' : 'orange'}-50 p-4 rounded-lg">
                    <div class="font-bold mb-3">
                        ${r.anomalies.some(a => a.horsService) ? 'üö´' : '‚ö†Ô∏è'} Anomalies (${r.anomalies.length})
                    </div>
                    <div class="space-y-4">
                        ${r.anomalies.map(a => {
                            const photos = a.photos || (a.photo ? [a.photo] : []);
                            return `
                                <div class="bg-white p-3 rounded-lg border-l-4 ${a.horsService ? 'border-red-500' : 'border-orange-500'}">
                                    <div class="flex items-start gap-2">
                                        <i class="fas fa-${a.horsService ? 'ban text-red-500' : 'exclamation-triangle text-orange-500'} mt-1"></i>
                                        <div class="flex-1">
                                            <div class="font-semibold">${a.pointNom || a.localisation || 'Point'}</div>
                                            <p class="text-sm text-gray-600 mt-1">${a.description}</p>
                                            <div class="text-xs text-gray-400 mt-1">${formatDateTime(a.date)}</div>
                                            ${photos.length > 0 ? `
                                                <div class="flex flex-wrap gap-2 mt-2">
                                                    ${photos.map(photo => `
                                                        <img src="${photo}" class="w-16 h-16 object-cover rounded-lg cursor-pointer hover:opacity-80" onclick="agrandirPhoto('${photo.replace(/'/g, "\\'")}')">
                                                    `).join('')}
                                                </div>
                                                <p class="text-xs text-gray-400 mt-1">${photos.length} photo(s)</p>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            ` : ''}
            
            ${r.observationFin ? `
                <div class="bg-blue-50 p-4 rounded-lg">
                    <div class="font-semibold text-blue-700 mb-2">Observation finale</div>
                    <p class="text-sm">${r.observationFin}</p>
                </div>
            ` : ''}
        </div>
    `, null, 'Fermer');
}

function agrandirPhoto(src) {
    showModal('Photo', `
        <div class="text-center">
            <img src="${src}" class="max-w-full max-h-[60vh] rounded-lg mx-auto">
        </div>
    `, null, 'Fermer');
}

// ==================== MAIN COURANTE ====================

function renderMainCourante() {
    let entrees = DB.mainCourante.filter(m => {
        const matchTexte = !filtresMainCourante.texte || 
            m.description.toLowerCase().includes(filtresMainCourante.texte.toLowerCase()) ||
            m.type.toLowerCase().includes(filtresMainCourante.texte.toLowerCase());
        const matchType = !filtresMainCourante.type || m.type === filtresMainCourante.type;
        let matchDate = true;
        if (filtresMainCourante.dateDebut) {
            matchDate = new Date(m.date) >= new Date(filtresMainCourante.dateDebut);
        }
        if (filtresMainCourante.dateFin && matchDate) {
            matchDate = new Date(m.date) <= new Date(filtresMainCourante.dateFin + 'T23:59:59');
        }
        return matchTexte && matchType && matchDate;
    });
    
    const types = [...new Set(DB.mainCourante.map(m => m.type))];
    
    return `
        <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
            <h1 class="text-2xl font-bold text-gray-800">
                <i class="fas fa-clipboard-list mr-2 text-primary-500"></i>Main Courante
            </h1>
            <button onclick="window.print()" class="btn btn-primary no-print">
                <i class="fas fa-print mr-2"></i>Imprimer
            </button>
        </div>
        
        <div class="search-filters no-print">
            <input type="text" class="input" placeholder="üîç Rechercher..." value="${filtresMainCourante.texte}" 
                onchange="filtresMainCourante.texte = this.value; navigate('mainCourante')">
            <select class="input" onchange="filtresMainCourante.type = this.value; navigate('mainCourante')">
                <option value="">Tous types</option>
                ${types.map(t => `<option value="${t}" ${filtresMainCourante.type === t ? 'selected' : ''}>${t}</option>`).join('')}
            </select>
            <input type="date" class="input" value="${filtresMainCourante.dateDebut}" 
                onchange="filtresMainCourante.dateDebut = this.value; navigate('mainCourante')">
            <input type="date" class="input" value="${filtresMainCourante.dateFin}" 
                onchange="filtresMainCourante.dateFin = this.value; navigate('mainCourante')">
            <button onclick="filtresMainCourante = {texte:'', type:'', dateDebut:'', dateFin:''}; navigate('mainCourante')" class="btn btn-secondary btn-sm">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="card">
            <div class="gradient-header text-white p-4 font-semibold">
                √âv√©nements (${entrees.length})
            </div>
            <div class="overflow-x-auto">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Date/Heure</th>
                            <th>Type</th>
                            <th>Description</th>
                            <th>D√©tails</th>
                            <th>Agent</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${entrees.length ? entrees.slice(0, 100).map(m => {
                            let details = '';
                            if (m.evenementId) {
                                const evt = DB.evenements.find(e => e.id === m.evenementId);
                                if (evt) {
                                    if (evt.statut === 'En cours' && evt.commentaire) {
                                        details = `<span class="text-orange-600 text-xs">${evt.commentaire.substring(0, 50)}${evt.commentaire.length > 50 ? '...' : ''}</span>`;
                                    } else if (evt.statut === 'Termin√©' && evt.compteRendu) {
                                        details = `<span class="text-green-600 text-xs">${evt.compteRendu.substring(0, 50)}${evt.compteRendu.length > 50 ? '...' : ''}</span>`;
                                    }
                                }
                            }
                            return `
                                <tr>
                                    <td class="whitespace-nowrap">${formatDateTime(m.date)}</td>
                                    <td><span class="badge ${getMainCouranteBadgeClass(m.type)}">${m.type}</span></td>
                                    <td>${m.description}</td>
                                    <td>${details}</td>
                                    <td>${m.agent}</td>
                                </tr>
                            `;
                        }).join('') : '<tr><td colspan="5" class="text-center py-8 text-gray-500">Aucun √©v√©nement</td></tr>'}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

// ==================== EVENEMENTS ====================

function renderEvenements() {
    let evts = DB.evenements.filter(e => {
        const matchTexte = !filtresEvenements.texte || e.description?.toLowerCase().includes(filtresEvenements.texte.toLowerCase());
        const matchType = !filtresEvenements.type || e.type === filtresEvenements.type;
        const matchStatut = !filtresEvenements.statut || e.statut === filtresEvenements.statut;
        return matchTexte && matchType && matchStatut;
    }).sort((a, b) => new Date(b.date) - new Date(a.date));
    
    const stats = {
        debut: DB.evenements.filter(e => e.statut === 'D√©but').length,
        enCours: DB.evenements.filter(e => e.statut === 'En cours').length,
        termine: DB.evenements.filter(e => e.statut === 'Termin√©').length
    };
    
    return `
        <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
            <h1 class="text-2xl font-bold text-gray-800">
                <i class="fas fa-exclamation-triangle mr-2 text-primary-500"></i>√âv√©nements
            </h1>
            <div class="flex gap-2 no-print">
                <button onclick="showModalEvenement()" class="btn btn-primary">
                    <i class="fas fa-plus mr-2"></i>Nouveau
                </button>
                <button onclick="window.print()" class="btn btn-primary">
                    <i class="fas fa-print mr-2"></i>Imprimer
                </button>
            </div>
        </div>
        
        <div class="search-filters no-print">
            <input type="text" class="input" placeholder="üîç Rechercher..." value="${filtresEvenements.texte}" 
                onchange="filtresEvenements.texte = this.value; navigate('evenements')">
            <select class="input" onchange="filtresEvenements.type = this.value; navigate('evenements')">
                <option value="">Tous types</option>
                ${typesEvenement.map(t => `<option value="${t}" ${filtresEvenements.type === t ? 'selected' : ''}>${t}</option>`).join('')}
            </select>
            <select class="input" onchange="filtresEvenements.statut = this.value; navigate('evenements')">
                <option value="">Tous statuts</option>
                <option value="D√©but" ${filtresEvenements.statut === 'D√©but' ? 'selected' : ''}>üî¥ D√©but</option>
                <option value="En cours" ${filtresEvenements.statut === 'En cours' ? 'selected' : ''}>üü† En cours</option>
                <option value="Termin√©" ${filtresEvenements.statut === 'Termin√©' ? 'selected' : ''}>üü¢ Termin√©</option>
            </select>
            <button onclick="filtresEvenements = {texte:'', type:'', statut:''}; navigate('evenements')" class="btn btn-secondary btn-sm">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="grid grid-cols-3 gap-4 mb-6 no-print">
            <div class="stat-card bg-red-50"><div class="text-2xl font-bold text-red-600">${stats.debut}</div><div class="text-xs text-red-600">üî¥ Alertes</div></div>
            <div class="stat-card bg-orange-50"><div class="text-2xl font-bold text-orange-600">${stats.enCours}</div><div class="text-xs text-orange-600">üü† En cours</div></div>
            <div class="stat-card bg-green-50"><div class="text-2xl font-bold text-green-600">${stats.termine}</div><div class="text-xs text-green-600">üü¢ Termin√©s</div></div>
        </div>
        
        <div class="card">
            <div class="p-4 space-y-3">
                ${evts.length ? evts.map(e => {
                    const agent = DB.agents.find(a => a.id === e.agentId);
                    const color = e.statut === 'D√©but' ? 'red' : e.statut === 'En cours' ? 'orange' : 'green';
                    return `
                        <div class="flex items-start justify-between p-4 bg-${color}-50 rounded-xl border-l-4 border-${color}-500">
                            <div class="flex items-start gap-4 flex-1">
                                <span class="status-dot ${color} no-print mt-1"></span>
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-1 flex-wrap">
                                        <span class="font-semibold">${e.type}</span>
                                        <span class="badge badge-${e.statut === 'D√©but' ? 'danger' : e.statut === 'En cours' ? 'warning' : 'success'}">${e.statut}</span>
                                    </div>
                                    ${e.localisation ? `<div class="text-sm text-gray-600"><i class="fas fa-map-marker-alt mr-1"></i>${e.localisation}</div>` : ''}
                                    <div class="text-sm text-gray-500">${agent?.prenom || ''} ${agent?.nom || ''} ‚Ä¢ ${formatDateTime(e.date)}</div>
                                    ${e.commentaire && e.statut === 'En cours' ? `<div class="text-sm text-orange-600 mt-2 bg-orange-100 p-2 rounded"><i class="fas fa-comment mr-1"></i>${e.commentaire}</div>` : ''}
                                    ${e.compteRendu && e.statut === 'Termin√©' ? `<div class="text-sm text-green-600 mt-2 bg-green-100 p-2 rounded"><i class="fas fa-check-circle mr-1"></i>${e.compteRendu.substring(0, 100)}${e.compteRendu.length > 100 ? '...' : ''}</div>` : ''}
                                </div>
                            </div>
                            <div class="flex gap-2 no-print ml-2">
                                ${e.statut !== 'Termin√©' ? `
                                    <button onclick="modifierStatutEvenement(${e.id})" class="btn btn-secondary btn-sm"><i class="fas fa-edit"></i></button>
                                ` : ''}
                                <button onclick="voirEvenement(${e.id})" class="btn btn-secondary btn-sm"><i class="fas fa-eye"></i></button>
                            </div>
                        </div>
                    `;
                }).join('') : '<p class="text-gray-500 text-center py-8">Aucun √©v√©nement</p>'}
            </div>
        </div>
    `;
}

function showModalEvenement() {
    const agentsPoste = getAgentsEnPoste();
    
    let locOptions = '<option value="">S√©lectionner...</option>';
    configEtablissement.batiments.forEach(bat => {
        bat.secteurs.forEach(sect => {
            sect.zones.forEach(zone => {
                locOptions += `<option value="${bat.nom} > ${sect.nom} > ${zone}">${bat.nom} > ${sect.nom} > ${zone}</option>`;
            });
        });
    });
    locOptions += '<option value="__autre__">Autre (pr√©ciser)</option>';
    
    showModal('Nouvel √âv√©nement', `
        <div class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-semibold mb-2">Type *</label>
                    <select id="evtType" class="input">
                        ${typesEvenement.map(t => `<option>${t}</option>`).join('')}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Agent *</label>
                    <select id="evtAgent" class="input">
                        ${agentsPoste.length ? agentsPoste.map(a => `<option value="${a.id}">${a.prenom} ${a.nom}</option>`).join('') : `<option value="${currentUser?.id}">${currentUser?.prenom} ${currentUser?.nom}</option>`}
                    </select>
                </div>
            </div>
            <div>
                <label class="block text-sm font-semibold mb-2">Localisation *</label>
                <select id="evtLocSelect" class="input mb-2" onchange="document.getElementById('evtLocAutre').classList.toggle('hidden', this.value !== '__autre__')">
                    ${locOptions}
                </select>
                <input type="text" id="evtLocAutre" class="input hidden" placeholder="Pr√©cisez la localisation...">
            </div>
            <div>
                <label class="block text-sm font-semibold mb-2">Description *</label>
                <textarea id="evtDesc" class="input" rows="4" placeholder="D√©crivez l'√©v√©nement..."></textarea>
            </div>
            <div class="bg-red-50 p-3 rounded-lg text-sm text-red-700">
                <i class="fas fa-exclamation-circle mr-1"></i>
                L'√©v√©nement sera cr√©√© avec le statut <strong>"D√©but"</strong> (alerte rouge)
            </div>
        </div>
    `, () => {
        const type = document.getElementById('evtType').value;
        const agentId = parseInt(document.getElementById('evtAgent').value);
        const locSelect = document.getElementById('evtLocSelect').value;
        const locAutre = document.getElementById('evtLocAutre').value.trim();
        const localisation = locSelect === '__autre__' ? locAutre : locSelect;
        const description = document.getElementById('evtDesc').value.trim();
        
        if (!description || !localisation) {
            showToast('Remplissez tous les champs', 'error');
            return;
        }
        
        const evt = {
            id: genId(),
            type,
            statut: 'D√©but',
            agentId,
            localisation,
            description,
            date: new Date().toISOString(),
            commentaire: '',
            compteRendu: ''
        };
        
        DB.evenements.unshift(evt);
        addMainCourante(type, `üî¥ D√âBUT: ${description.substring(0, 50)}...`, agentId, { evenementId: evt.id, localisation });
        sauvegarderVersFirebase();
        
        closeModal();
        showToast('üö® √âv√©nement cr√©√©');
        navigate('evenements');
    });
}

function modifierStatutEvenement(id) {
    const e = DB.evenements.find(x => x.id === id);
    if (!e) return;
    
    showModal('Modifier le statut', `
        <div class="space-y-4">
            <div class="bg-gray-50 p-3 rounded-lg">
                <div class="font-semibold">${e.type}</div>
                <div class="text-sm text-gray-500">${e.localisation || ''}</div>
            </div>
            <div>
                <label class="block text-sm font-semibold mb-2">Nouveau statut</label>
                <select id="evtNewStatut" class="input" onchange="toggleEvtFields()">
                    <option value="D√©but" ${e.statut === 'D√©but' ? 'selected' : ''}>üî¥ D√©but (Alerte)</option>
                    <option value="En cours" ${e.statut === 'En cours' ? 'selected' : ''}>üü† En cours</option>
                    <option value="Termin√©" ${e.statut === 'Termin√©' ? 'selected' : ''}>üü¢ Termin√©</option>
                </select>
            </div>
            <div id="commentSection" class="${e.statut === 'En cours' ? '' : 'hidden'}">
                <label class="block text-sm font-semibold mb-2">Commentaire de suivi</label>
                <textarea id="evtComment" class="input" rows="3" placeholder="Actions en cours, observations...">${e.commentaire || ''}</textarea>
            </div>
            <div id="crSection" class="${e.statut === 'Termin√©' ? '' : 'hidden'}">
                <label class="block text-sm font-semibold mb-2">Compte-rendu final *</label>
                <textarea id="evtCR" class="input" rows="4" placeholder="Actions men√©es, r√©solution...">${e.compteRendu || ''}</textarea>
            </div>
        </div>
    `, () => {
        const newStatut = document.getElementById('evtNewStatut').value;
        const comment = document.getElementById('evtComment')?.value || '';
        const cr = document.getElementById('evtCR')?.value || '';
        
        if (newStatut === 'Termin√©' && !cr.trim()) {
            showToast('Compte-rendu requis pour cl√¥turer', 'error');
            return;
        }
        
        e.statut = newStatut;
        
        if (newStatut === 'En cours') {
            e.commentaire = comment;
            addMainCourante('√âv√©nement', `üü† ${e.type} - En cours${comment ? ': ' + comment.substring(0, 30) : ''}`, currentUser?.id, { evenementId: e.id });
        } else if (newStatut === 'Termin√©') {
            e.compteRendu = cr;
            e.dateCloture = new Date().toISOString();
            addMainCourante('√âv√©nement', `üü¢ ${e.type} - Termin√©`, currentUser?.id, { evenementId: e.id });
        } else {
            addMainCourante('√âv√©nement', `üî¥ ${e.type} - D√©but`, currentUser?.id, { evenementId: e.id });
        }
        
        sauvegarderVersFirebase();
        closeModal();
        showToast(`Statut mis √† jour: ${newStatut}`);
        navigate('evenements');
    });
}

function toggleEvtFields() {
    const statut = document.getElementById('evtNewStatut')?.value;
    const commentSection = document.getElementById('commentSection');
    const crSection = document.getElementById('crSection');
    
    if (commentSection) commentSection.classList.toggle('hidden', statut !== 'En cours');
    if (crSection) crSection.classList.toggle('hidden', statut !== 'Termin√©');
}

function voirEvenement(id) {
    const e = DB.evenements.find(x => x.id === id);
    if (!e) return;
    
    const agent = DB.agents.find(a => a.id === e.agentId);
    const color = e.statut === 'D√©but' ? 'red' : e.statut === 'En cours' ? 'orange' : 'green';
    
    showModal('D√©tails de l\'√©v√©nement', `
        <div class="space-y-4">
            <div class="flex items-center gap-4">
                <span class="status-dot ${color}" style="width:24px;height:24px;"></span>
                <div>
                    <div class="text-xl font-bold">${e.type}</div>
                    <span class="badge badge-${e.statut === 'D√©but' ? 'danger' : e.statut === 'En cours' ? 'warning' : 'success'}">${e.statut}</span>
                </div>
            </div>
            
            ${e.localisation ? `
                <div class="bg-blue-50 p-3 rounded-xl">
                    <i class="fas fa-map-marker-alt text-blue-500 mr-2"></i>${e.localisation}
                </div>
            ` : ''}
            
            <div class="bg-gray-50 p-4 rounded-xl">
                <p>${e.description}</p>
            </div>
            
            <div class="grid grid-cols-2 gap-4 text-sm">
                <div class="bg-gray-50 p-3 rounded-lg">
                    <div class="text-xs text-gray-500">Signal√© par</div>
                    <div class="font-medium">${agent?.prenom || ''} ${agent?.nom || ''}</div>
                </div>
                <div class="bg-gray-50 p-3 rounded-lg">
                    <div class="text-xs text-gray-500">Date</div>
                    <div class="font-medium">${formatDateTime(e.date)}</div>
                </div>
            </div>
            
            ${e.commentaire ? `
                <div class="bg-orange-50 p-4 rounded-xl">
                    <div class="font-semibold text-orange-700 mb-2"><i class="fas fa-comment mr-1"></i>Commentaire</div>
                    <p class="text-sm">${e.commentaire}</p>
                </div>
            ` : ''}
            
            ${e.compteRendu ? `
                <div class="bg-green-50 p-4 rounded-xl">
                    <div class="font-semibold text-green-700 mb-2"><i class="fas fa-check-circle mr-1"></i>Compte-rendu</div>
                    <p class="text-sm">${e.compteRendu}</p>
                    ${e.dateCloture ? `<div class="text-xs text-gray-500 mt-2">Cl√¥tur√© le ${formatDateTime(e.dateCloture)}</div>` : ''}
                </div>
            ` : ''}
        </div>
    `, null, 'Fermer');
}

// ==================== MATERIELS ====================

function renderMateriels() {
    const types = [...new Set(DB.materiels.map(m => m.type))];
    
    let mats = DB.materiels.filter(m => {
        const matchTexte = !filtresMateriels.texte || 
            m.nom.toLowerCase().includes(filtresMateriels.texte.toLowerCase()) ||
            (m.localisation || '').toLowerCase().includes(filtresMateriels.texte.toLowerCase());
        const matchType = !filtresMateriels.type || m.type === filtresMateriels.type;
        const matchStatut = !filtresMateriels.statut || m.statut === filtresMateriels.statut;
        return matchTexte && matchType && matchStatut;
    });
    
    const stats = {
        total: DB.materiels.length,
        ok: DB.materiels.filter(m => m.statut === 'Op√©rationnel').length,
        aVerifier: DB.materiels.filter(m => m.statut === '√Ä v√©rifier').length,
        hs: DB.materiels.filter(m => m.statut === 'Hors Service' || m.statut === 'En maintenance').length
    };
    
    const canEdit = ['SSIAP 2', 'SSIAP 3', 'Administrateur'].includes(currentUser?.qualification);
    const canAdd = ['SSIAP 3', 'Administrateur'].includes(currentUser?.qualification);
    
    return `
        <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
            <h1 class="text-2xl font-bold text-gray-800">
                <i class="fas fa-fire-extinguisher mr-2 text-primary-500"></i>Mat√©riels
            </h1>
            <div class="flex gap-2 no-print">
                ${canAdd ? `
                    <button onclick="showModalMateriel()" class="btn btn-primary">
                        <i class="fas fa-plus mr-2"></i>Nouveau
                    </button>
                ` : ''}
                <button onclick="window.print()" class="btn btn-primary">
                    <i class="fas fa-print mr-2"></i>Imprimer
                </button>
            </div>
        </div>
        
        <div class="search-filters no-print">
            <input type="text" class="input" placeholder="üîç Rechercher..." value="${filtresMateriels.texte}" 
                onchange="filtresMateriels.texte = this.value; navigate('materiels')">
            <select class="input" onchange="filtresMateriels.type = this.value; navigate('materiels')">
                <option value="">Tous types</option>
                ${types.map(t => `<option value="${t}" ${filtresMateriels.type === t ? 'selected' : ''}>${t}</option>`).join('')}
            </select>
            <select class="input" onchange="filtresMateriels.statut = this.value; navigate('materiels')">
                <option value="">Tous statuts</option>
                <option value="Op√©rationnel" ${filtresMateriels.statut === 'Op√©rationnel' ? 'selected' : ''}>Op√©rationnel</option>
                <option value="√Ä v√©rifier" ${filtresMateriels.statut === '√Ä v√©rifier' ? 'selected' : ''}>√Ä v√©rifier</option>
                <option value="Hors Service" ${filtresMateriels.statut === 'Hors Service' ? 'selected' : ''}>Hors Service</option>
            </select>
            <button onclick="filtresMateriels = {texte:'', type:'', statut:''}; navigate('materiels')" class="btn btn-secondary btn-sm">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6 no-print">
            <div class="stat-card"><div class="text-2xl font-bold text-blue-600">${stats.total}</div><div class="text-xs text-gray-500">Total</div></div>
            <div class="stat-card"><div class="text-2xl font-bold text-green-600">${stats.ok}</div><div class="text-xs text-gray-500">Op√©rationnels</div></div>
            <div class="stat-card"><div class="text-2xl font-bold text-orange-600">${stats.aVerifier}</div><div class="text-xs text-gray-500">√Ä v√©rifier</div></div>
            <div class="stat-card"><div class="text-2xl font-bold text-red-600">${stats.hs}</div><div class="text-xs text-gray-500">Hors service</div></div>
        </div>
        
        <div class="card">
            <div class="overflow-x-auto">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Mat√©riel</th>
                            <th>Type</th>
                            <th>Localisation</th>
                            <th>Statut</th>
                            <th>QR Code</th>
                            ${canEdit ? '<th class="no-print">Actions</th>' : ''}
                        </tr>
                    </thead>
                    <tbody>
                        ${mats.length ? mats.map(m => {
                            const statutClass = m.statut === 'Op√©rationnel' ? 'badge-success' : m.statut === '√Ä v√©rifier' ? 'badge-warning' : 'badge-danger';
                            return `
                                <tr>
                                    <td class="font-medium">${m.nom}</td>
                                    <td><span class="badge badge-info">${m.type}</span></td>
                                    <td class="text-sm text-gray-600">${m.localisation || '-'}</td>
                                    <td><span class="badge ${statutClass}">${m.statut}</span></td>
                                    <td class="text-xs font-mono text-gray-400">${m.codeQR || '-'}</td>
                                    ${canEdit ? `
                                        <td class="no-print">
                                            <div class="flex gap-1">
                                                <button onclick="voirMateriel(${m.id})" class="btn btn-icon btn-sm btn-secondary" title="Voir">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button onclick="modifierMateriel(${m.id})" class="btn btn-icon btn-sm btn-secondary" title="Modifier">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            </div>
                                        </td>
                                    ` : ''}
                                </tr>
                            `;
                        }).join('') : '<tr><td colspan="6" class="text-center py-8 text-gray-500">Aucun mat√©riel</td></tr>'}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

function voirMateriel(id) {
    const m = DB.materiels.find(x => x.id === id);
    if (!m) return;
    
    const statutClass = m.statut === 'Op√©rationnel' ? 'badge-success' : m.statut === '√Ä v√©rifier' ? 'badge-warning' : 'badge-danger';
    
    showModal('Fiche Mat√©riel', `
        <div class="space-y-4">
            <div class="flex items-start justify-between gap-4">
                <div class="flex-1">
                    <h3 class="text-xl font-bold">${m.nom}</h3>
                    <div class="flex gap-2 mt-1">
                        <span class="badge badge-info">${m.type}</span>
                        <span class="badge ${statutClass}">${m.statut}</span>
                    </div>
                </div>
                <div id="qrCodeMaterielView" class="bg-white p-2 rounded-lg border min-w-[100px] min-h-[100px] flex items-center justify-center">
                    <i class="fas fa-spinner fa-spin text-gray-300"></i>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-gray-50 p-3 rounded-lg">
                    <div class="text-xs text-gray-500">Localisation</div>
                    <div class="font-medium text-sm">${m.localisation || '-'}</div>
                </div>
                <div class="bg-gray-50 p-3 rounded-lg">
                    <div class="text-xs text-gray-500">Code QR</div>
                    <div class="font-mono text-sm">${m.codeQR || '-'}</div>
                </div>
                <div class="bg-gray-50 p-3 rounded-lg">
                    <div class="text-xs text-gray-500">Derni√®re maintenance</div>
                    <div class="font-medium">${m.derniereMaint ? formatDate(m.derniereMaint) : '-'}</div>
                </div>
                <div class="bg-gray-50 p-3 rounded-lg">
                    <div class="text-xs text-gray-500">Prochaine maintenance</div>
                    <div class="font-medium">${m.prochaineMaint ? formatDate(m.prochaineMaint) : '-'}</div>
                </div>
            </div>
            
            ${m.observation ? `
                <div class="bg-orange-50 p-4 rounded-lg">
                    <div class="font-semibold text-orange-700 mb-2"><i class="fas fa-exclamation-triangle mr-1"></i>Observation</div>
                    <p class="text-sm">${m.observation}</p>
                </div>
            ` : ''}
        </div>
    `, null, 'Fermer');
    
    setTimeout(() => {
        const qrDiv = document.getElementById('qrCodeMaterielView');
        if (qrDiv && m.codeQR && typeof QRCode !== 'undefined') {
            qrDiv.innerHTML = '';
            try {
                new QRCode(qrDiv, { 
                    text: m.codeQR, 
                    width: 80, 
                    height: 80,
                    correctLevel: QRCode.CorrectLevel.M
                });
            } catch(e) {
                qrDiv.innerHTML = `<span class="text-gray-400 text-xs font-mono">${m.codeQR}</span>`;
            }
        } else if (qrDiv) {
            qrDiv.innerHTML = '<span class="text-gray-400 text-xs">Pas de QR</span>';
        }
    }, 200);
}

function showModalMateriel() {
    const types = ['Extincteur', 'RIA', 'D√©tecteur', 'Porte CF', 'BAES', 'Colonne s√®che', 'Autre'];
    const statuts = ['Op√©rationnel', '√Ä v√©rifier', 'En maintenance', 'Hors Service'];
    
    let locOptions = '<option value="">S√©lectionner...</option>';
    configEtablissement.batiments.forEach(bat => {
        bat.secteurs.forEach(sect => {
            sect.zones.forEach(zone => {
                locOptions += `<option value="${bat.nom} > ${sect.nom} > ${zone}">${bat.nom} > ${sect.nom} > ${zone}</option>`;
            });
        });
    });
    
    showModal('Nouveau Mat√©riel', `
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-semibold mb-2">Nom *</label>
                <input type="text" id="matNom" class="input" placeholder="Ex: Extincteur CO2 5kg - Hall">
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-semibold mb-2">Type *</label>
                    <select id="matType" class="input">${types.map(t => `<option>${t}</option>`).join('')}</select>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Statut</label>
                    <select id="matStatut" class="input">${statuts.map(s => `<option>${s}</option>`).join('')}</select>
                </div>
            </div>
            <div>
                <label class="block text-sm font-semibold mb-2">Localisation</label>
                <select id="matLoc" class="input">${locOptions}</select>
            </div>
            <div>
                <label class="block text-sm font-semibold mb-2">Code QR (optionnel)</label>
                <input type="text" id="matQR" class="input" placeholder="Ex: MAT-EXT-004">
                <p class="text-xs text-gray-500 mt-1">Laissez vide pour g√©n√©rer automatiquement</p>
            </div>
        </div>
    `, () => {
        const nom = document.getElementById('matNom').value.trim();
        if (!nom) return showToast('Nom requis', 'error');
        
        const newId = genId();
        let codeQR = document.getElementById('matQR').value.trim();
        if (!codeQR) {
            codeQR = `MAT-${document.getElementById('matType').value.substring(0, 3).toUpperCase()}-${String(newId).slice(-4)}`;
        }
        
        DB.materiels.push({
            id: newId,
            nom,
            type: document.getElementById('matType').value,
            statut: document.getElementById('matStatut').value,
            localisation: document.getElementById('matLoc').value,
            codeQR,
            dateCreation: new Date().toISOString()
        });
        
        addMainCourante('Mat√©riel', `Ajout: ${nom}`, currentUser?.id);
        sauvegarderVersFirebase();
        
        closeModal();
        showToast('‚úÖ Mat√©riel ajout√©');
        navigate('materiels');
    });
}

function modifierMateriel(id) {
    const m = DB.materiels.find(x => x.id === id);
    if (!m) return;
    
    const types = ['Extincteur', 'RIA', 'D√©tecteur', 'Porte CF', 'BAES', 'Colonne s√®che', 'Autre'];
    const statuts = ['Op√©rationnel', '√Ä v√©rifier', 'En maintenance', 'Hors Service'];
    
    let locOptions = `<option value="">S√©lectionner...</option>`;
    let locFound = false;
    configEtablissement.batiments.forEach(bat => {
        bat.secteurs.forEach(sect => {
            sect.zones.forEach(zone => {
                const loc = `${bat.nom} > ${sect.nom} > ${zone}`;
                const selected = m.localisation === loc;
                if (selected) locFound = true;
                locOptions += `<option value="${loc}" ${selected ? 'selected' : ''}>${loc}</option>`;
            });
        });
    });
    locOptions += `<option value="__autre__" ${m.localisation && !locFound ? 'selected' : ''}>Autre (saisie libre)</option>`;
    
    showModal('Modifier Mat√©riel', `
        <div class="space-y-4">
            <div class="flex items-start justify-between gap-4">
                <div class="flex-1">
                    <label class="block text-sm font-semibold mb-2">Nom *</label>
                    <input type="text" id="matNomEdit" class="input" value="${m.nom}">
                </div>
                <div id="qrCodeMaterielEdit" class="bg-white p-2 rounded-lg border min-w-[80px] min-h-[80px] flex items-center justify-center">
                    <i class="fas fa-spinner fa-spin text-gray-300"></i>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-semibold mb-2">Type</label>
                    <select id="matTypeEdit" class="input">${types.map(t => `<option ${m.type === t ? 'selected' : ''}>${t}</option>`).join('')}</select>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Statut</label>
                    <select id="matStatutEdit" class="input">${statuts.map(s => `<option ${m.statut === s ? 'selected' : ''}>${s}</option>`).join('')}</select>
                </div>
            </div>
            <div>
                <label class="block text-sm font-semibold mb-2">Localisation</label>
                <select id="matLocEdit" class="input mb-2" onchange="document.getElementById('matLocAutreEdit').classList.toggle('hidden', this.value !== '__autre__')">
                    ${locOptions}
                </select>
                <input type="text" id="matLocAutreEdit" class="input ${m.localisation && !locFound ? '' : 'hidden'}" value="${m.localisation || ''}" placeholder="Saisir la localisation...">
            </div>
            <div>
                <label class="block text-sm font-semibold mb-2">Code QR</label>
                <input type="text" id="matQREdit" class="input" value="${m.codeQR || ''}">
            </div>
            <div>
                <label class="block text-sm font-semibold mb-2">Observation</label>
                <textarea id="matObsEdit" class="input" rows="2">${m.observation || ''}</textarea>
            </div>
        </div>
    `, () => {
        const nom = document.getElementById('matNomEdit').value.trim();
        if (!nom) return showToast('Nom requis', 'error');
        
        const locSelect = document.getElementById('matLocEdit').value;
        const locAutre = document.getElementById('matLocAutreEdit').value.trim();
        
        m.nom = nom;
        m.type = document.getElementById('matTypeEdit').value;
        m.statut = document.getElementById('matStatutEdit').value;
        m.localisation = locSelect === '__autre__' ? locAutre : locSelect;
        m.codeQR = document.getElementById('matQREdit').value.trim();
        m.observation = document.getElementById('matObsEdit').value;
        
        addMainCourante('Mat√©riel', `Modification: ${nom}`, currentUser?.id);
        sauvegarderVersFirebase();
        
        closeModal();
        showToast('‚úÖ Mat√©riel modifi√©');
        navigate('materiels');
    });
    
    setTimeout(() => {
        const qrDiv = document.getElementById('qrCodeMaterielEdit');
        if (qrDiv && m.codeQR && typeof QRCode !== 'undefined') {
            qrDiv.innerHTML = '';
            try {
                new QRCode(qrDiv, { 
                    text: m.codeQR, 
                    width: 70, 
                    height: 70,
                    correctLevel: QRCode.CorrectLevel.M
                });
            } catch(e) {
                qrDiv.innerHTML = `<span class="text-gray-400 text-xs font-mono">${m.codeQR}</span>`;
            }
        } else if (qrDiv) {
            qrDiv.innerHTML = '<span class="text-gray-400 text-xs">Pas de QR</span>';
        }
    }, 200);
}

// ==================== CONSIGNES ====================

function renderConsignes() {
    const now = new Date();
    
    let consignesFiltrees = DB.consignes.filter(c => {
        const estActive = c.active && (!c.dateFin || new Date(c.dateFin) >= now);
        const matchTexte = !filtresConsignes.texte || 
            c.titre.toLowerCase().includes(filtresConsignes.texte.toLowerCase()) ||
            c.contenu.toLowerCase().includes(filtresConsignes.texte.toLowerCase());
        const matchNiveau = !filtresConsignes.niveau || c.niveau === filtresConsignes.niveau;
        const matchPriorite = !filtresConsignes.priorite || c.priorite === filtresConsignes.priorite;
        return estActive && matchTexte && matchNiveau && matchPriorite;
    });
    
    const canManage = ['SSIAP 2', 'SSIAP 3', 'Administrateur'].includes(currentUser?.qualification);
    
    return `
        <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
            <h1 class="text-2xl font-bold text-gray-800">
                <i class="fas fa-file-alt mr-2 text-primary-500"></i>Consignes
            </h1>
            <div class="flex gap-2 no-print">
                ${canManage ? `
                    <button onclick="showModalConsigne()" class="btn btn-primary">
                        <i class="fas fa-plus mr-2"></i>Nouvelle
                    </button>
                ` : ''}
                <button onclick="window.print()" class="btn btn-primary">
                    <i class="fas fa-print mr-2"></i>Imprimer
                </button>
            </div>
        </div>
        
        <div class="search-filters no-print">
            <input type="text" class="input" placeholder="üîç Rechercher..." value="${filtresConsignes.texte}" 
                onchange="filtresConsignes.texte = this.value; navigate('consignes')">
            <select class="input" onchange="filtresConsignes.niveau = this.value; navigate('consignes')">
                <option value="">Tous niveaux</option>
                <option value="Particuli√®re" ${filtresConsignes.niveau === 'Particuli√®re' ? 'selected' : ''}>Particuli√®re</option>
                <option value="Permanente" ${filtresConsignes.niveau === 'Permanente' ? 'selected' : ''}>Permanente</option>
                <option value="Temporaire" ${filtresConsignes.niveau === 'Temporaire' ? 'selected' : ''}>Temporaire</option>
            </select>
            <select class="input" onchange="filtresConsignes.priorite = this.value; navigate('consignes')">
                <option value="">Toutes priorit√©s</option>
                <option value="Urgente" ${filtresConsignes.priorite === 'Urgente' ? 'selected' : ''}>Urgente</option>
                <option value="Haute" ${filtresConsignes.priorite === 'Haute' ? 'selected' : ''}>Haute</option>
                <option value="Normale" ${filtresConsignes.priorite === 'Normale' ? 'selected' : ''}>Normale</option>
                <option value="Basse" ${filtresConsignes.priorite === 'Basse' ? 'selected' : ''}>Basse</option>
            </select>
            <button onclick="filtresConsignes = {texte:'', niveau:'', priorite:''}; navigate('consignes')" class="btn btn-secondary btn-sm">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="grid grid-cols-2 gap-4 mb-6 no-print">
            <div class="stat-card bg-orange-50">
                <div class="text-2xl font-bold text-orange-600">${consignesFiltrees.filter(c => c.niveau === 'Particuli√®re').length}</div>
                <div class="text-xs text-orange-600">Particuli√®res</div>
            </div>
            <div class="stat-card bg-blue-50">
                <div class="text-2xl font-bold text-blue-600">${consignesFiltrees.filter(c => c.niveau !== 'Particuli√®re').length}</div>
                <div class="text-xs text-blue-600">Permanentes/Autres</div>
            </div>
        </div>
        
        <div class="card p-4 space-y-4">
            ${consignesFiltrees.length ? consignesFiltrees.map(c => renderConsigneCard(c, canManage)).join('') : '<p class="text-gray-500 text-center py-8">Aucune consigne</p>'}
        </div>
    `;
}

function renderConsigneCard(c, canManage) {
    const couleur = c.niveau === 'Particuli√®re' ? 'orange' : 'blue';
    const prioriteClass = c.priorite === 'Haute' || c.priorite === 'Urgente' ? 'badge-danger' : 'badge-gray';
    
    return `
        <div class="p-4 bg-${couleur}-50 rounded-xl border-l-4 border-${couleur}-500">
            <div class="flex items-start justify-between gap-2 mb-2">
                <div class="flex items-center gap-2 flex-wrap">
                    <span class="badge ${c.niveau === 'Particuli√®re' ? 'badge-warning' : 'badge-info'}">${c.niveau}</span>
                    <span class="badge ${prioriteClass}">${c.priorite || 'Normale'}</span>
                    <span class="badge badge-purple">${c.destinataire}</span>
                </div>
                ${canManage ? `
                    <div class="flex gap-1 no-print">
                        <button onclick="modifierConsigne(${c.id})" class="btn btn-icon btn-sm btn-secondary"><i class="fas fa-edit"></i></button>
                        <button onclick="supprimerConsigne(${c.id})" class="btn btn-icon btn-sm btn-danger"><i class="fas fa-trash"></i></button>
                    </div>
                ` : ''}
            </div>
            <div class="font-semibold mb-1">${c.titre}</div>
            <p class="text-sm text-gray-600">${c.contenu.substring(0, 150)}${c.contenu.length > 150 ? '...' : ''}</p>
            ${c.dateFin ? `<div class="text-xs text-gray-500 mt-2">Jusqu'au ${formatDate(c.dateFin)}</div>` : ''}
            <button onclick="voirConsigne(${c.id})" class="text-${couleur}-600 text-sm mt-2 hover:underline no-print">
                <i class="fas fa-eye mr-1"></i>Voir d√©tails
            </button>
        </div>
    `;
}

function voirConsigne(id) {
    const c = DB.consignes.find(x => x.id === id);
    if (!c) return;
    
    showModal('D√©tails Consigne', `
        <div class="space-y-4">
            <div class="flex items-center gap-2 flex-wrap">
                <span class="badge ${c.niveau === 'Particuli√®re' ? 'badge-warning' : 'badge-info'}">${c.niveau}</span>
                <span class="badge ${c.priorite === 'Haute' || c.priorite === 'Urgente' ? 'badge-danger' : 'badge-gray'}">${c.priorite || 'Normale'}</span>
                <span class="badge badge-purple">${c.destinataire}</span>
            </div>
            
            <h3 class="text-xl font-bold">${c.titre}</h3>
            
            <div class="bg-gray-50 p-4 rounded-xl whitespace-pre-line text-sm">${c.contenu}</div>
            
            <div class="grid grid-cols-2 gap-4 text-sm">
                <div class="bg-gray-50 p-3 rounded-lg">
                    <div class="text-xs text-gray-500">D√©but</div>
                    <div class="font-medium">${c.dateDebut ? formatDate(c.dateDebut) : '-'}</div>
                </div>
                <div class="bg-gray-50 p-3 rounded-lg">
                    <div class="text-xs text-gray-500">Fin</div>
                    <div class="font-medium">${c.dateFin ? formatDate(c.dateFin) : 'Ind√©termin√©e'}</div>
                </div>
            </div>
        </div>
    `, null, 'Fermer');
}

function showModalConsigne() {
    const niveaux = ['Particuli√®re', 'Permanente', 'Temporaire'];
    const destinataires = ['Tout le monde', 'Chef de poste', '√âquipiers'];
    const priorites = ['Basse', 'Normale', 'Haute', 'Urgente'];
    
    showModal('Nouvelle Consigne', `
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-semibold mb-2">Titre *</label>
                <input type="text" id="consTitre" class="input" placeholder="Titre de la consigne">
            </div>
            <div class="grid grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-semibold mb-2">Niveau</label>
                    <select id="consNiveau" class="input">${niveaux.map(n => `<option>${n}</option>`).join('')}</select>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Destinataire</label>
                    <select id="consDest" class="input">${destinataires.map(d => `<option>${d}</option>`).join('')}</select>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Priorit√©</label>
                    <select id="consPrio" class="input">${priorites.map(p => `<option ${p === 'Normale' ? 'selected' : ''}>${p}</option>`).join('')}</select>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-semibold mb-2">Date d√©but</label>
                    <input type="date" id="consDateDebut" class="input" value="${new Date().toISOString().split('T')[0]}">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Date fin (optionnel)</label>
                    <input type="date" id="consDateFin" class="input">
                </div>
            </div>
            <div>
                <label class="block text-sm font-semibold mb-2">Contenu *</label>
                <textarea id="consContenu" class="input" rows="5" placeholder="D√©tails de la consigne..."></textarea>
            </div>
        </div>
    `, () => {
        const titre = document.getElementById('consTitre').value.trim();
        const contenu = document.getElementById('consContenu').value.trim();
        
        if (!titre || !contenu) return showToast('Remplissez tous les champs obligatoires', 'error');
        
        DB.consignes.push({
            id: genId(),
            titre,
            niveau: document.getElementById('consNiveau').value,
            destinataire: document.getElementById('consDest').value,
            priorite: document.getElementById('consPrio').value,
            contenu,
            dateDebut: document.getElementById('consDateDebut').value,
            dateFin: document.getElementById('consDateFin').value || null,
            active: true
        });
        
        addMainCourante('Consigne', `Cr√©ation: ${titre}`, currentUser?.id);
        sauvegarderVersFirebase();
        
        closeModal();
        showToast('‚úÖ Consigne cr√©√©e');
        navigate('consignes');
    });
}

function modifierConsigne(id) {
    const c = DB.consignes.find(x => x.id === id);
    if (!c) return;
    
    const niveaux = ['Particuli√®re', 'Permanente', 'Temporaire'];
    const destinataires = ['Tout le monde', 'Chef de poste', '√âquipiers'];
    const priorites = ['Basse', 'Normale', 'Haute', 'Urgente'];
    
    showModal('Modifier Consigne', `
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-semibold mb-2">Titre *</label>
                <input type="text" id="consTitreEdit" class="input" value="${c.titre}">
            </div>
            <div class="grid grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-semibold mb-2">Niveau</label>
                    <select id="consNiveauEdit" class="input">${niveaux.map(n => `<option ${c.niveau === n ? 'selected' : ''}>${n}</option>`).join('')}</select>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Destinataire</label>
                    <select id="consDestEdit" class="input">${destinataires.map(d => `<option ${c.destinataire === d ? 'selected' : ''}>${d}</option>`).join('')}</select>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Priorit√©</label>
                    <select id="consPrioEdit" class="input">${priorites.map(p => `<option ${c.priorite === p ? 'selected' : ''}>${p}</option>`).join('')}</select>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-semibold mb-2">Date d√©but</label>
                    <input type="date" id="consDateDebutEdit" class="input" value="${c.dateDebut || ''}">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Date fin</label>
                    <input type="date" id="consDateFinEdit" class="input" value="${c.dateFin || ''}">
                </div>
            </div>
            <div>
                <label class="block text-sm font-semibold mb-2">Contenu *</label>
                <textarea id="consContenuEdit" class="input" rows="5">${c.contenu}</textarea>
            </div>
        </div>
    `, () => {
        const titre = document.getElementById('consTitreEdit').value.trim();
        const contenu = document.getElementById('consContenuEdit').value.trim();
        
        if (!titre || !contenu) return showToast('Remplissez tous les champs', 'error');
        
        c.titre = titre;
        c.niveau = document.getElementById('consNiveauEdit').value;
        c.destinataire = document.getElementById('consDestEdit').value;
        c.priorite = document.getElementById('consPrioEdit').value;
        c.contenu = contenu;
        c.dateDebut = document.getElementById('consDateDebutEdit').value;
        c.dateFin = document.getElementById('consDateFinEdit').value || null;
        
        addMainCourante('Consigne', `Modification: ${titre}`, currentUser?.id);
        sauvegarderVersFirebase();
        
        closeModal();
        showToast('‚úÖ Consigne modifi√©e');
        navigate('consignes');
    });
}

function supprimerConsigne(id) {
    showConfirm('Supprimer cette consigne ?', () => {
        const c = DB.consignes.find(x => x.id === id);
        DB.consignes = DB.consignes.filter(x => x.id !== id);
        if (c) addMainCourante('Consigne', `Suppression: ${c.titre}`, currentUser?.id);
        sauvegarderVersFirebase();
        closeModal();
        showToast('üóëÔ∏è Consigne supprim√©e');
        navigate('consignes');
    });
}

// ==================== AGENTS ====================

function renderAgents() {
    const qualifications = [...new Set(DB.agents.map(a => a.qualification))];
    
    let agentsFiltres = DB.agents.filter(a => {
        const matchTexte = !filtresAgents.texte || 
            `${a.prenom} ${a.nom}`.toLowerCase().includes(filtresAgents.texte.toLowerCase()) ||
            (a.email || '').toLowerCase().includes(filtresAgents.texte.toLowerCase());
        const matchQualif = !filtresAgents.qualification || a.qualification === filtresAgents.qualification;
        return matchTexte && matchQualif;
    }).sort((a, b) => {
        const ordre = { 'Administrateur': 0, 'SSIAP 3': 1, 'SSIAP 2': 2, 'SSIAP 1': 3 };
        return (ordre[a.qualification] ?? 4) - (ordre[b.qualification] ?? 4);
    });
    
    return `
        <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
            <h1 class="text-2xl font-bold text-gray-800">
                <i class="fas fa-users mr-2 text-primary-500"></i>Agents
            </h1>
            <div class="flex gap-2 no-print">
                <button onclick="showModalAgent()" class="btn btn-primary">
                    <i class="fas fa-plus mr-2"></i>Nouveau
                </button>
                <button onclick="window.print()" class="btn btn-primary">
                    <i class="fas fa-print mr-2"></i>Imprimer
                </button>
            </div>
        </div>
        
        <div class="search-filters no-print">
            <input type="text" class="input" placeholder="üîç Rechercher nom, email..." value="${filtresAgents.texte}" 
                onchange="filtresAgents.texte = this.value; navigate('agents')">
            <select class="input" onchange="filtresAgents.qualification = this.value; navigate('agents')">
                <option value="">Toutes qualifications</option>
                ${qualifications.map(q => `<option value="${q}" ${filtresAgents.qualification === q ? 'selected' : ''}>${q}</option>`).join('')}
            </select>
            <button onclick="filtresAgents = {texte:'', qualification:''}; navigate('agents')" class="btn btn-secondary btn-sm">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="card">
            <div class="overflow-x-auto">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Agent</th>
                            <th>Qualification</th>
                            <th>T√©l√©phone</th>
                            <th>Statut</th>
                            <th class="no-print">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${agentsFiltres.map(a => `
                            <tr>
                                <td>
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-xl gradient-header flex items-center justify-center text-white font-semibold no-print">
                                            ${a.prenom?.[0] || ''}${a.nom?.[0] || ''}
                                        </div>
                                        <div>
                                            <div class="font-medium">${a.prenom} ${a.nom}</div>
                                            <div class="text-xs text-gray-500">${a.email || ''}</div>
                                        </div>
                                    </div>
                                </td>
                                <td><span class="badge badge-info">${a.qualification}</span></td>
                                <td class="text-sm">${a.telephone || '-'}</td>
                                <td><span class="badge ${a.actif ? 'badge-success' : 'badge-danger'}">${a.actif ? 'Actif' : 'Inactif'}</span></td>
                                <td class="no-print">
                                    <div class="flex gap-1">
                                        <button onclick="voirAgent(${a.id})" class="btn btn-icon btn-secondary btn-sm" title="Voir">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button onclick="modifierAgent(${a.id})" class="btn btn-icon btn-secondary btn-sm" title="Modifier">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

function voirAgent(id) {
    const a = DB.agents.find(x => x.id === id);
    if (!a) return;
    
    const pin = obtenirCodePin(a);
    
    showModal('Fiche Agent', `
        <div class="space-y-4">
            <div class="flex items-center gap-4 mb-4">
                <div class="w-16 h-16 rounded-xl gradient-header flex items-center justify-center text-white text-2xl font-semibold">
                    ${a.prenom[0]}${a.nom[0]}
                </div>
                <div>
                    <div class="text-xl font-bold">${a.prenom} ${a.nom}</div>
                    <div class="flex gap-2 mt-1">
                        <span class="badge badge-info">${a.qualification}</span>
                        <span class="badge ${a.actif ? 'badge-success' : 'badge-danger'}">${a.actif ? 'Actif' : 'Inactif'}</span>
                    </div>
                </div>
            </div>
            
            <div class="bg-blue-50 p-4 rounded-lg">
                <div class="text-sm font-semibold text-blue-700">Code PIN</div>
                <div class="text-2xl font-mono font-bold text-blue-600">${pin}</div>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-gray-50 p-3 rounded-lg">
                    <div class="text-xs text-gray-500">Email</div>
                    <div class="font-medium text-sm">${a.email || '-'}</div>
                </div>
                <div class="bg-gray-50 p-3 rounded-lg">
                    <div class="text-xs text-gray-500">T√©l√©phone</div>
                    <div class="font-medium">${a.telephone || '-'}</div>
                </div>
                <div class="bg-gray-50 p-3 rounded-lg">
                    <div class="text-xs text-gray-500">Entreprise</div>
                    <div class="font-medium">${a.entreprise || '-'}</div>
                </div>
                <div class="bg-gray-50 p-3 rounded-lg">
                    <div class="text-xs text-gray-500">D√©but contrat</div>
                    <div class="font-medium">${a.dateDebutContrat ? formatDate(a.dateDebutContrat) : '-'}</div>
                </div>
            </div>
        </div>
    `, null, 'Fermer');
}

function showModalAgent() {
    showModal('Nouvel Agent', `
        <div class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-semibold mb-2">Pr√©nom *</label>
                    <input type="text" id="agentPrenom" class="input">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Nom *</label>
                    <input type="text" id="agentNom" class="input">
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-semibold mb-2">Qualification</label>
                    <select id="agentQualif" class="input">
                        <option>SSIAP 1</option>
                        <option>SSIAP 2</option>
                        <option>SSIAP 3</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Entreprise</label>
                    <input type="text" id="agentEntr" class="input" value="SecuriPlus">
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-semibold mb-2">Email</label>
                    <input type="email" id="agentEmail" class="input">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">T√©l√©phone</label>
                    <input type="tel" id="agentTel" class="input">
                </div>
            </div>
            <div>
                <label class="block text-sm font-semibold mb-2">D√©but contrat *</label>
                <input type="date" id="agentDebut" class="input" value="${new Date().toISOString().split('T')[0]}">
                <p class="text-xs text-gray-500 mt-1">Le code PIN sera g√©n√©r√© √† partir de cette date</p>
            </div>
        </div>
    `, () => {
        const prenom = document.getElementById('agentPrenom').value.trim();
        const nom = document.getElementById('agentNom').value.trim();
        const dateDebutContrat = document.getElementById('agentDebut').value;
        
        if (!prenom || !nom || !dateDebutContrat) return showToast('Remplissez les champs obligatoires', 'error');
        
        const newAgent = {
            id: genId(),
            prenom,
            nom,
            qualification: document.getElementById('agentQualif').value,
            entreprise: document.getElementById('agentEntr').value,
            email: document.getElementById('agentEmail').value,
            telephone: document.getElementById('agentTel').value,
            dateDebutContrat,
            actif: true
        };
        
        DB.agents.push(newAgent);
        sauvegarderVersFirebase();
        
        closeModal();
        showToast(`‚úÖ Agent cr√©√© - PIN: ${genererCodePin(dateDebutContrat)}`);
        initLogin();
        navigate('agents');
    });
}

function modifierAgent(id) {
    const a = DB.agents.find(x => x.id === id);
    if (!a) return;
    
    const qualifications = ['SSIAP 1', 'SSIAP 2', 'SSIAP 3'];
    
    showModal('Modifier Agent', `
        <div class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-semibold mb-2">Pr√©nom *</label>
                    <input type="text" id="agentPrenomEdit" class="input" value="${a.prenom}">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Nom *</label>
                    <input type="text" id="agentNomEdit" class="input" value="${a.nom}">
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-semibold mb-2">Qualification</label>
                    <select id="agentQualifEdit" class="input">
                        ${qualifications.map(q => `<option ${a.qualification === q ? 'selected' : ''}>${q}</option>`).join('')}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Statut</label>
                    <select id="agentActifEdit" class="input">
                        <option value="true" ${a.actif ? 'selected' : ''}>Actif</option>
                        <option value="false" ${!a.actif ? 'selected' : ''}>Inactif</option>
                    </select>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-semibold mb-2">Email</label>
                    <input type="email" id="agentEmailEdit" class="input" value="${a.email || ''}">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">T√©l√©phone</label>
                    <input type="tel" id="agentTelEdit" class="input" value="${a.telephone || ''}">
                </div>
            </div>
            <div>
                <label class="block text-sm font-semibold mb-2">Entreprise</label>
                <input type="text" id="agentEntrEdit" class="input" value="${a.entreprise || ''}">
            </div>
        </div>
    `, () => {
        const prenom = document.getElementById('agentPrenomEdit').value.trim();
        const nom = document.getElementById('agentNomEdit').value.trim();
        
        if (!prenom || !nom) return showToast('Pr√©nom et nom requis', 'error');
        
        a.prenom = prenom;
        a.nom = nom;
        a.qualification = document.getElementById('agentQualifEdit').value;
        a.actif = document.getElementById('agentActifEdit').value === 'true';
        a.email = document.getElementById('agentEmailEdit').value;
        a.telephone = document.getElementById('agentTelEdit').value;
        a.entreprise = document.getElementById('agentEntrEdit').value;
        
        sauvegarderVersFirebase();
        closeModal();
        showToast('‚úÖ Agent modifi√©');
        initLogin();
        navigate('agents');
    });
}

// ==================== ADMINISTRATION ====================

function renderAdministration() {
    const tabs = [
        { id: 'sync', label: 'Synchronisation', icon: 'fa-cloud' },
        { id: 'qrcodes', label: 'QR Codes', icon: 'fa-qrcode' },
        { id: 'etablissement', label: '√âtablissement', icon: 'fa-building' },
        { id: 'donnees', label: 'Donn√©es', icon: 'fa-database' }
    ];
    
    return `
        <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
            <h1 class="text-2xl font-bold text-gray-800">
                <i class="fas fa-cogs mr-2 text-primary-500"></i>Administration
            </h1>
            <button onclick="window.print()" class="btn btn-primary no-print">
                <i class="fas fa-print mr-2"></i>Imprimer
            </button>
        </div>
        
        <div class="search-filters no-print">
            <select class="input" onchange="adminTab = this.value; navigate('administration')">
                ${tabs.map(t => `<option value="${t.id}" ${adminTab === t.id ? 'selected' : ''}><i class="fas ${t.icon}"></i> ${t.label}</option>`).join('')}
            </select>
        </div>
        
        <div class="flex flex-wrap gap-2 mb-6 no-print">
            ${tabs.map(t => `
                <button onclick="adminTab='${t.id}'; navigate('administration')" class="btn ${adminTab === t.id ? 'btn-primary' : 'btn-secondary'}">
                    <i class="fas ${t.icon} mr-2"></i>${t.label}
                </button>
            `).join('')}
        </div>
        
        <div class="card p-6">
            ${adminTab === 'sync' ? renderAdminSync() : ''}
            ${adminTab === 'qrcodes' ? renderAdminQRCodes() : ''}
            ${adminTab === 'etablissement' ? renderAdminEtablissement() : ''}
            ${adminTab === 'donnees' ? renderAdminDonnees() : ''}
        </div>
    `;
}

function renderAdminSync() {
    return `
        <div class="space-y-6">
            <h2 class="text-lg font-bold"><i class="fas fa-cloud mr-2"></i>Synchronisation Firebase</h2>
            
            <div class="grid grid-cols-2 gap-4">
                <button onclick="sauvegarderVersFirebase().then(() => showToast('‚úÖ Sauvegard√©!'))" class="btn btn-success py-4 justify-center">
                    <i class="fas fa-cloud-upload-alt mr-2"></i>Envoyer vers Cloud
                </button>
                <button onclick="chargerDepuisFirebase(() => { showToast('‚úÖ Charg√©!'); navigate('administration'); })" class="btn btn-primary py-4 justify-center">
                    <i class="fas fa-cloud-download-alt mr-2"></i>R√©cup√©rer du Cloud
                </button>
            </div>
            
            <div class="border-t pt-6">
                <h2 class="text-lg font-bold mb-4">Statistiques</h2>
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 text-sm">
                    <div class="bg-gray-50 p-4 rounded-lg text-center">
                        <div class="text-2xl font-bold text-blue-600">${DB.agents.length}</div>
                        <div class="text-gray-500">Agents</div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg text-center">
                        <div class="text-2xl font-bold text-orange-600">${DB.materiels.length}</div>
                        <div class="text-gray-500">Mat√©riels</div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg text-center">
                        <div class="text-2xl font-bold text-green-600">${DB.rondes.length}</div>
                        <div class="text-gray-500">Rondes</div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg text-center">
                        <div class="text-2xl font-bold text-purple-600">${DB.mainCourante.length}</div>
                        <div class="text-gray-500">Main courante</div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function renderAdminQRCodes() {
    let allPoints = [];
    
    configEtablissement.batiments.forEach(bat => {
        bat.secteurs.forEach(sect => {
            sect.zones.forEach(zone => {
                const qr = `ZONE-${bat.id}-${sect.id}-${zone.toUpperCase().replace(/[^A-Z0-9]/g, '')}`;
                allPoints.push({ type: 'Zone', nom: zone, chemin: `${bat.nom} > ${sect.nom}`, qrCode: qr });
            });
        });
    });
    
    DB.materiels.forEach(m => {
        allPoints.push({ type: m.type, nom: m.nom, chemin: m.localisation || '', qrCode: m.codeQR || `MAT-${m.id}` });
    });
    
    setTimeout(() => genererQRCodesAdmin(), 300);
    
    return `
        <div class="space-y-6">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <h2 class="text-lg font-bold"><i class="fas fa-qrcode mr-2"></i>QR Codes (${allPoints.length})</h2>
                <button onclick="imprimerQRCodes()" class="btn btn-primary">
                    <i class="fas fa-print mr-2"></i>Imprimer tout
                </button>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div class="stat-card bg-blue-50">
                    <div class="text-2xl font-bold text-blue-600">${allPoints.filter(p => p.type === 'Zone').length}</div>
                    <div class="text-xs">Zones</div>
                </div>
                <div class="stat-card bg-orange-50">
                    <div class="text-2xl font-bold text-orange-600">${allPoints.filter(p => p.type !== 'Zone').length}</div>
                    <div class="text-xs">Mat√©riels</div>
                </div>
            </div>
            
            <div class="qr-grid" id="qrCodesContainer">
                ${allPoints.slice(0, 12).map((p, i) => `
                    <div class="qr-card">
                        <div class="text-xs mb-2">
                            <span class="badge ${p.type === 'Zone' ? 'badge-info' : 'badge-warning'}">${p.type}</span>
                        </div>
                        <div id="qr-${i}" class="mb-2 flex justify-center min-h-[80px]"></div>
                        <div class="font-semibold text-sm">${p.nom}</div>
                        <div class="text-xs text-gray-500 truncate">${p.chemin}</div>
                        <div class="text-xs text-gray-400 font-mono mt-1 truncate">${p.qrCode}</div>
                    </div>
                `).join('')}
            </div>
            
            ${allPoints.length > 12 ? `
                <p class="text-center text-gray-500 text-sm">
                    Et ${allPoints.length - 12} autres... Utilisez "Imprimer tout" pour voir tous les QR codes.
                </p>
            ` : ''}
        </div>
    `;
}

function genererQRCodesAdmin() {
    if (typeof QRCode === 'undefined') return;
    
    let allPoints = [];
    
    configEtablissement.batiments.forEach(bat => {
        bat.secteurs.forEach(sect => {
            sect.zones.forEach(zone => {
                const qr = `ZONE-${bat.id}-${sect.id}-${zone.toUpperCase().replace(/[^A-Z0-9]/g, '')}`;
                allPoints.push({ qrCode: qr });
            });
        });
    });
    
    DB.materiels.forEach(m => {
        allPoints.push({ qrCode: m.codeQR || `MAT-${m.id}` });
    });
    
    allPoints.slice(0, 12).forEach((p, i) => {
        const container = document.getElementById(`qr-${i}`);
        if (container) {
            container.innerHTML = '';
            try {
                new QRCode(container, { 
                    text: p.qrCode, 
                    width: 80, 
                    height: 80,
                    correctLevel: QRCode.CorrectLevel.M
                });
            } catch(e) {
                container.innerHTML = `<span class="text-gray-400 text-xs font-mono">${p.qrCode}</span>`;
            }
        }
    });
}

function imprimerQRCodes() {
    let allPoints = [];
    
    configEtablissement.batiments.forEach(bat => {
        bat.secteurs.forEach(sect => {
            sect.zones.forEach(zone => {
                const qr = `ZONE-${bat.id}-${sect.id}-${zone.toUpperCase().replace(/[^A-Z0-9]/g, '')}`;
                allPoints.push({ type: 'Zone', nom: zone, chemin: `${bat.nom} > ${sect.nom}`, qrCode: qr });
            });
        });
    });
    
    DB.materiels.forEach(m => {
        allPoints.push({ type: m.type, nom: m.nom, chemin: m.localisation || '', qrCode: m.codeQR || `MAT-${m.id}` });
    });
    
    const pw = window.open('', '_blank');
    pw.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>QR Codes SSIAP Patrol</title>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"><\/script>
            <style>
                body { font-family: Arial, sans-serif; padding: 20px; font-size: 11px; }
                h1 { text-align: center; color: #4f46e5; margin-bottom: 10px; font-size: 16px; }
                .subtitle { text-align: center; color: #666; margin-bottom: 20px; font-size: 11px; }
                .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
                .card { border: 1px solid #ccc; padding: 10px; text-align: center; page-break-inside: avoid; border-radius: 6px; }
                .card h3 { margin: 6px 0 2px; font-size: 10px; }
                .card p { margin: 0; font-size: 8px; color: #666; }
                .card .code { font-family: monospace; font-size: 7px; color: #999; margin-top: 3px; word-break: break-all; }
                .badge { font-size: 8px; padding: 2px 5px; border-radius: 8px; display: inline-block; margin-bottom: 4px; }
                .badge-zone { background: #dbeafe; color: #1d4ed8; }
                .badge-mat { background: #fef3c7; color: #d97706; }
                @media print { body { padding: 5px; } .grid { gap: 8px; } }
            </style>
        </head>
        <body>
            <h1>üîí QR Codes - SSIAP Patrol</h1>
            <p class="subtitle">${allPoints.length} QR codes ‚Ä¢ ${new Date().toLocaleDateString('fr-FR')}</p>
            <div class="grid">
                ${allPoints.map((p, i) => `
                    <div class="card">
                        <span class="badge ${p.type === 'Zone' ? 'badge-zone' : 'badge-mat'}">${p.type}</span>
                        <div id="qr${i}"></div>
                        <h3>${p.nom}</h3>
                        <p>${p.chemin}</p>
                        <div class="code">${p.qrCode}</div>
                    </div>
                `).join('')}
            </div>
            <script>
                ${allPoints.map((p, i) => `try { new QRCode(document.getElementById('qr${i}'), { text: '${p.qrCode}', width: 60, height: 60 }); } catch(e) {}`).join('\n')}
                setTimeout(() => window.print(), 1500);
            <\/script>
        </body>
        </html>
    `);
}

function renderAdminEtablissement() {
    return `
        <div class="space-y-6">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-bold"><i class="fas fa-building mr-2"></i>Structure de l'√©tablissement</h2>
                <button onclick="ajouterBatiment()" class="btn btn-primary btn-sm">
                    <i class="fas fa-plus mr-2"></i>B√¢timent
                </button>
            </div>
            
            <div class="space-y-4">
                ${configEtablissement.batiments.map(bat => `
                    <div class="border rounded-xl overflow-hidden">
                        <div class="bg-blue-50 p-4 flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-building text-blue-600 text-xl"></i>
                                <div>
                                    <div class="font-bold">${bat.nom}</div>
                                    <div class="text-sm text-gray-500">${bat.secteurs.length} secteur(s), ${bat.secteurs.reduce((acc, s) => acc + s.zones.length, 0)} zone(s)</div>
                                </div>
                            </div>
                            <div class="flex gap-2 no-print">
                                <button onclick="ajouterSecteur('${bat.id}')" class="btn btn-sm btn-success" title="Ajouter secteur">
                                    <i class="fas fa-plus"></i>
                                </button>
                                <button onclick="supprimerBatiment('${bat.id}')" class="btn btn-sm btn-danger" title="Supprimer">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="p-4 space-y-3">
                            ${bat.secteurs.map(sect => `
                                <div class="bg-gray-50 p-3 rounded-lg">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="font-semibold">
                                            <i class="fas fa-layer-group text-green-600 mr-2"></i>${sect.nom}
                                        </div>
                                        <div class="flex gap-1 no-print">
                                            <button onclick="ajouterZone('${bat.id}', '${sect.id}')" class="btn btn-icon btn-sm btn-success" title="Ajouter zone">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                            <button onclick="supprimerSecteur('${bat.id}', '${sect.id}')" class="btn btn-icon btn-sm btn-danger" title="Supprimer">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="flex flex-wrap gap-2">
                                        ${sect.zones.map(zone => `
                                            <span class="badge badge-info">
                                                ${zone}
                                                <button onclick="supprimerZone('${bat.id}', '${sect.id}', '${zone}')" class="ml-1 text-red-500 hover:text-red-700 no-print">&times;</button>
                                            </span>
                                        `).join('')}
                                        ${sect.zones.length === 0 ? '<span class="text-gray-400 text-sm">Aucune zone</span>' : ''}
                                    </div>
                                </div>
                            `).join('')}
                            ${bat.secteurs.length === 0 ? '<p class="text-gray-400 text-sm text-center">Aucun secteur</p>' : ''}
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
}

function ajouterBatiment() {
    showModal('Nouveau B√¢timent', `
        <div>
            <label class="block text-sm font-semibold mb-2">Nom du b√¢timent *</label>
            <input type="text" id="batNom" class="input" placeholder="Ex: B√¢timent C">
        </div>
    `, () => {
        const nom = document.getElementById('batNom').value.trim();
        if (!nom) return showToast('Nom requis', 'error');
        
        configEtablissement.batiments.push({ id: 'bat' + genId(), nom, secteurs: [] });
        sauvegarderVersFirebase();
        closeModal();
        showToast('‚úÖ B√¢timent ajout√©');
        navigate('administration');
    });
}

function supprimerBatiment(batId) {
    showConfirm('Supprimer ce b√¢timent et tous ses secteurs/zones ?', () => {
        configEtablissement.batiments = configEtablissement.batiments.filter(b => b.id !== batId);
        sauvegarderVersFirebase();
        closeModal();
        showToast('üóëÔ∏è B√¢timent supprim√©');
        navigate('administration');
    });
}

function ajouterSecteur(batId) {
    showModal('Nouveau Secteur', `
        <div>
            <label class="block text-sm font-semibold mb-2">Nom du secteur *</label>
            <input type="text" id="sectNom" class="input" placeholder="Ex: 3√®me √©tage">
        </div>
    `, () => {
        const nom = document.getElementById('sectNom').value.trim();
        if (!nom) return showToast('Nom requis', 'error');
        
        const bat = configEtablissement.batiments.find(b => b.id === batId);
        if (bat) {
            bat.secteurs.push({ id: batId + '-' + nom.toLowerCase().replace(/[^a-z0-9]/g, '-'), nom, zones: [] });
            sauvegarderVersFirebase();
        }
        closeModal();
        showToast('‚úÖ Secteur ajout√©');
        navigate('administration');
    });
}

function supprimerSecteur(batId, sectId) {
    showConfirm('Supprimer ce secteur et toutes ses zones ?', () => {
        const bat = configEtablissement.batiments.find(b => b.id === batId);
        if (bat) {
            bat.secteurs = bat.secteurs.filter(s => s.id !== sectId);
            sauvegarderVersFirebase();
        }
        closeModal();
        showToast('üóëÔ∏è Secteur supprim√©');
        navigate('administration');
    });
}

function ajouterZone(batId, sectId) {
    showModal('Nouvelle Zone', `
        <div>
            <label class="block text-sm font-semibold mb-2">Nom de la zone *</label>
            <input type="text" id="zoneNom" class="input" placeholder="Ex: Salle de r√©union">
        </div>
    `, () => {
        const nom = document.getElementById('zoneNom').value.trim();
        if (!nom) return showToast('Nom requis', 'error');
        
        const bat = configEtablissement.batiments.find(b => b.id === batId);
        const sect = bat?.secteurs.find(s => s.id === sectId);
        
        if (sect) {
            if (sect.zones.includes(nom)) return showToast('Zone existante', 'error');
            sect.zones.push(nom);
            sauvegarderVersFirebase();
        }
        closeModal();
        showToast('‚úÖ Zone ajout√©e');
        navigate('administration');
    });
}

function supprimerZone(batId, sectId, zoneNom) {
    const bat = configEtablissement.batiments.find(b => b.id === batId);
    const sect = bat?.secteurs.find(s => s.id === sectId);
    
    if (sect) {
        sect.zones = sect.zones.filter(z => z !== zoneNom);
        sauvegarderVersFirebase();
        showToast('üóëÔ∏è Zone supprim√©e');
        navigate('administration');
    }
}

function renderAdminDonnees() {
    return `
        <div class="space-y-6">
            <h2 class="text-lg font-bold"><i class="fas fa-database mr-2"></i>Gestion des donn√©es</h2>
            
            <div class="grid grid-cols-2 gap-4">
                <button onclick="exporterDonnees()" class="btn btn-success py-4 justify-center">
                    <i class="fas fa-download mr-2"></i>Exporter (JSON)
                </button>
                <button onclick="importerDonnees()" class="btn btn-primary py-4 justify-center">
                    <i class="fas fa-upload mr-2"></i>Importer
                </button>
            </div>
            
            <div class="border-t pt-6">
                <h3 class="text-lg font-bold text-red-600 mb-4">
                    <i class="fas fa-exclamation-triangle mr-2"></i>Zone danger
                </h3>
                <div class="space-y-3">
                    <button onclick="reinitialiserOperationnel()" class="btn btn-warning w-full justify-center">
                        <i class="fas fa-eraser mr-2"></i>R√©initialiser donn√©es op√©rationnelles
                    </button>
                    <p class="text-xs text-gray-500 text-center">Supprime rondes, √©v√©nements, main courante (conserve agents et mat√©riels)</p>
                </div>
            </div>
        </div>
    `;
}

function exporterDonnees() {
    const data = {
        version: '2.1',
        date: new Date().toISOString(),
        agents: DB.agents,
        materiels: DB.materiels,
        prisesPoste: DB.prisesPoste,
        rondes: DB.rondes,
        evenements: DB.evenements,
        mainCourante: DB.mainCourante,
        consignes: DB.consignes,
        configEtablissement,
        typesRondes
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `ssiap-patrol-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    
    showToast('üíæ Donn√©es export√©es');
}

function importerDonnees() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    
    input.onchange = e => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = event => {
            try {
                const data = JSON.parse(event.target.result);
                
                if (data.agents) DB.agents = data.agents;
                if (data.materiels) DB.materiels = data.materiels;
                if (data.prisesPoste) DB.prisesPoste = data.prisesPoste;
                if (data.rondes) DB.rondes = data.rondes;
                if (data.evenements) DB.evenements = data.evenements;
                if (data.mainCourante) DB.mainCourante = data.mainCourante;
                if (data.consignes) DB.consignes = data.consignes;
                if (data.configEtablissement) configEtablissement = data.configEtablissement;
                if (data.typesRondes) typesRondes = data.typesRondes;
                
                sauvegarderVersFirebase();
                showToast('‚úÖ Donn√©es import√©es');
                initLogin();
                navigate(currentView);
            } catch (err) {
                showToast('‚ùå Fichier invalide', 'error');
            }
        };
        reader.readAsText(file);
    };
    
    input.click();
}

function reinitialiserOperationnel() {
    showConfirm('‚ö†Ô∏è Supprimer toutes les rondes, √©v√©nements et la main courante ?\n\nCette action est irr√©versible.', () => {
        DB.prisesPoste = [];
        DB.rondes = [];
        DB.evenements = [];
        DB.mainCourante = [];
        
        sauvegarderVersFirebase();
        closeModal();
        showToast('üóëÔ∏è Donn√©es op√©rationnelles r√©initialis√©es');
        navigate('administration');
    });
}

// ==================== MODALS & TOASTS ====================

function showModal(title, content, onConfirm, confirmText = 'Confirmer') {
    modalConfirmCallback = onConfirm;
    
    document.getElementById('modalContainer').innerHTML = `
        <div class="modal-overlay" onclick="if(event.target === this) closeModal()">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="text-xl font-bold text-gray-800">${title}</h2>
                </div>
                <div class="modal-body">${content}</div>
                <div class="modal-footer">
                    <button onclick="closeModal()" class="btn btn-secondary">Annuler</button>
                    ${onConfirm ? `<button onclick="modalConfirmCallback?.()" class="btn btn-primary">${confirmText}</button>` : ''}
                </div>
            </div>
        </div>
    `;
}

function closeModal() { 
    document.getElementById('modalContainer').innerHTML = ''; 
    modalConfirmCallback = null; 
    arreterScanQR(); 
}

function showConfirm(message, onConfirm) { 
    showModal('Confirmation', `<p class="text-gray-600 whitespace-pre-line">${message}</p>`, onConfirm, 'Confirmer'); 
}

function showToast(message, type = 'success') {
    const colors = { 
        success: 'bg-green-500', 
        error: 'bg-red-500', 
        warning: 'bg-orange-500', 
        info: 'bg-blue-500' 
    };
    
    const toast = document.createElement('div');
    toast.className = `fixed top-20 left-1/2 transform -translate-x-1/2 ${colors[type]} text-white px-6 py-3 rounded-xl shadow-lg z-[200] fade-in`;
    toast.innerHTML = `<span>${message}</span>`;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.3s';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// ==================== INITIALISATION ====================

document.addEventListener('DOMContentLoaded', () => {
    console.log('üöÄ D√©marrage SSIAP Patrol v2.1');
    
    chargerDepuisFirebase(() => {
        initLogin();
        
        if (detecterModeRondier()) {
            afficherLoginRondier(false);
        }
        
        updateFirebaseStatus(firestoreEnabled);
    });
});

// Login avec Enter
document.addEventListener('keydown', e => { 
    if (e.key === 'Enter' && !document.getElementById('loginScreen')?.classList.contains('hidden')) {
        login();
    }
});
</script>
</body>
</html>
