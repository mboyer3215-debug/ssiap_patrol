<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SSIAP Patrol - Gestion PC Sécurité</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        :root {
            --primary-50: #f0f9ff; --primary-100: #e0f2fe; --primary-200: #bae6fd;
            --primary-300: #7dd3fc; --primary-400: #38bdf8; --primary-500: #0ea5e9;
            --primary-600: #0284c7; --primary-700: #0369a1; --primary-800: #075985;
            --gray-50: #f8fafc; --gray-100: #f1f5f9; --gray-200: #e2e8f0;
            --gray-300: #cbd5e1; --gray-400: #94a3b8; --gray-500: #64748b;
            --gray-600: #475569; --gray-700: #334155; --gray-800: #1e293b;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--gray-100); min-height: 100vh; padding-bottom: 80px; }
        .header { background: linear-gradient(135deg, var(--primary-600), var(--primary-800)); color: white; padding: 16px 20px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header-content { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .logo { font-size: 1.5rem; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        .logo i { font-size: 1.8rem; }
        .user-info { display: flex; align-items: center; gap: 12px; font-size: 0.9rem; }
        .user-avatar { width: 40px; height: 40px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .main-content { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .nav-bottom { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid var(--gray-200); display: flex; justify-content: space-around; padding: 8px 0; z-index: 100; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
        .nav-item { display: flex; flex-direction: column; align-items: center; padding: 8px 12px; color: var(--gray-500); text-decoration: none; font-size: 0.75rem; transition: all 0.2s; border-radius: 8px; cursor: pointer; }
        .nav-item:hover, .nav-item.active { color: var(--primary-600); background: var(--primary-50); }
        .nav-item i { font-size: 1.3rem; margin-bottom: 4px; }
        .card { background: white; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 16px; overflow: hidden; }
        .card-header { padding: 16px 20px; border-bottom: 1px solid var(--gray-100); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .card-body { padding: 20px; }
        .btn { padding: 10px 20px; border-radius: 10px; border: none; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s; font-size: 0.9rem; }
        .btn-primary { background: linear-gradient(135deg, var(--primary-500), var(--primary-600)); color: white; }
        .btn-primary:hover { background: linear-gradient(135deg, var(--primary-600), var(--primary-700)); transform: translateY(-1px); }
        .btn-secondary { background: var(--gray-200); color: var(--gray-700); }
        .btn-success { background: linear-gradient(135deg, #22c55e, #16a34a); color: white; }
        .btn-danger { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
        .btn-warning { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; }
        .btn-lg { padding: 14px 28px; font-size: 1rem; }
        .btn-icon { width: 40px; height: 40px; padding: 0; border-radius: 10px; }
        .input { width: 100%; padding: 12px 16px; border: 2px solid var(--gray-200); border-radius: 10px; font-size: 1rem; transition: all 0.2s; }
        .input:focus { outline: none; border-color: var(--primary-500); box-shadow: 0 0 0 3px var(--primary-100); }
        .badge { padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; display: inline-flex; align-items: center; gap: 4px; }
        .badge-success { background: #dcfce7; color: #16a34a; }
        .badge-warning { background: #fef3c7; color: #d97706; }
        .badge-danger { background: #fee2e2; color: #dc2626; }
        .badge-info { background: #dbeafe; color: #2563eb; }
        .stat-card { background: white; border-radius: 12px; padding: 16px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .stat-card i { font-size: 1.5rem; margin-bottom: 8px; }
        .stat-card .value { font-size: 1.8rem; font-weight: 700; }
        .stat-card .label { font-size: 0.8rem; color: var(--gray-500); margin-top: 4px; }
        .timeline { position: relative; padding-left: 24px; }
        .timeline::before { content: ''; position: absolute; left: 8px; top: 0; bottom: 0; width: 2px; background: var(--gray-200); }
        .timeline-item { position: relative; padding-bottom: 16px; }
        .timeline-item::before { content: ''; position: absolute; left: -20px; top: 4px; width: 12px; height: 12px; background: var(--primary-500); border-radius: 50%; border: 2px solid white; box-shadow: 0 0 0 2px var(--primary-200); }
        .timeline-item.anomalie::before { background: #f59e0b; box-shadow: 0 0 0 2px #fef3c7; }
        .timeline-item.termine::before { background: #22c55e; box-shadow: 0 0 0 2px #dcfce7; }
        .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
        @media (max-width: 768px) { .grid-3, .grid-4 { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 480px) { .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; } }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 20px; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal { background: white; border-radius: 20px; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; transform: scale(0.9); transition: all 0.3s; }
        .modal-overlay.active .modal { transform: scale(1); }
        .modal-header { padding: 20px; border-bottom: 1px solid var(--gray-100); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: white; z-index: 10; }
        .modal-body { padding: 20px; }
        .modal-footer { padding: 16px 20px; border-top: 1px solid var(--gray-100); display: flex; gap: 12px; justify-content: flex-end; position: sticky; bottom: 0; background: white; }
        .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: var(--gray-800); color: white; padding: 12px 24px; border-radius: 10px; z-index: 2000; opacity: 0; transition: opacity 0.3s; }
        .toast.show { opacity: 1; }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .zone-btn { padding: 16px; background: var(--gray-50); border: 2px solid var(--gray-200); border-radius: 12px; text-align: center; cursor: pointer; transition: all 0.2s; }
        .zone-btn:hover { border-color: var(--primary-400); background: var(--primary-50); }
        .zone-btn.checked { border-color: #22c55e; background: #dcfce7; }
        .zone-btn.anomalie { border-color: #f59e0b; background: #fef3c7; }
        .quick-actions { display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; margin-top: 20px; }
        .qr-scanner-container { position: relative; width: 100%; max-width: 300px; margin: 0 auto; }
        #qr-video { width: 100%; border-radius: 12px; }
        #qr-canvas { display: none; }
        .scanner-overlay { position: absolute; inset: 0; border: 3px solid var(--primary-500); border-radius: 12px; pointer-events: none; }
        .scanner-line { position: absolute; left: 0; right: 0; height: 2px; background: var(--primary-500); animation: scan 2s linear infinite; }
        @keyframes scan { 0% { top: 0; } 50% { top: 100%; } 100% { top: 0; } }
        .checklist-item { display: flex; align-items: flex-start; gap: 12px; padding: 12px; background: var(--gray-50); border-radius: 10px; margin-bottom: 8px; }
        .checklist-item input[type="checkbox"] { width: 20px; height: 20px; margin-top: 2px; }
        .agent-card { display: flex; align-items: center; gap: 12px; padding: 12px; border: 2px solid var(--gray-200); border-radius: 12px; cursor: pointer; transition: all 0.2s; }
        .agent-card:hover, .agent-card.selected { border-color: var(--primary-500); background: var(--primary-50); }
        .agent-avatar { width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; }
        .status-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }
        .status-dot.online { background: #22c55e; }
        .status-dot.offline { background: var(--gray-400); }
        .ronde-progress { background: var(--gray-200); height: 8px; border-radius: 4px; overflow: hidden; }
        .ronde-progress-bar { height: 100%; background: linear-gradient(90deg, var(--primary-500), #22c55e); transition: width 0.3s; }
        .tabs { display: flex; border-bottom: 2px solid var(--gray-200); margin-bottom: 20px; overflow-x: auto; }
        .tab { padding: 12px 20px; cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -2px; white-space: nowrap; transition: all 0.2s; }
        .tab:hover { background: var(--gray-50); }
        .tab.active { border-bottom-color: var(--primary-500); color: var(--primary-600); font-weight: 600; }
        .search-box { position: relative; }
        .search-box i { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--gray-400); }
        .search-box input { padding-left: 42px; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--gray-200); }
        th { background: var(--gray-50); font-weight: 600; font-size: 0.85rem; color: var(--gray-600); }
        tr:hover { background: var(--gray-50); }
        .photo-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; margin-top: 8px; }
        .photo-thumb { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 8px; cursor: pointer; }
        .sync-status { display: flex; align-items: center; gap: 6px; font-size: 0.8rem; padding: 6px 12px; background: var(--gray-100); border-radius: 20px; }
        .sync-status.synced { color: #16a34a; }
        .sync-status.pending { color: #d97706; }
        .sync-status.error { color: #dc2626; }
        .empty-state { text-align: center; padding: 40px 20px; color: var(--gray-500); }
        .empty-state i { font-size: 3rem; margin-bottom: 16px; opacity: 0.5; }
        .offline-banner { background: #fef3c7; color: #92400e; padding: 8px 16px; text-align: center; font-size: 0.85rem; }
        .print-only { display: none; }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block; }
            body { padding: 0; background: white; }
            .header, .nav-bottom { display: none; }
            .card { box-shadow: none; border: 1px solid #ddd; }
        }
        .space-y-4 > * + * { margin-top: 16px; }
        .space-y-2 > * + * { margin-top: 8px; }
        .space-y-6 > * + * { margin-top: 24px; }
        .text-xs { font-size: 0.75rem; }
        .text-sm { font-size: 0.875rem; }
        .text-lg { font-size: 1.125rem; }
        .text-xl { font-size: 1.25rem; }
        .text-2xl { font-size: 1.5rem; }
        .font-bold { font-weight: 700; }
        .font-semibold { font-weight: 600; }
        .text-gray-400 { color: var(--gray-400); }
        .text-gray-500 { color: var(--gray-500); }
        .text-gray-600 { color: var(--gray-600); }
        .qr-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; }
        .qr-card { background: white; border: 1px solid var(--gray-200); border-radius: 12px; padding: 12px; text-align: center; }
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content { display: none; position: absolute; right: 0; top: 100%; background: white; min-width: 200px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-radius: 12px; z-index: 100; overflow: hidden; }
        .dropdown-content.show { display: block; }
        .dropdown-item { padding: 12px 16px; cursor: pointer; transition: background 0.2s; display: flex; align-items: center; gap: 10px; }
        .dropdown-item:hover { background: var(--gray-50); }
        .alert { padding: 16px; border-radius: 12px; margin-bottom: 16px; }
        .alert-info { background: #dbeafe; color: #1e40af; }
        .alert-warning { background: #fef3c7; color: #92400e; }
        .alert-danger { background: #fee2e2; color: #991b1b; }
        .alert-success { background: #dcfce7; color: #166534; }
    </style>
</head>
<body>
    <div id="app"></div>
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modal-title">Modal</h3>
                <button onclick="closeModal()" class="btn btn-icon btn-secondary"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" id="modal-body"></div>
            <div class="modal-footer" id="modal-footer"></div>
        </div>
    </div>
    <div class="toast" id="toast"></div>

<script>
// ==================== CONFIGURATION ====================
const FIREBASE_CONFIG = {
    apiKey: "AIzaSyDqcTEKCNzXHAyt8sdMU0JGNeWbHipDCOE",
    authDomain: "ssiap-pro.firebaseapp.com",
    databaseURL: "https://ssiap-pro-default-rtdb.firebaseio.com",
    projectId: "ssiap-pro",
    storageBucket: "ssiap-pro.firebasestorage.app",
    messagingSenderId: "950341022498",
    appId: "1:950341022498:web:ef89ed85f09e17b7a09a6c"
};

const APP_CONFIG = {
    etablissement: "TOUR EUROPA",
    version: "3.0.0",
    syncInterval: 30000
};

// ==================== ÉTAT GLOBAL ====================
let currentUser = null;
let currentPage = 'accueil';
let rondeEnCours = null;
let syncStatus = 'synced';
let isOnline = navigator.onLine;
let firebase = null;
let database = null;
let adminTab = 'sync';

// Filtres
let filtresMainCourante = { type: '', agent: '', periode: 'today' };
let filtresRondes = { agent: '', statut: '', periode: 'all' };
let filtresMateriels = { type: '', statut: '', localisation: '' };
let filtresConsignes = { type: '', statut: '' };
let filtresQRCodes = { batiment: '', secteur: '', type: '' };
let filtresEtablissement = { batiment: '', secteur: '' };

// Configuration établissement
let configEtablissement = {
    batiments: [
        {
            id: 'bat-a',
            nom: 'Bâtiment A',
            secteurs: [
                { id: 'sect-1', nom: 'Secteur 1', zones: ['Zone 1A', 'Zone 1B', 'Zone 1C'] },
                { id: 'sect-2', nom: 'Secteur 2', zones: ['Zone 2A', 'Zone 2B'] }
            ]
        },
        {
            id: 'bat-b',
            nom: 'Bâtiment B',
            secteurs: [
                { id: 'sect-3', nom: 'Secteur 3', zones: ['Zone 3A', 'Zone 3B', 'Zone 3C'] }
            ]
        }
    ]
};

// Base de données locale
let DB = {
    agents: [
        { id: 'agent-1', nom: 'Martin', prenom: 'Jean', matricule: 'SSIAP-001', role: 'Chef d\'équipe', pin: '1234', statut: 'actif', couleur: '#3b82f6' },
        { id: 'agent-2', nom: 'Dubois', prenom: 'Marie', matricule: 'SSIAP-002', role: 'Agent SSIAP 2', pin: '5678', statut: 'actif', couleur: '#22c55e' },
        { id: 'agent-3', nom: 'Bernard', prenom: 'Pierre', matricule: 'SSIAP-003', role: 'Agent SSIAP 1', pin: '9012', statut: 'actif', couleur: '#f59e0b' }
    ],
    rondes: [],
    mainCourante: [],
    materiels: [
        { id: 'mat-1', type: 'Extincteur', nom: 'EXT-001', localisation: 'Bâtiment A > Secteur 1 > Zone 1A', statut: 'Opérationnel', derniereMaint: '2025-01-15', prochaineMaint: '2026-01-15', codeQR: 'EXT-001' },
        { id: 'mat-2', type: 'RIA', nom: 'RIA-001', localisation: 'Bâtiment A > Secteur 1 > Zone 1B', statut: 'Opérationnel', derniereMaint: '2025-02-01', prochaineMaint: '2026-02-01', codeQR: 'RIA-001' },
        { id: 'mat-3', type: 'BAES', nom: 'BAES-001', localisation: 'Bâtiment A > Secteur 2 > Zone 2A', statut: 'À vérifier', derniereMaint: '2024-06-15', prochaineMaint: '2025-06-15', codeQR: 'BAES-001' }
    ],
    consignes: [
        { id: 'cons-1', titre: 'Fermeture portes CF', description: 'Vérifier la fermeture de toutes les portes coupe-feu à 22h', type: 'permanent', statut: 'active', dateCreation: '2025-01-01' },
        { id: 'cons-2', titre: 'Livraison exceptionnelle', description: 'Livraison prévue quai B - autoriser accès camion XYZ', type: 'temporaire', statut: 'active', dateCreation: '2025-06-14', dateExpiration: '2025-06-14' }
    ],
    pointages: [],
    modeleRondes: []
};

// ==================== FIREBASE ====================
function initFirebase() {
    const script = document.createElement('script');
    script.src = 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js';
    script.onload = () => {
        const script2 = document.createElement('script');
        script2.src = 'https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js';
        script2.onload = () => {
            try {
                firebase = window.firebase;
                firebase.initializeApp(FIREBASE_CONFIG);
                database = firebase.database();
                chargerDepuisFirebase();
                setInterval(() => { if (isOnline) sauvegarderVersFirebase(); }, APP_CONFIG.syncInterval);
            } catch (e) { console.error('Erreur Firebase:', e); }
        };
        document.head.appendChild(script2);
    };
    document.head.appendChild(script);
}

function sauvegarderVersFirebase() {
    if (!database || !isOnline) { syncStatus = 'pending'; updateSyncUI(); return; }
    const data = { DB, configEtablissement, lastUpdate: new Date().toISOString() };
    database.ref('etablissements/' + APP_CONFIG.etablissement.replace(/[^a-zA-Z0-9]/g, '_')).set(data)
        .then(() => { syncStatus = 'synced'; updateSyncUI(); })
        .catch(e => { console.error('Erreur sync:', e); syncStatus = 'error'; updateSyncUI(); });
}

function chargerDepuisFirebase() {
    if (!database) return;
    database.ref('etablissements/' + APP_CONFIG.etablissement.replace(/[^a-zA-Z0-9]/g, '_')).once('value')
        .then(snapshot => {
            const data = snapshot.val();
            if (data) {
                if (data.DB) {
                    DB = { ...DB, ...data.DB };
                    DB.agents = data.DB.agents || DB.agents;
                    DB.rondes = data.DB.rondes || [];
                    DB.mainCourante = data.DB.mainCourante || [];
                    DB.materiels = data.DB.materiels || DB.materiels;
                    DB.consignes = data.DB.consignes || DB.consignes;
                    DB.pointages = data.DB.pointages || [];
                    DB.modeleRondes = data.DB.modeleRondes || [];
                }
                if (data.configEtablissement) configEtablissement = data.configEtablissement;
                render();
            }
            syncStatus = 'synced';
            updateSyncUI();
        })
        .catch(e => { console.error('Erreur chargement:', e); syncStatus = 'error'; updateSyncUI(); });
}

function updateSyncUI() {
    const el = document.getElementById('sync-status');
    if (el) {
        const icons = { synced: 'fa-cloud-check', pending: 'fa-cloud-arrow-up', error: 'fa-cloud-exclamation' };
        const texts = { synced: 'Synchronisé', pending: 'En attente...', error: 'Erreur sync' };
        el.className = `sync-status ${syncStatus}`;
        el.innerHTML = `<i class="fas ${icons[syncStatus] || 'fa-cloud'}"></i> ${texts[syncStatus] || ''}`;
    }
}

// ==================== UTILITAIRES ====================
const genId = () => 'id-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
const formatDate = d => d ? new Date(d).toLocaleDateString('fr-FR') : '-';
const formatTime = d => d ? new Date(d).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }) : '-';
const formatDateTime = d => d ? `${formatDate(d)} ${formatTime(d)}` : '-';

function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.style.background = type === 'error' ? '#dc2626' : type === 'warning' ? '#f59e0b' : '#22c55e';
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 3000);
}

function showModal(title, content, onConfirm, confirmText = 'Confirmer', cancelText = 'Annuler') {
    document.getElementById('modal-title').textContent = title;
    document.getElementById('modal-body').innerHTML = content;
    let footerHtml = `<button onclick="closeModal()" class="btn btn-secondary">${cancelText}</button>`;
    if (onConfirm) footerHtml += `<button onclick="window.modalConfirm()" class="btn btn-primary">${confirmText}</button>`;
    document.getElementById('modal-footer').innerHTML = footerHtml;
    window.modalConfirm = () => { onConfirm(); };
    document.getElementById('modal-overlay').classList.add('active');
}

function closeModal() {
    document.getElementById('modal-overlay').classList.remove('active');
}

function navigate(page) {
    currentPage = page;
    render();
    window.scrollTo(0, 0);
}

function addMainCourante(type, description, agentId, extra = {}) {
    const agent = DB.agents.find(a => a.id === agentId);
    const entree = { id: genId(), date: new Date().toISOString(), type, description, agent: agent ? `${agent.prenom} ${agent.nom}` : 'Système', agentId, ...extra };
    DB.mainCourante.unshift(entree);
    return entree;
}

function getStatutCouleurRonde(ronde) {
    if (!ronde.anomalies?.length) return 'green';
    if (ronde.anomalies.some(a => a.horsService)) return 'red';
    return 'orange';
}

function getBadgeClass(couleur) {
    return couleur === 'green' ? 'badge-success' : couleur === 'orange' ? 'badge-warning' : 'badge-danger';
}

function getMainCouranteBadgeClass(type) {
    if (['Alarme', 'Secours', 'Incident', 'Intrusion', 'Anomalie'].some(t => type.includes(t))) return 'badge-danger';
    if (['Terminé', 'Fin', 'OK'].some(t => type.includes(t))) return 'badge-success';
    if (['Prise', 'Départ', 'Ronde', 'En cours'].some(t => type.includes(t))) return 'badge-warning';
    return 'badge-info';
}

// ==================== AUTHENTIFICATION ====================
function renderLogin() {
    return `
        <div class="min-h-screen flex items-center justify-center p-4" style="min-height: calc(100vh - 200px);">
            <div class="card p-8 w-full max-w-md">
                <div class="text-center mb-8">
                    <i class="fas fa-shield-halved text-6xl text-primary-500 mb-4" style="color: var(--primary-500);"></i>
                    <h1 class="text-2xl font-bold">SSIAP Patrol</h1>
                    <p class="text-gray-500">${APP_CONFIG.etablissement}</p>
                </div>
                <div class="space-y-4">
                    <h3 class="font-semibold text-center">Sélectionnez votre profil</h3>
                    <div class="space-y-2" id="agents-list">
                        ${DB.agents.filter(a => a.statut === 'actif').map(agent => `
                            <div class="agent-card" onclick="selectAgent('${agent.id}')">
                                <div class="agent-avatar" style="background: ${agent.couleur}">${agent.prenom[0]}${agent.nom[0]}</div>
                                <div class="flex-1">
                                    <div class="font-semibold">${agent.prenom} ${agent.nom}</div>
                                    <div class="text-sm text-gray-500">${agent.role}</div>
                                </div>
                                <i class="fas fa-chevron-right text-gray-400"></i>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        </div>
    `;
}

function selectAgent(agentId) {
    const agent = DB.agents.find(a => a.id === agentId);
    if (!agent) return;
    showModal('Entrez votre code PIN', `
        <div class="text-center mb-4">
            <div class="agent-avatar mx-auto mb-2" style="background: ${agent.couleur}; width: 60px; height: 60px; font-size: 1.5rem;">${agent.prenom[0]}${agent.nom[0]}</div>
            <div class="font-semibold">${agent.prenom} ${agent.nom}</div>
        </div>
        <input type="password" id="pin-input" class="input text-center text-2xl tracking-widest" maxlength="4" placeholder="••••" autofocus>
        <p class="text-sm text-gray-500 text-center mt-2">Code par défaut: ${agent.pin}</p>
    `, () => {
        const pin = document.getElementById('pin-input').value;
        if (pin === agent.pin) {
            currentUser = agent;
            addMainCourante('Connexion', `Prise de service: ${agent.prenom} ${agent.nom}`, agent.id);
            sauvegarderVersFirebase();
            closeModal();
            navigate('accueil');
            showToast(`Bienvenue ${agent.prenom} !`);
        } else {
            showToast('Code PIN incorrect', 'error');
        }
    }, 'Valider');
    setTimeout(() => document.getElementById('pin-input')?.focus(), 300);
}

function logout() {
    if (currentUser) {
        addMainCourante('Déconnexion', `Fin de service: ${currentUser.prenom} ${currentUser.nom}`, currentUser.id);
        sauvegarderVersFirebase();
    }
    currentUser = null;
    rondeEnCours = null;
    navigate('accueil');
    showToast('Déconnexion réussie');
}

// ==================== PAGE ACCUEIL ====================
function renderAccueil() {
    const today = new Date().toDateString();
    const rondesToday = DB.rondes.filter(r => new Date(r.dateDebut).toDateString() === today);
    const anomaliesToday = rondesToday.reduce((acc, r) => acc + (r.anomalies?.length || 0), 0);
    const lastEvents = DB.mainCourante.slice(0, 5);
    const consignesActives = DB.consignes.filter(c => c.statut === 'active');
    const materielProbleme = DB.materiels.filter(m => m.statut !== 'Opérationnel');

    return `
        <div class="space-y-6">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Bonjour ${currentUser.prenom} !</h1>
                    <p class="text-gray-500">${new Date().toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                </div>
                <div id="sync-status" class="sync-status synced no-print">
                    <i class="fas fa-cloud-check"></i> Synchronisé
                </div>
            </div>
            
            ${rondeEnCours ? `
                <div class="alert alert-warning">
                    <div class="flex items-center justify-between flex-wrap gap-4">
                        <div>
                            <i class="fas fa-route mr-2"></i>
                            <strong>Ronde en cours:</strong> ${rondeEnCours.nom}
                            <span class="ml-2">(${rondeEnCours.zonesValidees?.length || 0}/${rondeEnCours.zones?.length || 0} zones)</span>
                        </div>
                        <button onclick="navigate('ronde-encours')" class="btn btn-warning btn-sm">
                            <i class="fas fa-play mr-1"></i>Continuer
                        </button>
                    </div>
                </div>
            ` : ''}
            
            <div class="grid-4">
                <div class="stat-card" style="background: linear-gradient(135deg, #dbeafe, #bfdbfe);">
                    <i class="fas fa-route" style="color: var(--primary-600);"></i>
                    <div class="value" style="color: var(--primary-700);">${rondesToday.length}</div>
                    <div class="label">Rondes aujourd'hui</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #fef3c7, #fde68a);">
                    <i class="fas fa-exclamation-triangle" style="color: #d97706;"></i>
                    <div class="value" style="color: #b45309;">${anomaliesToday}</div>
                    <div class="label">Anomalies</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #dcfce7, #bbf7d0);">
                    <i class="fas fa-clipboard-check" style="color: #16a34a;"></i>
                    <div class="value" style="color: #15803d;">${consignesActives.length}</div>
                    <div class="label">Consignes actives</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #fee2e2, #fecaca);">
                    <i class="fas fa-tools" style="color: #dc2626;"></i>
                    <div class="value" style="color: #b91c1c;">${materielProbleme.length}</div>
                    <div class="label">Matériels à vérifier</div>
                </div>
            </div>
            
            <div class="quick-actions no-print">
                <button onclick="navigate('nouvelle-ronde')" class="btn btn-primary btn-lg">
                    <i class="fas fa-plus-circle"></i>Nouvelle Ronde
                </button>
                <button onclick="navigate('evenement')" class="btn btn-danger btn-lg">
                    <i class="fas fa-bell"></i>Signaler Événement
                </button>
                <button onclick="navigate('scanner')" class="btn btn-secondary btn-lg">
                    <i class="fas fa-qrcode"></i>Scanner QR
                </button>
            </div>
            
            ${consignesActives.length > 0 ? `
                <div class="card">
                    <div class="card-header">
                        <h3 class="font-semibold"><i class="fas fa-clipboard-list mr-2 text-primary-500" style="color: var(--primary-500);"></i>Consignes actives</h3>
                        <button onclick="navigate('consignes')" class="btn btn-sm btn-secondary">Voir tout</button>
                    </div>
                    <div class="card-body">
                        <div class="space-y-2">
                            ${consignesActives.slice(0, 3).map(c => `
                                <div class="p-3 rounded-lg ${c.type === 'temporaire' ? 'bg-orange-50' : 'bg-blue-50'}">
                                    <div class="flex items-start justify-between">
                                        <div>
                                            <span class="badge ${c.type === 'temporaire' ? 'badge-warning' : 'badge-info'}">${c.type}</span>
                                            <div class="font-semibold mt-1">${c.titre}</div>
                                            <div class="text-sm text-gray-600">${c.description}</div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            ` : ''}
            
            <div class="card">
                <div class="card-header">
                    <h3 class="font-semibold"><i class="fas fa-clock mr-2 text-primary-500" style="color: var(--primary-500);"></i>Derniers événements</h3>
                    <button onclick="navigate('main-courante')" class="btn btn-sm btn-secondary">Voir tout</button>
                </div>
                <div class="card-body">
                    ${lastEvents.length > 0 ? `
                        <div class="timeline">
                            ${lastEvents.map(e => `
                                <div class="timeline-item ${e.type.includes('Anomalie') ? 'anomalie' : ''}">
                                    <div class="flex items-start justify-between">
                                        <div>
                                            <span class="badge ${getMainCouranteBadgeClass(e.type)}">${e.type}</span>
                                            <div class="font-medium mt-1">${e.description}</div>
                                            <div class="text-sm text-gray-500">${e.agent} - ${formatTime(e.date)}</div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : '<p class="text-gray-500 text-center">Aucun événement</p>'}
                </div>
            </div>
        </div>
    `;
}

// ==================== NOUVELLE RONDE ====================
function renderNouvelleRonde() {
    const modeles = DB.modeleRondes || [];
    
    return `
        <div class="space-y-6">
            <div class="flex items-center justify-between">
                <h1 class="text-2xl font-bold"><i class="fas fa-route mr-2 text-primary-500" style="color: var(--primary-500);"></i>Nouvelle Ronde</h1>
                <button onclick="navigate('accueil')" class="btn btn-secondary">
                    <i class="fas fa-arrow-left mr-2"></i>Retour
                </button>
            </div>
            
            ${modeles.length > 0 ? `
                <div class="card">
                    <div class="card-header">
                        <h3 class="font-semibold">Modèles de rondes</h3>
                    </div>
                    <div class="card-body">
                        <div class="grid-2">
                            ${modeles.map(m => `
                                <div class="zone-btn" onclick="demarrerRondeModele('${m.id}')">
                                    <i class="fas fa-clipboard-list text-2xl mb-2" style="color: var(--primary-500);"></i>
                                    <div class="font-semibold">${m.nom}</div>
                                    <div class="text-sm text-gray-500">${m.zones?.length || 0} zones</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            ` : ''}
            
            <div class="card">
                <div class="card-header">
                    <h3 class="font-semibold">Configuration manuelle</h3>
                </div>
                <div class="card-body">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold mb-2">Nom de la ronde</label>
                            <input type="text" id="ronde-nom" class="input" placeholder="Ex: Ronde de nuit - Bâtiment A" value="Ronde ${formatTime(new Date())}">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold mb-2">Sélectionnez les zones</label>
                            ${configEtablissement.batiments.map(bat => `
                                <div class="mb-4">
                                    <div class="font-semibold text-gray-700 mb-2 flex items-center">
                                        <i class="fas fa-building mr-2"></i>${bat.nom}
                                        <button onclick="toggleBatiment('${bat.id}')" class="ml-auto btn btn-sm btn-secondary">Tout sélectionner</button>
                                    </div>
                                    ${bat.secteurs.map(sect => `
                                        <div class="ml-4 mb-2">
                                            <div class="text-sm text-gray-600 mb-1 flex items-center">
                                                <i class="fas fa-layer-group mr-1"></i>${sect.nom}
                                                <button onclick="toggleSecteur('${bat.id}', '${sect.id}')" class="ml-auto btn btn-sm btn-secondary text-xs">Sélectionner</button>
                                            </div>
                                            <div class="grid-3 ml-4">
                                                ${sect.zones.map(zone => `
                                                    <label class="zone-btn" id="zone-${bat.id}-${sect.id}-${zone.replace(/\s/g, '')}">
                                                        <input type="checkbox" class="zone-checkbox" data-bat="${bat.id}" data-sect="${sect.id}" data-zone="${zone}" style="display:none;">
                                                        <i class="fas fa-map-marker-alt mr-1"></i>
                                                        <span class="text-sm">${zone}</span>
                                                    </label>
                                                `).join('')}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            `).join('')}
                        </div>
                        
                        <button onclick="demarrerRonde()" class="btn btn-primary btn-lg w-full">
                            <i class="fas fa-play mr-2"></i>Démarrer la ronde
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function toggleBatiment(batId) {
    const checkboxes = document.querySelectorAll(`.zone-checkbox[data-bat="${batId}"]`);
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
    checkboxes.forEach(cb => {
        cb.checked = !allChecked;
        updateZoneBtnStyle(cb);
    });
}

function toggleSecteur(batId, sectId) {
    const checkboxes = document.querySelectorAll(`.zone-checkbox[data-bat="${batId}"][data-sect="${sectId}"]`);
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
    checkboxes.forEach(cb => {
        cb.checked = !allChecked;
        updateZoneBtnStyle(cb);
    });
}

function updateZoneBtnStyle(checkbox) {
    const btn = checkbox.parentElement;
    if (checkbox.checked) {
        btn.classList.add('checked');
    } else {
        btn.classList.remove('checked');
    }
}

document.addEventListener('change', e => {
    if (e.target.classList.contains('zone-checkbox')) {
        updateZoneBtnStyle(e.target);
    }
});

function demarrerRonde() {
    const nom = document.getElementById('ronde-nom').value.trim() || `Ronde ${formatTime(new Date())}`;
    const checkboxes = document.querySelectorAll('.zone-checkbox:checked');
    
    if (checkboxes.length === 0) {
        showToast('Sélectionnez au moins une zone', 'error');
        return;
    }
    
    const zones = Array.from(checkboxes).map(cb => ({
        batiment: cb.dataset.bat,
        secteur: cb.dataset.sect,
        zone: cb.dataset.zone,
        qrCode: `ZONE-${cb.dataset.bat}-${cb.dataset.sect}-${cb.dataset.zone.replace(/\s/g, '').toUpperCase()}`
    }));
    
    rondeEnCours = {
        id: genId(),
        nom,
        dateDebut: new Date().toISOString(),
        agentId: currentUser.id,
        agent: `${currentUser.prenom} ${currentUser.nom}`,
        zones,
        zonesValidees: [],
        anomalies: [],
        statut: 'en_cours'
    };
    
    addMainCourante('Ronde', `Début: ${nom} (${zones.length} zones)`, currentUser.id);
    sauvegarderVersFirebase();
    
    navigate('ronde-encours');
    showToast('Ronde démarrée !');
}

function demarrerRondeModele(modeleId) {
    const modele = DB.modeleRondes.find(m => m.id === modeleId);
    if (!modele) return;
    
    rondeEnCours = {
        id: genId(),
        nom: modele.nom,
        dateDebut: new Date().toISOString(),
        agentId: currentUser.id,
        agent: `${currentUser.prenom} ${currentUser.nom}`,
        zones: modele.zones.map(z => ({ ...z })),
        zonesValidees: [],
        anomalies: [],
        statut: 'en_cours'
    };
    
    addMainCourante('Ronde', `Début: ${modele.nom} (${modele.zones.length} zones)`, currentUser.id);
    sauvegarderVersFirebase();
    
    navigate('ronde-encours');
    showToast('Ronde démarrée !');
}

// ==================== RONDE EN COURS ====================
function renderRondeEnCours() {
    if (!rondeEnCours) {
        navigate('accueil');
        return '<p>Aucune ronde en cours</p>';
    }
    
    const progress = rondeEnCours.zones.length > 0 ? Math.round((rondeEnCours.zonesValidees.length / rondeEnCours.zones.length) * 100) : 0;
    
    return `
        <div class="space-y-6">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <div>
                    <h1 class="text-xl font-bold"><i class="fas fa-route mr-2 text-primary-500" style="color: var(--primary-500);"></i>${rondeEnCours.nom}</h1>
                    <p class="text-gray-500">Démarrée à ${formatTime(rondeEnCours.dateDebut)}</p>
                </div>
                <button onclick="terminerRonde()" class="btn btn-success">
                    <i class="fas fa-flag-checkered mr-2"></i>Terminer
                </button>
            </div>
            
            <div class="card p-4">
                <div class="flex items-center justify-between mb-2">
                    <span class="font-semibold">Progression</span>
                    <span class="text-primary-600" style="color: var(--primary-600);">${rondeEnCours.zonesValidees.length}/${rondeEnCours.zones.length} zones</span>
                </div>
                <div class="ronde-progress">
                    <div class="ronde-progress-bar" style="width: ${progress}%"></div>
                </div>
            </div>
            
            <div class="grid-2">
                <button onclick="navigate('scanner-ronde')" class="btn btn-primary btn-lg">
                    <i class="fas fa-qrcode mr-2"></i>Scanner QR Code
                </button>
                <button onclick="validerZoneManuelle()" class="btn btn-secondary btn-lg">
                    <i class="fas fa-hand-pointer mr-2"></i>Validation manuelle
                </button>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h3 class="font-semibold">Zones à contrôler</h3>
                </div>
                <div class="card-body">
                    <div class="space-y-2">
                        ${rondeEnCours.zones.map((z, index) => {
                            const validation = rondeEnCours.zonesValidees.find(v => v.zone === z.zone);
                            const anomalie = rondeEnCours.anomalies.find(a => a.zone === z.zone);
                            let statusClass = '';
                            let statusIcon = 'fa-circle';
                            let statusText = 'À contrôler';
                            
                            if (validation) {
                                if (anomalie) {
                                    statusClass = 'anomalie';
                                    statusIcon = 'fa-exclamation-triangle';
                                    statusText = 'Anomalie signalée';
                                } else {
                                    statusClass = 'checked';
                                    statusIcon = 'fa-check-circle';
                                    statusText = `OK - ${formatTime(validation.date)}`;
                                }
                            }
                            
                            return `
                                <div class="zone-btn ${statusClass}" onclick="voirDetailsZone(${index})" style="text-align: left; display: flex; align-items: center; gap: 12px;">
                                    <i class="fas ${statusIcon} ${validation ? (anomalie ? 'text-orange-500' : 'text-green-500') : 'text-gray-300'}" style="color: ${validation ? (anomalie ? '#f59e0b' : '#22c55e') : '#d1d5db'};"></i>
                                    <div class="flex-1">
                                        <div class="font-semibold">${z.zone}</div>
                                        <div class="text-sm text-gray-500">${z.batiment} > ${z.secteur}</div>
                                    </div>
                                    <div class="text-sm text-gray-500">${statusText}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            </div>
            
            ${rondeEnCours.anomalies.length > 0 ? `
                <div class="card">
                    <div class="card-header">
                        <h3 class="font-semibold text-orange-600" style="color: #d97706;"><i class="fas fa-exclamation-triangle mr-2"></i>Anomalies signalées (${rondeEnCours.anomalies.length})</h3>
                    </div>
                    <div class="card-body">
                        <div class="space-y-2">
                            ${rondeEnCours.anomalies.map(a => `
                                <div class="p-3 bg-orange-50 rounded-lg">
                                    <div class="font-semibold">${a.zone}</div>
                                    <div class="text-sm text-gray-600">${a.description}</div>
                                    ${a.horsService ? '<span class="badge badge-danger mt-1">Hors service</span>' : ''}
                                    ${a.photos?.length ? `<div class="photo-grid">${a.photos.map(p => `<img src="${p}" class="photo-thumb" onclick="voirPhoto('${p}')">`).join('')}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            ` : ''}
        </div>
    `;
}

function voirDetailsZone(index) {
    const zone = rondeEnCours.zones[index];
    const validation = rondeEnCours.zonesValidees.find(v => v.zone === zone.zone);
    const anomalie = rondeEnCours.anomalies.find(a => a.zone === zone.zone);
    
    let content = `
        <div class="space-y-4">
            <div class="text-center p-4 bg-gray-50 rounded-lg">
                <i class="fas fa-map-marker-alt text-3xl mb-2" style="color: var(--primary-500);"></i>
                <h3 class="font-bold text-lg">${zone.zone}</h3>
                <p class="text-gray-500">${zone.batiment} > ${zone.secteur}</p>
            </div>
            
            ${validation ? `
                <div class="p-3 bg-green-50 rounded-lg">
                    <i class="fas fa-check-circle text-green-500 mr-2"></i>
                    <span class="font-semibold">Validée à ${formatTime(validation.date)}</span>
                    ${validation.methode ? `<div class="text-sm text-gray-500">Méthode: ${validation.methode}</div>` : ''}
                </div>
            ` : ''}
            
            ${anomalie ? `
                <div class="p-3 bg-orange-50 rounded-lg">
                    <div class="font-semibold text-orange-700"><i class="fas fa-exclamation-triangle mr-2"></i>Anomalie</div>
                    <p class="text-sm mt-1">${anomalie.description}</p>
                    ${anomalie.horsService ? '<span class="badge badge-danger mt-2">Hors service</span>' : ''}
                    ${anomalie.photos?.length ? `
                        <div class="photo-grid mt-2">
                            ${anomalie.photos.map(p => `<img src="${p}" class="photo-thumb" onclick="voirPhoto('${p}')">`).join('')}
                        </div>
                    ` : ''}
                </div>
            ` : ''}
            
            ${!validation ? `
                <div class="grid-2">
                    <button onclick="validerZoneDirecte(${index})" class="btn btn-success">
                        <i class="fas fa-check mr-2"></i>Valider OK
                    </button>
                    <button onclick="signalerAnomalieZone(${index})" class="btn btn-warning">
                        <i class="fas fa-exclamation-triangle mr-2"></i>Anomalie
                    </button>
                </div>
            ` : ''}
        </div>
    `;
    
    showModal(`Zone: ${zone.zone}`, content, null, 'Fermer');
}

function validerZoneDirecte(index) {
    const zone = rondeEnCours.zones[index];
    rondeEnCours.zonesValidees.push({
        zone: zone.zone,
        date: new Date().toISOString(),
        methode: 'Manuel'
    });
    closeModal();
    render();
    showToast(`Zone ${zone.zone} validée !`);
}

function signalerAnomalieZone(index) {
    const zone = rondeEnCours.zones[index];
    closeModal();
    signalerAnomalie(zone);
}

function validerZoneManuelle() {
    const zonesNonValidees = rondeEnCours.zones.filter(z => !rondeEnCours.zonesValidees.find(v => v.zone === z.zone));
    
    if (zonesNonValidees.length === 0) {
        showToast('Toutes les zones ont été validées !', 'warning');
        return;
    }
    
    showModal('Validation manuelle', `
        <div class="space-y-2">
            <p class="text-gray-600 mb-4">Sélectionnez la zone à valider:</p>
            ${zonesNonValidees.map((z, i) => `
                <div class="zone-btn" onclick="validerZoneSelectionnee('${z.zone}', '${z.batiment}', '${z.secteur}')">
                    <div class="font-semibold">${z.zone}</div>
                    <div class="text-sm text-gray-500">${z.batiment} > ${z.secteur}</div>
                </div>
            `).join('')}
        </div>
    `, null, 'Annuler');
}

function validerZoneSelectionnee(zoneName, batiment, secteur) {
    closeModal();
    const zone = rondeEnCours.zones.find(z => z.zone === zoneName);
    
    showModal('Contrôle de zone', `
        <div class="space-y-4">
            <div class="text-center p-4 bg-gray-50 rounded-lg">
                <i class="fas fa-map-marker-alt text-3xl mb-2" style="color: var(--primary-500);"></i>
                <h3 class="font-bold">${zoneName}</h3>
                <p class="text-sm text-gray-500">${batiment} > ${secteur}</p>
            </div>
            <div class="grid-2">
                <button onclick="confirmerValidation('${zoneName}')" class="btn btn-success btn-lg">
                    <i class="fas fa-check mr-2"></i>Tout OK
                </button>
                <button onclick="closeModal(); signalerAnomalie({zone:'${zoneName}', batiment:'${batiment}', secteur:'${secteur}'})" class="btn btn-warning btn-lg">
                    <i class="fas fa-exclamation-triangle mr-2"></i>Anomalie
                </button>
            </div>
        </div>
    `, null, 'Annuler');
}

function confirmerValidation(zoneName) {
    rondeEnCours.zonesValidees.push({
        zone: zoneName,
        date: new Date().toISOString(),
        methode: 'Manuel'
    });
    closeModal();
    render();
    showToast(`Zone ${zoneName} validée !`);
}

function signalerAnomalie(zone) {
    showModal('Signaler une anomalie', `
        <div class="space-y-4">
            <div class="text-center p-3 bg-orange-50 rounded-lg">
                <i class="fas fa-map-marker-alt text-xl mb-1" style="color: #d97706;"></i>
                <div class="font-semibold">${zone.zone}</div>
            </div>
            <div>
                <label class="block text-sm font-semibold mb-2">Description de l'anomalie *</label>
                <textarea id="anomalie-desc" class="input" rows="3" placeholder="Décrivez l'anomalie constatée..."></textarea>
            </div>
            <div>
                <label class="flex items-center gap-2">
                    <input type="checkbox" id="anomalie-hs">
                    <span class="font-semibold text-red-600">Équipement hors service</span>
                </label>
            </div>
            <div>
                <label class="block text-sm font-semibold mb-2">Photos (optionnel)</label>
                <input type="file" id="anomalie-photos" accept="image/*" multiple class="input" capture="environment">
                <div id="photos-preview" class="photo-grid mt-2"></div>
            </div>
        </div>
    `, () => {
        const desc = document.getElementById('anomalie-desc').value.trim();
        if (!desc) {
            showToast('Description requise', 'error');
            return;
        }
        
        const horsService = document.getElementById('anomalie-hs').checked;
        const photosInput = document.getElementById('anomalie-photos');
        const photos = [];
        
        // Traitement des photos
        if (photosInput.files.length > 0) {
            const promises = Array.from(photosInput.files).map(file => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(file);
                });
            });
            
            Promise.all(promises).then(photoData => {
                photos.push(...photoData);
                enregistrerAnomalie(zone, desc, horsService, photos);
            });
        } else {
            enregistrerAnomalie(zone, desc, horsService, photos);
        }
    }, 'Enregistrer');
    
    // Preview des photos
    document.getElementById('anomalie-photos')?.addEventListener('change', function(e) {
        const preview = document.getElementById('photos-preview');
        preview.innerHTML = '';
        Array.from(e.target.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = (ev) => {
                preview.innerHTML += `<img src="${ev.target.result}" class="photo-thumb">`;
            };
            reader.readAsDataURL(file);
        });
    });
}

function enregistrerAnomalie(zone, desc, horsService, photos) {
    rondeEnCours.anomalies.push({
        zone: zone.zone,
        description: desc,
        horsService,
        photos,
        date: new Date().toISOString()
    });
    
    if (!rondeEnCours.zonesValidees.find(v => v.zone === zone.zone)) {
        rondeEnCours.zonesValidees.push({
            zone: zone.zone,
            date: new Date().toISOString(),
            methode: 'Manuel (avec anomalie)'
        });
    }
    
    addMainCourante('Anomalie', `${zone.zone}: ${desc}${horsService ? ' (HS)' : ''}`, currentUser.id);
    
    closeModal();
    render();
    showToast('Anomalie enregistrée', 'warning');
}

function terminerRonde() {
    showModal('Terminer la ronde ?', `
        <div class="space-y-4">
            <div class="text-center">
                <i class="fas fa-flag-checkered text-4xl mb-4" style="color: var(--primary-500);"></i>
                <p class="text-lg font-semibold">${rondeEnCours.nom}</p>
            </div>
            <div class="grid-2 text-center">
                <div class="stat-card">
                    <div class="value text-green-600" style="color: #16a34a;">${rondeEnCours.zonesValidees.length}/${rondeEnCours.zones.length}</div>
                    <div class="label">Zones validées</div>
                </div>
                <div class="stat-card">
                    <div class="value text-orange-600" style="color: #d97706;">${rondeEnCours.anomalies.length}</div>
                    <div class="label">Anomalies</div>
                </div>
            </div>
            ${rondeEnCours.zonesValidees.length < rondeEnCours.zones.length ? `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    Attention: ${rondeEnCours.zones.length - rondeEnCours.zonesValidees.length} zone(s) non validée(s)
                </div>
            ` : ''}
            <div>
                <label class="block text-sm font-semibold mb-2">Commentaire de fin (optionnel)</label>
                <textarea id="ronde-commentaire" class="input" rows="2" placeholder="RAS, observations particulières..."></textarea>
            </div>
        </div>
    `, () => {
        const commentaire = document.getElementById('ronde-commentaire').value.trim();
        
        rondeEnCours.dateFin = new Date().toISOString();
        rondeEnCours.statut = 'termine';
        rondeEnCours.commentaire = commentaire;
        
        DB.rondes.unshift(rondeEnCours);
        
        const statut = getStatutCouleurRonde(rondeEnCours);
        const statutTexte = statut === 'green' ? 'OK' : statut === 'orange' ? 'avec anomalies' : 'avec HS';
        addMainCourante('Ronde terminée', `${rondeEnCours.nom} - ${statutTexte} (${rondeEnCours.zonesValidees.length}/${rondeEnCours.zones.length} zones)`, currentUser.id);
        
        sauvegarderVersFirebase();
        
        rondeEnCours = null;
        closeModal();
        navigate('rondes');
        showToast('Ronde terminée et enregistrée !');
    }, 'Confirmer');
}

// ==================== SCANNER QR ====================
function renderScannerRonde() {
    return `
        <div class="space-y-6">
            <div class="flex items-center justify-between">
                <h1 class="text-xl font-bold"><i class="fas fa-qrcode mr-2"></i>Scanner QR Code</h1>
                <button onclick="navigate('ronde-encours')" class="btn btn-secondary">
                    <i class="fas fa-arrow-left mr-2"></i>Retour
                </button>
            </div>
            
            <div class="card p-6">
                <div class="qr-scanner-container">
                    <video id="qr-video" playsinline></video>
                    <canvas id="qr-canvas"></canvas>
                    <div class="scanner-overlay">
                        <div class="scanner-line"></div>
                    </div>
                </div>
                <p class="text-center text-gray-500 mt-4">Placez le QR code dans le cadre</p>
            </div>
            
            <div class="text-center">
                <button onclick="arreterScanner(); navigate('ronde-encours')" class="btn btn-secondary">
                    <i class="fas fa-times mr-2"></i>Annuler
                </button>
            </div>
        </div>
    `;
}

function renderScanner() {
    return `
        <div class="space-y-6">
            <div class="flex items-center justify-between">
                <h1 class="text-xl font-bold"><i class="fas fa-qrcode mr-2"></i>Scanner QR Code</h1>
                <button onclick="navigate('accueil')" class="btn btn-secondary">
                    <i class="fas fa-arrow-left mr-2"></i>Retour
                </button>
            </div>
            
            <div class="card p-6">
                <div class="qr-scanner-container">
                    <video id="qr-video" playsinline></video>
                    <canvas id="qr-canvas"></canvas>
                    <div class="scanner-overlay">
                        <div class="scanner-line"></div>
                    </div>
                </div>
                <p class="text-center text-gray-500 mt-4">Placez le QR code dans le cadre</p>
            </div>
        </div>
    `;
}

let videoStream = null;
let scannerInterval = null;

function demarrerScanner() {
    const video = document.getElementById('qr-video');
    const canvas = document.getElementById('qr-canvas');
    if (!video || !canvas) return;
    
    const ctx = canvas.getContext('2d');
    
    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
        .then(stream => {
            videoStream = stream;
            video.srcObject = stream;
            video.play();
            
            scannerInterval = setInterval(() => {
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    ctx.drawImage(video, 0, 0);
                    
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const code = jsQR(imageData.data, imageData.width, imageData.height);
                    
                    if (code) {
                        arreterScanner();
                        traiterQRCode(code.data);
                    }
                }
            }, 100);
        })
        .catch(err => {
            console.error('Erreur caméra:', err);
            showToast('Impossible d\'accéder à la caméra', 'error');
        });
}

function arreterScanner() {
    if (scannerInterval) {
        clearInterval(scannerInterval);
        scannerInterval = null;
    }
    if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        videoStream = null;
    }
}

function traiterQRCode(data) {
    if (rondeEnCours) {
        const zone = rondeEnCours.zones.find(z => z.qrCode === data);
        if (zone) {
            if (rondeEnCours.zonesValidees.find(v => v.zone === zone.zone)) {
                showToast(`Zone ${zone.zone} déjà validée`, 'warning');
                navigate('ronde-encours');
                return;
            }
            
            showModal('Zone détectée', `
                <div class="space-y-4">
                    <div class="text-center p-4 bg-green-50 rounded-lg">
                        <i class="fas fa-check-circle text-4xl text-green-500 mb-2"></i>
                        <h3 class="font-bold text-lg">${zone.zone}</h3>
                        <p class="text-gray-500">${zone.batiment} > ${zone.secteur}</p>
                    </div>
                    <div class="grid-2">
                        <button onclick="validerQRZone('${zone.zone}')" class="btn btn-success btn-lg">
                            <i class="fas fa-check mr-2"></i>Tout OK
                        </button>
                        <button onclick="closeModal(); signalerAnomalie({zone:'${zone.zone}', batiment:'${zone.batiment}', secteur:'${zone.secteur}'})" class="btn btn-warning btn-lg">
                            <i class="fas fa-exclamation-triangle mr-2"></i>Anomalie
                        </button>
                    </div>
                </div>
            `, null, 'Annuler');
        } else {
            showToast('QR Code non reconnu pour cette ronde', 'error');
            navigate('ronde-encours');
        }
    } else {
        const materiel = DB.materiels.find(m => m.codeQR === data);
        if (materiel) {
            showModal('Matériel détecté', `
                <div class="space-y-4">
                    <div class="text-center p-4 bg-blue-50 rounded-lg">
                        <i class="fas fa-tools text-3xl mb-2" style="color: var(--primary-500);"></i>
                        <h3 class="font-bold">${materiel.nom}</h3>
                        <p class="text-gray-500">${materiel.type}</p>
                        <span class="badge ${materiel.statut === 'Opérationnel' ? 'badge-success' : 'badge-warning'}">${materiel.statut}</span>
                    </div>
                    <div class="grid-2">
                        <div class="stat-card"><div class="label">Localisation</div><div class="text-sm font-medium">${materiel.localisation}</div></div>
                        <div class="stat-card"><div class="label">Prochaine maint.</div><div class="text-sm font-medium">${formatDate(materiel.prochaineMaint)}</div></div>
                    </div>
                </div>
            `, null, 'Fermer');
        } else {
            showToast('QR Code: ' + data, 'warning');
        }
        navigate('accueil');
    }
}

function validerQRZone(zoneName) {
    rondeEnCours.zonesValidees.push({
        zone: zoneName,
        date: new Date().toISOString(),
        methode: 'QR Code'
    });
    closeModal();
    navigate('ronde-encours');
    showToast(`Zone ${zoneName} validée par QR !`);
}

// ==================== HISTORIQUE DES RONDES ====================
function renderRondes() {
    let rondesFiltrees = [...DB.rondes];
    
    // Filtres
    if (filtresRondes.agent) {
        rondesFiltrees = rondesFiltrees.filter(r => r.agentId === filtresRondes.agent);
    }
    if (filtresRondes.statut === 'anomalies') {
        rondesFiltrees = rondesFiltrees.filter(r => r.anomalies?.length > 0);
    } else if (filtresRondes.statut === 'ok') {
        rondesFiltrees = rondesFiltrees.filter(r => !r.anomalies?.length);
    }
    if (filtresRondes.periode === 'today') {
        const today = new Date().toDateString();
        rondesFiltrees = rondesFiltrees.filter(r => new Date(r.dateDebut).toDateString() === today);
    } else if (filtresRondes.periode === 'week') {
        const weekAgo = new Date(); weekAgo.setDate(weekAgo.getDate() - 7);
        rondesFiltrees = rondesFiltrees.filter(r => new Date(r.dateDebut) >= weekAgo);
    }
    
    return `
        <div class="space-y-6">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <h1 class="text-2xl font-bold"><i class="fas fa-history mr-2 text-primary-500" style="color: var(--primary-500);"></i>Historique des rondes</h1>
                <button onclick="exporterRondes()" class="btn btn-secondary no-print">
                    <i class="fas fa-download mr-2"></i>Exporter
                </button>
            </div>
            
            <div class="card no-print">
                <div class="card-body">
                    <div class="grid-3">
                        <div>
                            <label class="block text-sm font-semibold mb-2">Agent</label>
                            <select class="input" onchange="filtresRondes.agent = this.value; render()">
                                <option value="">Tous</option>
                                ${DB.agents.map(a => `<option value="${a.id}" ${filtresRondes.agent === a.id ? 'selected' : ''}>${a.prenom} ${a.nom}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2">Statut</label>
                            <select class="input" onchange="filtresRondes.statut = this.value; render()">
                                <option value="">Tous</option>
                                <option value="ok" ${filtresRondes.statut === 'ok' ? 'selected' : ''}>Sans anomalie</option>
                                <option value="anomalies" ${filtresRondes.statut === 'anomalies' ? 'selected' : ''}>Avec anomalies</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2">Période</label>
                            <select class="input" onchange="filtresRondes.periode = this.value; render()">
                                <option value="all" ${filtresRondes.periode === 'all' ? 'selected' : ''}>Toutes</option>
                                <option value="today" ${filtresRondes.periode === 'today' ? 'selected' : ''}>Aujourd'hui</option>
                                <option value="week" ${filtresRondes.periode === 'week' ? 'selected' : ''}>7 derniers jours</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="space-y-4">
                ${rondesFiltrees.length > 0 ? rondesFiltrees.map(r => {
                    const statut = getStatutCouleurRonde(r);
                    const duree = r.dateFin ? Math.round((new Date(r.dateFin) - new Date(r.dateDebut)) / 60000) : '-';
                    return `
                        <div class="card" onclick="voirDetailsRonde('${r.id}')" style="cursor: pointer;">
                            <div class="card-body">
                                <div class="flex items-start justify-between flex-wrap gap-4">
                                    <div class="flex items-center gap-4">
                                        <div class="status-dot ${statut === 'green' ? 'online' : ''}" style="background: ${statut === 'green' ? '#22c55e' : statut === 'orange' ? '#f59e0b' : '#ef4444'}; width: 16px; height: 16px;"></div>
                                        <div>
                                            <div class="font-bold">${r.nom}</div>
                                            <div class="text-sm text-gray-500">${r.agent} - ${formatDateTime(r.dateDebut)}</div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="flex gap-2">
                                            <span class="badge ${getBadgeClass(statut)}">${r.zonesValidees?.length || 0}/${r.zones?.length || 0} zones</span>
                                            ${r.anomalies?.length ? `<span class="badge badge-warning">${r.anomalies.length} anomalie(s)</span>` : ''}
                                        </div>
                                        <div class="text-sm text-gray-500 mt-1">Durée: ${duree} min</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('') : '<div class="empty-state"><i class="fas fa-route"></i><p>Aucune ronde trouvée</p></div>'}
            </div>
        </div>
    `;
}

function voirDetailsRonde(rondeId) {
    const r = DB.rondes.find(x => x.id === rondeId);
    if (!r) return;
    
    const statut = getStatutCouleurRonde(r);
    const duree = r.dateFin ? Math.round((new Date(r.dateFin) - new Date(r.dateDebut)) / 60000) : '-';
    
    showModal(`Détails: ${r.nom}`, `
        <div class="space-y-4">
            <div class="grid-2">
                <div class="stat-card">
                    <div class="label">Agent</div>
                    <div class="font-semibold">${r.agent}</div>
                </div>
                <div class="stat-card">
                    <div class="label">Durée</div>
                    <div class="font-semibold">${duree} min</div>
                </div>
            </div>
            
            <div class="grid-2">
                <div class="stat-card">
                    <div class="label">Début</div>
                    <div class="font-semibold">${formatDateTime(r.dateDebut)}</div>
                </div>
                <div class="stat-card">
                    <div class="label">Fin</div>
                    <div class="font-semibold">${r.dateFin ? formatDateTime(r.dateFin) : '-'}</div>
                </div>
            </div>
            
            <div class="p-3 rounded-lg ${statut === 'green' ? 'bg-green-50' : statut === 'orange' ? 'bg-orange-50' : 'bg-red-50'}">
                <div class="font-semibold">Zones contrôlées: ${r.zonesValidees?.length || 0}/${r.zones?.length || 0}</div>
                <div class="ronde-progress mt-2">
                    <div class="ronde-progress-bar" style="width: ${r.zones?.length ? Math.round((r.zonesValidees?.length || 0) / r.zones.length * 100) : 0}%"></div>
                </div>
            </div>
            
            ${r.anomalies?.length ? `
                <div>
                    <h4 class="font-semibold text-orange-600 mb-2"><i class="fas fa-exclamation-triangle mr-2"></i>Anomalies (${r.anomalies.length})</h4>
                    <div class="space-y-2">
                        ${r.anomalies.map(a => `
                            <div class="p-3 bg-orange-50 rounded-lg">
                                <div class="font-semibold">${a.zone}</div>
                                <div class="text-sm">${a.description}</div>
                                ${a.horsService ? '<span class="badge badge-danger mt-1">Hors service</span>' : ''}
                                ${a.photos?.length ? `<div class="photo-grid mt-2">${a.photos.map(p => `<img src="${p}" class="photo-thumb" onclick="voirPhoto('${p}')">`).join('')}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : ''}
            
            ${r.commentaire ? `
                <div class="p-3 bg-gray-50 rounded-lg">
                    <div class="font-semibold mb-1">Commentaire</div>
                    <div class="text-sm">${r.commentaire}</div>
                </div>
            ` : ''}
            
            ${r.zones?.length ? `
                <div>
                    <h4 class="font-semibold mb-2">Détail des zones</h4>
                    <div class="space-y-1 max-h-48 overflow-y-auto">
                        ${r.zones.map(z => {
                            const validation = r.zonesValidees?.find(v => v.zone === z.zone);
                            const anomalie = r.anomalies?.find(a => a.zone === z.zone);
                            return `
                                <div class="flex items-center justify-between p-2 rounded ${validation ? (anomalie ? 'bg-orange-50' : 'bg-green-50') : 'bg-red-50'}">
                                    <span class="text-sm">${z.zone}</span>
                                    <span class="text-xs text-gray-500">
                                        ${validation ? `${formatTime(validation.date)} (${validation.methode || 'N/A'})` : 'Non validée'}
                                    </span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            ` : ''}
        </div>
    `, null, 'Fermer');
}

function voirPhoto(url) {
    showModal('Photo', `<img src="${url}" style="width:100%; border-radius: 8px;">`, null, 'Fermer');
}

// ==================== MAIN COURANTE ====================
function renderMainCourante() {
    let evenements = [...DB.mainCourante];
    
    // Filtres
    if (filtresMainCourante.type) {
        evenements = evenements.filter(e => e.type.toLowerCase().includes(filtresMainCourante.type.toLowerCase()));
    }
    if (filtresMainCourante.agent) {
        evenements = evenements.filter(e => e.agentId === filtresMainCourante.agent);
    }
    if (filtresMainCourante.periode === 'today') {
        const today = new Date().toDateString();
        evenements = evenements.filter(e => new Date(e.date).toDateString() === today);
    } else if (filtresMainCourante.periode === 'week') {
        const weekAgo = new Date(); weekAgo.setDate(weekAgo.getDate() - 7);
        evenements = evenements.filter(e => new Date(e.date) >= weekAgo);
    }
    
    return `
        <div class="space-y-6">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <h1 class="text-2xl font-bold"><i class="fas fa-book mr-2 text-primary-500" style="color: var(--primary-500);"></i>Main courante</h1>
                <div class="flex gap-2 no-print">
                    <button onclick="ajouterEvenementManuel()" class="btn btn-primary">
                        <i class="fas fa-plus mr-2"></i>Ajouter
                    </button>
                    <button onclick="imprimerMainCourante()" class="btn btn-secondary">
                        <i class="fas fa-print mr-2"></i>Imprimer
                    </button>
                </div>
            </div>
            
            <div class="card no-print">
                <div class="card-body">
                    <div class="grid-3">
                        <div>
                            <label class="block text-sm font-semibold mb-2">Type</label>
                            <select class="input" onchange="filtresMainCourante.type = this.value; render()">
                                <option value="">Tous</option>
                                <option value="Ronde" ${filtresMainCourante.type === 'Ronde' ? 'selected' : ''}>Rondes</option>
                                <option value="Anomalie" ${filtresMainCourante.type === 'Anomalie' ? 'selected' : ''}>Anomalies</option>
                                <option value="Alarme" ${filtresMainCourante.type === 'Alarme' ? 'selected' : ''}>Alarmes</option>
                                <option value="Connexion" ${filtresMainCourante.type === 'Connexion' ? 'selected' : ''}>Connexions</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2">Agent</label>
                            <select class="input" onchange="filtresMainCourante.agent = this.value; render()">
                                <option value="">Tous</option>
                                ${DB.agents.map(a => `<option value="${a.id}" ${filtresMainCourante.agent === a.id ? 'selected' : ''}>${a.prenom} ${a.nom}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2">Période</label>
                            <select class="input" onchange="filtresMainCourante.periode = this.value; render()">
                                <option value="today" ${filtresMainCourante.periode === 'today' ? 'selected' : ''}>Aujourd'hui</option>
                                <option value="week" ${filtresMainCourante.periode === 'week' ? 'selected' : ''}>7 derniers jours</option>
                                <option value="all" ${filtresMainCourante.periode === 'all' ? 'selected' : ''}>Tout</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-body">
                    ${evenements.length > 0 ? `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Date/Heure</th>
                                        <th>Type</th>
                                        <th>Description</th>
                                        <th>Agent</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${evenements.slice(0, 100).map(e => `
                                        <tr>
                                            <td class="text-sm">${formatDateTime(e.date)}</td>
                                            <td><span class="badge ${getMainCouranteBadgeClass(e.type)}">${e.type}</span></td>
                                            <td>${e.description}</td>
                                            <td class="text-sm text-gray-500">${e.agent}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : '<div class="empty-state"><i class="fas fa-book"></i><p>Aucun événement</p></div>'}
                </div>
            </div>
        </div>
    `;
}

function ajouterEvenementManuel() {
    const types = ['Observation', 'Incident', 'Alarme', 'Intervention', 'Appel', 'Livraison', 'Visiteur', 'Autre'];
    
    showModal('Ajouter un événement', `
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-semibold mb-2">Type *</label>
                <select id="event-type" class="input">
                    ${types.map(t => `<option value="${t}">${t}</option>`).join('')}
                </select>
            </div>
            <div>
                <label class="block text-sm font-semibold mb-2">Description *</label>
                <textarea id="event-desc" class="input" rows="3" placeholder="Décrivez l'événement..."></textarea>
            </div>
        </div>
    `, () => {
        const type = document.getElementById('event-type').value;
        const desc = document.getElementById('event-desc').value.trim();
        if (!desc) {
            showToast('Description requise', 'error');
            return;
        }
        
        addMainCourante(type, desc, currentUser.id);
        sauvegarderVersFirebase();
        
        closeModal();
        render();
        showToast('Événement ajouté');
    });
}

// ==================== PAGE ÉVÉNEMENT ====================
function renderEvenement() {
    const typesBoutons = [
        { type: 'Alarme incendie', icon: 'fa-fire', color: '#dc2626', bg: '#fee2e2' },
        { type: 'Intrusion', icon: 'fa-user-secret', color: '#7c3aed', bg: '#ede9fe' },
        { type: 'Accident', icon: 'fa-car-crash', color: '#ea580c', bg: '#ffedd5' },
        { type: 'Secours personne', icon: 'fa-heart-pulse', color: '#dc2626', bg: '#fee2e2' },
        { type: 'Incident technique', icon: 'fa-wrench', color: '#0284c7', bg: '#e0f2fe' },
        { type: 'Colis suspect', icon: 'fa-box', color: '#ca8a04', bg: '#fef9c3' },
        { type: 'Dégât des eaux', icon: 'fa-droplet', color: '#0891b2', bg: '#cffafe' },
        { type: 'Autre', icon: 'fa-circle-exclamation', color: '#64748b', bg: '#f1f5f9' }
    ];
    
    return `
        <div class="space-y-6">
            <div class="flex items-center justify-between">
                <h1 class="text-2xl font-bold"><i class="fas fa-bell mr-2 text-red-500"></i>Signaler un événement</h1>
                <button onclick="navigate('accueil')" class="btn btn-secondary">
                    <i class="fas fa-arrow-left mr-2"></i>Retour
                </button>
            </div>
            
            <div class="grid-2">
                ${typesBoutons.map(t => `
                    <button onclick="signalerEvenement('${t.type}')" class="btn btn-lg" style="background: ${t.bg}; color: ${t.color}; flex-direction: column; padding: 24px;">
                        <i class="fas ${t.icon} text-3xl mb-2"></i>
                        ${t.type}
                    </button>
                `).join('')}
            </div>
        </div>
    `;
}

function signalerEvenement(type) {
    showModal(`Signaler: ${type}`, `
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-semibold mb-2">Localisation</label>
                <select id="event-loc" class="input">
                    <option value="">Sélectionner...</option>
                    ${configEtablissement.batiments.map(bat => 
                        bat.secteurs.map(sect => 
                            sect.zones.map(zone => `<option value="${bat.nom} > ${sect.nom} > ${zone}">${bat.nom} > ${sect.nom} > ${zone}</option>`)
                        ).join('')
                    ).join('')}
                </select>
            </div>
            <div>
                <label class="block text-sm font-semibold mb-2">Description *</label>
                <textarea id="event-desc" class="input" rows="3" placeholder="Décrivez la situation..."></textarea>
            </div>
            <div>
                <label class="block text-sm font-semibold mb-2">Actions entreprises</label>
                <textarea id="event-actions" class="input" rows="2" placeholder="Actions réalisées..."></textarea>
            </div>
        </div>
    `, () => {
        const loc = document.getElementById('event-loc').value;
        const desc = document.getElementById('event-desc').value.trim();
        const actions = document.getElementById('event-actions').value.trim();
        
        if (!desc) {
            showToast('Description requise', 'error');
            return;
        }
        
        let fullDesc = desc;
        if (loc) fullDesc = `[${loc}] ${desc}`;
        if (actions) fullDesc += ` | Actions: ${actions}`;
        
        addMainCourante(type, fullDesc, currentUser.id);
        sauvegarderVersFirebase();
        
        closeModal();
        navigate('main-courante');
        showToast('Événement enregistré !', 'warning');
    }, 'Enregistrer');
}

// ==================== MATÉRIELS ====================
function renderMateriels() {
    let materiels = [...DB.materiels];
    
    // Filtres
    if (filtresMateriels.type) {
        materiels = materiels.filter(m => m.type === filtresMateriels.type);
    }
    if (filtresMateriels.statut) {
        materiels = materiels.filter(m => m.statut === filtresMateriels.statut);
    }
    if (filtresMateriels.localisation) {
        materiels = materiels.filter(m => m.localisation?.includes(filtresMateriels.localisation));
    }
    
    const types = [...new Set(DB.materiels.map(m => m.type))];
    const statuts = [...new Set(DB.materiels.map(m => m.statut))];
    
    return `
        <div class="space-y-6">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <h1 class="text-2xl font-bold"><i class="fas fa-tools mr-2 text-primary-500" style="color: var(--primary-500);"></i>Matériels de sécurité</h1>
                <button onclick="ajouterMateriel()" class="btn btn-primary no-print">
                    <i class="fas fa-plus mr-2"></i>Ajouter
                </button>
            </div>
            
            <div class="card no-print">
                <div class="card-body">
                    <div class="grid-3">
                        <div>
                            <label class="block text-sm font-semibold mb-2">Type</label>
                            <select class="input" onchange="filtresMateriels.type = this.value; render()">
                                <option value="">Tous</option>
                                ${types.map(t => `<option value="${t}" ${filtresMateriels.type === t ? 'selected' : ''}>${t}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2">Statut</label>
                            <select class="input" onchange="filtresMateriels.statut = this.value; render()">
                                <option value="">Tous</option>
                                ${statuts.map(s => `<option value="${s}" ${filtresMateriels.statut === s ? 'selected' : ''}>${s}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2">Recherche</label>
                            <input type="text" class="input" placeholder="Nom, localisation..." onchange="filtresMateriels.localisation = this.value; render()">
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="grid-4">
                <div class="stat-card bg-blue-50">
                    <div class="value text-blue-600">${DB.materiels.length}</div>
                    <div class="label">Total</div>
                </div>
                <div class="stat-card bg-green-50">
                    <div class="value text-green-600">${DB.materiels.filter(m => m.statut === 'Opérationnel').length}</div>
                    <div class="label">Opérationnels</div>
                </div>
                <div class="stat-card bg-orange-50">
                    <div class="value text-orange-600">${DB.materiels.filter(m => m.statut === 'À vérifier').length}</div>
                    <div class="label">À vérifier</div>
                </div>
                <div class="stat-card bg-red-50">
                    <div class="value text-red-600">${DB.materiels.filter(m => m.statut === 'Hors Service').length}</div>
                    <div class="label">Hors service</div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-body">
                    ${materiels.length > 0 ? `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Nom</th>
                                        <th>Type</th>
                                        <th>Localisation</th>
                                        <th>Statut</th>
                                        <th>Prochaine maint.</th>
                                        <th class="no-print">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${materiels.map(m => `
                                        <tr>
                                            <td class="font-semibold">${m.nom}</td>
                                            <td><span class="badge badge-info">${m.type}</span></td>
                                            <td class="text-sm">${m.localisation || '-'}</td>
                                            <td><span class="badge ${m.statut === 'Opérationnel' ? 'badge-success' : m.statut === 'À vérifier' ? 'badge-warning' : 'badge-danger'}">${m.statut}</span></td>
                                            <td class="text-sm">${formatDate(m.prochaineMaint)}</td>
                                            <td class="no-print">
                                                <div class="flex gap-2">
                                                    <button onclick="voirMateriel('${m.id}')" class="btn btn-sm btn-secondary"><i class="fas fa-eye"></i></button>
                                                    <button onclick="modifierMateriel('${m.id}')" class="btn btn-sm btn-primary"><i class="fas fa-edit"></i></button>
                                                </div>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : '<div class="empty-state"><i class="fas fa-tools"></i><p>Aucun matériel trouvé</p></div>'}
                </div>
            </div>
        </div>
    `;
}

function ajouterMateriel() {
    const types = ['Extincteur', 'RIA', 'Détecteur', 'Porte CF', 'BAES', 'Colonne sèche', 'Autre'];
    
    let locOptions = `<option value="">Sélectionner...</option>`;
    configEtablissement.batiments.forEach(bat => {
        bat.secteurs.forEach(sect => {
            sect.zones.forEach(zone => {
                locOptions += `<option value="${bat.nom} > ${sect.nom} > ${zone}">${bat.nom} > ${sect.nom} > ${zone}</option>`;
            });
        });
    });
    locOptions += `<option value="__autre__">Autre (saisie libre)</option>`;
    
    showModal('Ajouter un matériel', `
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-semibold mb-2">Nom / Référence *</label>
                <input type="text" id="matNom" class="input" placeholder="Ex: EXT-042">
            </div>
            <div>
                <label class="block text-sm font-semibold mb-2">Type</label>
                <select id="matType" class="input">${types.map(t => `<option>${t}</option>`).join('')}</select>
            </div>
            <div>
                <label class="block text-sm font-semibold mb-2">Localisation</label>
                <select id="matLoc" class="input" onchange="document.getElementById('matLocAutre').classList.toggle('hidden', this.value !== '__autre__')">
                    ${locOptions}
                </select>
                <input type="text" id="matLocAutre" class="input mt-2 hidden" placeholder="Saisir la localisation...">
            </div>
            <div>
                <label class="block text-sm font-semibold mb-2">Code QR</label>
                <input type="text" id="matQR" class="input" placeholder="Code pour le QR">
            </div>
        </div>
    `, () => {
        const nom = document.getElementById('matNom').value.trim();
        if (!nom) { showToast('Nom requis', 'error'); return; }
        
        const locSelect = document.getElementById('matLoc').value;
        const locAutre = document.getElementById('matLocAutre').value.trim();
        
        const m = {
            id: genId(),
            nom,
            type: document.getElementById('matType').value,
            localisation: locSelect === '__autre__' ? locAutre : locSelect,
            statut: 'Opérationnel',
            codeQR: document.getElementById('matQR').value.trim() || nom,
            dateAjout: new Date().toISOString()
        };
        
        DB.materiels.push(m);
        addMainCourante('Matériel', `Ajout: ${nom}`, currentUser.id);
        sauvegarderVersFirebase();
        
        closeModal();
        render();
        showToast('Matériel ajouté');
    });
}

function voirMateriel(id) {
    const m = DB.materiels.find(x => x.id === id);
    if (!m) return;
    
    const statutClass = m.statut === 'Opérationnel' ? 'badge-success' : m.statut === 'À vérifier' ? 'badge-warning' : 'badge-danger';
    const qrDivId = 'qrMatView-' + Date.now();
    
    showModal('Fiche Matériel', `
        <div class="space-y-4">
            <div class="flex items-start justify-between gap-4">
                <div class="flex-1">
                    <h3 class="text-xl font-bold">${m.nom}</h3>
                    <div class="flex gap-2 mt-1">
                        <span class="badge badge-info">${m.type}</span>
                        <span class="badge ${statutClass}">${m.statut}</span>
                    </div>
                </div>
                <div id="${qrDivId}" class="bg-white p-2 rounded-lg border flex items-center justify-center" style="min-width:100px;min-height:100px;">
                    <i class="fas fa-qrcode text-gray-300 text-3xl"></i>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-gray-50 p-3 rounded-lg">
                    <div class="text-xs text-gray-500">Localisation</div>
                    <div class="font-medium text-sm">${m.localisation || '-'}</div>
                </div>
                <div class="bg-gray-50 p-3 rounded-lg">
                    <div class="text-xs text-gray-500">Code QR</div>
                    <div class="font-mono text-sm">${m.codeQR || '-'}</div>
                </div>
                <div class="bg-gray-50 p-3 rounded-lg">
                    <div class="text-xs text-gray-500">Dernière maintenance</div>
                    <div class="font-medium">${m.derniereMaint ? formatDate(m.derniereMaint) : '-'}</div>
                </div>
                <div class="bg-gray-50 p-3 rounded-lg">
                    <div class="text-xs text-gray-500">Prochaine maintenance</div>
                    <div class="font-medium">${m.prochaineMaint ? formatDate(m.prochaineMaint) : '-'}</div>
                </div>
            </div>
            
            ${m.observation ? `
                <div class="bg-orange-50 p-4 rounded-lg">
                    <div class="font-semibold text-orange-700 mb-2"><i class="fas fa-exclamation-triangle mr-1"></i>Observation</div>
                    <p class="text-sm">${m.observation}</p>
                </div>
            ` : ''}
        </div>
    `, null, 'Fermer');
    
    // Générer QR code après un court délai
    setTimeout(() => {
        const qrDiv = document.getElementById(qrDivId);
        if (qrDiv && m.codeQR && typeof QRCode !== 'undefined') {
            qrDiv.innerHTML = '';
            try {
                new QRCode(qrDiv, { 
                    text: m.codeQR, 
                    width: 80, 
                    height: 80,
                    colorDark: '#000000',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.M
                });
            } catch(e) {
                console.error('Erreur QR:', e);
                qrDiv.innerHTML = `<div class="text-center"><div class="font-mono text-xs text-gray-500">${m.codeQR}</div></div>`;
            }
        } else if (qrDiv) {
            qrDiv.innerHTML = '<span class="text-gray-400 text-xs">Pas de QR</span>';
        }
    }, 300);
}

function modifierMateriel(id) {
    const m = DB.materiels.find(x => x.id === id);
    if (!m) return;
    
    const types = ['Extincteur', 'RIA', 'Détecteur', 'Porte CF', 'BAES', 'Colonne sèche', 'Autre'];
    const statuts = ['Opérationnel', 'À vérifier', 'En maintenance', 'Hors Service'];
    const qrDivId = 'qrMatEdit-' + Date.now();
    
    let locOptions = `<option value="">Sélectionner...</option>`;
    let locFound = false;
    configEtablissement.batiments.forEach(bat => {
        bat.secteurs.forEach(sect => {
            sect.zones.forEach(zone => {
                const loc = `${bat.nom} > ${sect.nom} > ${zone}`;
                const selected = m.localisation === loc;
                if (selected) locFound = true;
                locOptions += `<option value="${loc}" ${selected ? 'selected' : ''}>${loc}</option>`;
            });
        });
    });
    locOptions += `<option value="__autre__" ${m.localisation && !locFound ? 'selected' : ''}>Autre (saisie libre)</option>`;
    
    showModal('Modifier Matériel', `
        <div class="space-y-4">
            <div class="flex items-start justify-between gap-4">
                <div class="flex-1">
                    <label class="block text-sm font-semibold mb-2">Nom *</label>
                    <input type="text" id="matNomEdit" class="input" value="${m.nom}">
                </div>
                <div id="${qrDivId}" class="bg-white p-2 rounded-lg border flex items-center justify-center" style="min-width:80px;min-height:80px;">
                    <i class="fas fa-qrcode text-gray-300 text-2xl"></i>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-semibold mb-2">Type</label>
                    <select id="matTypeEdit" class="input">${types.map(t => `<option ${m.type === t ? 'selected' : ''}>${t}</option>`).join('')}</select>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Statut</label>
                    <select id="matStatutEdit" class="input">${statuts.map(s => `<option ${m.statut === s ? 'selected' : ''}>${s}</option>`).join('')}</select>
                </div>
            </div>
            <div>
                <label class="block text-sm font-semibold mb-2">Localisation</label>
                <select id="matLocEdit" class="input mb-2" onchange="document.getElementById('matLocAutreEdit').classList.toggle('hidden', this.value !== '__autre__')">
                    ${locOptions}
                </select>
                <input type="text" id="matLocAutreEdit" class="input ${m.localisation && !locFound ? '' : 'hidden'}" value="${m.localisation || ''}" placeholder="Saisir la localisation...">
            </div>
            <div>
                <label class="block text-sm font-semibold mb-2">Code QR</label>
                <input type="text" id="matQREdit" class="input" value="${m.codeQR || ''}">
            </div>
            <div>
                <label class="block text-sm font-semibold mb-2">Observation</label>
                <textarea id="matObsEdit" class="input" rows="2">${m.observation || ''}</textarea>
            </div>
        </div>
    `, () => {
        const nom = document.getElementById('matNomEdit').value.trim();
        if (!nom) return showToast('Nom requis', 'error');
        
        const locSelect = document.getElementById('matLocEdit').value;
        const locAutre = document.getElementById('matLocAutreEdit').value.trim();
        
        m.nom = nom;
        m.type = document.getElementById('matTypeEdit').value;
        m.statut = document.getElementById('matStatutEdit').value;
        m.localisation = locSelect === '__autre__' ? locAutre : locSelect;
        m.codeQR = document.getElementById('matQREdit').value.trim();
        m.observation = document.getElementById('matObsEdit').value;
        
        addMainCourante('Matériel', `Modification: ${nom}`, currentUser?.id);
        sauvegarderVersFirebase();
        
        closeModal();
        showToast('✅ Matériel modifié');
        navigate('materiels');
    });
    
    // Générer QR code après un court délai
    setTimeout(() => {
        const qrDiv = document.getElementById(qrDivId);
        if (qrDiv && m.codeQR && typeof QRCode !== 'undefined') {
            qrDiv.innerHTML = '';
            try {
                new QRCode(qrDiv, { 
                    text: m.codeQR, 
                    width: 70, 
                    height: 70,
                    colorDark: '#000000',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.M
                });
            } catch(e) {
                console.error('Erreur QR:', e);
                qrDiv.innerHTML = `<div class="text-center"><div class="font-mono text-xs text-gray-500">${m.codeQR}</div></div>`;
            }
        } else if (qrDiv) {
            qrDiv.innerHTML = '<span class="text-gray-400 text-xs">Pas de QR</span>';
        }
    }, 300);
}

// ==================== CONSIGNES ====================
function renderConsignes() {
    let consignes = [...DB.consignes];
    
    if (filtresConsignes.type) {
        consignes = consignes.filter(c => c.type === filtresConsignes.type);
    }
    if (filtresConsignes.statut) {
        consignes = consignes.filter(c => c.statut === filtresConsignes.statut);
    }
    
    return `
        <div class="space-y-6">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <h1 class="text-2xl font-bold"><i class="fas fa-clipboard-list mr-2 text-primary-500" style="color: var(--primary-500);"></i>Consignes</h1>
                <button onclick="ajouterConsigne()" class="btn btn-primary no-print">
                    <i class="fas fa-plus mr-2"></i>Ajouter
                </button>
            </div>
            
            <div class="card no-print">
                <div class="card-body">
                    <div class="grid-2">
                        <div>
                            <label class="block text-sm font-semibold mb-2">Type</label>
                            <select class="input" onchange="filtresConsignes.type = this.value; render()">
                                <option value="">Tous</option>
                                <option value="permanent" ${filtresConsignes.type === 'permanent' ? 'selected' : ''}>Permanentes</option>
                                <option value="temporaire" ${filtresConsignes.type === 'temporaire' ? 'selected' : ''}>Temporaires</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2">Statut</label>
                            <select class="input" onchange="filtresConsignes.statut = this.value; render()">
                                <option value="">Tous</option>
                                <option value="active" ${filtresConsignes.statut === 'active' ? 'selected' : ''}>Actives</option>
                                <option value="inactive" ${filtresConsignes.statut === 'inactive' ? 'selected' : ''}>Inactives</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="space-y-4">
                ${consignes.length > 0 ? consignes.map(c => `
                    <div class="card">
                        <div class="card-body">
                            <div class="flex items-start justify-between gap-4">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="badge ${c.type === 'permanent' ? 'badge-info' : 'badge-warning'}">${c.type}</span>
                                        <span class="badge ${c.statut === 'active' ? 'badge-success' : 'badge-danger'}">${c.statut}</span>
                                    </div>
                                    <h3 class="font-bold text-lg">${c.titre}</h3>
                                    <p class="text-gray-600 mt-2">${c.description}</p>
                                    ${c.dateExpiration ? `<p class="text-sm text-gray-500 mt-2">Expire le: ${formatDate(c.dateExpiration)}</p>` : ''}
                                </div>
                                <div class="flex gap-2 no-print">
                                    <button onclick="modifierConsigne('${c.id}')" class="btn btn-sm btn-primary"><i class="fas fa-edit"></i></button>
                                    <button onclick="supprimerConsigne('${c.id}')" class="btn btn-sm btn-danger"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('') : '<div class="empty-state"><i class="fas fa-clipboard-list"></i><p>Aucune consigne</p></div>'}
            </div>
        </div>
    `;
}

function ajouterConsigne() {
    showModal('Ajouter une consigne', `
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-semibold mb-2">Titre *</label>
                <input type="text" id="consigneTitre" class="input" placeholder="Titre de la consigne">
            </div>
            <div>
                <label class="block text-sm font-semibold mb-2">Description *</label>
                <textarea id="consigneDesc" class="input" rows="3" placeholder="Détails de la consigne..."></textarea>
            </div>
            <div>
                <label class="block text-sm font-semibold mb-2">Type</label>
                <select id="consigneType" class="input">
                    <option value="permanent">Permanente</option>
                    <option value="temporaire">Temporaire</option>
                </select>
            </div>
            <div id="dateExpirationContainer" class="hidden">
                <label class="block text-sm font-semibold mb-2">Date d'expiration</label>
                <input type="date" id="consigneExpiration" class="input">
            </div>
        </div>
    `, () => {
        const titre = document.getElementById('consigneTitre').value.trim();
        const desc = document.getElementById('consigneDesc').value.trim();
        if (!titre || !desc) { showToast('Titre et description requis', 'error'); return; }
        
        const c = {
            id: genId(),
            titre,
            description: desc,
            type: document.getElementById('consigneType').value,
            dateExpiration: document.getElementById('consigneExpiration').value || null,
            statut: 'active',
            dateCreation: new Date().toISOString()
        };
        
        DB.consignes.push(c);
        addMainCourante('Consigne', `Ajout: ${titre}`, currentUser.id);
        sauvegarderVersFirebase();
        
        closeModal();
        render();
        showToast('Consigne ajoutée');
    });
    
    document.getElementById('consigneType')?.addEventListener('change', function() {
        document.getElementById('dateExpirationContainer').classList.toggle('hidden', this.value !== 'temporaire');
    });
}

function modifierConsigne(id) {
    const c = DB.consignes.find(x => x.id === id);
    if (!c) return;
    
    showModal('Modifier la consigne', `
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-semibold mb-2">Titre *</label>
                <input type="text" id="consigneTitre" class="input" value="${c.titre}">
            </div>
            <div>
                <label class="block text-sm font-semibold mb-2">Description *</label>
                <textarea id="consigneDesc" class="input" rows="3">${c.description}</textarea>
            </div>
            <div>
                <label class="block text-sm font-semibold mb-2">Type</label>
                <select id="consigneType" class="input">
                    <option value="permanent" ${c.type === 'permanent' ? 'selected' : ''}>Permanente</option>
                    <option value="temporaire" ${c.type === 'temporaire' ? 'selected' : ''}>Temporaire</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-semibold mb-2">Statut</label>
                <select id="consigneStatut" class="input">
                    <option value="active" ${c.statut === 'active' ? 'selected' : ''}>Active</option>
                    <option value="inactive" ${c.statut === 'inactive' ? 'selected' : ''}>Inactive</option>
                </select>
            </div>
            <div id="dateExpirationContainer" class="${c.type === 'temporaire' ? '' : 'hidden'}">
                <label class="block text-sm font-semibold mb-2">Date d'expiration</label>
                <input type="date" id="consigneExpiration" class="input" value="${c.dateExpiration || ''}">
            </div>
        </div>
    `, () => {
        const titre = document.getElementById('consigneTitre').value.trim();
        const desc = document.getElementById('consigneDesc').value.trim();
        if (!titre || !desc) { showToast('Titre et description requis', 'error'); return; }
        
        c.titre = titre;
        c.description = desc;
        c.type = document.getElementById('consigneType').value;
        c.statut = document.getElementById('consigneStatut').value;
        c.dateExpiration = document.getElementById('consigneExpiration').value || null;
        
        addMainCourante('Consigne', `Modification: ${titre}`, currentUser.id);
        sauvegarderVersFirebase();
        
        closeModal();
        render();
        showToast('Consigne modifiée');
    });
    
    setTimeout(() => {
        document.getElementById('consigneType')?.addEventListener('change', function() {
            document.getElementById('dateExpirationContainer').classList.toggle('hidden', this.value !== 'temporaire');
        });
    }, 100);
}

function supprimerConsigne(id) {
    const c = DB.consignes.find(x => x.id === id);
    if (!c) return;
    
    showModal('Supprimer la consigne ?', `
        <p>Voulez-vous vraiment supprimer la consigne "<strong>${c.titre}</strong>" ?</p>
    `, () => {
        DB.consignes = DB.consignes.filter(x => x.id !== id);
        addMainCourante('Consigne', `Suppression: ${c.titre}`, currentUser.id);
        sauvegarderVersFirebase();
        
        closeModal();
        render();
        showToast('Consigne supprimée');
    }, 'Supprimer', 'Annuler');
}

// ==================== ADMINISTRATION ====================
function renderAdministration() {
    const tabs = [
        { id: 'sync', label: 'Synchronisation', icon: 'fa-cloud' },
        { id: 'qrcodes', label: 'QR Codes', icon: 'fa-qrcode' },
        { id: 'etablissement', label: 'Établissement', icon: 'fa-building' },
        { id: 'donnees', label: 'Données', icon: 'fa-database' }
    ];
    
    return `
        <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
            <h1 class="text-2xl font-bold text-gray-800">
                <i class="fas fa-cogs mr-2 text-primary-500"></i>Administration
            </h1>
            <button onclick="window.print()" class="btn btn-primary no-print">
                <i class="fas fa-print mr-2"></i>Imprimer
            </button>
        </div>
        
        <div class="flex flex-wrap gap-2 mb-6 no-print">
            ${tabs.map(t => `
                <button onclick="adminTab='${t.id}'; navigate('administration')" class="btn ${adminTab === t.id ? 'btn-primary' : 'btn-secondary'}">
                    <i class="fas ${t.icon} mr-2"></i>${t.label}
                </button>
            `).join('')}
        </div>
        
        <div class="card p-6">
            ${adminTab === 'sync' ? renderAdminSync() : ''}
            ${adminTab === 'qrcodes' ? renderAdminQRCodes() : ''}
            ${adminTab === 'etablissement' ? renderAdminEtablissement() : ''}
            ${adminTab === 'donnees' ? renderAdminDonnees() : ''}
        </div>
    `;
}

function renderAdminSync() {
    return `
        <div class="space-y-6">
            <h2 class="text-lg font-bold"><i class="fas fa-cloud mr-2"></i>Synchronisation Firebase</h2>
            <div class="grid-2">
                <div class="stat-card bg-blue-50">
                    <i class="fas fa-database text-blue-500"></i>
                    <div class="value text-blue-600">${DB.rondes.length}</div>
                    <div class="label">Rondes</div>
                </div>
                <div class="stat-card bg-green-50">
                    <i class="fas fa-list text-green-500"></i>
                    <div class="value text-green-600">${DB.mainCourante.length}</div>
                    <div class="label">Événements</div>
                </div>
            </div>
            <div class="flex gap-4 flex-wrap">
                <button onclick="sauvegarderVersFirebase(); showToast('Synchronisation lancée')" class="btn btn-primary">
                    <i class="fas fa-cloud-upload-alt mr-2"></i>Sauvegarder
                </button>
                <button onclick="chargerDepuisFirebase(); showToast('Chargement...')" class="btn btn-secondary">
                    <i class="fas fa-cloud-download-alt mr-2"></i>Charger
                </button>
            </div>
        </div>
    `;
}

function renderAdminQRCodes() {
    // Récupérer les options de filtres
    const batiments = configEtablissement.batiments;
    const typesMateriels = [...new Set(DB.materiels.map(m => m.type))];
    
    // Récupérer les secteurs du bâtiment sélectionné
    let secteursDisponibles = [];
    if (filtresQRCodes.batiment) {
        const bat = batiments.find(b => b.id === filtresQRCodes.batiment);
        if (bat) secteursDisponibles = bat.secteurs;
    }
    
    // Construire la liste des points filtrés
    let allPoints = [];
    
    // Ajouter les zones (si pas de filtre type matériel)
    if (!filtresQRCodes.type || filtresQRCodes.type === '__zones__') {
        configEtablissement.batiments.forEach(bat => {
            // Filtre par bâtiment
            if (filtresQRCodes.batiment && bat.id !== filtresQRCodes.batiment) return;
            
            bat.secteurs.forEach(sect => {
                // Filtre par secteur
                if (filtresQRCodes.secteur && sect.id !== filtresQRCodes.secteur) return;
                
                sect.zones.forEach(zone => {
                    const qr = `ZONE-${bat.id}-${sect.id}-${zone.toUpperCase().replace(/[^A-Z0-9]/g, '')}`;
                    allPoints.push({ 
                        type: 'Zone', 
                        nom: zone, 
                        chemin: `${bat.nom} > ${sect.nom}`, 
                        qrCode: qr,
                        batimentId: bat.id,
                        secteurId: sect.id
                    });
                });
            });
        });
    }
    
    // Ajouter les matériels (si pas de filtre "zones uniquement")
    if (filtresQRCodes.type !== '__zones__') {
        DB.materiels.forEach(m => {
            // Filtre par type
            if (filtresQRCodes.type && filtresQRCodes.type !== '__zones__' && m.type !== filtresQRCodes.type) return;
            
            // Filtre par bâtiment/secteur (via localisation)
            if (filtresQRCodes.batiment || filtresQRCodes.secteur) {
                let matchLoc = false;
                const bat = batiments.find(b => b.id === filtresQRCodes.batiment);
                if (bat && m.localisation?.includes(bat.nom)) {
                    if (filtresQRCodes.secteur) {
                        const sect = bat.secteurs.find(s => s.id === filtresQRCodes.secteur);
                        if (sect && m.localisation?.includes(sect.nom)) {
                            matchLoc = true;
                        }
                    } else {
                        matchLoc = true;
                    }
                }
                if (!matchLoc) return;
            }
            
            allPoints.push({ 
                type: m.type, 
                nom: m.nom, 
                chemin: m.localisation || '', 
                qrCode: m.codeQR || `MAT-${m.id}` 
            });
        });
    }
    
    setTimeout(() => genererQRCodesAdminFiltre(allPoints), 300);
    
    return `
        <div class="space-y-6">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <h2 class="text-lg font-bold"><i class="fas fa-qrcode mr-2"></i>QR Codes (${allPoints.length})</h2>
                <button onclick="imprimerQRCodesFiltres()" class="btn btn-primary">
                    <i class="fas fa-print mr-2"></i>Imprimer
                </button>
            </div>
            
            <!-- Filtres -->
            <div class="bg-gray-50 p-4 rounded-xl space-y-3">
                <div class="font-semibold text-sm text-gray-700"><i class="fas fa-filter mr-2"></i>Filtrer les QR Codes</div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">Bâtiment</label>
                        <select class="input" onchange="filtresQRCodes.batiment = this.value; filtresQRCodes.secteur = ''; navigate('administration')">
                            <option value="">Tous les bâtiments</option>
                            ${batiments.map(b => `<option value="${b.id}" ${filtresQRCodes.batiment === b.id ? 'selected' : ''}>${b.nom}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">Secteur</label>
                        <select class="input" onchange="filtresQRCodes.secteur = this.value; navigate('administration')" ${!filtresQRCodes.batiment ? 'disabled' : ''}>
                            <option value="">Tous les secteurs</option>
                            ${secteursDisponibles.map(s => `<option value="${s.id}" ${filtresQRCodes.secteur === s.id ? 'selected' : ''}>${s.nom}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">Type</label>
                        <select class="input" onchange="filtresQRCodes.type = this.value; navigate('administration')">
                            <option value="">Zones + Tous matériels</option>
                            <option value="__zones__" ${filtresQRCodes.type === '__zones__' ? 'selected' : ''}>Zones uniquement</option>
                            ${typesMateriels.map(t => `<option value="${t}" ${filtresQRCodes.type === t ? 'selected' : ''}>${t}</option>`).join('')}
                        </select>
                    </div>
                </div>
                <div class="flex justify-end">
                    <button onclick="filtresQRCodes = {batiment:'', secteur:'', type:''}; navigate('administration')" class="btn btn-secondary btn-sm">
                        <i class="fas fa-times mr-1"></i>Réinitialiser
                    </button>
                </div>
            </div>
            
            <!-- Stats -->
            <div class="grid grid-cols-2 gap-4">
                <div class="stat-card bg-blue-50">
                    <div class="text-2xl font-bold text-blue-600">${allPoints.filter(p => p.type === 'Zone').length}</div>
                    <div class="text-xs">Zones</div>
                </div>
                <div class="stat-card bg-orange-50">
                    <div class="text-2xl font-bold text-orange-600">${allPoints.filter(p => p.type !== 'Zone').length}</div>
                    <div class="text-xs">Matériels</div>
                </div>
            </div>
            
            <!-- Grille QR Codes -->
            <div class="qr-grid" id="qrCodesContainer">
                ${allPoints.length > 0 ? allPoints.slice(0, 20).map((p, i) => `
                    <div class="qr-card">
                        <div class="text-xs mb-2">
                            <span class="badge ${p.type === 'Zone' ? 'badge-info' : 'badge-warning'}">${p.type}</span>
                        </div>
                        <div id="qr-admin-${i}" class="mb-2 flex justify-center min-h-[80px]"></div>
                        <div class="font-semibold text-sm">${p.nom}</div>
                        <div class="text-xs text-gray-500 truncate">${p.chemin}</div>
                        <div class="text-xs text-gray-400 font-mono mt-1 truncate">${p.qrCode}</div>
                    </div>
                `).join('') : '<div class="col-span-full text-center py-8 text-gray-500">Aucun QR code trouvé avec ces filtres</div>'}
            </div>
            
            ${allPoints.length > 20 ? `
                <p class="text-center text-gray-500 text-sm">
                    Affichage des 20 premiers sur ${allPoints.length}. Utilisez "Imprimer" pour tous les voir.
                </p>
            ` : ''}
        </div>
    `;
}

function genererQRCodesAdminFiltre(points) {
    if (typeof QRCode === 'undefined') return;
    
    points.slice(0, 20).forEach((p, i) => {
        const container = document.getElementById(`qr-admin-${i}`);
        if (container && p.qrCode) {
            container.innerHTML = '';
            try {
                new QRCode(container, { 
                    text: p.qrCode, 
                    width: 80, 
                    height: 80,
                    colorDark: '#000000',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.M
                });
            } catch(e) {
                container.innerHTML = `<span class="text-gray-400 text-xs font-mono">${p.qrCode}</span>`;
            }
        }
    });
}

function imprimerQRCodesFiltres() {
    // Construire la liste des points filtrés (même logique que renderAdminQRCodes)
    let allPoints = [];
    const batiments = configEtablissement.batiments;
    
    // Ajouter les zones
    if (!filtresQRCodes.type || filtresQRCodes.type === '__zones__') {
        configEtablissement.batiments.forEach(bat => {
            if (filtresQRCodes.batiment && bat.id !== filtresQRCodes.batiment) return;
            
            bat.secteurs.forEach(sect => {
                if (filtresQRCodes.secteur && sect.id !== filtresQRCodes.secteur) return;
                
                sect.zones.forEach(zone => {
                    const qr = `ZONE-${bat.id}-${sect.id}-${zone.toUpperCase().replace(/[^A-Z0-9]/g, '')}`;
                    allPoints.push({ type: 'Zone', nom: zone, chemin: `${bat.nom} > ${sect.nom}`, qrCode: qr });
                });
            });
        });
    }
    
    // Ajouter les matériels
    if (filtresQRCodes.type !== '__zones__') {
        DB.materiels.forEach(m => {
            if (filtresQRCodes.type && filtresQRCodes.type !== '__zones__' && m.type !== filtresQRCodes.type) return;
            
            if (filtresQRCodes.batiment || filtresQRCodes.secteur) {
                let matchLoc = false;
                const bat = batiments.find(b => b.id === filtresQRCodes.batiment);
                if (bat && m.localisation?.includes(bat.nom)) {
                    if (filtresQRCodes.secteur) {
                        const sect = bat.secteurs.find(s => s.id === filtresQRCodes.secteur);
                        if (sect && m.localisation?.includes(sect.nom)) matchLoc = true;
                    } else {
                        matchLoc = true;
                    }
                }
                if (!matchLoc) return;
            }
            
            allPoints.push({ type: m.type, nom: m.nom, chemin: m.localisation || '', qrCode: m.codeQR || `MAT-${m.id}` });
        });
    }
    
    if (allPoints.length === 0) {
        showToast('Aucun QR code à imprimer', 'warning');
        return;
    }
    
    // Titre pour l'impression
    let titreFiltre = 'Tous les QR Codes';
    if (filtresQRCodes.batiment) {
        const bat = batiments.find(b => b.id === filtresQRCodes.batiment);
        titreFiltre = bat?.nom || '';
        if (filtresQRCodes.secteur) {
            const sect = bat?.secteurs.find(s => s.id === filtresQRCodes.secteur);
            titreFiltre += ` > ${sect?.nom || ''}`;
        }
    }
    if (filtresQRCodes.type) {
        titreFiltre += filtresQRCodes.type === '__zones__' ? ' (Zones)' : ` (${filtresQRCodes.type})`;
    }
    
    const pw = window.open('', '_blank');
    pw.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>QR Codes - ${titreFiltre}</title>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"><\/script>
            <style>
                body { font-family: Arial, sans-serif; padding: 20px; font-size: 11px; }
                h1 { text-align: center; color: #4f46e5; margin-bottom: 5px; font-size: 16px; }
                .subtitle { text-align: center; color: #666; margin-bottom: 20px; font-size: 11px; }
                .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
                .card { border: 1px solid #ccc; padding: 10px; text-align: center; page-break-inside: avoid; border-radius: 6px; }
                .card h3 { margin: 6px 0 2px; font-size: 10px; }
                .card p { margin: 0; font-size: 8px; color: #666; }
                .card .code { font-family: monospace; font-size: 7px; color: #999; margin-top: 3px; word-break: break-all; }
                .badge { font-size: 8px; padding: 2px 5px; border-radius: 8px; display: inline-block; margin-bottom: 4px; }
                .badge-zone { background: #dbeafe; color: #1d4ed8; }
                .badge-mat { background: #fef3c7; color: #d97706; }
                @media print { body { padding: 5px; } .grid { gap: 8px; } }
            </style>
        </head>
        <body>
            <h1>🔒 QR Codes SSIAP Patrol</h1>
            <p class="subtitle">${titreFiltre} • ${allPoints.length} QR codes • ${new Date().toLocaleDateString('fr-FR')}</p>
            <div class="grid">
                ${allPoints.map((p, i) => `
                    <div class="card">
                        <span class="badge ${p.type === 'Zone' ? 'badge-zone' : 'badge-mat'}">${p.type}</span>
                        <div id="qr${i}"></div>
                        <h3>${p.nom}</h3>
                        <p>${p.chemin}</p>
                        <div class="code">${p.qrCode}</div>
                    </div>
                `).join('')}
            </div>
            <script>
                ${allPoints.map((p, i) => `try { new QRCode(document.getElementById('qr${i}'), { text: '${p.qrCode}', width: 60, height: 60 }); } catch(e) {}`).join('\n')}
                setTimeout(() => window.print(), 1500);
            <\/script>
        </body>
        </html>
    `);
}

function renderAdminEtablissement() {
    const batiments = configEtablissement.batiments;
    
    // Récupérer les secteurs du bâtiment sélectionné
    let secteursDisponibles = [];
    let batimentSelectionne = null;
    if (filtresEtablissement.batiment) {
        batimentSelectionne = batiments.find(b => b.id === filtresEtablissement.batiment);
        if (batimentSelectionne) secteursDisponibles = batimentSelectionne.secteurs;
    }
    
    // Filtrer les bâtiments à afficher
    let batimentsAffiches = batiments;
    if (filtresEtablissement.batiment) {
        batimentsAffiches = batiments.filter(b => b.id === filtresEtablissement.batiment);
    }
    
    return `
        <div class="space-y-6">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <h2 class="text-lg font-bold"><i class="fas fa-building mr-2"></i>Structure de l'établissement</h2>
                <button onclick="ajouterBatiment()" class="btn btn-primary btn-sm no-print">
                    <i class="fas fa-plus mr-2"></i>Bâtiment
                </button>
            </div>
            
            <!-- Filtres -->
            <div class="bg-gray-50 p-4 rounded-xl space-y-3 no-print">
                <div class="font-semibold text-sm text-gray-700"><i class="fas fa-filter mr-2"></i>Filtrer la structure</div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">Bâtiment</label>
                        <select class="input" onchange="filtresEtablissement.batiment = this.value; filtresEtablissement.secteur = ''; navigate('administration')">
                            <option value="">Tous les bâtiments</option>
                            ${batiments.map(b => `<option value="${b.id}" ${filtresEtablissement.batiment === b.id ? 'selected' : ''}>${b.nom}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">Secteur</label>
                        <select class="input" onchange="filtresEtablissement.secteur = this.value; navigate('administration')" ${!filtresEtablissement.batiment ? 'disabled' : ''}>
                            <option value="">Tous les secteurs</option>
                            ${secteursDisponibles.map(s => `<option value="${s.id}" ${filtresEtablissement.secteur === s.id ? 'selected' : ''}>${s.nom}</option>`).join('')}
                        </select>
                    </div>
                </div>
                <div class="flex justify-end">
                    <button onclick="filtresEtablissement = {batiment:'', secteur:''}; navigate('administration')" class="btn btn-secondary btn-sm">
                        <i class="fas fa-times mr-1"></i>Réinitialiser
                    </button>
                </div>
            </div>
            
            <!-- Stats -->
            <div class="grid grid-cols-3 gap-4 no-print">
                <div class="stat-card bg-blue-50">
                    <div class="text-2xl font-bold text-blue-600">${batimentsAffiches.length}</div>
                    <div class="text-xs">Bâtiment(s)</div>
                </div>
                <div class="stat-card bg-green-50">
                    <div class="text-2xl font-bold text-green-600">${batimentsAffiches.reduce((acc, b) => {
                        if (filtresEtablissement.secteur) {
                            return acc + (b.secteurs.find(s => s.id === filtresEtablissement.secteur) ? 1 : 0);
                        }
                        return acc + b.secteurs.length;
                    }, 0)}</div>
                    <div class="text-xs">Secteur(s)</div>
                </div>
                <div class="stat-card bg-purple-50">
                    <div class="text-2xl font-bold text-purple-600">${batimentsAffiches.reduce((acc, b) => {
                        return acc + b.secteurs.reduce((acc2, s) => {
                            if (filtresEtablissement.secteur && s.id !== filtresEtablissement.secteur) return acc2;
                            return acc2 + s.zones.length;
                        }, 0);
                    }, 0)}</div>
                    <div class="text-xs">Zone(s)</div>
                </div>
            </div>
            
            <!-- Structure -->
            <div class="space-y-4">
                ${batimentsAffiches.map(bat => {
                    // Filtrer les secteurs si nécessaire
                    let secteursAffiches = bat.secteurs;
                    if (filtresEtablissement.secteur) {
                        secteursAffiches = bat.secteurs.filter(s => s.id === filtresEtablissement.secteur);
                    }
                    
                    return `
                        <div class="border rounded-xl overflow-hidden">
                            <div class="bg-blue-50 p-4 flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <i class="fas fa-building text-blue-600 text-xl"></i>
                                    <div>
                                        <div class="font-bold">${bat.nom}</div>
                                        <div class="text-sm text-gray-500">${secteursAffiches.length} secteur(s), ${secteursAffiches.reduce((acc, s) => acc + s.zones.length, 0)} zone(s)</div>
                                    </div>
                                </div>
                                <div class="flex gap-2 no-print">
                                    <button onclick="ajouterSecteur('${bat.id}')" class="btn btn-sm btn-success" title="Ajouter secteur">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                    <button onclick="supprimerBatiment('${bat.id}')" class="btn btn-sm btn-danger" title="Supprimer">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="p-4 space-y-3">
                                ${secteursAffiches.map(sect => `
                                    <div class="bg-gray-50 p-3 rounded-lg">
                                        <div class="flex items-center justify-between mb-2">
                                            <div class="font-semibold">
                                                <i class="fas fa-layer-group text-green-600 mr-2"></i>${sect.nom}
                                            </div>
                                            <div class="flex gap-1 no-print">
                                                <button onclick="ajouterZone('${bat.id}', '${sect.id}')" class="btn btn-icon btn-sm btn-success" title="Ajouter zone">
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                                <button onclick="supprimerSecteur('${bat.id}', '${sect.id}')" class="btn btn-icon btn-sm btn-danger" title="Supprimer">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="flex flex-wrap gap-2">
                                            ${sect.zones.map(zone => `
                                                <span class="badge badge-info">
                                                    ${zone}
                                                    <button onclick="supprimerZone('${bat.id}', '${sect.id}', '${zone}')" class="ml-1 text-red-500 hover:text-red-700 no-print">&times;</button>
                                                </span>
                                            `).join('')}
                                            ${sect.zones.length === 0 ? '<span class="text-gray-400 text-sm">Aucune zone</span>' : ''}
                                        </div>
                                    </div>
                                `).join('')}
                                ${secteursAffiches.length === 0 ? '<p class="text-gray-400 text-sm text-center">Aucun secteur</p>' : ''}
                            </div>
                        </div>
                    `;
                }).join('')}
                
                ${batimentsAffiches.length === 0 ? '<p class="text-gray-500 text-center py-8">Aucun bâtiment trouvé avec ces filtres</p>' : ''}
            </div>
        </div>
    `;
}

function ajouterBatiment() {
    showModal('Ajouter un bâtiment', `
        <div><label class="block text-sm font-semibold mb-2">Nom du bâtiment *</label>
        <input type="text" id="batNom" class="input" placeholder="Ex: Bâtiment C"></div>
    `, () => {
        const nom = document.getElementById('batNom').value.trim();
        if (!nom) { showToast('Nom requis', 'error'); return; }
        configEtablissement.batiments.push({ id: 'bat-' + genId(), nom, secteurs: [] });
        sauvegarderVersFirebase();
        closeModal(); render(); showToast('Bâtiment ajouté');
    });
}

function supprimerBatiment(batId) {
    showModal('Supprimer ce bâtiment ?', '<p>Cette action supprimera tous les secteurs et zones associés.</p>', () => {
        configEtablissement.batiments = configEtablissement.batiments.filter(b => b.id !== batId);
        sauvegarderVersFirebase();
        closeModal(); render(); showToast('Bâtiment supprimé');
    }, 'Supprimer');
}

function ajouterSecteur(batId) {
    showModal('Ajouter un secteur', `
        <div><label class="block text-sm font-semibold mb-2">Nom du secteur *</label>
        <input type="text" id="sectNom" class="input" placeholder="Ex: Secteur 4"></div>
    `, () => {
        const nom = document.getElementById('sectNom').value.trim();
        if (!nom) { showToast('Nom requis', 'error'); return; }
        const bat = configEtablissement.batiments.find(b => b.id === batId);
        if (bat) { bat.secteurs.push({ id: 'sect-' + genId(), nom, zones: [] }); }
        sauvegarderVersFirebase();
        closeModal(); render(); showToast('Secteur ajouté');
    });
}

function supprimerSecteur(batId, sectId) {
    const bat = configEtablissement.batiments.find(b => b.id === batId);
    if (bat) { bat.secteurs = bat.secteurs.filter(s => s.id !== sectId); }
    sauvegarderVersFirebase(); render(); showToast('Secteur supprimé');
}

function ajouterZone(batId, sectId) {
    showModal('Ajouter une zone', `
        <div><label class="block text-sm font-semibold mb-2">Nom de la zone *</label>
        <input type="text" id="zoneNom" class="input" placeholder="Ex: Zone 4A"></div>
    `, () => {
        const nom = document.getElementById('zoneNom').value.trim();
        if (!nom) { showToast('Nom requis', 'error'); return; }
        const bat = configEtablissement.batiments.find(b => b.id === batId);
        if (bat) {
            const sect = bat.secteurs.find(s => s.id === sectId);
            if (sect) { sect.zones.push(nom); }
        }
        sauvegarderVersFirebase();
        closeModal(); render(); showToast('Zone ajoutée');
    });
}

function supprimerZone(batId, sectId, zone) {
    const bat = configEtablissement.batiments.find(b => b.id === batId);
    if (bat) {
        const sect = bat.secteurs.find(s => s.id === sectId);
        if (sect) { sect.zones = sect.zones.filter(z => z !== zone); }
    }
    sauvegarderVersFirebase(); render(); showToast('Zone supprimée');
}

function renderAdminDonnees() {
    return `
        <div class="space-y-6">
            <h2 class="text-lg font-bold"><i class="fas fa-database mr-2"></i>Gestion des données</h2>
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                Attention: ces actions sont irréversibles !
            </div>
            <div class="grid-2">
                <button onclick="exporterDonnees()" class="btn btn-secondary">
                    <i class="fas fa-download mr-2"></i>Exporter JSON
                </button>
                <button onclick="document.getElementById('importFile').click()" class="btn btn-secondary">
                    <i class="fas fa-upload mr-2"></i>Importer JSON
                </button>
                <input type="file" id="importFile" accept=".json" class="hidden" onchange="importerDonnees(event)">
            </div>
            <hr>
            <div class="grid-2">
                <button onclick="reinitialiserRondes()" class="btn btn-danger">
                    <i class="fas fa-trash mr-2"></i>Supprimer les rondes
                </button>
                <button onclick="reinitialiserMainCourante()" class="btn btn-danger">
                    <i class="fas fa-trash mr-2"></i>Vider main courante
                </button>
            </div>
        </div>
    `;
}

function exporterDonnees() {
    const data = { DB, configEtablissement, exportDate: new Date().toISOString() };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ssiap-patrol-export-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    showToast('Export téléchargé');
}

function importerDonnees(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const data = JSON.parse(e.target.result);
            if (data.DB) DB = { ...DB, ...data.DB };
            if (data.configEtablissement) configEtablissement = data.configEtablissement;
            sauvegarderVersFirebase();
            render();
            showToast('Import réussi !');
        } catch (err) {
            showToast('Erreur lors de l\'import', 'error');
        }
    };
    reader.readAsText(file);
}

function reinitialiserRondes() {
    showModal('Confirmer la suppression', '<p>Supprimer toutes les rondes ?</p>', () => {
        DB.rondes = [];
        sauvegarderVersFirebase();
        closeModal(); render(); showToast('Rondes supprimées');
    }, 'Supprimer');
}

function reinitialiserMainCourante() {
    showModal('Confirmer la suppression', '<p>Vider la main courante ?</p>', () => {
        DB.mainCourante = [];
        sauvegarderVersFirebase();
        closeModal(); render(); showToast('Main courante vidée');
    }, 'Supprimer');
}

function exporterRondes() {
    let csv = 'Date;Heure début;Heure fin;Nom;Agent;Zones;Anomalies;Commentaire\n';
    DB.rondes.forEach(r => {
        csv += `${formatDate(r.dateDebut)};${formatTime(r.dateDebut)};${r.dateFin ? formatTime(r.dateFin) : '-'};${r.nom};${r.agent};${r.zonesValidees?.length || 0}/${r.zones?.length || 0};${r.anomalies?.length || 0};${r.commentaire || ''}\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `rondes-${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    showToast('Export téléchargé');
}

function imprimerMainCourante() {
    window.print();
}

// ==================== NAVIGATION & RENDER ====================
function render() {
    let content = '';
    let showNav = true;
    
    if (!currentUser) {
        content = renderLogin();
        showNav = false;
    } else {
        switch (currentPage) {
            case 'accueil': content = renderAccueil(); break;
            case 'nouvelle-ronde': content = renderNouvelleRonde(); break;
            case 'ronde-encours': content = renderRondeEnCours(); break;
            case 'scanner-ronde': content = renderScannerRonde(); break;
            case 'scanner': content = renderScanner(); break;
            case 'rondes': content = renderRondes(); break;
            case 'main-courante': content = renderMainCourante(); break;
            case 'evenement': content = renderEvenement(); break;
            case 'materiels': content = renderMateriels(); break;
            case 'consignes': content = renderConsignes(); break;
            case 'administration': content = renderAdministration(); break;
            default: content = renderAccueil();
        }
    }
    
    document.getElementById('app').innerHTML = `
        ${currentUser ? `
            <div class="header no-print">
                <div class="header-content">
                    <div class="logo">
                        <i class="fas fa-shield-halved"></i>
                        <span>SSIAP Patrol</span>
                    </div>
                    <div class="user-info">
                        <div class="user-avatar" style="background: ${currentUser.couleur}">${currentUser.prenom[0]}${currentUser.nom[0]}</div>
                        <div class="dropdown">
                            <button onclick="toggleDropdown()" class="btn btn-secondary btn-sm">
                                ${currentUser.prenom} <i class="fas fa-chevron-down ml-2"></i>
                            </button>
                            <div class="dropdown-content" id="userDropdown">
                                <div class="dropdown-item" onclick="navigate('administration')">
                                    <i class="fas fa-cog"></i> Administration
                                </div>
                                <div class="dropdown-item" onclick="logout()">
                                    <i class="fas fa-sign-out-alt"></i> Déconnexion
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        ` : ''}
        
        ${!isOnline ? '<div class="offline-banner no-print"><i class="fas fa-wifi-slash mr-2"></i>Mode hors ligne</div>' : ''}
        
        <div class="main-content">
            ${content}
        </div>
        
        ${showNav ? `
            <nav class="nav-bottom no-print">
                <div class="nav-item ${currentPage === 'accueil' ? 'active' : ''}" onclick="navigate('accueil')">
                    <i class="fas fa-home"></i>
                    <span>Accueil</span>
                </div>
                <div class="nav-item ${currentPage === 'rondes' ? 'active' : ''}" onclick="navigate('rondes')">
                    <i class="fas fa-route"></i>
                    <span>Rondes</span>
                </div>
                <div class="nav-item ${currentPage === 'main-courante' ? 'active' : ''}" onclick="navigate('main-courante')">
                    <i class="fas fa-book"></i>
                    <span>Main courante</span>
                </div>
                <div class="nav-item ${currentPage === 'materiels' ? 'active' : ''}" onclick="navigate('materiels')">
                    <i class="fas fa-tools"></i>
                    <span>Matériels</span>
                </div>
                <div class="nav-item ${currentPage === 'consignes' ? 'active' : ''}" onclick="navigate('consignes')">
                    <i class="fas fa-clipboard-list"></i>
                    <span>Consignes</span>
                </div>
            </nav>
        ` : ''}
    `;
    
    // Démarrer le scanner si nécessaire
    if (['scanner', 'scanner-ronde'].includes(currentPage)) {
        setTimeout(demarrerScanner, 100);
    }
    
    updateSyncUI();
}

function toggleDropdown() {
    document.getElementById('userDropdown')?.classList.toggle('show');
}

document.addEventListener('click', (e) => {
    if (!e.target.closest('.dropdown')) {
        document.getElementById('userDropdown')?.classList.remove('show');
    }
});

// Gestion offline
window.addEventListener('online', () => { isOnline = true; render(); sauvegarderVersFirebase(); });
window.addEventListener('offline', () => { isOnline = false; render(); });

// Initialisation
document.addEventListener('DOMContentLoaded', () => {
    initFirebase();
    render();
});
</script>
</body>
</html>
