<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSIAP Patrol - Gestion S√©curit√© Incendie</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Poppins', 'sans-serif'] },
                    colors: {
                        primary: { 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca' },
                        accent: { 500: '#8b5cf6', 600: '#7c3aed' }
                    }
                }
            }
        }
    </script>
    <style>
        * { box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; }

        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .gradient-header { background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 100%); }
        .gradient-success { background: linear-gradient(90deg, #10b981 0%, #34d399 100%); }
        .gradient-warning { background: linear-gradient(90deg, #f59e0b 0%, #fbbf24 100%); }
        .gradient-danger { background: linear-gradient(90deg, #ef4444 0%, #f87171 100%); }
        .gradient-info { background: linear-gradient(90deg, #3b82f6 0%, #60a5fa 100%); }

        .dark .gradient-bg { background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%); }
        .dark body { background: #0f172a; color: #e2e8f0; }

        .card { background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); overflow: hidden; }
        .dark .card { background: #1e293b; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }

        .sidebar { width: 280px; background: white; height: 100vh; position: fixed; left: 0; top: 0; z-index: 50; transition: transform 0.3s; }
        .dark .sidebar { background: #1e293b; }
        .sidebar-hidden { transform: translateX(-100%); }

        .nav-link { display: flex; align-items: center; gap: 12px; padding: 14px 20px; margin: 4px 12px; border-radius: 12px; color: #64748b; font-weight: 500; transition: all 0.2s; cursor: pointer; }
        .nav-link:hover { background: #f1f5f9; color: #6366f1; }
        .nav-link.active { background: linear-gradient(90deg, #6366f1, #8b5cf6); color: white; box-shadow: 0 4px 15px rgba(99,102,241,0.4); }
        .dark .nav-link:hover { background: #334155; }

        .btn { padding: 10px 20px; border-radius: 10px; font-weight: 600; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; cursor: pointer; border: none; }
        .btn-primary { background: linear-gradient(90deg, #6366f1, #8b5cf6); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(99,102,241,0.4); }
        .btn-success { background: linear-gradient(90deg, #10b981, #34d399); color: white; }
        .btn-danger { background: linear-gradient(90deg, #ef4444, #f87171); color: white; }
        .btn-warning { background: linear-gradient(90deg, #f59e0b, #fbbf24); color: white; }
        .btn-secondary { background: #f1f5f9; color: #475569; }
        .dark .btn-secondary { background: #334155; color: #e2e8f0; }
        .btn-sm { padding: 6px 12px; font-size: 13px; }
        .btn-icon { width: 36px; height: 36px; padding: 0; display: flex; align-items: center; justify-content: center; border-radius: 10px; }

        .status-btn { width: 32px; height: 32px; border-radius: 8px; border: none; cursor: pointer; transition: all 0.2s; }
        .status-btn.red { background: #ef4444; }
        .status-btn.orange { background: #f59e0b; }
        .status-btn.green { background: #10b981; }
        .status-btn:hover { transform: scale(1.1); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }

        .input { width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 15px; transition: all 0.2s; background: white; }
        .input:focus { outline: none; border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99,102,241,0.1); }
        .dark .input { background: #0f172a; border-color: #334155; color: white; }

        .badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .badge-success { background: #dcfce7; color: #16a34a; }
        .badge-warning { background: #fef3c7; color: #d97706; }
        .badge-danger { background: #fee2e2; color: #dc2626; }
        .badge-info { background: #dbeafe; color: #2563eb; }
        .badge-purple { background: #f3e8ff; color: #9333ea; }
        .dark .badge-success { background: #166534; color: #bbf7d0; }
        .dark .badge-warning { background: #92400e; color: #fde68a; }
        .dark .badge-danger { background: #991b1b; color: #fecaca; }
        .dark .badge-info { background: #1e40af; color: #bfdbfe; }
        .dark .badge-purple { background: #581c87; color: #e9d5ff; }

        .stat-card { padding: 20px; border-radius: 16px; text-align: center; }
        .stat-card .icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 12px; font-size: 20px; }
        .stat-card .value { font-size: 28px; font-weight: 700; }
        .stat-card .label { font-size: 13px; color: #64748b; margin-top: 4px; }

        .table { width: 100%; }
        .table th { padding: 14px 16px; text-align: left; font-weight: 600; color: #64748b; font-size: 13px; text-transform: uppercase; border-bottom: 2px solid #e2e8f0; }
        .table td { padding: 16px; border-bottom: 1px solid #f1f5f9; }
        .table tr:hover td { background: #f8fafc; }
        .dark .table th { border-color: #334155; }
        .dark .table td { border-color: #334155; }
        .dark .table tr:hover td { background: #334155; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 100; padding: 20px; backdrop-filter: blur(4px); }
        .modal-content { background: white; border-radius: 20px; max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto; animation: modalIn 0.3s; }
        .dark .modal-content { background: #1e293b; }
        @keyframes modalIn { from { opacity: 0; transform: scale(0.95) translateY(-20px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        .modal-header { padding: 24px 24px 0; }
        .modal-body { padding: 24px; }
        .modal-footer { padding: 0 24px 24px; display: flex; gap: 12px; justify-content: flex-end; }

        .status-dot { width: 14px; height: 14px; border-radius: 50%; display: inline-block; animation: pulse 2s infinite; }
        .status-dot.red { background: #ef4444; box-shadow: 0 0 8px #ef4444; }
        .status-dot.orange { background: #f59e0b; box-shadow: 0 0 8px #f59e0b; }
        .status-dot.green { background: #10b981; box-shadow: 0 0 8px #10b981; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

        .timeline { position: relative; padding-left: 30px; }
        .timeline::before { content: ''; position: absolute; left: 8px; top: 0; bottom: 0; width: 2px; background: #e2e8f0; }
        .dark .timeline::before { background: #334155; }
        .timeline-item { position: relative; padding-bottom: 20px; }
        .timeline-item::before { content: ''; position: absolute; left: -22px; top: 5px; width: 12px; height: 12px; border-radius: 50%; background: #6366f1; border: 2px solid white; }
        .dark .timeline-item::before { border-color: #1e293b; }
        .timeline-item.first::before { background: #ef4444; width: 16px; height: 16px; left: -24px; top: 3px; }

        .qr-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
        .qr-card { padding: 15px; border: 2px solid #e2e8f0; border-radius: 12px; text-align: center; page-break-inside: avoid; }
        .dark .qr-card { border-color: #334155; }

        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        @media (max-width: 1024px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-left: 0 !important; }
        }

        @media print {
            .no-print { display: none !important; }
            .sidebar { display: none !important; }
            .main-content { margin-left: 0 !important; }
            body { background: white; }
            .card { box-shadow: none; border: 1px solid #e2e8f0; }
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Navigation mobile pour rondiers */
        .mobile-nav-btn { transition: all 0.2s; }
        .mobile-nav-btn:active { transform: scale(0.95); }
        .mobile-nav-btn.active { color: #6366f1; }
        .mobile-nav-btn.active i { color: #6366f1; }
        .dark .mobile-nav-btn.active { color: #818cf8; }
        .dark .mobile-nav-btn.active i { color: #818cf8; }
    </style>
</head>
<body class="bg-gray-50 dark:bg-slate-900">

<!-- LOGIN PRINCIPAL (PC S√©curit√©) -->
<div id="loginScreen" class="gradient-bg min-h-screen flex items-center justify-center p-4">
    <div class="card p-8 w-full max-w-md fade-in">
        <div class="text-center mb-8">
            <div class="w-20 h-20 gradient-header rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
                <i class="fas fa-shield-alt text-white text-3xl"></i>
            </div>
            <h1 class="text-2xl font-bold text-gray-800 dark:text-white">SSIAP Patrol</h1>
            <p class="text-gray-500 mt-1">Syst√®me de gestion des rondes</p>
        </div>

        <div class="space-y-5">
            <div>
                <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Agent</label>
                <select id="loginAgent" class="input">
                    <option value="">S√©lectionner un agent...</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Mot de passe</label>
                <input type="password" id="loginPassword" class="input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <div class="bg-gray-50 dark:bg-slate-800 rounded-xl p-4 text-sm">
                <div class="font-semibold text-gray-700 dark:text-gray-300 mb-2">üîê Mots de passe</div>
                <div class="space-y-1 text-gray-600 dark:text-gray-400">
                    <div>SSIAP 1 ‚Üí <code class="bg-gray-200 dark:bg-slate-700 px-2 py-0.5 rounded">rondier</code></div>
                    <div>SSIAP 2 ‚Üí <code class="bg-gray-200 dark:bg-slate-700 px-2 py-0.5 rounded">chefdeposte</code></div>
                    <div>SSIAP 3 ‚Üí <code class="bg-gray-200 dark:bg-slate-700 px-2 py-0.5 rounded">ssiap3</code></div>
                </div>
            </div>
            <div id="loginError" class="text-red-500 text-sm font-medium hidden"></div>
            <button onclick="login()" class="btn btn-primary w-full justify-center py-3">
                <i class="fas fa-sign-in-alt"></i> Se connecter
            </button>
            <div class="pt-4 border-t border-gray-200 dark:border-gray-700 mt-4">
                <button onclick="accederModeRondier()" class="btn btn-secondary w-full justify-center">
                    <i class="fas fa-mobile-alt"></i> Acc√®s Rondier Mobile
                </button>
            </div>
        </div>
    </div>
</div>

<!-- LOGIN RONDIER (T√©l√©phone mobile) -->
<div id="loginRondier" class="gradient-bg min-h-screen flex items-center justify-center p-4 hidden">
    <div class="card p-6 w-full max-w-md fade-in">
        <div class="text-center mb-6">
            <div class="w-16 h-16 bg-orange-500 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
                <i class="fas fa-walking text-white text-2xl"></i>
            </div>
            <h1 class="text-xl font-bold text-gray-800 dark:text-white">Connexion Rondier</h1>
            <p class="text-gray-500 text-sm mt-1">S√©lectionnez votre nom pour commencer</p>
        </div>

        <div id="rondierLoading" class="text-center py-8">
            <i class="fas fa-sync-alt fa-spin text-3xl text-primary-500 mb-4"></i>
            <p class="text-gray-500">Chargement des agents en poste...</p>
        </div>

        <div id="rondierContent" class="space-y-4 hidden">
            <div id="rondierAgentsList" class="space-y-2">
                <!-- Agents en poste seront list√©s ici -->
            </div>

            <div id="rondierNoAgent" class="text-center py-6 hidden">
                <div class="w-16 h-16 bg-yellow-100 dark:bg-yellow-900/50 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-exclamation-triangle text-yellow-600 text-2xl"></i>
                </div>
                <p class="text-gray-600 dark:text-gray-400 font-medium">Aucun rondier en poste</p>
                <p class="text-gray-500 text-sm mt-2">Faites votre prise de poste au PC S√©curit√© d'abord.</p>
                <button onclick="rechargerAgentsRondier()" class="btn btn-secondary mt-4">
                    <i class="fas fa-sync-alt"></i> Actualiser
                </button>
            </div>

            <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
                <button onclick="afficherLoginPrincipal()" class="btn btn-secondary w-full justify-center">
                    <i class="fas fa-desktop"></i> Connexion PC S√©curit√©
                </button>
            </div>
        </div>
    </div>
</div>

<!-- MAIN APP -->
<div id="mainApp" class="hidden">
    <aside class="sidebar no-print" id="sidebar">
        <div class="p-6 border-b border-gray-100 dark:border-slate-700">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 gradient-header rounded-xl flex items-center justify-center shadow-lg">
                    <i class="fas fa-shield-alt text-white text-xl"></i>
                </div>
                <div>
                    <div class="font-bold text-lg text-gray-800 dark:text-white">SSIAP Patrol</div>
                    <div class="text-xs text-gray-500" id="userBadge"></div>
                    <div class="text-xs" id="firebaseStatus"></div>
                </div>
            </div>
        </div>

        <nav class="py-4 pb-48 overflow-y-auto" id="navMenu" style="max-height: calc(100vh - 120px);"></nav>

        <div class="absolute bottom-0 left-0 right-0 p-4 border-t border-gray-100 dark:border-slate-700 space-y-2 bg-white dark:bg-slate-800" id="sidebarActions">
            <!-- Boutons dynamiques selon le niveau SSIAP -->
        </div>
    </aside>

    <!-- Header mobile - masqu√© pour SSIAP 1 qui utilise la barre en bas -->
    <header id="mobileHeader" class="lg:hidden fixed top-0 left-0 right-0 bg-white dark:bg-slate-800 shadow-md z-40 p-4 flex items-center justify-between no-print">
        <button onclick="toggleSidebar()" class="btn btn-icon btn-secondary">
            <i class="fas fa-bars"></i>
        </button>
        <div class="font-bold text-gray-800 dark:text-white">SSIAP Patrol</div>
        <button onclick="logout()" class="btn btn-icon btn-secondary">
            <i class="fas fa-sign-out-alt"></i>
        </button>
    </header>

    <!-- Header simplifi√© pour rondiers SSIAP 1 -->
    <header id="rondierHeader" class="lg:hidden fixed top-0 left-0 right-0 gradient-header text-white z-40 p-3 hidden no-print">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
                    <i class="fas fa-walking"></i>
                </div>
                <div>
                    <div class="font-semibold text-sm" id="rondierHeaderName">Rondier</div>
                    <div class="text-xs opacity-80">En service</div>
                </div>
            </div>
            <button onclick="logout()" class="btn btn-sm bg-white/20 hover:bg-white/30 text-white border-0">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </div>
    </header>

    <div id="sidebarOverlay" class="fixed inset-0 bg-black/50 z-40 hidden lg:hidden" onclick="toggleSidebar()"></div>

    <main class="main-content lg:ml-[280px] min-h-screen pt-20 lg:pt-0 pb-20 lg:pb-0">
        <div class="p-6" id="mainContent"></div>
    </main>

    <!-- Barre de navigation mobile pour rondiers SSIAP 1 -->
    <nav id="mobileNavBar" class="lg:hidden fixed bottom-0 left-0 right-0 bg-white dark:bg-slate-800 border-t border-gray-200 dark:border-slate-700 z-50 hidden">
        <div class="flex justify-around items-center h-16">
            <button onclick="navigate('rondes')" id="mobileNavRondes" class="mobile-nav-btn flex flex-col items-center justify-center flex-1 h-full text-gray-500 dark:text-gray-400">
                <i class="fas fa-route text-xl mb-1"></i>
                <span class="text-xs font-medium">Rondes</span>
            </button>
            <button onclick="navigate('materiels')" id="mobileNavMateriels" class="mobile-nav-btn flex flex-col items-center justify-center flex-1 h-full text-gray-500 dark:text-gray-400">
                <i class="fas fa-fire-extinguisher text-xl mb-1"></i>
                <span class="text-xs font-medium">Mat√©riels</span>
            </button>
            <button onclick="navigate('consignes')" id="mobileNavConsignes" class="mobile-nav-btn flex flex-col items-center justify-center flex-1 h-full text-gray-500 dark:text-gray-400">
                <i class="fas fa-file-alt text-xl mb-1"></i>
                <span class="text-xs font-medium">Consignes</span>
            </button>
        </div>
    </nav>
</div>

<div id="modalContainer"></div>

<script>
// ========== DATABASE ==========
const DB = {
    agents: [
        { id: 1, nom: 'Martin', prenom: 'Jean-Pierre', qualification: 'SSIAP 2', entreprise: 'SecuriPlus', actif: true, email: 'jp.martin@securiplus.fr', dateDiplome: '2020-05-15', dateRecyclage: '2023-05-15', dateDebutContrat: '2020-06-01', dateFinContrat: null },
        { id: 2, nom: 'Dupont', prenom: 'Alain', qualification: 'SSIAP 1', entreprise: 'SecuriPlus', actif: true, email: 'a.dupont@securiplus.fr', dateDiplome: '2019-03-10', dateRecyclage: '2022-03-10', dateDebutContrat: '2019-04-01', dateFinContrat: null },
        { id: 3, nom: 'Boyer', prenom: 'Michel', qualification: 'SSIAP 1', entreprise: 'SecuriPlus', actif: true, email: 'm.boyer@securiplus.fr', dateDiplome: '2018-11-20', dateRecyclage: '2021-11-20', dateDebutContrat: '2018-12-01', dateFinContrat: null },
        { id: 4, nom: 'Dubois', prenom: 'Marie', qualification: 'SSIAP 2', entreprise: 'SecuriPlus', actif: true, email: 'm.dubois@securiplus.fr', dateDiplome: '2021-01-25', dateRecyclage: '2024-01-25', dateDebutContrat: '2021-02-01', dateFinContrat: null },
        { id: 5, nom: 'Garcia', prenom: 'Pierre', qualification: 'SSIAP 1', entreprise: 'SecuriPlus', actif: true, email: 'p.garcia@securiplus.fr', dateDiplome: '2020-09-05', dateRecyclage: '2023-09-05', dateDebutContrat: '2020-10-01', dateFinContrat: null },
        { id: 6, nom: 'Leroy', prenom: 'Fran√ßois', qualification: 'SSIAP 3', entreprise: 'SecuriPlus', actif: true, email: 'f.leroy@securiplus.fr', dateDiplome: '2017-07-12', dateRecyclage: '2023-07-12', dateDebutContrat: '2017-08-01', dateFinContrat: null }
    ],
    materiels: [
        { id: 1, nom: 'Extincteur CO2 5kg - Hall', type: 'Extincteur', localisation: 'Hall Entr√©e - Zone A', statut: 'Op√©rationnel', derniereMaint: '2025-01-15', prochaineMaint: '2026-01-15' },
        { id: 2, nom: 'RIA DN25 - Couloir 2√®me', type: 'RIA', localisation: 'Couloir 2√®me √©tage', statut: 'Op√©rationnel', derniereMaint: '2025-02-01', prochaineMaint: '2026-02-01' },
        { id: 3, nom: 'D√©tecteur Optique B05', type: 'D√©tecteur', localisation: 'Bureau 205 - 2√®me √©tage', statut: '√Ä v√©rifier', derniereMaint: '2024-12-01', prochaineMaint: '2025-06-01' },
        { id: 4, nom: 'PCF Escalier A', type: 'Porte CF', localisation: 'Escalier A - RDC', statut: 'Op√©rationnel', derniereMaint: '2025-03-01', prochaineMaint: '2025-09-01' },
        { id: 5, nom: 'Extincteur Eau 6L - Cuisine', type: 'Extincteur', localisation: 'Cuisine - RDC', statut: 'En maintenance', derniereMaint: '2025-01-10', prochaineMaint: '2026-01-10' }
    ],
    prisesPoste: [],
    rondes: [],
    evenements: [],
    mainCourante: [],
    consignes: [
        { id: 1, titre: 'Visite commission de s√©curit√©', niveau: 'Particuli√®re', destinataire: 'Tout le monde', priorite: 'Haute', contenu: 'Commission de s√©curit√© pr√©vue le 15 octobre 2025. V√©rifier la mise √† jour des registres.', dateDebut: '2025-07-01', dateFin: '2025-10-15', active: true },
        { id: 2, titre: 'Contr√¥le acc√®s livraisons', niveau: 'Courante', destinataire: 'Chef de poste', priorite: 'Normale', contenu: 'V√©rifier syst√©matiquement les bons de livraison et noter les immatriculations.', dateDebut: '2025-01-01', dateFin: null, active: true }
    ]
};

let currentUser = null;
let currentView = 'dashboard';
let modalConfirmCallback = null;

// ========== FIREBASE ==========
const firebaseConfig = {
    apiKey: "AIzaSyBXK-4-9HBcTKCPQBdRzDSwTc55vRXWNOk",
    authDomain: "ssiap-patrol.firebaseapp.com",
    projectId: "ssiap-patrol",
    storageBucket: "ssiap-patrol.firebasestorage.app",
    messagingSenderId: "582750096370",
    appId: "1:582750096370:web:025f700bc1bf9194afb96b",
    measurementId: "G-3VW3N2LK4G"
};

let firebaseApp = null;
let db = null;
let firestoreEnabled = false;
let donneesChargees = false; // IMPORTANT: Flag pour bloquer les sauvegardes avant chargement

try {
    if (typeof firebase !== 'undefined') {
        firebaseApp = firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        firestoreEnabled = true;
        console.log('Firebase initialis√© avec succ√®s');
        updateFirebaseStatus(true);
        // NE PAS appeler activerSyncTempsReel ici - on le fera apr√®s le chargement initial
    }
} catch (e) {
    console.log('Firebase non disponible:', e);
    firestoreEnabled = false;
    updateFirebaseStatus(false);
}

function updateFirebaseStatus(connected) {
    setTimeout(() => {
        const el = document.getElementById('firebaseStatus');
        if (el) {
            if (connected) {
                el.innerHTML = '<span class="text-green-600"><i class="fas fa-cloud"></i> Firebase connect√©</span>';
            } else {
                el.innerHTML = '<span class="text-red-600"><i class="fas fa-cloud-slash"></i> Hors ligne</span>';
            }
        }
    }, 100);
}

function sauvegarderVersFirebase() {
    if (!firestoreEnabled || !db) return;

    // PROTECTION: Ne jamais sauvegarder si les donn√©es n'ont pas √©t√© charg√©es
    if (!donneesChargees) {
        console.warn('‚ö†Ô∏è BLOQU√â: Tentative de sauvegarde avant chargement des donn√©es');
        return;
    }

    try {
        const saveData = {
            version: '1.0',
            date: new Date().toISOString(),
            agents: DB.agents,
            materiels: DB.materiels,
            prisesPoste: DB.prisesPoste,
            rondes: DB.rondes,
            evenements: DB.evenements,
            mainCourante: DB.mainCourante,
            consignes: DB.consignes,
            configEtablissement: configEtablissement,
            typesRondes: typesRondes
        };

        console.log('üíæ Sauvegarde Firebase - prisesPoste:', DB.prisesPoste.length);
        db.collection('ssiap-patrol').doc('data').set(saveData)
            .then(() => console.log('‚úÖ Donn√©es sauvegard√©es dans Firebase'))
            .catch(err => console.error('Erreur sauvegarde Firebase:', err));
    } catch (e) {
        console.error('Erreur lors de la sauvegarde Firebase:', e);
    }
}

function chargerDepuisFirebase(callback) {
    if (!firestoreEnabled || !db) {
        donneesChargees = true; // Marquer comme charg√© m√™me sans Firebase
        if (callback) callback();
        return;
    }

    try {
        db.collection('ssiap-patrol').doc('data').get()
            .then(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    DB.agents = data.agents || DB.agents;
                    DB.materiels = data.materiels || DB.materiels;
                    DB.prisesPoste = data.prisesPoste || [];
                    DB.rondes = data.rondes || [];
                    DB.evenements = data.evenements || [];
                    DB.mainCourante = data.mainCourante || [];
                    DB.consignes = data.consignes || DB.consignes;
                    // Charger la config √©tablissement et types de rondes
                    if (data.configEtablissement) configEtablissement = data.configEtablissement;
                    if (data.typesRondes) typesRondes = data.typesRondes;
                    console.log('‚úÖ Donn√©es charg√©es depuis Firebase');
                    console.log('üìä prisesPoste charg√©es:', DB.prisesPoste.length);
                } else {
                    console.log('‚ö†Ô∏è Document Firebase non trouv√© - utilisation des donn√©es par d√©faut');
                }
                // IMPORTANT: Marquer les donn√©es comme charg√©es MAINTENANT
                donneesChargees = true;
                console.log('üîì Sauvegardes autoris√©es maintenant');

                // Toujours appeler le callback, m√™me si pas de donn√©es
                if (callback) callback();
                else initLogin();
            })
            .catch(err => {
                console.error('Erreur chargement Firebase:', err);
                donneesChargees = true; // Permettre quand m√™me les sauvegardes
                if (callback) callback();
                else initLogin();
            });
    } catch (e) {
        console.error('Erreur lors du chargement Firebase:', e);
        donneesChargees = true;
        if (callback) callback();
        else initLogin();
    }
}

// Activer l'√©coute en temps r√©el Firebase
function activerSyncTempsReel() {
    if (!firestoreEnabled || !db) return;

    try {
        db.collection('ssiap-patrol').doc('data').onSnapshot(doc => {
            if (doc.exists) {
                const data = doc.data();
                DB.agents = data.agents || DB.agents;
                DB.materiels = data.materiels || DB.materiels;
                DB.prisesPoste = data.prisesPoste || [];
                DB.rondes = data.rondes || [];
                DB.evenements = data.evenements || [];
                DB.mainCourante = data.mainCourante || [];
                DB.consignes = data.consignes || DB.consignes;
                // Sync config √©tablissement et types de rondes
                if (data.configEtablissement) configEtablissement = data.configEtablissement;
                if (data.typesRondes) typesRondes = data.typesRondes;
                console.log('üîÑ Donn√©es synchronis√©es en temps r√©el');

                // Rafra√Æchir la vue actuelle si l'app est ouverte
                if (currentUser && currentView) {
                    const c = document.getElementById('mainContent');
                    if (c && views[currentView]) {
                        c.innerHTML = '<div class="fade-in">' + views[currentView]() + '</div>';
                    }
                }
            }
        }, err => {
            console.error('Erreur sync temps r√©el:', err);
        });
    } catch (e) {
        console.error('Erreur activation sync temps r√©el:', e);
    }
}

// Rafra√Æchir manuellement les donn√©es
function rafraichirDonnees() {
    showToast('üîÑ Synchronisation...', 'info');
    chargerDepuisFirebase(() => {
        showToast('‚úÖ Donn√©es synchronis√©es !');
        if (currentView) {
            navigate(currentView);
        }
    });
}

// ========== DARK MODE ==========
if (window.matchMedia?.('(prefers-color-scheme: dark)').matches) {
    document.documentElement.classList.add('dark');
}
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
    document.documentElement.classList.toggle('dark', e.matches);
});

// ========== UTILITIES ==========
const formatDate = d => d ? new Date(d).toLocaleDateString('fr-FR') : '-';
const formatTime = d => d ? new Date(d).toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'}) : '-';
const formatDateTime = d => d ? `${formatDate(d)} ${formatTime(d)}` : '-';
const genId = () => Date.now() + Math.random();

function getAgentsEnPoste() {
    return DB.prisesPoste.filter(p => !p.finPoste).map(p => {
        const agent = DB.agents.find(a => a.id === p.agentId);
        return agent ? { ...agent, prisePosteId: p.id, poste: p.poste, heureDebut: p.heureDebut } : null;
    }).filter(Boolean);
}

function getChefDePoste() {
    return getAgentsEnPoste().find(a => a.poste === 'Chef de poste');
}

function addMainCourante(type, description, agentId, extra = {}) {
    const agent = DB.agents.find(a => a.id === agentId);
    DB.mainCourante.unshift({
        id: genId(), date: new Date().toISOString(), type, description,
        agent: agent ? `${agent.prenom} ${agent.nom}` : 'Syst√®me', agentId, ...extra
    });
    sauvegarderVersFirebase();
}

function getStatusColor(statut) {
    if (statut === 'D√©but' || statut === 'Alerte' || statut === 'Nouveau') return 'red';
    if (statut === 'En cours') return 'orange';
    if (statut === 'Termin√©') return 'green';
    return 'red';
}

function verifierRecyclages() {
    const maintenant = new Date();
    const troixAnsEnMs = 3 * 365 * 24 * 60 * 60 * 1000;
    let modifie = false;

    DB.agents.forEach(agent => {
        if (agent.dateRecyclage) {
            const dateRecyclage = new Date(agent.dateRecyclage);
            const diff = maintenant - dateRecyclage;

            if (diff > troixAnsEnMs && agent.actif) {
                agent.actif = false;
                modifie = true;
                console.log(`Agent ${agent.prenom} ${agent.nom} d√©sactiv√©: recyclage expir√© depuis ${formatDate(agent.dateRecyclage)}`);
            }
        }
    });

    // Ne sauvegarder QUE si quelque chose a chang√©
    if (modifie) {
        sauvegarderVersFirebase();
    }
}

function verifierDateContrat() {
    if (!currentUser) return;

    const agent = DB.agents.find(a => a.id === currentUser.id);
    if (!agent) return;

    const maintenant = new Date();

    if (agent.dateFinContrat) {
        const dateFin = new Date(agent.dateFinContrat);
        if (maintenant > dateFin) {
            showToast('Votre contrat est expir√©. D√©connexion...', 'error');
            setTimeout(() => {
                logout();
            }, 2000);
            return;
        }
    }

    if (!agent.actif) {
        showToast('Votre compte a √©t√© d√©sactiv√©. D√©connexion...', 'error');
        setTimeout(() => {
            logout();
        }, 2000);
    }
}

setInterval(verifierDateContrat, 60000);

// ========== LOGIN ==========
function initLogin() {
    const sel = document.getElementById('loginAgent');
    sel.innerHTML = '<option value="">S√©lectionner un agent...</option>' +
        DB.agents.filter(a => a.actif).map(a =>
            `<option value="${a.id}">${a.prenom} ${a.nom} - ${a.qualification}</option>`
        ).join('');
}

function login() {
    const agentId = parseInt(document.getElementById('loginAgent').value);
    const pwd = document.getElementById('loginPassword').value;
    const agent = DB.agents.find(a => a.id === agentId);

    if (!agent) return showLoginError('S√©lectionnez un agent');

    const validPwd = agent.qualification === 'SSIAP 3' ? (pwd === 'ssiap3') :
                     agent.qualification === 'SSIAP 2' ? (pwd === 'chefdeposte') : (pwd === 'rondier');

    if (!validPwd) return showLoginError('Mot de passe incorrect');

    currentUser = { ...agent };
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('mainApp').classList.remove('hidden');
    document.getElementById('userBadge').innerHTML = `<span class="badge badge-purple">${currentUser.qualification}</span> ${currentUser.prenom} ${currentUser.nom}`;

    // Recharger les donn√©es Firebase √† la connexion pour avoir les derni√®res infos
    chargerDepuisFirebase(() => {
        console.log('Donn√©es recharg√©es apr√®s connexion');
        initApp();
    });
}

function showLoginError(msg) {
    const el = document.getElementById('loginError');
    el.textContent = msg;
    el.classList.remove('hidden');
}

function logout() {
    // Sauvegarde automatique pour SSIAP 2 √† la d√©connexion
    if (currentUser?.qualification === 'SSIAP 2') {
        sauvegarderVersFirebase();
        telechargerBackupAuto();
    }

    currentUser = null;
    document.getElementById('mainApp').classList.add('hidden');

    // V√©rifier si on est en mode rondier
    if (detecterModeRondier()) {
        afficherLoginRondier(true); // Forcer le rechargement
    } else {
        document.getElementById('loginScreen').classList.remove('hidden');
        document.getElementById('loginRondier').classList.add('hidden');
        document.getElementById('loginPassword').value = '';
        document.getElementById('loginError').classList.add('hidden');
    }
}

function telechargerBackupAuto() {
    const saveData = {
        version: '1.0',
        date: new Date().toISOString(),
        agents: DB.agents,
        materiels: DB.materiels,
        prisesPoste: DB.prisesPoste,
        rondes: DB.rondes,
        evenements: DB.evenements,
        mainCourante: DB.mainCourante,
        consignes: DB.consignes
    };

    const blob = new Blob([JSON.stringify(saveData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'ssiap-patrol-backup.json'; // Toujours le m√™me nom = √©crase l'ancien
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// ========== NAVIGATION ==========
const menuItems = [
    { id: 'dashboard', icon: 'fa-tachometer-alt', label: 'Tableau de bord', ssiap1: false, ssiap2: true, ssiap3: true },
    { id: 'prisePoste', icon: 'fa-user-clock', label: 'Prise de Poste', ssiap1: false, ssiap2: true, ssiap3: false },
    { id: 'verifications', icon: 'fa-clipboard-check', label: 'V√©rifications', ssiap1: false, ssiap2: true, ssiap3: true },
    { id: 'rondes', icon: 'fa-route', label: 'Rondes', ssiap1: true, ssiap2: true, ssiap3: true },
    { id: 'mainCourante', icon: 'fa-clipboard-list', label: 'Main Courante', ssiap1: false, ssiap2: true, ssiap3: true },
    { id: 'evenements', icon: 'fa-exclamation-triangle', label: '√âv√©nements', ssiap1: false, ssiap2: true, ssiap3: true },
    { id: 'materiels', icon: 'fa-fire-extinguisher', label: 'Mat√©riels', ssiap1: true, ssiap2: true, ssiap3: true },
    { id: 'consignes', icon: 'fa-file-alt', label: 'Consignes', ssiap1: true, ssiap2: true, ssiap3: true },
    { id: 'agents', icon: 'fa-users', label: 'Agents', ssiap1: false, ssiap2: false, ssiap3: true },
    { id: 'administration', icon: 'fa-cogs', label: 'Administration', ssiap1: false, ssiap2: false, ssiap3: true }
];

function initApp() {
    renderNav();
    renderSidebarActions();
    updateMobileNav();

    // V√©rifier les maintenances √† venir (J-30) et cr√©er les consignes automatiquement
    verifierMaintenances();

    const defaultView = currentUser?.qualification === 'SSIAP 1' ? 'rondes' : 'dashboard';
    navigate(defaultView);
}

function renderSidebarActions() {
    const qual = currentUser?.qualification;
    const container = document.getElementById('sidebarActions');

    let html = '';

    // SSIAP 3 : Boutons manuels de sauvegarde/chargement
    if (qual === 'SSIAP 3') {
        html += `
            <button onclick="sauvegarderVersFirebase(); sauvegarderDonnees();" class="btn btn-success w-full justify-center btn-sm" title="Sauvegarder dans Firebase + fichier">
                <i class="fas fa-cloud-upload-alt"></i> Sauvegarder
            </button>
            <button onclick="chargerDonnees()" class="btn btn-secondary w-full justify-center btn-sm">
                <i class="fas fa-upload"></i> Charger fichier
            </button>
        `;
    }

    // Bouton d√©connexion pour tous
    html += `
        <button onclick="logout()" class="btn btn-secondary w-full justify-center">
            <i class="fas fa-sign-out-alt"></i> D√©connexion
        </button>
    `;

    container.innerHTML = html;
}

function renderNav() {
    const qual = currentUser?.qualification;
    document.getElementById('navMenu').innerHTML = menuItems
        .filter(m => {
            if (qual === 'SSIAP 3') return m.ssiap3;
            if (qual === 'SSIAP 2') return m.ssiap2;
            if (qual === 'SSIAP 1') return m.ssiap1;
            return false;
        })
        .map(m => `
            <div class="nav-link ${currentView === m.id ? 'active' : ''}" onclick="navigate('${m.id}')">
                <i class="fas ${m.icon} w-5"></i>
                <span>${m.label}</span>
            </div>
        `).join('');
}

function navigate(view) {
    currentView = view;
    renderNav();
    updateMobileNav();
    const c = document.getElementById('mainContent');
    c.innerHTML = '<div class="fade-in">' + (views[view]?.() || '') + '</div>';

    // Fermer la sidebar sur mobile apr√®s navigation
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebarOverlay');
    if (sidebar && sidebar.classList.contains('open')) {
        sidebar.classList.remove('open');
        overlay?.classList.add('hidden');
    }

    // G√©n√©rer le QR code d'acc√®s rondier sur le dashboard
    if (view === 'dashboard') {
        setTimeout(() => {
            const qrDiv = document.getElementById('qrCodeAccess');
            if (qrDiv && typeof QRCode !== 'undefined') {
                qrDiv.innerHTML = '';
                // G√©n√©rer l'URL avec le param√®tre mode=rondier pour le mobile
                const baseUrl = window.location.href.split('?')[0];
                const rondierUrl = baseUrl + '?mode=rondier';
                new QRCode(qrDiv, {
                    text: rondierUrl,
                    width: 120,
                    height: 120
                });
            }
        }, 100);
    }
}

function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('open');
    document.getElementById('sidebarOverlay').classList.toggle('hidden');
}

function updateMobileNav() {
    const mobileNav = document.getElementById('mobileNavBar');
    const mobileHeader = document.getElementById('mobileHeader');
    const rondierHeader = document.getElementById('rondierHeader');
    const rondierName = document.getElementById('rondierHeaderName');

    // Afficher la barre de nav mobile uniquement pour SSIAP 1
    if (currentUser?.qualification === 'SSIAP 1') {
        // Afficher nav en bas et header rondier
        mobileNav?.classList.remove('hidden');
        mobileHeader?.classList.add('hidden');
        rondierHeader?.classList.remove('hidden');

        // Mettre √† jour le nom dans le header
        if (rondierName && currentUser) {
            rondierName.textContent = `${currentUser.prenom} ${currentUser.nom}`;
        }

        // Mettre √† jour l'√©tat actif des boutons
        const buttons = {
            'rondes': document.getElementById('mobileNavRondes'),
            'materiels': document.getElementById('mobileNavMateriels'),
            'consignes': document.getElementById('mobileNavConsignes')
        };

        Object.keys(buttons).forEach(id => {
            if (buttons[id]) {
                if (currentView === id) {
                    buttons[id].classList.add('active');
                } else {
                    buttons[id].classList.remove('active');
                }
            }
        });
    } else {
        // Pour SSIAP 2/3, afficher header normal
        mobileNav?.classList.add('hidden');
        mobileHeader?.classList.remove('hidden');
        rondierHeader?.classList.add('hidden');
    }
}

// ========== VIEWS ==========
const views = {
    dashboard: renderDashboard,
    prisePoste: renderPrisePoste,
    verifications: renderVerifications,
    rondes: renderRondes,
    mainCourante: renderMainCourante,
    evenements: renderEvenements,
    materiels: renderMateriels,
    consignes: renderConsignes,
    agents: renderAgents,
    administration: renderAdministration
};

// ========== DASHBOARD ==========
function renderDashboard() {
    const agentsPoste = getAgentsEnPoste();
    const chef = getChefDePoste();
    const equipiers = agentsPoste.filter(a => a.poste !== 'Chef de poste');
    const rondesEnCours = DB.rondes.filter(r => !r.heureFin);
    const evtsEnCours = DB.evenements.filter(e => e.statut !== 'Termin√©');
    const todayEvents = DB.mainCourante.filter(m => new Date(m.date).toDateString() === new Date().toDateString());

    // Calculer les maintenances en retard et √† venir
    const aujourd_hui = new Date();
    const maintenancesEnRetard = DB.materiels.filter(m => {
        if (!m.prochaineMaint) return false;
        return new Date(m.prochaineMaint) < aujourd_hui;
    });
    const maintenancesProches = DB.materiels.filter(m => {
        if (!m.prochaineMaint) return false;
        const dateMaint = new Date(m.prochaineMaint);
        const dans30jours = new Date(aujourd_hui);
        dans30jours.setDate(dans30jours.getDate() + 30);
        return dateMaint >= aujourd_hui && dateMaint <= dans30jours;
    });

    return `
        <div class="gradient-header text-white p-6 rounded-2xl mb-6 shadow-lg flex flex-wrap items-center justify-between gap-4">
            <div>
                <h1 class="text-2xl font-bold">Tableau de bord SSIAP</h1>
                <p class="opacity-90">${new Date().toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
            </div>
            <div class="bg-white p-3 rounded-xl no-print">
                <div id="qrCodeAccess"></div>
                <p class="text-center text-xs text-gray-600 mt-2"><i class="fas fa-mobile-alt mr-1"></i>Acc√®s Rondier Mobile</p>
            </div>
        </div>

        <div class="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
            <div class="stat-card bg-white dark:bg-slate-800">
                <div class="icon bg-green-100 dark:bg-green-900 text-green-600 dark:text-green-400"><i class="fas fa-users"></i></div>
                <div class="value text-gray-800 dark:text-white">${agentsPoste.length}</div>
                <div class="label">Agents en poste</div>
            </div>
            <div class="stat-card bg-white dark:bg-slate-800">
                <div class="icon bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-400"><i class="fas fa-route"></i></div>
                <div class="value text-gray-800 dark:text-white">${rondesEnCours.length}</div>
                <div class="label">Rondes en cours</div>
            </div>
            <div class="stat-card bg-white dark:bg-slate-800">
                <div class="icon bg-red-100 dark:bg-red-900 text-red-600 dark:text-red-400"><i class="fas fa-exclamation-triangle"></i></div>
                <div class="value text-gray-800 dark:text-white">${evtsEnCours.length}</div>
                <div class="label">√âv√©nements actifs</div>
            </div>
            <div class="stat-card bg-white dark:bg-slate-800">
                <div class="icon bg-purple-100 dark:bg-purple-900 text-purple-600 dark:text-purple-400"><i class="fas fa-clipboard-list"></i></div>
                <div class="value text-gray-800 dark:text-white">${todayEvents.length}</div>
                <div class="label">Actions aujourd'hui</div>
            </div>
            <div class="stat-card bg-white dark:bg-slate-800 ${maintenancesEnRetard.length > 0 ? 'ring-2 ring-orange-500 animate-pulse' : ''}" onclick="navigate('materiels')" style="cursor: pointer;">
                <div class="icon ${maintenancesEnRetard.length > 0 ? 'bg-orange-100 dark:bg-orange-900 text-orange-600 dark:text-orange-400' : 'bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-400'}"><i class="fas fa-wrench"></i></div>
                <div class="value ${maintenancesEnRetard.length > 0 ? 'text-orange-600 dark:text-orange-400' : 'text-gray-800 dark:text-white'}">${maintenancesEnRetard.length}</div>
                <div class="label">${maintenancesEnRetard.length > 0 ? 'Maint. en retard !' : 'Maint. en retard'}</div>
                ${maintenancesProches.length > 0 ? `<div class="text-xs text-yellow-600 dark:text-yellow-400 mt-1"><i class="fas fa-clock"></i> +${maintenancesProches.length} √† venir</div>` : ''}
            </div>
        </div>

        ${evtsEnCours.length ? `
        <div class="card mb-6">
            <div class="gradient-danger text-white p-4 font-semibold rounded-t-2xl flex items-center gap-2">
                <i class="fas fa-bell"></i> √âv√©nements en cours
            </div>
            <div class="p-4 space-y-3">
                ${evtsEnCours.map(e => {
                    const agent = DB.agents.find(a => a.id === e.agentId);
                    return `
                        <div class="flex items-center gap-4 p-3 bg-red-50 dark:bg-red-900/20 rounded-xl cursor-pointer hover:bg-red-100 dark:hover:bg-red-900/30" onclick="voirEvenement(${e.id})">
                            <span class="status-dot ${getStatusColor(e.statut)}"></span>
                            <div class="flex-1">
                                <div class="font-semibold text-gray-800 dark:text-white">${e.type}</div>
                                <div class="text-sm text-gray-500">${e.localisation || 'Non pr√©cis√©'} ‚Ä¢ ${formatTime(e.date)}</div>
                            </div>
                            <span class="badge badge-${e.statut === 'Termin√©' ? 'success' : e.statut === 'En cours' ? 'warning' : 'danger'}">${e.statut}</span>
                            <i class="fas fa-eye text-gray-400"></i>
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
        ` : ''}

        <div class="grid lg:grid-cols-2 gap-6">
            <div class="card">
                <div class="gradient-success text-white p-4 font-semibold rounded-t-2xl flex items-center gap-2">
                    <i class="fas fa-users"></i> √âquipe en poste
                </div>
                <div class="p-4">
                    ${chef ? `
                        <div class="flex items-center gap-3 p-3 bg-yellow-50 dark:bg-yellow-900/30 rounded-xl mb-3">
                            <div class="w-10 h-10 bg-yellow-500 rounded-xl flex items-center justify-center text-white"><i class="fas fa-crown"></i></div>
                            <div>
                                <div class="font-semibold text-gray-800 dark:text-white">Chef de Poste</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">${chef.prenom} ${chef.nom} ‚Ä¢ depuis ${formatTime(chef.heureDebut)}</div>
                            </div>
                        </div>
                    ` : '<p class="text-gray-500 text-center py-2">Aucun chef de poste</p>'}
                    ${equipiers.length ? equipiers.map(a => `
                        <div class="flex items-center gap-3 p-3 hover:bg-gray-50 dark:hover:bg-slate-700 rounded-xl">
                            <div class="w-10 h-10 bg-primary-500 rounded-xl flex items-center justify-center text-white font-semibold">${a.prenom[0]}${a.nom[0]}</div>
                            <div>
                                <div class="font-medium text-gray-800 dark:text-white">${a.prenom} ${a.nom}</div>
                                <div class="text-sm text-gray-500">${a.qualification} ‚Ä¢ depuis ${formatTime(a.heureDebut)}</div>
                            </div>
                        </div>
                    `).join('') : '<p class="text-gray-500 text-center py-4">Aucun √©quipier</p>'}
                </div>
            </div>

            <div class="card">
                <div class="gradient-warning text-white p-4 font-semibold rounded-t-2xl flex items-center gap-2">
                    <i class="fas fa-file-alt"></i> Consignes actives
                </div>
                <div class="p-4 space-y-3">
                    ${DB.consignes.filter(c => c.active && (c.destinataire === 'Tout le monde' ||
                        (c.destinataire === 'Chef de poste' && currentUser?.qualification !== 'SSIAP 1') ||
                        (c.destinataire === 'Chef de service' && currentUser?.qualification === 'SSIAP 3')
                    )).map(c => `
                        <div class="flex items-center gap-3 p-3 bg-purple-50 dark:bg-purple-900/30 rounded-xl">
                            <i class="fas fa-file-alt text-purple-500"></i>
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="badge badge-${c.niveau === 'Particuli√®re' ? 'warning' : 'info'}">${c.niveau}</span>
                                    <span class="badge badge-purple">${c.destinataire}</span>
                                </div>
                                <div class="font-medium text-gray-800 dark:text-white">${c.titre}</div>
                                <div class="text-sm text-gray-500">${c.contenu.substring(0, 60)}...</div>
                            </div>
                        </div>
                    `).join('') || '<p class="text-gray-500 text-center py-4">Aucune consigne</p>'}
                </div>
            </div>
        </div>
    `;
}

// ========== PRISE DE POSTE ==========
function renderPrisePoste() {
    const agentsPoste = getAgentsEnPoste();
    return `
        <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
            <h1 class="text-2xl font-bold text-gray-800 dark:text-white"><i class="fas fa-user-clock mr-2 text-primary-500"></i>Prise de Poste</h1>
            <button onclick="showModalPrisePoste()" class="btn btn-primary"><i class="fas fa-plus"></i> Nouvelle prise de poste</button>
        </div>

        <div class="card">
            <div class="gradient-success text-white p-4 font-semibold">Agents en poste (${agentsPoste.length})</div>
            <div class="p-4">
                ${agentsPoste.length ? `
                    <table class="table">
                        <thead><tr><th>Agent</th><th>Qualification</th><th>Poste</th><th>D√©but</th><th>Actions</th></tr></thead>
                        <tbody>
                            ${agentsPoste.map(a => `
                                <tr>
                                    <td class="font-medium">${a.prenom} ${a.nom}</td>
                                    <td><span class="badge badge-info">${a.qualification}</span></td>
                                    <td><span class="badge ${a.poste === 'Chef de poste' ? 'badge-warning' : 'badge-success'}">${a.poste}</span></td>
                                    <td>${formatDateTime(a.heureDebut)}</td>
                                    <td><button onclick="finPoste(${a.prisePosteId})" class="btn btn-danger btn-sm"><i class="fas fa-stop"></i> Fin</button></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                ` : '<p class="text-gray-500 text-center py-8">Aucun agent en poste</p>'}
            </div>
        </div>
    `;
}

function showModalPrisePoste() {
    showModal('Nouvelle Prise de Poste', `
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-semibold mb-2">Niveau SSIAP</label>
                <select id="ppNiveau" class="input" onchange="updateAgentsList()">
                    <option value="">S√©lectionner un niveau...</option>
                    <option value="SSIAP 1">SSIAP 1</option>
                    <option value="SSIAP 2">SSIAP 2</option>
                    <option value="SSIAP 3">SSIAP 3</option>
                </select>
            </div>

            <div id="agentSection" style="display: none;">
                <label class="block text-sm font-semibold mb-2">üë§ Agents</label>
                <input type="text" id="ppAgentSearch" class="input mb-2" placeholder="Rechercher un agent..." oninput="filterAgentsList()">
                <select id="ppAgent" class="input" size="5" style="height: 120px;">
                </select>
            </div>

            <div id="posteSection" style="display: none;">
                <label class="block text-sm font-semibold mb-2">Poste</label>
                <select id="ppPoste" class="input">
                </select>
            </div>
        </div>
    `, () => {
        const agentId = parseInt(document.getElementById('ppAgent').value);
        if (!agentId) return showToast('S√©lectionnez un agent', 'error');

        const poste = document.getElementById('ppPoste').value;
        const pp = {
            id: genId(),
            agentId,
            poste,
            heureDebut: new Date().toISOString(),
            finPoste: null,
            verificationsEffectuees: false
        };
        DB.prisesPoste.push(pp);

        const agent = DB.agents.find(a => a.id === agentId);
        addMainCourante('Prise de Poste', `${pp.poste} - ${agent.prenom} ${agent.nom}`, agentId);
        sauvegarderVersFirebase();
        closeModal();
        showToast('Prise de poste enregistr√©e');

        // Ouvrir automatiquement la page V√©rifications pour tous les postes
        navigate('verifications');

        // Programmer un rappel si les v√©rifications ne sont pas faites apr√®s 30 secondes
        setTimeout(() => {
            const ppCheck = DB.prisesPoste.find(p => p.id === pp.id);
            if (ppCheck && !ppCheck.verificationsEffectuees) {
                showRappelVerifications(agent);
            }
        }, 30000);
    });
}

function showRappelVerifications(agent) {
    const rappelDiv = document.createElement('div');
    rappelDiv.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 z-50 max-w-lg w-full mx-4';
    rappelDiv.id = 'rappelVerifications';
    rappelDiv.innerHTML = `
        <div class="bg-yellow-100 dark:bg-yellow-900/50 border-2 border-yellow-500 rounded-xl p-4 shadow-lg">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-yellow-500 rounded-full flex items-center justify-center text-white text-xl">
                    <i class="fas fa-clipboard-check"></i>
                </div>
                <div class="flex-1">
                    <div class="font-bold text-yellow-700 dark:text-yellow-300 text-lg">‚ö†Ô∏è Rappel V√©rifications</div>
                    <div class="text-yellow-600 dark:text-yellow-400">
                        Vous avez oubli√© de faire les v√©rifications pour <strong>${agent.prenom} ${agent.nom}</strong>
                    </div>
                </div>
                <button onclick="this.closest('.fixed').remove()" class="ml-auto text-yellow-500 hover:text-yellow-700 text-xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="mt-3 flex gap-2">
                <button onclick="this.closest('.fixed').remove(); navigate('verifications');" class="btn btn-warning btn-sm flex-1">
                    <i class="fas fa-clipboard-check mr-1"></i> Faire les v√©rifications
                </button>
            </div>
        </div>
    `;

    // Supprimer un ancien rappel s'il existe
    const oldRappel = document.getElementById('rappelVerifications');
    if (oldRappel) oldRappel.remove();

    document.body.appendChild(rappelDiv);

    // Auto-fermeture apr√®s 15 secondes
    setTimeout(() => {
        if (rappelDiv.parentNode) {
            rappelDiv.remove();
        }
    }, 15000);
}

function updateAgentsList() {
    const niveau = document.getElementById('ppNiveau').value;
    const agentSection = document.getElementById('agentSection');
    const posteSection = document.getElementById('posteSection');
    const agentSelect = document.getElementById('ppAgent');
    const posteSelect = document.getElementById('ppPoste');

    if (!niveau) {
        agentSection.style.display = 'none';
        posteSection.style.display = 'none';
        return;
    }

    const agentsActifs = DB.agents.filter(a => a.actif && a.qualification === niveau);
    const agentsEnPoste = getAgentsEnPoste().map(a => a.id);
    const agentsDisponibles = agentsActifs.filter(a => !agentsEnPoste.includes(a.id));

    agentSelect.innerHTML = agentsDisponibles.map(a =>
        `<option value="${a.id}">${a.prenom} ${a.nom}</option>`
    ).join('');

    // Mise √† jour des postes selon le niveau SSIAP
    const hasChef = getChefDePoste();
    let postesOptions = '';

    if (niveau === 'SSIAP 1') {
        // SSIAP 1 = uniquement √âquipier
        postesOptions = '<option value="√âquipier">√âquipier</option>';
    } else if (niveau === 'SSIAP 2') {
        // SSIAP 2 = Chef de poste (si pas d√©j√† pris) ou Chef d'√âquipe
        if (!hasChef) {
            postesOptions += '<option value="Chef de poste">Chef de poste</option>';
        }
        postesOptions += '<option value="Chef d\'√âquipe">Chef d\'√âquipe</option>';
    } else if (niveau === 'SSIAP 3') {
        // SSIAP 3 = Chef de poste (si pas d√©j√† pris) ou Chef d'√âquipe
        if (!hasChef) {
            postesOptions += '<option value="Chef de poste">Chef de poste</option>';
        }
        postesOptions += '<option value="Chef d\'√âquipe">Chef d\'√âquipe</option>';
    }

    posteSelect.innerHTML = postesOptions;

    agentSection.style.display = agentsDisponibles.length ? 'block' : 'none';
    posteSection.style.display = agentsDisponibles.length ? 'block' : 'none';

    if (agentsDisponibles.length === 0) {
        agentSelect.innerHTML = '<option value="">Aucun agent disponible</option>';
    }
}

function filterAgentsList() {
    const search = document.getElementById('ppAgentSearch').value.toLowerCase();
    const agentSelect = document.getElementById('ppAgent');
    const options = Array.from(agentSelect.options);

    options.forEach(opt => {
        const text = opt.textContent.toLowerCase();
        opt.style.display = text.includes(search) ? '' : 'none';
    });
}

// ========== VERIFICATIONS ==========
// Configuration des v√©rifications par type de poste
const VERIFICATIONS_CONFIG = {
    'Chef de poste': {
        securite: [
            'Test de signalisation',
            'Bilan SSI',
            '√âclairage de s√©curit√© PC',
            'Moyens de secours PC'
        ],
        techniques: [
            'Test de ligne directe',
            'Test TU',
            'Test radio',
            'Report alarme technique',
            'PTI'
        ],
        administratives: [
            'Registre de s√©curit√©',
            'Consignes particuli√®res',
            'Consignes g√©n√©rales',
            'Registre des cl√©s'
        ]
    },
    "Chef d'√âquipe": {
        securite: [],
        techniques: [
            'Test radio',
            'PTI',
            'Lampe torche',
            'Trousseau de cl√©s',
            'Outils de ronde'
        ],
        administratives: [
            'Consignes particuli√®res',
            'Consignes g√©n√©rales'
        ]
    },
    "√âquipier": {
        securite: [],
        techniques: [
            'Test radio',
            'PTI',
            'Lampe torche',
            'Trousseau de cl√©s',
            'Outils de ronde'
        ],
        administratives: [
            'Consignes particuli√®res',
            'Consignes g√©n√©rales'
        ]
    }
};

function renderVerifications() {
    const agentsEnPoste = getAgentsEnPoste();
    const agentsSansVerif = agentsEnPoste.filter(a => {
        const pp = DB.prisesPoste.find(p => p.agentId === a.id && !p.finPoste);
        return pp && !pp.verificationsEffectuees;
    });

    return `
        <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
            <h1 class="text-2xl font-bold text-gray-800 dark:text-white"><i class="fas fa-clipboard-check mr-2 text-primary-500"></i>V√©rifications</h1>
        </div>

        ${agentsEnPoste.length === 0 ? `
            <div class="card p-8 text-center">
                <div class="text-6xl mb-4">üë§</div>
                <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-2">Aucun agent en poste</h2>
                <p class="text-gray-500 mb-4">Un agent doit d'abord effectuer sa prise de poste.</p>
                <button onclick="navigate('prisePoste')" class="btn btn-primary"><i class="fas fa-user-clock"></i> Aller √† Prise de Poste</button>
            </div>
        ` : `
            <!-- Agents avec v√©rifications √† faire -->
            ${agentsSansVerif.length > 0 ? `
                <div class="mb-6">
                    <h2 class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-3">
                        <i class="fas fa-exclamation-circle text-orange-500 mr-2"></i>V√©rifications √† effectuer (${agentsSansVerif.length})
                    </h2>
                    <div class="grid gap-4">
                        ${agentsSansVerif.map(agent => {
                            const pp = DB.prisesPoste.find(p => p.agentId === agent.id && !p.finPoste);
                            return `
                                <div class="card">
                                    <div class="gradient-warning text-white p-4 font-semibold flex items-center justify-between rounded-t-2xl">
                                        <span><i class="fas fa-user mr-2"></i>${agent.prenom} ${agent.nom}</span>
                                        <span class="badge bg-white/20 text-white">${pp?.poste || 'Agent'}</span>
                                    </div>
                                    <div class="p-4">
                                        <button onclick="ouvrirVerificationsAgent(${agent.id})" class="btn btn-primary w-full">
                                            <i class="fas fa-clipboard-check"></i> Effectuer les v√©rifications
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            ` : ''}

            <!-- Agents avec v√©rifications effectu√©es -->
            ${agentsEnPoste.filter(a => {
                const pp = DB.prisesPoste.find(p => p.agentId === a.id && !p.finPoste);
                return pp && pp.verificationsEffectuees;
            }).length > 0 ? `
                <div>
                    <h2 class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-3">
                        <i class="fas fa-check-circle text-green-500 mr-2"></i>V√©rifications effectu√©es
                    </h2>
                    <div class="grid gap-3">
                        ${agentsEnPoste.filter(a => {
                            const pp = DB.prisesPoste.find(p => p.agentId === a.id && !p.finPoste);
                            return pp && pp.verificationsEffectuees;
                        }).map(agent => {
                            const pp = DB.prisesPoste.find(p => p.agentId === agent.id && !p.finPoste);
                            return `
                                <div class="card p-4 flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 bg-green-500 rounded-xl flex items-center justify-center text-white">
                                            <i class="fas fa-check"></i>
                                        </div>
                                        <div>
                                            <div class="font-medium text-gray-800 dark:text-white">${agent.prenom} ${agent.nom}</div>
                                            <div class="text-sm text-gray-500">${pp?.poste || 'Agent'}</div>
                                        </div>
                                    </div>
                                    <button onclick="refaireVerifications(${agent.id})" class="btn btn-secondary btn-sm">
                                        <i class="fas fa-redo"></i> Refaire
                                    </button>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            ` : ''}

            ${agentsSansVerif.length === 0 && agentsEnPoste.every(a => {
                const pp = DB.prisesPoste.find(p => p.agentId === a.id && !p.finPoste);
                return pp && pp.verificationsEffectuees;
            }) ? `
                <div class="card p-8 text-center mt-6">
                    <div class="text-6xl mb-4">‚úÖ</div>
                    <h2 class="text-xl font-bold text-green-600 mb-2">Toutes les v√©rifications sont termin√©es !</h2>
                    <p class="text-gray-500">Tous les agents en poste ont effectu√© leurs v√©rifications.</p>
                </div>
            ` : ''}
        `}
    `;
}

function ouvrirVerificationsAgent(agentId) {
    const agent = DB.agents.find(a => a.id === agentId);
    const pp = DB.prisesPoste.find(p => p.agentId === agentId && !p.finPoste);
    if (!agent || !pp) return;

    const poste = pp.poste;
    const config = VERIFICATIONS_CONFIG[poste] || VERIFICATIONS_CONFIG["Chef d'√âquipe"];
    const totalVerifs = config.securite.length + config.techniques.length + config.administratives.length;

    // R√©cup√©rer les v√©rifications d√©j√† effectu√©es
    const verifsDeja = pp.verifications || { securite: [], techniques: [], administratives: [] };

    // Fonction pour v√©rifier si un item est d√©j√† coch√©
    const isChecked = (category, item) => {
        if (category === 'securite') return verifsDeja.securite?.includes(item);
        if (category === 'technique') return verifsDeja.techniques?.includes(item);
        if (category === 'administrative') return verifsDeja.administratives?.includes(item);
        return false;
    };

    // Compter les v√©rifications d√©j√† faites
    const dejaFaites = (verifsDeja.securite?.length || 0) + (verifsDeja.techniques?.length || 0) + (verifsDeja.administratives?.length || 0);

    let html = `<div class="space-y-6" id="verificationsForm" data-agent-id="${agentId}">`;

    // V√©rifications S√©curit√© (seulement si il y en a)
    if (config.securite.length > 0) {
        html += `
            <div class="bg-orange-50 dark:bg-orange-900/30 p-4 rounded-xl">
                <div class="font-semibold mb-3 flex items-center gap-2 text-orange-700 dark:text-orange-400">
                    <i class="fas fa-shield-alt"></i>
                    V√©rifications S√©curit√©
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    ${config.securite.map(item => `
                        <label class="flex items-center gap-3 p-2 bg-white dark:bg-slate-800 rounded-lg cursor-pointer hover:bg-orange-100 dark:hover:bg-orange-900/50 transition">
                            <input type="checkbox" class="w-5 h-5 verif-check" data-category="securite" data-label="${item}" ${isChecked('securite', item) ? 'checked' : ''}>
                            <span>${item}</span>
                        </label>
                    `).join('')}
                </div>
            </div>
        `;
    }

    // V√©rifications Techniques
    if (config.techniques.length > 0) {
        html += `
            <div class="bg-yellow-50 dark:bg-yellow-900/30 p-4 rounded-xl">
                <div class="font-semibold mb-3 flex items-center gap-2 text-yellow-700 dark:text-yellow-400">
                    <i class="fas fa-tools"></i>
                    V√©rifications Techniques
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    ${config.techniques.map(item => `
                        <label class="flex items-center gap-3 p-2 bg-white dark:bg-slate-800 rounded-lg cursor-pointer hover:bg-yellow-100 dark:hover:bg-yellow-900/50 transition">
                            <input type="checkbox" class="w-5 h-5 verif-check" data-category="technique" data-label="${item}" ${isChecked('technique', item) ? 'checked' : ''}>
                            <span>${item}</span>
                        </label>
                    `).join('')}
                </div>
            </div>
        `;
    }

    // V√©rifications Administratives
    if (config.administratives.length > 0) {
        html += `
            <div class="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-xl">
                <div class="font-semibold mb-3 flex items-center gap-2 text-blue-700 dark:text-blue-400">
                    <i class="fas fa-file-alt"></i>
                    V√©rifications Administratives
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    ${config.administratives.map(item => `
                        <label class="flex items-center gap-3 p-2 bg-white dark:bg-slate-800 rounded-lg cursor-pointer hover:bg-blue-100 dark:hover:bg-blue-900/50 transition">
                            <input type="checkbox" class="w-5 h-5 verif-check" data-category="administrative" data-label="${item}" ${isChecked('administrative', item) ? 'checked' : ''}>
                            <span>${item}</span>
                        </label>
                    `).join('')}
                </div>
            </div>
        `;
    }

    html += `
        <div class="flex flex-wrap items-center justify-between gap-4 pt-4 border-t border-gray-200 dark:border-gray-700">
            <div id="verifCounter" class="text-lg font-semibold text-gray-600 dark:text-gray-400">
                <span id="verifChecked">${dejaFaites}</span> / <span id="verifTotal">${totalVerifs}</span> v√©rifications
            </div>
        </div>
    </div>`;

    showModal(`V√©rifications - ${agent.prenom} ${agent.nom} (${poste})`, html, () => {
        enregistrerVerificationsAgent(agentId);
    });
}

function refaireVerifications(agentId) {
    const pp = DB.prisesPoste.find(p => p.agentId === agentId && !p.finPoste);
    if (pp) {
        pp.verificationsEffectuees = false;
        // On garde les v√©rifications existantes pour les pr√©-cocher
        sauvegarderVersFirebase();
        navigate('verifications');
    }
}

function enregistrerVerificationsAgent(agentId) {
    const agent = DB.agents.find(a => a.id === agentId);
    const pp = DB.prisesPoste.find(p => p.agentId === agentId && !p.finPoste);
    if (!agent || !pp) return;

    const checkboxes = document.querySelectorAll('.verif-check');
    const total = checkboxes.length;
    let checked = 0;
    const verifications = { securite: [], techniques: [], administratives: [] };

    checkboxes.forEach(cb => {
        if (cb.checked) {
            checked++;
            const category = cb.getAttribute('data-category');
            const label = cb.getAttribute('data-label');
            if (category === 'securite') verifications.securite.push(label);
            else if (category === 'technique') verifications.techniques.push(label);
            else verifications.administratives.push(label);
        }
    });

    pp.verifications = verifications;

    const allChecked = checked === total;
    const posteLabel = pp.poste;

    if (allChecked) {
        pp.verificationsEffectuees = true;
        addMainCourante('V√©rifications', `üëç Toutes les v√©rifications ${posteLabel} effectu√©es (${checked}/${total})`, agentId);
        showToast('‚úÖ Toutes les v√©rifications sont compl√®tes !', 'success');
    } else {
        pp.verificationsEffectuees = false;
        addMainCourante('V√©rifications', `‚ö†Ô∏è V√©rifications ${posteLabel} incompl√®tes (${checked}/${total})`, agentId);
    }

    sauvegarderVersFirebase();
    closeModal();

    // Afficher un message d'avertissement si v√©rifications incompl√®tes
    if (!allChecked) {
        setTimeout(() => {
            showAlertVerificationsIncompletes(agent, checked, total);
        }, 100);
    }

    navigate('verifications');
}

function showAlertVerificationsIncompletes(agent, checked, total) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 z-50 max-w-lg w-full mx-4';
    alertDiv.innerHTML = `
        <div class="bg-red-100 dark:bg-red-900/50 border-2 border-red-500 rounded-xl p-4 shadow-lg animate-pulse">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-red-500 rounded-full flex items-center justify-center text-white text-xl">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div>
                    <div class="font-bold text-red-700 dark:text-red-300 text-lg">‚ö†Ô∏è Attention</div>
                    <div class="text-red-600 dark:text-red-400">
                        Toutes les v√©rifications pour l'agent <strong>${agent.prenom} ${agent.nom}</strong> ne sont pas termin√©es (${checked}/${total})
                    </div>
                </div>
                <button onclick="this.closest('.fixed').remove()" class="ml-auto text-red-500 hover:text-red-700 text-xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(alertDiv);

    // Auto-fermeture apr√®s 8 secondes
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 8000);
}

// Mise √† jour du compteur en temps r√©el
document.addEventListener('change', (e) => {
    if (e.target.classList.contains('verif-check')) {
        const checked = document.querySelectorAll('.verif-check:checked').length;
        const checkedEl = document.getElementById('verifChecked');
        if (checkedEl) checkedEl.textContent = checked;
    }
});

function finPoste(id) {
    showConfirm('Confirmer la fin de poste ?', () => {
        const pp = DB.prisesPoste.find(p => p.id === id);
        if (pp) {
            pp.finPoste = new Date().toISOString();
            const agent = DB.agents.find(a => a.id === pp.agentId);
            addMainCourante('Fin de Poste', `${agent.prenom} ${agent.nom}`, pp.agentId);
            showToast('Fin de poste enregistr√©e');
            navigate('prisePoste');
        }
    });
}

// ========== RONDES ==========
let typesRondes = ['Ouverture', 'Fermeture', 'V√©rification moyens de secours', 'V√©rification d√©gagements', 'Surveillance travaux', 'Surveillance post incident', 'Ronde de s√©curit√©', 'Ronde technique', 'Ronde incendie'];

// ========== STRUCTURE HIERARCHIQUE DE L'√âTABLISSEMENT ==========
// Configuration de l'√©tablissement (modifiable par SSIAP 3)
let configEtablissement = {
    nom: "√âtablissement",
    batiments: [
        {
            id: 'bat1',
            nom: 'B√¢timent Principal',
            secteurs: [
                {
                    id: 'bat1-ss',
                    nom: 'Sous-sol',
                    zones: ['Parking souterrain', 'Local technique', 'Chaufferie', 'Archives']
                },
                {
                    id: 'bat1-rdc',
                    nom: 'RDC',
                    zones: ['Hall d\'entr√©e', 'Accueil', 'Salle de r√©union A', 'Sanitaires RDC', 'Couloir principal']
                },
                {
                    id: 'bat1-r1',
                    nom: '1er √©tage',
                    zones: ['Bureaux 101-110', 'Salle de pause', 'Sanitaires R+1', 'Couloir R+1']
                },
                {
                    id: 'bat1-r2',
                    nom: '2√®me √©tage',
                    zones: ['Bureaux 201-210', 'Salle de r√©union B', 'Sanitaires R+2', 'Couloir R+2']
                }
            ]
        },
        {
            id: 'bat2',
            nom: 'B√¢timent Annexe',
            secteurs: [
                {
                    id: 'bat2-rdc',
                    nom: 'RDC',
                    zones: ['Entrep√¥t', 'Quai de livraison', 'Bureau logistique']
                },
                {
                    id: 'bat2-r1',
                    nom: '1er √©tage',
                    zones: ['Atelier', 'Vestiaires', 'R√©fectoire']
                }
            ]
        },
        {
            id: 'bat3',
            nom: 'Ext√©rieurs',
            secteurs: [
                {
                    id: 'bat3-ext',
                    nom: 'Zones ext√©rieures',
                    zones: ['Parking visiteurs', 'Parking personnel', 'Voie pompiers', 'Espaces verts']
                }
            ]
        }
    ]
};

// Fonction pour obtenir la liste plate des zones (pour compatibilit√©)
function getZonesPlates() {
    const zones = ['Toutes zones'];
    configEtablissement.batiments.forEach(bat => {
        bat.secteurs.forEach(sect => {
            sect.zones.forEach(zone => {
                zones.push(`${bat.nom} > ${sect.nom} > ${zone}`);
            });
        });
    });
    return zones;
}

// Fonction pour obtenir la localisation compl√®te
function getLocalisationComplete(batiment, secteur, zone) {
    return `${batiment} > ${secteur} > ${zone}`;
}

// Anciennes zones (pour compatibilit√©)
const zonesRondes = ['B√¢timent Principal', 'B√¢timent Annexe', 'Ext√©rieurs', 'Toutes zones'];

const pointsControleParZone = {
    'B√¢timent Principal': ['Entr√©e principale', 'Accueil', 'Hall', 'Escalier A', 'Escalier B', 'Ascenseurs', 'Issues de secours'],
    'Parking': ['Entr√©e v√©hicules', 'Sortie v√©hicules', 'Niveau -1', 'Niveau -2', 'Local technique parking', 'D√©senfumage parking'],
    'Sous-sol': ['Local technique', 'Chaufferie', 'Local √©lectrique', 'TGBT', 'R√©serve', 'Archives'],
    'RDC': ['Hall entr√©e', 'Accueil', 'Bureaux RDC', 'Sanitaires', 'Local poubelles', 'Issue secours RDC'],
    '1er √©tage': ['Couloir 1er', 'Bureaux 100-110', 'Salle r√©union 1', 'Sanitaires 1er', 'Issue secours 1er'],
    '2√®me √©tage': ['Couloir 2√®me', 'Bureaux 200-210', 'Salle r√©union 2', 'Sanitaires 2√®me', 'Issue secours 2√®me'],
    '3√®me √©tage': ['Couloir 3√®me', 'Bureaux 300-310', 'Direction', 'Sanitaires 3√®me', 'Issue secours 3√®me'],
    'Toiture/Terrasse': ['Acc√®s toiture', 'Machinerie ascenseur', 'CTA', 'Antennes', 'Garde-corps'],
    'Ext√©rieurs': ['Fa√ßade Nord', 'Fa√ßade Sud', 'Fa√ßade Est', 'Fa√ßade Ouest', 'Espaces verts', 'Cl√¥tures'],
    'Zone technique': ['Local SSI', 'PC S√©curit√©', 'Local sprinkler', 'Groupe √©lectrog√®ne', 'Local onduleur'],
    'Local SSI': ['Centrale incendie', 'Tableau report', 'BAES', 'T√©l√©phone s√©curit√©', 'Cl√©s de s√©curit√©'],
    'Toutes zones': ['V√©rification g√©n√©rale']
};

const dur√©esEstim√©es = ['15 min', '30 min', '45 min', '1h', '1h30', '2h'];

// Variables de filtres pour les rondes
let filtreRondeStatut = '';
let filtreRondeZone = '';
let filtreRondeType = '';

function renderRondes() {
    const isSsiap1 = currentUser?.qualification === 'SSIAP 1';
    const canCreate = isSsiap1; // Seul SSIAP 1 peut cr√©er des rondes

    const stats = {
        total: DB.rondes.length,
        enCours: DB.rondes.filter(r => !r.heureFin).length,
        terminees: DB.rondes.filter(r => r.heureFin).length,
        anomalies: DB.rondes.filter(r => r.anomalies?.length).length
    };

    // Rondes en cours de l'utilisateur actuel
    const mesRondesEnCours = DB.rondes.filter(r => !r.heureFin && r.agentId === currentUser?.id);

    // Version mobile pour SSIAP 1
    if (isSsiap1) {
        return renderRondesMobile(mesRondesEnCours, stats);
    }

    // Filtrer les rondes
    const rondesFiltrees = DB.rondes.filter(r => {
        const matchStatut = !filtreRondeStatut ||
            (filtreRondeStatut === 'En cours' && !r.heureFin) ||
            (filtreRondeStatut === 'Termin√©e' && r.heureFin);
        const matchZone = !filtreRondeZone || r.zone === filtreRondeZone;
        const matchType = !filtreRondeType || r.type === filtreRondeType;
        return matchStatut && matchZone && matchType;
    });

    return `
        <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
            <div>
                <h1 class="text-2xl font-bold text-gray-800 dark:text-white flex items-center gap-2">
                    <i class="fas fa-route text-primary-500"></i>
                    Gestion des Rondes
                </h1>
                <p class="text-gray-500 text-sm mt-1">${stats.total} ronde(s) ‚Ä¢ ${stats.enCours} en cours</p>
            </div>
            <div class="flex gap-2">
                <button onclick="rafraichirDonnees()" class="btn btn-secondary btn-sm" title="Rafra√Æchir les donn√©es"><i class="fas fa-sync-alt"></i></button>
            </div>
        </div>

        ${mesRondesEnCours.length ? `
        <div class="bg-yellow-50 dark:bg-yellow-900/30 border-2 border-yellow-400 rounded-xl p-4 mb-6">
            <div class="font-bold text-yellow-700 dark:text-yellow-400 mb-2"><i class="fas fa-walking mr-2"></i>Mes rondes en cours</div>
            <div class="space-y-2">
                ${mesRondesEnCours.map(r => `
                    <div class="flex items-center justify-between bg-white dark:bg-slate-800 p-3 rounded-lg">
                        <div>
                            <div class="font-medium">${r.nom || r.type}</div>
                            <div class="text-sm text-gray-500">D√©part: ${formatTime(r.heureDebut)} ‚Ä¢ ${r.pointsControle?.filter(p => p.valide).length || 0}/${r.pointsControle?.length || 0} points valid√©s</div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="effectuerRonde(${r.id})" class="btn btn-warning btn-sm"><i class="fas fa-clipboard-check"></i> Continuer</button>
                            <button onclick="terminerRondeAvecDetails(${r.id})" class="btn btn-success btn-sm"><i class="fas fa-flag-checkered"></i> Terminer</button>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
        ` : ''}

        <!-- Statistiques avec points color√©s -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="stat-card bg-white dark:bg-slate-800 flex items-center gap-4">
                <div class="w-4 h-4 rounded-full bg-blue-500"></div>
                <div>
                    <div class="text-xs text-gray-500 uppercase">Total</div>
                    <div class="text-2xl font-bold text-gray-800 dark:text-white">${stats.total}</div>
                </div>
            </div>
            <div class="stat-card bg-white dark:bg-slate-800 flex items-center gap-4">
                <div class="w-4 h-4 rounded-full bg-orange-500 animate-pulse"></div>
                <div>
                    <div class="text-xs text-gray-500 uppercase">En cours</div>
                    <div class="text-2xl font-bold text-orange-600">${stats.enCours}</div>
                </div>
            </div>
            <div class="stat-card bg-white dark:bg-slate-800 flex items-center gap-4">
                <div class="w-4 h-4 rounded-full bg-green-500"></div>
                <div>
                    <div class="text-xs text-gray-500 uppercase">Termin√©es</div>
                    <div class="text-2xl font-bold text-green-600">${stats.terminees}</div>
                </div>
            </div>
            <div class="stat-card bg-white dark:bg-slate-800 flex items-center gap-4">
                <div class="w-4 h-4 rounded-full bg-red-500"></div>
                <div>
                    <div class="text-xs text-gray-500 uppercase">Avec anomalies</div>
                    <div class="text-2xl font-bold text-red-600">${stats.anomalies}</div>
                </div>
            </div>
        </div>

        <!-- Filtres -->
        <div class="card mb-6">
            <div class="p-4">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-xs text-gray-500 mb-1"><i class="fas fa-filter mr-1"></i>Statut</label>
                        <select id="filtreRondeStatut" class="input" onchange="filtrerRondes()">
                            <option value="">Tous les statuts</option>
                            <option value="En cours" ${filtreRondeStatut === 'En cours' ? 'selected' : ''}>En cours</option>
                            <option value="Termin√©e" ${filtreRondeStatut === 'Termin√©e' ? 'selected' : ''}>Termin√©e</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1"><i class="fas fa-map-marker-alt mr-1"></i>Zone</label>
                        <select id="filtreRondeZone" class="input" onchange="filtrerRondes()">
                            <option value="">Toutes les zones</option>
                            ${zonesRondes.map(z => `<option value="${z}" ${filtreRondeZone === z ? 'selected' : ''}>${z}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1"><i class="fas fa-route mr-1"></i>Type</label>
                        <select id="filtreRondeType" class="input" onchange="filtrerRondes()">
                            <option value="">Tous les types</option>
                            ${typesRondes.map(t => `<option value="${t}" ${filtreRondeType === t ? 'selected' : ''}>${t}</option>`).join('')}
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button onclick="reinitialiserFiltresRondes()" class="btn btn-secondary w-full"><i class="fas fa-undo mr-1"></i>R√©initialiser</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Liste des rondes -->
        <div class="card">
            <div class="p-4 space-y-3">
                ${rondesFiltrees.length ? rondesFiltrees.map(r => {
                    const agent = DB.agents.find(a => a.id === r.agentId);
                    const pointsValides = r.pointsControle?.filter(p => p.valide).length || 0;
                    const totalPoints = r.pointsControle?.length || 0;
                    const progression = totalPoints > 0 ? Math.round((pointsValides / totalPoints) * 100) : 0;
                    const hasAnomalies = r.anomalies?.length > 0;

                    return `
                        <div class="flex flex-wrap items-center justify-between gap-4 p-4 bg-gray-50 dark:bg-slate-700 rounded-xl ${hasAnomalies ? 'border-l-4 border-red-500' : ''}">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1 flex-wrap">
                                    <span class="badge ${r.heureFin ? 'badge-success' : 'badge-warning'}">${r.heureFin ? 'Termin√©e' : 'En cours'}</span>
                                    <span class="badge badge-info">${r.type}</span>
                                    ${r.zone ? `<span class="badge badge-purple">${r.zone}</span>` : ''}
                                    ${hasAnomalies ? `<span class="badge badge-danger">${r.anomalies.length} anomalie(s)</span>` : ''}
                                </div>
                                <div class="font-medium text-gray-800 dark:text-white">${r.nom || r.type}</div>
                                <div class="text-sm text-gray-500">${agent?.prenom || ''} ${agent?.nom || ''} ‚Ä¢ ${formatDateTime(r.heureDebut)}</div>
                                ${totalPoints > 0 ? `
                                <div class="mt-2">
                                    <div class="flex items-center gap-2">
                                        <div class="flex-1 bg-gray-200 dark:bg-slate-600 rounded-full h-2">
                                            <div class="bg-green-500 h-2 rounded-full transition-all" style="width: ${progression}%"></div>
                                        </div>
                                        <span class="text-xs text-gray-500">${pointsValides}/${totalPoints}</span>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                            <div class="flex gap-2 flex-wrap">
                                ${!r.heureFin && r.agentId === currentUser?.id ? `
                                    <button onclick="effectuerRonde(${r.id})" class="btn btn-warning btn-sm"><i class="fas fa-clipboard-check"></i> Valider</button>
                                    <button onclick="terminerRondeAvecDetails(${r.id})" class="btn btn-success btn-sm"><i class="fas fa-flag-checkered"></i></button>
                                ` : ''}
                                <button onclick="voirRonde(${r.id})" class="btn btn-secondary btn-sm"><i class="fas fa-eye"></i></button>
                            </div>
                        </div>
                    `;
                }).join('') : '<p class="text-gray-500 text-center py-8">Aucune ronde trouv√©e</p>'}
            </div>
        </div>
    `;
}

// Version mobile optimis√©e pour les rondiers SSIAP 1
function renderRondesMobile(mesRondesEnCours, stats) {
    // S'il y a une ronde en cours, afficher l'interface de ronde
    if (mesRondesEnCours.length > 0) {
        const r = mesRondesEnCours[0];
        const pointsValides = r.pointsControle?.filter(p => p.valide).length || 0;
        const totalPoints = r.pointsControle?.length || 0;
        const progression = totalPoints > 0 ? Math.round((pointsValides / totalPoints) * 100) : 0;
        const duree = Math.round((new Date() - new Date(r.heureDebut)) / 60000);

        return `
            <div class="space-y-4">
                <!-- Ronde en cours -->
                <div class="bg-gradient-to-r from-yellow-400 to-orange-500 text-white p-5 rounded-2xl shadow-lg">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center animate-pulse">
                            <i class="fas fa-walking text-2xl"></i>
                        </div>
                        <div class="flex-1">
                            <div class="font-bold text-lg">${r.nom || r.type}</div>
                            <div class="text-sm opacity-90">${r.zone || 'Toutes zones'} ‚Ä¢ ${duree} min</div>
                        </div>
                    </div>

                    <!-- Progression -->
                    <div class="bg-white/20 rounded-full h-4 mb-2">
                        <div class="bg-white h-4 rounded-full transition-all" style="width: ${progression}%"></div>
                    </div>
                    <div class="text-sm text-center mb-4">${pointsValides}/${totalPoints} points valid√©s</div>

                    <!-- Bouton Scanner -->
                    <button onclick="scannerPointControle(${r.id})" class="w-full bg-white text-orange-600 font-bold py-5 rounded-xl flex items-center justify-center gap-3 active:scale-95 transition-transform mb-3">
                        <i class="fas fa-qrcode text-2xl"></i>
                        <span class="text-lg">Scanner un point</span>
                    </button>

                    <!-- Boutons secondaires -->
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="voirPointsRonde(${r.id})" class="bg-white/20 text-white font-bold py-3 rounded-xl flex items-center justify-center gap-2 text-sm">
                            <i class="fas fa-list"></i> Voir points
                        </button>
                        <button onclick="terminerRondeAvecDetails(${r.id})" class="bg-white/20 text-white font-bold py-3 rounded-xl flex items-center justify-center gap-2 text-sm border-2 border-white/50">
                            <i class="fas fa-flag-checkered"></i> Terminer
                        </button>
                    </div>
                </div>

                <!-- Signaler anomalie -->
                <button onclick="signalerAnomalieMobile(${r.id})" class="w-full card p-4 flex items-center gap-4 text-left">
                    <div class="w-12 h-12 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center">
                        <i class="fas fa-exclamation-triangle text-red-500 text-xl"></i>
                    </div>
                    <div class="flex-1">
                        <div class="font-semibold text-gray-800 dark:text-white">Signaler une anomalie</div>
                        <div class="text-xs text-gray-500">Prendre photo, changer statut mat√©riel</div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-300"></i>
                </button>
            </div>
        `;
    }

    // Sinon, afficher le bouton pour d√©marrer une nouvelle ronde
    return `
        <div class="flex flex-col items-center justify-center min-h-[60vh] space-y-6">
            <!-- Bouton Nouvelle Ronde -->
            <button onclick="nouvelleRondeMobile()" class="w-full max-w-sm gradient-header text-white p-8 rounded-3xl shadow-2xl flex flex-col items-center gap-4 active:scale-95 transition-transform">
                <div class="w-20 h-20 bg-white/20 rounded-full flex items-center justify-center">
                    <i class="fas fa-play text-4xl"></i>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold">Nouvelle Ronde</div>
                    <div class="text-sm opacity-80 mt-1">Appuyez pour commencer</div>
                </div>
            </button>

            <!-- Stats du jour -->
            <div class="grid grid-cols-2 gap-4 w-full max-w-sm">
                <div class="card p-4 text-center">
                    <div class="text-3xl font-bold text-green-600">${stats.terminees}</div>
                    <div class="text-xs text-gray-500 uppercase">Termin√©es</div>
                </div>
                <div class="card p-4 text-center">
                    <div class="text-3xl font-bold text-red-600">${stats.anomalies}</div>
                    <div class="text-xs text-gray-500 uppercase">Anomalies</div>
                </div>
            </div>
        </div>
    `;
}

// ========== NOUVELLES FONCTIONS RONDES MOBILE ==========

// Cat√©gories de rondes sp√©cifiques
const categoriesRondeSpecifique = [
    { id: 'extincteurs', nom: 'Extincteurs', icon: 'fa-fire-extinguisher', types: ['Extincteur'] },
    { id: 'ria', nom: 'RIA', icon: 'fa-tint', types: ['RIA'] },
    { id: 'eclairage', nom: '√âclairage s√©curit√©', icon: 'fa-lightbulb', types: ['√âclairage', 'BAES'] },
    { id: 'issues', nom: 'Issues de secours', icon: 'fa-door-open', types: ['Issue de secours', 'Porte'] },
    { id: 'pcf', nom: 'Portes coupe-feu', icon: 'fa-door-closed', types: ['Porte CF', 'Clapet CF'] },
    { id: 'detecteurs', nom: 'D√©tecteurs', icon: 'fa-smoke', types: ['D√©tecteur', 'D√©clencheur'] },
    { id: 'desenfumage', nom: 'D√©senfumage', icon: 'fa-wind', types: ['D√©senfumage', 'Exutoire'] }
];

function nouvelleRondeMobile() {
    // V√©rifier que l'agent est en poste
    const estEnPoste = DB.prisesPoste.find(p => p.agentId === currentUser?.id && !p.finPoste);
    if (!estEnPoste) {
        showModal('‚ö†Ô∏è Prise de poste requise', `
            <div class="text-center space-y-4">
                <div class="w-20 h-20 bg-yellow-100 dark:bg-yellow-900/50 rounded-full flex items-center justify-center mx-auto">
                    <i class="fas fa-desktop text-yellow-600 text-3xl"></i>
                </div>
                <p class="text-gray-600 dark:text-gray-400">
                    Effectuez votre <strong>prise de poste</strong> au <strong>PC S√©curit√©</strong> avant de d√©marrer une ronde.
                </p>
            </div>
        `, null, 'Compris');
        return;
    }

    // Afficher le choix Global / Sp√©cifique
    showModal('Nouvelle Ronde', `
        <div class="space-y-4">
            <p class="text-gray-600 dark:text-gray-400 text-center mb-4">Choisissez le type de ronde</p>

            <!-- Option Global -->
            <button onclick="closeModal(); choisirZoneRonde('global')" class="w-full p-5 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-2xl flex items-center gap-4 active:scale-95 transition-transform">
                <div class="w-14 h-14 bg-white/20 rounded-xl flex items-center justify-center">
                    <i class="fas fa-building text-2xl"></i>
                </div>
                <div class="text-left flex-1">
                    <div class="font-bold text-lg">Ronde Globale</div>
                    <div class="text-sm opacity-80">Par zone/secteur de l'√©tablissement</div>
                </div>
                <i class="fas fa-chevron-right opacity-50"></i>
            </button>

            <!-- Option Sp√©cifique -->
            <button onclick="closeModal(); choisirCategorieRonde()" class="w-full p-5 bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-2xl flex items-center gap-4 active:scale-95 transition-transform">
                <div class="w-14 h-14 bg-white/20 rounded-xl flex items-center justify-center">
                    <i class="fas fa-fire-extinguisher text-2xl"></i>
                </div>
                <div class="text-left flex-1">
                    <div class="font-bold text-lg">Ronde Sp√©cifique</div>
                    <div class="text-sm opacity-80">Par type de mat√©riel</div>
                </div>
                <i class="fas fa-chevron-right opacity-50"></i>
            </button>
        </div>
    `, null, 'Annuler');
}

function choisirZoneRonde(type) {
    // Afficher les b√¢timents d'abord
    showModal('Choisir le niveau de ronde', `
        <div class="space-y-3">
            <p class="text-gray-600 dark:text-gray-400 text-center text-sm mb-4">S√©lectionnez le p√©rim√®tre de la ronde</p>

            <!-- Ronde compl√®te √©tablissement -->
            <button onclick="closeModal(); choisirNiveauRonde('etablissement')" class="w-full p-4 bg-gradient-to-r from-purple-500 to-indigo-600 text-white rounded-xl flex items-center gap-3">
                <div class="w-12 h-12 bg-white/20 rounded-lg flex items-center justify-center">
                    <i class="fas fa-building text-2xl"></i>
                </div>
                <div class="text-left flex-1">
                    <div class="font-bold">√âtablissement complet</div>
                    <div class="text-sm opacity-80">Tous les b√¢timents</div>
                </div>
            </button>

            <div class="border-t border-gray-200 dark:border-gray-700 my-2"></div>
            <p class="text-xs text-gray-500 text-center">Ou choisissez un b√¢timent sp√©cifique :</p>

            ${configEtablissement.batiments.map(bat => `
                <button onclick="closeModal(); choisirSecteurRonde('${bat.id}')" class="w-full p-4 bg-gray-50 dark:bg-slate-700 hover:bg-blue-50 dark:hover:bg-blue-900/30 rounded-xl flex items-center gap-3 transition-colors">
                    <div class="w-10 h-10 bg-blue-100 dark:bg-blue-900/50 rounded-lg flex items-center justify-center">
                        <i class="fas fa-building text-blue-600"></i>
                    </div>
                    <div class="flex-1 text-left">
                        <div class="font-medium text-gray-800 dark:text-white">${bat.nom}</div>
                        <div class="text-xs text-gray-500">${bat.secteurs.length} secteur(s)</div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-300"></i>
                </button>
            `).join('')}
        </div>
    `, null, 'Retour');
}

function choisirNiveauRonde(niveau, batimentId = null, secteurId = null) {
    if (niveau === 'etablissement') {
        // Ronde de tout l'√©tablissement
        demarrerRondeGlobale('√âtablissement complet', null, null);
    }
}

function choisirSecteurRonde(batimentId) {
    const batiment = configEtablissement.batiments.find(b => b.id === batimentId);
    if (!batiment) return;

    showModal(`${batiment.nom}`, `
        <div class="space-y-3">
            <p class="text-gray-600 dark:text-gray-400 text-center text-sm mb-4">Choisissez le niveau de d√©tail</p>

            <!-- Ronde compl√®te b√¢timent -->
            <button onclick="closeModal(); demarrerRondeGlobale('${batiment.nom}', '${batimentId}', null)" class="w-full p-4 bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-xl flex items-center gap-3">
                <div class="w-12 h-12 bg-white/20 rounded-lg flex items-center justify-center">
                    <i class="fas fa-layer-group text-2xl"></i>
                </div>
                <div class="text-left flex-1">
                    <div class="font-bold">Tout le b√¢timent</div>
                    <div class="text-sm opacity-80">Tous les secteurs</div>
                </div>
            </button>

            <div class="border-t border-gray-200 dark:border-gray-700 my-2"></div>
            <p class="text-xs text-gray-500 text-center">Ou choisissez un secteur :</p>

            ${batiment.secteurs.map(sect => `
                <button onclick="closeModal(); choisirZoneSecteur('${batimentId}', '${sect.id}')" class="w-full p-4 bg-gray-50 dark:bg-slate-700 hover:bg-blue-50 dark:hover:bg-blue-900/30 rounded-xl flex items-center gap-3 transition-colors">
                    <div class="w-10 h-10 bg-green-100 dark:bg-green-900/50 rounded-lg flex items-center justify-center">
                        <i class="fas fa-layer-group text-green-600"></i>
                    </div>
                    <div class="flex-1 text-left">
                        <div class="font-medium text-gray-800 dark:text-white">${sect.nom}</div>
                        <div class="text-xs text-gray-500">${sect.zones.length} zone(s)</div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-300"></i>
                </button>
            `).join('')}
        </div>
    `, null, 'Retour');
}

function choisirZoneSecteur(batimentId, secteurId) {
    const batiment = configEtablissement.batiments.find(b => b.id === batimentId);
    const secteur = batiment?.secteurs.find(s => s.id === secteurId);
    if (!secteur) return;

    showModal(`${batiment.nom} > ${secteur.nom}`, `
        <div class="space-y-3">
            <!-- Ronde compl√®te secteur -->
            <button onclick="closeModal(); demarrerRondeGlobale('${batiment.nom} > ${secteur.nom}', '${batimentId}', '${secteurId}')" class="w-full p-4 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-xl flex items-center gap-3">
                <div class="w-12 h-12 bg-white/20 rounded-lg flex items-center justify-center">
                    <i class="fas fa-check-double text-2xl"></i>
                </div>
                <div class="text-left flex-1">
                    <div class="font-bold">Tout le secteur</div>
                    <div class="text-sm opacity-80">${secteur.zones.length} zones</div>
                </div>
            </button>

            <div class="border-t border-gray-200 dark:border-gray-700 my-2"></div>
            <p class="text-xs text-gray-500 text-center">Ou une zone sp√©cifique :</p>

            <div class="max-h-60 overflow-y-auto space-y-2">
                ${secteur.zones.map(zone => `
                    <button onclick="closeModal(); demarrerRondeGlobale('${batiment.nom} > ${secteur.nom} > ${zone}', '${batimentId}', '${secteurId}', '${zone}')" class="w-full p-3 bg-gray-50 dark:bg-slate-700 hover:bg-green-50 dark:hover:bg-green-900/30 rounded-xl flex items-center gap-3 transition-colors">
                        <div class="w-8 h-8 bg-yellow-100 dark:bg-yellow-900/50 rounded-lg flex items-center justify-center">
                            <i class="fas fa-map-pin text-yellow-600"></i>
                        </div>
                        <span class="font-medium text-sm text-gray-800 dark:text-white">${zone}</span>
                    </button>
                `).join('')}
            </div>
        </div>
    `, null, 'Retour');
}

function demarrerRondeGlobale(nom, batimentId = null, secteurId = null, zoneSpecifique = null) {
    let pointsControle = [];

    if (!batimentId) {
        // Ronde √©tablissement complet - tous les b√¢timents
        configEtablissement.batiments.forEach(bat => {
            bat.secteurs.forEach(sect => {
                sect.zones.forEach(zone => {
                    pointsControle.push({
                        id: genId(),
                        nom: zone,
                        chemin: `${bat.nom} > ${sect.nom} > ${zone}`,
                        batimentId: bat.id,
                        secteurId: sect.id,
                        qrCode: `ZONE-${bat.id}-${sect.id}-${zone.replace(/\s+/g, '-').toUpperCase()}`.substring(0, 50),
                        valide: false,
                        heureValidation: null,
                        observation: ''
                    });
                });
            });
        });
    } else if (batimentId && !secteurId) {
        // Ronde d'un b√¢timent complet
        const batiment = configEtablissement.batiments.find(b => b.id === batimentId);
        batiment?.secteurs.forEach(sect => {
            sect.zones.forEach(zone => {
                pointsControle.push({
                    id: genId(),
                    nom: zone,
                    chemin: `${batiment.nom} > ${sect.nom} > ${zone}`,
                    batimentId: batimentId,
                    secteurId: sect.id,
                    qrCode: `ZONE-${batimentId}-${sect.id}-${zone.replace(/\s+/g, '-').toUpperCase()}`.substring(0, 50),
                    valide: false,
                    heureValidation: null,
                    observation: ''
                });
            });
        });
    } else if (secteurId && !zoneSpecifique) {
        // Ronde d'un secteur complet
        const batiment = configEtablissement.batiments.find(b => b.id === batimentId);
        const secteur = batiment?.secteurs.find(s => s.id === secteurId);
        secteur?.zones.forEach(zone => {
            pointsControle.push({
                id: genId(),
                nom: zone,
                chemin: `${batiment.nom} > ${secteur.nom} > ${zone}`,
                batimentId: batimentId,
                secteurId: secteurId,
                qrCode: `ZONE-${batimentId}-${secteurId}-${zone.replace(/\s+/g, '-').toUpperCase()}`.substring(0, 50),
                valide: false,
                heureValidation: null,
                observation: ''
            });
        });
    } else if (zoneSpecifique) {
        // Ronde d'une zone unique
        pointsControle.push({
            id: genId(),
            nom: zoneSpecifique,
            chemin: nom,
            batimentId: batimentId,
            secteurId: secteurId,
            qrCode: `ZONE-${batimentId}-${secteurId}-${zoneSpecifique.replace(/\s+/g, '-').toUpperCase()}`.substring(0, 50),
            valide: false,
            heureValidation: null,
            observation: ''
        });
    }

    if (pointsControle.length === 0) {
        showToast('Aucun point de contr√¥le pour cette ronde', 'error');
        return;
    }

    // Cr√©er la ronde
    const nouvelleRonde = {
        id: genId(),
        type: 'Ronde de s√©curit√©',
        nom: `Ronde ${nom}`,
        zone: nom,
        batimentId: batimentId,
        secteurId: secteurId,
        modeRonde: 'global',
        agentId: currentUser?.id,
        heureDebut: new Date().toISOString(),
        heureFin: null,
        pointsControle: pointsControle,
        anomalies: [],
        observation: '',
        observationFin: ''
    };

    DB.rondes.push(nouvelleRonde);
    addMainCourante('D√©part Ronde', `Ronde ${nom} - ${pointsControle.length} points`, currentUser?.id);
    sauvegarderVersFirebase();

    showToast(`üöÄ Ronde d√©marr√©e ! ${pointsControle.length} points √† valider`);
    navigate('rondes');
}

function choisirCategorieRonde() {
    showModal('Choisir le type de mat√©riel', `
        <div class="space-y-2 max-h-96 overflow-y-auto">
            ${categoriesRondeSpecifique.map(cat => {
                // Compter les mat√©riels de cette cat√©gorie
                const count = DB.materiels.filter(m => cat.types.some(t => m.type.includes(t))).length;
                return `
                <button onclick="closeModal(); choisirZonePourCategorie('${cat.id}')" class="w-full p-4 bg-gray-50 dark:bg-slate-700 hover:bg-orange-50 dark:hover:bg-orange-900/30 rounded-xl flex items-center gap-3 transition-colors ${count === 0 ? 'opacity-50' : ''}">
                    <div class="w-10 h-10 bg-orange-100 dark:bg-orange-900/50 rounded-lg flex items-center justify-center">
                        <i class="fas ${cat.icon} text-orange-600"></i>
                    </div>
                    <div class="flex-1 text-left">
                        <div class="font-medium text-gray-800 dark:text-white">${cat.nom}</div>
                        <div class="text-xs text-gray-500">${count} mat√©riel(s)</div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-300"></i>
                </button>
                `;
            }).join('')}
        </div>
    `, null, 'Retour');
}

function choisirZonePourCategorie(categorieId) {
    const categorie = categoriesRondeSpecifique.find(c => c.id === categorieId);
    if (!categorie) return;

    // Compter les mat√©riels de cette cat√©gorie dans tout l'√©tablissement
    const materielsCategorie = DB.materiels.filter(m => categorie.types.some(t => m.type.includes(t)));

    if (materielsCategorie.length === 0) {
        showToast('Aucun mat√©riel de ce type trouv√©', 'error');
        return;
    }

    // M√™me structure hi√©rarchique que pour les rondes globales
    showModal(`${categorie.nom} - Localisation`, `
        <div class="space-y-3">
            <p class="text-gray-600 dark:text-gray-400 text-center text-sm mb-4">Choisissez la zone √† contr√¥ler</p>

            <!-- √âtablissement complet -->
            <button onclick="closeModal(); demarrerRondeSpecifique('${categorieId}', null, null, null)" class="w-full p-4 bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-xl flex items-center gap-3">
                <div class="w-12 h-12 bg-white/20 rounded-lg flex items-center justify-center">
                    <i class="fas fa-building text-2xl"></i>
                </div>
                <div class="text-left flex-1">
                    <div class="font-bold">√âtablissement complet</div>
                    <div class="text-sm opacity-80">${materielsCategorie.length} ${categorie.nom.toLowerCase()} au total</div>
                </div>
                <i class="fas fa-chevron-right opacity-50"></i>
            </button>

            <div class="border-t border-gray-200 dark:border-gray-700 my-2"></div>
            <p class="text-xs text-gray-500 text-center">Ou choisissez un b√¢timent sp√©cifique :</p>

            ${configEtablissement.batiments.map(bat => {
                // Compter les mat√©riels de cette cat√©gorie dans ce b√¢timent
                const countBat = materielsCategorie.filter(m => m.localisation && m.localisation.startsWith(bat.nom)).length;
                return `
                <button onclick="closeModal(); choisirSecteurPourCategorie('${categorieId}', '${bat.id}')" class="w-full p-4 bg-gray-50 dark:bg-slate-700 hover:bg-orange-50 dark:hover:bg-orange-900/30 rounded-xl flex items-center gap-3 transition-colors ${countBat === 0 ? 'opacity-50' : ''}">
                    <div class="w-10 h-10 bg-blue-100 dark:bg-blue-900/50 rounded-lg flex items-center justify-center">
                        <i class="fas fa-building text-blue-600"></i>
                    </div>
                    <div class="flex-1 text-left">
                        <div class="font-medium text-gray-800 dark:text-white">${bat.nom}</div>
                        <div class="text-xs text-gray-500">${countBat} ${categorie.nom.toLowerCase()}</div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-300"></i>
                </button>
                `;
            }).join('')}
        </div>
    `, null, 'Retour');
}

function choisirSecteurPourCategorie(categorieId, batimentId) {
    const categorie = categoriesRondeSpecifique.find(c => c.id === categorieId);
    const batiment = configEtablissement.batiments.find(b => b.id === batimentId);
    if (!categorie || !batiment) return;

    const materielsCategorie = DB.materiels.filter(m => categorie.types.some(t => m.type.includes(t)));
    const materielsBat = materielsCategorie.filter(m => m.localisation && m.localisation.startsWith(batiment.nom));

    showModal(`${categorie.nom} - ${batiment.nom}`, `
        <div class="space-y-3">
            <p class="text-gray-600 dark:text-gray-400 text-center text-sm mb-4">Choisissez le niveau de d√©tail</p>

            <!-- Tout le b√¢timent -->
            <button onclick="closeModal(); demarrerRondeSpecifique('${categorieId}', '${batimentId}', null, null)" class="w-full p-4 bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-xl flex items-center gap-3">
                <div class="w-12 h-12 bg-white/20 rounded-lg flex items-center justify-center">
                    <i class="fas fa-building text-2xl"></i>
                </div>
                <div class="text-left flex-1">
                    <div class="font-bold">Tout ${batiment.nom}</div>
                    <div class="text-sm opacity-80">${materielsBat.length} ${categorie.nom.toLowerCase()}</div>
                </div>
                <i class="fas fa-chevron-right opacity-50"></i>
            </button>

            <div class="border-t border-gray-200 dark:border-gray-700 my-2"></div>
            <p class="text-xs text-gray-500 text-center">Ou choisissez un secteur :</p>

            ${batiment.secteurs.map(sect => {
                const countSect = materielsCategorie.filter(m => m.localisation && m.localisation.includes(sect.nom)).length;
                return `
                <button onclick="closeModal(); choisirZonePourCategorieSpec('${categorieId}', '${batimentId}', '${sect.id}')" class="w-full p-4 bg-gray-50 dark:bg-slate-700 hover:bg-orange-50 dark:hover:bg-orange-900/30 rounded-xl flex items-center gap-3 transition-colors ${countSect === 0 ? 'opacity-50' : ''}">
                    <div class="w-10 h-10 bg-purple-100 dark:bg-purple-900/50 rounded-lg flex items-center justify-center">
                        <i class="fas fa-layer-group text-purple-600"></i>
                    </div>
                    <div class="flex-1 text-left">
                        <div class="font-medium text-gray-800 dark:text-white">${sect.nom}</div>
                        <div class="text-xs text-gray-500">${countSect} ${categorie.nom.toLowerCase()}</div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-300"></i>
                </button>
                `;
            }).join('')}
        </div>
    `, null, 'Retour');
}

function choisirZonePourCategorieSpec(categorieId, batimentId, secteurId) {
    const categorie = categoriesRondeSpecifique.find(c => c.id === categorieId);
    const batiment = configEtablissement.batiments.find(b => b.id === batimentId);
    const secteur = batiment?.secteurs.find(s => s.id === secteurId);
    if (!categorie || !secteur) return;

    const materielsCategorie = DB.materiels.filter(m => categorie.types.some(t => m.type.includes(t)));
    const materielsSect = materielsCategorie.filter(m => m.localisation && m.localisation.includes(secteur.nom));

    showModal(`${categorie.nom} - ${batiment.nom} > ${secteur.nom}`, `
        <div class="space-y-3">
            <p class="text-gray-600 dark:text-gray-400 text-center text-sm mb-4">Choisissez le niveau de d√©tail</p>

            <!-- Tout le secteur -->
            <button onclick="closeModal(); demarrerRondeSpecifique('${categorieId}', '${batimentId}', '${secteurId}', null)" class="w-full p-4 bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-xl flex items-center gap-3">
                <div class="w-12 h-12 bg-white/20 rounded-lg flex items-center justify-center">
                    <i class="fas fa-layer-group text-2xl"></i>
                </div>
                <div class="text-left flex-1">
                    <div class="font-bold">Tout ${secteur.nom}</div>
                    <div class="text-sm opacity-80">${materielsSect.length} ${categorie.nom.toLowerCase()}</div>
                </div>
                <i class="fas fa-chevron-right opacity-50"></i>
            </button>

            <div class="border-t border-gray-200 dark:border-gray-700 my-2"></div>
            <p class="text-xs text-gray-500 text-center">Ou choisissez une zone sp√©cifique :</p>

            ${secteur.zones.map(zone => {
                const countZone = materielsCategorie.filter(m => m.localisation && m.localisation.includes(zone)).length;
                return `
                <button onclick="closeModal(); demarrerRondeSpecifique('${categorieId}', '${batimentId}', '${secteurId}', '${zone.replace(/'/g, "\\'")}')" class="w-full p-4 bg-gray-50 dark:bg-slate-700 hover:bg-orange-50 dark:hover:bg-orange-900/30 rounded-xl flex items-center gap-3 transition-colors ${countZone === 0 ? 'opacity-50' : ''}">
                    <div class="w-10 h-10 bg-green-100 dark:bg-green-900/50 rounded-lg flex items-center justify-center">
                        <i class="fas fa-map-marker-alt text-green-600"></i>
                    </div>
                    <div class="flex-1 text-left">
                        <div class="font-medium text-gray-800 dark:text-white">${zone}</div>
                        <div class="text-xs text-gray-500">${countZone} ${categorie.nom.toLowerCase()}</div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-300"></i>
                </button>
                `;
            }).join('')}
        </div>
    `, null, 'Retour');
}

function demarrerRondeSpecifique(categorieId, batimentId = null, secteurId = null, zoneSpecifique = null) {
    const categorie = categoriesRondeSpecifique.find(c => c.id === categorieId);
    if (!categorie) return;

    // R√©cup√©rer tous les mat√©riels de cette cat√©gorie
    let materiels = DB.materiels.filter(m => categorie.types.some(t => m.type.includes(t)));

    // Filtrer selon la localisation s√©lectionn√©e
    let nomRonde = `${categorie.nom}`;

    if (batimentId) {
        const batiment = configEtablissement.batiments.find(b => b.id === batimentId);
        if (batiment) {
            materiels = materiels.filter(m => m.localisation && m.localisation.startsWith(batiment.nom));
            nomRonde += ` - ${batiment.nom}`;

            if (secteurId) {
                const secteur = batiment.secteurs.find(s => s.id === secteurId);
                if (secteur) {
                    materiels = materiels.filter(m => m.localisation && m.localisation.includes(secteur.nom));
                    nomRonde += ` > ${secteur.nom}`;

                    if (zoneSpecifique) {
                        materiels = materiels.filter(m => m.localisation && m.localisation.includes(zoneSpecifique));
                        nomRonde += ` > ${zoneSpecifique}`;
                    }
                }
            }
        }
    } else {
        nomRonde += ' - √âtablissement complet';
    }

    if (materiels.length === 0) {
        showToast('Aucun mat√©riel trouv√© dans cette zone', 'error');
        return;
    }

    // Cr√©er les points de contr√¥le √† partir des mat√©riels
    const pointsControle = materiels.map(m => ({
        id: genId(),
        nom: m.nom,
        materielId: m.id,
        localisation: m.localisation,
        qrCode: m.codeQR || `MAT-${m.id}`,
        type: m.type,
        statut: m.statut,
        valide: false,
        heureValidation: null,
        observation: '',
        nouveauStatut: null
    }));

    // Cr√©er la ronde
    const ronde = {
        id: genId(),
        type: `Ronde ${categorie.nom}`,
        nom: nomRonde,
        zone: nomRonde,
        agentId: currentUser.id,
        heureDebut: new Date().toISOString(),
        heureFin: null,
        pointsControle: pointsControle,
        anomalies: [],
        observations: '',
        isSpecifique: true,
        categorieId: categorieId
    };

    DB.rondes.push(ronde);
    addMainCourante('D√©but ronde', `D√©but ronde sp√©cifique: ${nomRonde}`, currentUser.id);
    sauvegarderVersFirebase();

    showToast(`üöÄ Ronde d√©marr√©e ! ${pointsControle.length} ${categorie.nom.toLowerCase()} √† contr√¥ler`);
    navigate('rondes');
}

function demarrerRondeMobile(type, zone, categorieId = null) {
    let pointsControle = [];
    let nomRonde = '';
    let typeRonde = '';

    if (type === 'global') {
        // Ronde globale : points de contr√¥le par zone
        typeRonde = 'Ronde de s√©curit√©';
        nomRonde = `Ronde ${zone}`;

        // R√©cup√©rer les points de contr√¥le de cette zone depuis la config
        const pointsZone = pointsControleParZone[zone] || ['Point 1', 'Point 2', 'Point 3'];
        pointsControle = pointsZone.map((p, i) => ({
            id: genId(),
            nom: p,
            qrCode: `ZONE-${zone.replace(/\s+/g, '-').toUpperCase()}-${i + 1}`,
            valide: false,
            heureValidation: null,
            observation: ''
        }));
    } else if (type === 'specifique' && categorieId) {
        // Ronde sp√©cifique : mat√©riels comme points de contr√¥le
        const categorie = categoriesRondeSpecifique.find(c => c.id === categorieId);
        typeRonde = `Ronde ${categorie?.nom || 'Sp√©cifique'}`;
        nomRonde = `${categorie?.nom || 'Mat√©riels'} - ${zone}`;

        // R√©cup√©rer les mat√©riels de cette cat√©gorie dans cette zone
        let materiels = DB.materiels.filter(m => categorie.types.some(t => m.type.includes(t)));
        if (zone !== 'Toutes zones') {
            materiels = materiels.filter(m => m.localisation === zone);
        }

        pointsControle = materiels.map(m => ({
            id: genId(),
            nom: m.nom,
            materielId: m.id,
            qrCode: m.codeQR || `MAT-${m.id}`,
            valide: false,
            heureValidation: null,
            observation: ''
        }));
    }

    if (pointsControle.length === 0) {
        showToast('Aucun point de contr√¥le pour cette ronde', 'error');
        return;
    }

    // Cr√©er la ronde
    const nouvelleRonde = {
        id: genId(),
        type: typeRonde,
        nom: nomRonde,
        zone: zone,
        categorieId: categorieId,
        modeRonde: type, // 'global' ou 'specifique'
        agentId: currentUser?.id,
        heureDebut: new Date().toISOString(),
        heureFin: null,
        pointsControle: pointsControle,
        anomalies: [],
        observation: '',
        observationFin: ''
    };

    DB.rondes.push(nouvelleRonde);
    addMainCourante('D√©part Ronde', `${nomRonde} - ${pointsControle.length} points`, currentUser?.id);
    sauvegarderVersFirebase();

    showToast(`üöÄ Ronde d√©marr√©e ! ${pointsControle.length} points √† valider`);
    navigate('rondes');
}

let html5QrScanner = null;

function scannerPointControle(rondeId) {
    const r = DB.rondes.find(x => x.id === rondeId);
    if (!r) return;

    // Interface de scan QR code avec cam√©ra
    showModal('Scanner un point', `
        <div class="space-y-4">
            <!-- Zone de scan cam√©ra -->
            <div id="qr-reader" style="width: 100%;"></div>
            <div id="qr-reader-results" class="text-center text-sm text-gray-500"></div>

            <!-- Boutons de contr√¥le -->
            <div class="flex gap-2">
                <button onclick="demarrerScanQR(${rondeId})" id="btnStartScan" class="btn btn-primary flex-1">
                    <i class="fas fa-camera"></i> Activer cam√©ra
                </button>
                <button onclick="arreterScanQR()" id="btnStopScan" class="btn btn-secondary flex-1 hidden">
                    <i class="fas fa-stop"></i> Arr√™ter
                </button>
            </div>

            <!-- Saisie manuelle -->
            <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
                <label class="block text-sm font-semibold mb-2"><i class="fas fa-keyboard mr-1"></i>Ou entrez le code manuellement</label>
                <div class="flex gap-2">
                    <input type="text" id="qrCodeManuel" class="input flex-1" placeholder="Ex: ZONE-bat1-sect1-HALL">
                    <button onclick="validerQRCode(${rondeId})" class="btn btn-success"><i class="fas fa-check"></i></button>
                </div>
            </div>

            <!-- Liste des points restants -->
            <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
                <p class="text-sm font-semibold mb-2"><i class="fas fa-list mr-1"></i>Ou s√©lectionnez un point (${r.pointsControle.filter(p => !p.valide).length} restants) :</p>
                <div class="space-y-2 max-h-32 overflow-y-auto">
                    ${r.pointsControle.filter(p => !p.valide).map(p => `
                        <button onclick="validerPointDirectement(${rondeId}, '${p.id}')" class="w-full p-2 bg-gray-50 dark:bg-slate-700 rounded-lg flex items-center gap-3 text-left hover:bg-green-50 dark:hover:bg-green-900/30">
                            <i class="fas fa-circle text-gray-300 text-xs"></i>
                            <div class="flex-1">
                                <div class="font-medium text-sm">${p.nom}</div>
                                <div class="text-xs text-gray-400 font-mono">${p.qrCode}</div>
                            </div>
                        </button>
                    `).join('')}
                </div>
            </div>
        </div>
    `, null, 'Fermer');
}

function demarrerScanQR(rondeId) {
    const qrReader = document.getElementById('qr-reader');
    const resultsDiv = document.getElementById('qr-reader-results');
    const btnStart = document.getElementById('btnStartScan');
    const btnStop = document.getElementById('btnStopScan');

    if (!qrReader) return;

    // V√©rifier si Html5Qrcode est disponible
    if (typeof Html5Qrcode === 'undefined') {
        resultsDiv.innerHTML = '<span class="text-red-500">Scanner non disponible</span>';
        return;
    }

    btnStart.classList.add('hidden');
    btnStop.classList.remove('hidden');
    resultsDiv.innerHTML = '<span class="text-blue-500"><i class="fas fa-spinner fa-spin mr-1"></i>Initialisation de la cam√©ra...</span>';

    html5QrScanner = new Html5Qrcode("qr-reader");

    html5QrScanner.start(
        { facingMode: "environment" }, // Cam√©ra arri√®re
        {
            fps: 10,
            qrbox: { width: 250, height: 250 }
        },
        (decodedText) => {
            // QR Code d√©tect√© !
            console.log('QR Code scann√©:', decodedText);
            resultsDiv.innerHTML = '<span class="text-green-500"><i class="fas fa-check-circle mr-1"></i>Code d√©tect√©: ' + decodedText + '</span>';

            // Arr√™ter le scan
            arreterScanQR();

            // Valider automatiquement le point
            validerQRCodeAuto(rondeId, decodedText);
        },
        (errorMessage) => {
            // Erreur de scan (ignor√©e - c'est normal quand aucun QR n'est visible)
        }
    ).catch((err) => {
        console.error('Erreur cam√©ra:', err);
        resultsDiv.innerHTML = '<span class="text-red-500"><i class="fas fa-exclamation-triangle mr-1"></i>Erreur cam√©ra: ' + err + '</span>';
        btnStart.classList.remove('hidden');
        btnStop.classList.add('hidden');
    });
}

function arreterScanQR() {
    const btnStart = document.getElementById('btnStartScan');
    const btnStop = document.getElementById('btnStopScan');

    if (html5QrScanner) {
        html5QrScanner.stop().then(() => {
            html5QrScanner = null;
            if (btnStart) btnStart.classList.remove('hidden');
            if (btnStop) btnStop.classList.add('hidden');
        }).catch(err => console.error('Erreur arr√™t scanner:', err));
    }
}

function validerQRCodeAuto(rondeId, code) {
    const r = DB.rondes.find(x => x.id === rondeId);
    if (!r) return;

    // Chercher le point correspondant au code
    const point = r.pointsControle.find(p => p.qrCode?.toLowerCase() === code.toLowerCase());

    if (!point) {
        showToast('‚ùå Code QR non reconnu pour cette ronde', 'error');
        return;
    }

    if (point.valide) {
        showToast('‚ö†Ô∏è Ce point a d√©j√† √©t√© valid√©', 'warning');
        return;
    }

    // Valider le point
    point.valide = true;
    point.heureValidation = new Date().toISOString();
    sauvegarderVersFirebase();

    closeModal();
    showToast(`‚úÖ ${point.nom} valid√© !`);

    // Vibrer le t√©l√©phone si disponible
    if (navigator.vibrate) {
        navigator.vibrate(200);
    }

    navigate('rondes');
}

function validerQRCode(rondeId) {
    const code = document.getElementById('qrCodeManuel')?.value?.trim();
    if (!code) {
        showToast('Entrez un code QR', 'error');
        return;
    }

    const r = DB.rondes.find(x => x.id === rondeId);
    if (!r) return;

    // Chercher le point correspondant au code
    const point = r.pointsControle.find(p => p.qrCode?.toLowerCase() === code.toLowerCase());

    if (!point) {
        showToast('Code QR non reconnu pour cette ronde', 'error');
        return;
    }

    if (point.valide) {
        showToast('Ce point a d√©j√† √©t√© valid√©', 'error');
        return;
    }

    // Valider le point
    point.valide = true;
    point.heureValidation = new Date().toISOString();
    sauvegarderVersFirebase();

    closeModal();
    showToast(`‚úÖ ${point.nom} valid√© !`);
    navigate('rondes');
}

function validerPointDirectement(rondeId, pointId) {
    const r = DB.rondes.find(x => x.id === rondeId);
    if (!r) return;

    const point = r.pointsControle.find(p => p.id == pointId);
    if (!point) return;

    point.valide = true;
    point.heureValidation = new Date().toISOString();
    sauvegarderVersFirebase();

    closeModal();
    showToast(`‚úÖ ${point.nom} valid√© !`);
    navigate('rondes');
}

function voirPointsRonde(rondeId) {
    const r = DB.rondes.find(x => x.id === rondeId);
    if (!r) return;

    const pointsValides = r.pointsControle?.filter(p => p.valide) || [];
    const pointsNonValides = r.pointsControle?.filter(p => !p.valide) || [];

    showModal('Points de contr√¥le', `
        <div class="space-y-4 max-h-96 overflow-y-auto">
            ${pointsNonValides.length ? `
            <div>
                <h3 class="text-sm font-bold text-red-600 mb-2"><i class="fas fa-circle text-xs mr-1"></i>√Ä valider (${pointsNonValides.length})</h3>
                <div class="space-y-2">
                    ${pointsNonValides.map(p => `
                        <div class="p-3 bg-red-50 dark:bg-red-900/20 rounded-lg flex items-center gap-3">
                            <i class="fas fa-times-circle text-red-400"></i>
                            <div class="flex-1">
                                <div class="font-medium text-sm">${p.nom}</div>
                                <div class="text-xs text-gray-500">${p.qrCode}</div>
                            </div>
                            <button onclick="validerPointDirectement(${rondeId}, '${p.id}')" class="btn btn-sm btn-success">
                                <i class="fas fa-check"></i>
                            </button>
                        </div>
                    `).join('')}
                </div>
            </div>
            ` : ''}

            ${pointsValides.length ? `
            <div>
                <h3 class="text-sm font-bold text-green-600 mb-2"><i class="fas fa-check-circle text-xs mr-1"></i>Valid√©s (${pointsValides.length})</h3>
                <div class="space-y-2">
                    ${pointsValides.map(p => `
                        <div class="p-3 bg-green-50 dark:bg-green-900/20 rounded-lg flex items-center gap-3">
                            <i class="fas fa-check-circle text-green-500"></i>
                            <div class="flex-1">
                                <div class="font-medium text-sm">${p.nom}</div>
                                <div class="text-xs text-gray-500">${formatTime(p.heureValidation)}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
            ` : ''}
        </div>
    `, null, 'Fermer');
}

function signalerAnomalieMobile(rondeId) {
    const r = DB.rondes.find(x => x.id === rondeId);
    if (!r) return;

    // Si ronde sp√©cifique avec mat√©riels, afficher la liste des mat√©riels
    if (r.modeRonde === 'specifique') {
        const materielsRonde = r.pointsControle.filter(p => p.materielId).map(p => {
            const mat = DB.materiels.find(m => m.id === p.materielId);
            return mat;
        }).filter(Boolean);

        showModal('Signaler une anomalie', `
            <div class="space-y-4">
                <p class="text-gray-600 dark:text-gray-400 text-center">S√©lectionnez le mat√©riel concern√©</p>
                <div class="space-y-2 max-h-80 overflow-y-auto">
                    ${materielsRonde.map(m => `
                        <button onclick="closeModal(); ouvrirFicheMaterielAnomalie(${m.id}, ${rondeId})" class="w-full p-4 bg-gray-50 dark:bg-slate-700 rounded-xl flex items-center gap-3 text-left">
                            <i class="fas fa-fire-extinguisher text-orange-500"></i>
                            <div class="flex-1">
                                <div class="font-medium text-sm">${m.nom}</div>
                                <div class="text-xs text-gray-500">${m.localisation}</div>
                            </div>
                            <span class="badge badge-${m.statut === 'Op√©rationnel' ? 'success' : 'danger'} text-xs">${m.statut}</span>
                        </button>
                    `).join('')}
                </div>
            </div>
        `, null, 'Annuler');
    } else {
        // Ronde globale - formulaire simple
        showModal('Signaler une anomalie', `
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold mb-2">Localisation</label>
                    <select id="anomalieLoc" class="input">
                        ${(pointsControleParZone[r.zone] || zonesRondes).map(z => `<option>${z}</option>`).join('')}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Description</label>
                    <textarea id="anomalieDesc" class="input" rows="3" placeholder="D√©crivez l'anomalie..."></textarea>
                </div>
                <div class="bg-gray-50 dark:bg-slate-700 p-3 rounded-lg">
                    <label class="block text-sm font-semibold mb-2"><i class="fas fa-camera mr-1"></i>Photo (optionnel)</label>
                    <div class="flex gap-2">
                        <button type="button" onclick="document.getElementById('anomaliePhoto').click()" class="btn btn-primary flex-1">
                            <i class="fas fa-camera"></i> Prendre une photo
                        </button>
                    </div>
                    <input type="file" id="anomaliePhoto" accept="image/*" capture="environment" class="hidden" onchange="afficherApercu(this, 'apercuAnomalie')">
                    <div id="apercuAnomalie" class="mt-2 hidden">
                        <img id="imgApercuAnomalie" class="w-full rounded-lg max-h-40 object-cover">
                        <button type="button" onclick="supprimerPhoto('anomaliePhoto', 'apercuAnomalie')" class="btn btn-sm btn-danger mt-2 w-full">
                            <i class="fas fa-trash"></i> Supprimer
                        </button>
                    </div>
                </div>
            </div>
        `, async () => {
            const loc = document.getElementById('anomalieLoc')?.value;
            const desc = document.getElementById('anomalieDesc')?.value;
            const photoInput = document.getElementById('anomaliePhoto');

            if (!desc) {
                showToast('D√©crivez l\'anomalie', 'error');
                return;
            }

            // Convertir la photo en base64 si pr√©sente
            let photoBase64 = null;
            if (photoInput?.files?.length > 0) {
                photoBase64 = await convertirEnBase64(photoInput.files[0]);
            }

            r.anomalies = r.anomalies || [];
            r.anomalies.push({
                id: genId(),
                localisation: loc,
                description: desc,
                photo: photoBase64,
                date: new Date().toISOString(),
                agentId: currentUser?.id
            });

            addMainCourante('Anomalie Ronde', `${r.nom} - ${loc}: ${desc}`, currentUser?.id);
            sauvegarderVersFirebase();
            closeModal();
            showToast('‚ö†Ô∏è Anomalie signal√©e');
            navigate('rondes');
        }, 'Signaler');
    }
}

function ouvrirFicheMaterielAnomalie(materielId, rondeId) {
    const m = DB.materiels.find(x => x.id === materielId);
    if (!m) return;

    showModal(`${m.nom}`, `
        <div class="space-y-4">
            <div class="flex items-center gap-4 p-4 bg-gray-50 dark:bg-slate-700 rounded-xl">
                <div class="w-16 h-16 bg-orange-100 dark:bg-orange-900/50 rounded-xl flex items-center justify-center">
                    <i class="fas fa-fire-extinguisher text-orange-600 text-2xl"></i>
                </div>
                <div class="flex-1">
                    <div class="font-bold text-gray-800 dark:text-white">${m.nom}</div>
                    <div class="text-sm text-gray-500">${m.localisation}</div>
                    <span class="badge badge-${m.statut === 'Op√©rationnel' ? 'success' : m.statut === 'D√©faillant' ? 'danger' : 'warning'}">${m.statut}</span>
                </div>
            </div>

            <div>
                <label class="block text-sm font-semibold mb-2">Nouveau statut</label>
                <select id="nouveauStatutMat" class="input">
                    ${statutsMat.map(s => `<option ${s === m.statut ? 'selected' : ''}>${s}</option>`).join('')}
                </select>
            </div>

            <div>
                <label class="block text-sm font-semibold mb-2">Description du probl√®me</label>
                <textarea id="descProbleme" class="input" rows="3" placeholder="D√©crivez le probl√®me constat√©..."></textarea>
            </div>

            <div class="bg-gray-50 dark:bg-slate-700 p-3 rounded-lg">
                <label class="block text-sm font-semibold mb-2"><i class="fas fa-camera mr-1"></i>Photo (optionnel)</label>
                <div class="flex gap-2">
                    <button type="button" onclick="document.getElementById('photoAnomalie').click()" class="btn btn-primary flex-1">
                        <i class="fas fa-camera"></i> Prendre une photo
                    </button>
                </div>
                <input type="file" id="photoAnomalie" accept="image/*" capture="environment" class="hidden" onchange="afficherApercu(this, 'apercuPhotoMat')">
                <div id="apercuPhotoMat" class="mt-2 hidden">
                    <img id="imgApercuPhotoMat" class="w-full rounded-lg max-h-40 object-cover">
                    <button type="button" onclick="supprimerPhoto('photoAnomalie', 'apercuPhotoMat')" class="btn btn-sm btn-danger mt-2 w-full">
                        <i class="fas fa-trash"></i> Supprimer
                    </button>
                </div>
            </div>
        </div>
    `, async () => {
        const nouveauStatut = document.getElementById('nouveauStatutMat')?.value;
        const description = document.getElementById('descProbleme')?.value;
        const photoInput = document.getElementById('photoAnomalie');

        if (!description && nouveauStatut !== m.statut) {
            showToast('D√©crivez le probl√®me', 'error');
            return;
        }

        // Convertir la photo en base64 si pr√©sente
        let photoBase64 = null;
        if (photoInput?.files?.length > 0) {
            photoBase64 = await convertirEnBase64(photoInput.files[0]);
        }

        const ancienStatut = m.statut;
        m.statut = nouveauStatut;

        // Ajouter √† l'historique du mat√©riel
        if (!m.historique) m.historique = [];
        m.historique.push({
            date: new Date().toISOString(),
            action: `Statut chang√©: ${ancienStatut} ‚Üí ${nouveauStatut}`,
            description: description,
            photo: photoBase64,
            agentId: currentUser?.id
        });

        // Ajouter anomalie √† la ronde
        if (rondeId) {
            const r = DB.rondes.find(x => x.id === rondeId);
            if (r) {
                r.anomalies = r.anomalies || [];
                r.anomalies.push({
                    id: genId(),
                    materielId: materielId,
                    description: `${m.nom}: ${description || 'Changement de statut'} (${ancienStatut} ‚Üí ${nouveauStatut})`,
                    photo: photoBase64,
                    date: new Date().toISOString(),
                    agentId: currentUser?.id
                });
            }
        }

        // Cr√©er consigne si Hors Service
        if (nouveauStatut === 'Hors Service' && ancienStatut !== 'Hors Service') {
            const nouvelleConsigne = {
                id: genId(),
                titre: `${m.nom} - HORS SERVICE`,
                niveau: 'Particuli√®re',
                destinataire: 'Tout le monde',
                priorite: 'Haute',
                contenu: `‚ö†Ô∏è MAT√âRIEL HORS SERVICE\n\nType: ${m.type}\nLocalisation: ${m.localisation}\n\n${description ? 'Probl√®me:\n' + description : ''}`,
                dateDebut: new Date().toISOString().split('T')[0],
                dateFin: null,
                active: true
            };
            DB.consignes.push(nouvelleConsigne);
        }

        addMainCourante('Anomalie Mat√©riel', `${m.nom}: ${ancienStatut} ‚Üí ${nouveauStatut}`, currentUser?.id);
        sauvegarderVersFirebase();
        closeModal();
        showToast('‚úÖ Mat√©riel mis √† jour');
        navigate('rondes');
    }, 'Enregistrer');
}

function filtrerRondes() {
    filtreRondeStatut = document.getElementById('filtreRondeStatut')?.value || '';
    filtreRondeZone = document.getElementById('filtreRondeZone')?.value || '';
    filtreRondeType = document.getElementById('filtreRondeType')?.value || '';
    navigate('rondes');
}

function reinitialiserFiltresRondes() {
    filtreRondeStatut = '';
    filtreRondeZone = '';
    filtreRondeType = '';
    navigate('rondes');
}

function showModalRonde() {
    const agentsPoste = getAgentsEnPoste();

    // Si SSIAP 1, v√©rifier qu'il est bien en poste
    if (currentUser?.qualification === 'SSIAP 1') {
        const estEnPoste = agentsPoste.find(a => a.id === currentUser.id);

        if (!estEnPoste) {
            // Afficher un message demandant de faire la prise de poste au PC S√©curit√©
            showModal('‚ö†Ô∏è Prise de poste requise', `
                <div class="text-center space-y-4">
                    <div class="w-20 h-20 bg-yellow-100 dark:bg-yellow-900/50 rounded-full flex items-center justify-center mx-auto">
                        <i class="fas fa-desktop text-yellow-600 text-3xl"></i>
                    </div>
                    <div class="text-lg font-semibold text-gray-800 dark:text-white">
                        Vous n'√™tes pas en poste
                    </div>
                    <div class="text-gray-600 dark:text-gray-400">
                        Vous devez d'abord effectuer votre <strong>prise de poste</strong> au <strong>PC S√©curit√©</strong> avant de pouvoir d√©marrer une ronde.
                    </div>
                    <div class="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg text-sm text-blue-700 dark:text-blue-400">
                        <i class="fas fa-info-circle mr-2"></i>
                        Rendez-vous au poste de s√©curit√© pour que le chef de poste enregistre votre prise de poste.
                    </div>
                </div>
            `, null, 'Compris');
            return;
        }
    }

    if (!agentsPoste.length) {
        showToast('Aucun agent en poste pour effectuer une ronde', 'error');
        return;
    }

    showModal('Nouvelle Ronde', `
        <div class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-semibold mb-2"><i class="fas fa-route mr-1 text-primary-500"></i>Type de ronde *</label>
                    <select id="rondeType" class="input">
                        ${typesRondes.map(t => `<option value="${t}">${t}</option>`).join('')}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2"><i class="fas fa-user mr-1 text-primary-500"></i>Agent *</label>
                    <select id="rondeAgent" class="input">
                        ${agentsPoste.map(a => `<option value="${a.id}" ${a.id === currentUser?.id ? 'selected' : ''}>${a.prenom} ${a.nom} (${a.qualification})</option>`).join('')}
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-semibold mb-2"><i class="fas fa-map-marker-alt mr-1 text-primary-500"></i>Zone / Secteur *</label>
                    <select id="rondeZone" class="input" onchange="updatePointsControle()">
                        ${zonesRondes.map(z => `<option value="${z}">${z}</option>`).join('')}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2"><i class="fas fa-clock mr-1 text-primary-500"></i>Dur√©e estim√©e</label>
                    <select id="rondeDuree" class="input">
                        ${dur√©esEstim√©es.map(d => `<option value="${d}">${d}</option>`).join('')}
                    </select>
                </div>
            </div>

            <div>
                <label class="block text-sm font-semibold mb-2"><i class="fas fa-tasks mr-1 text-primary-500"></i>Points de contr√¥le</label>
                <div id="pointsControleContainer" class="bg-gray-50 dark:bg-slate-700 p-3 rounded-lg max-h-40 overflow-y-auto">
                    <!-- Points de contr√¥le dynamiques -->
                </div>
                <p class="text-xs text-gray-500 mt-1">Les points coch√©s seront √† valider pendant la ronde</p>
            </div>

            <div>
                <label class="block text-sm font-semibold mb-2"><i class="fas fa-edit mr-1 text-primary-500"></i>Consignes / Instructions</label>
                <textarea id="rondeConsignes" class="input" rows="2" placeholder="Instructions sp√©cifiques pour cette ronde..."></textarea>
            </div>

            <div>
                <label class="block text-sm font-semibold mb-2"><i class="fas fa-comment mr-1 text-primary-500"></i>Observation de d√©part</label>
                <textarea id="rondeObs" class="input" rows="2" placeholder="Observations avant le d√©part..."></textarea>
            </div>
        </div>
    `, () => {
        const agentId = parseInt(document.getElementById('rondeAgent').value);
        if (!agentId) return showToast('S√©lectionnez un agent', 'error');

        const type = document.getElementById('rondeType').value;
        const zone = document.getElementById('rondeZone').value;
        const duree = document.getElementById('rondeDuree').value;
        const consignes = document.getElementById('rondeConsignes').value;
        const observation = document.getElementById('rondeObs').value;

        // R√©cup√©rer les points de contr√¥le coch√©s
        const pointsChecked = [];
        document.querySelectorAll('#pointsControleContainer input[type="checkbox"]:checked').forEach(cb => {
            pointsChecked.push({ nom: cb.value, valide: false, heureValidation: null, observation: '' });
        });

        const ronde = {
            id: genId(),
            type,
            nom: `${type} - ${zone}`,
            agentId,
            zone,
            dureeEstimee: duree,
            consignes,
            pointsControle: pointsChecked,
            heureDebut: new Date().toISOString(),
            heureFin: null,
            observation,
            observationFin: '',
            anomalies: [],
            statut: 'En cours'
        };
        DB.rondes.unshift(ronde);

        const agent = DB.agents.find(a => a.id === agentId);
        addMainCourante('D√©part Ronde', `${type} - ${zone} - ${agent.prenom} ${agent.nom} (${pointsChecked.length} points)`, agentId);
        sauvegarderVersFirebase();
        closeModal();
        showToast('üö∂ Ronde d√©marr√©e !');
        navigate('rondes');
    });

    // Initialiser les points de contr√¥le
    setTimeout(() => updatePointsControle(), 100);
}

function updatePointsControle() {
    const zone = document.getElementById('rondeZone')?.value;
    const container = document.getElementById('pointsControleContainer');
    if (!zone || !container) return;

    const points = pointsControleParZone[zone] || [];
    container.innerHTML = points.length ? points.map((p, i) => `
        <label class="flex items-center gap-2 p-2 hover:bg-gray-100 dark:hover:bg-slate-600 rounded cursor-pointer">
            <input type="checkbox" value="${p}" checked class="w-4 h-4">
            <span class="text-sm">${p}</span>
        </label>
    `).join('') : '<p class="text-gray-500 text-sm">Aucun point de contr√¥le d√©fini pour cette zone</p>';
}

function finRonde(id) {
    showConfirm('Terminer cette ronde ?', () => {
        const r = DB.rondes.find(x => x.id === id);
        if (r) {
            r.heureFin = new Date().toISOString();
            r.statut = 'Termin√©e';
            const agent = DB.agents.find(a => a.id === r.agentId);
            const pointsValides = r.pointsControle?.filter(p => p.valide).length || 0;
            const totalPoints = r.pointsControle?.length || 0;
            addMainCourante('Fin Ronde', `${r.type} - ${r.zone || ''} - ${agent.prenom} ${agent.nom} (${pointsValides}/${totalPoints} points)`, r.agentId);
            sauvegarderVersFirebase();
            showToast('‚úÖ Ronde termin√©e');
            navigate('rondes');
        }
    });
}

// Effectuer la ronde - Valider les points de contr√¥le
function effectuerRonde(id) {
    const r = DB.rondes.find(x => x.id === id);
    if (!r) return;

    const agent = DB.agents.find(a => a.id === r.agentId);
    const pointsControle = r.pointsControle || [];

    showModal(`Ronde en cours - ${r.zone || r.type}`, `
        <div class="space-y-4">
            <div class="bg-blue-50 dark:bg-blue-900/30 p-3 rounded-lg">
                <div class="text-sm text-blue-700 dark:text-blue-400">
                    <strong>${r.type}</strong> ‚Ä¢ ${agent?.prenom} ${agent?.nom} ‚Ä¢ D√©part: ${formatTime(r.heureDebut)}
                </div>
                ${r.consignes ? `<div class="mt-2 text-sm"><strong>Consignes:</strong> ${r.consignes}</div>` : ''}
            </div>

            <div>
                <label class="block text-sm font-semibold mb-2"><i class="fas fa-tasks mr-1"></i>Points de contr√¥le (${pointsControle.filter(p => p.valide).length}/${pointsControle.length})</label>
                <div class="space-y-2 max-h-60 overflow-y-auto">
                    ${pointsControle.map((p, i) => `
                        <div class="flex items-center gap-3 p-3 ${p.valide ? 'bg-green-50 dark:bg-green-900/30' : 'bg-gray-50 dark:bg-slate-700'} rounded-lg">
                            <input type="checkbox" id="pc_${i}" ${p.valide ? 'checked' : ''} class="w-5 h-5" onchange="validerPointControle(${id}, ${i}, this.checked)">
                            <div class="flex-1">
                                <label for="pc_${i}" class="font-medium cursor-pointer ${p.valide ? 'text-green-700 dark:text-green-400' : ''}">${p.nom}</label>
                                ${p.heureValidation ? `<div class="text-xs text-gray-500">Valid√© √† ${formatTime(p.heureValidation)}</div>` : ''}
                            </div>
                            <button onclick="ajouterObservationPoint(${id}, ${i})" class="btn btn-icon btn-sm btn-secondary" title="Observation">
                                <i class="fas fa-comment ${p.observation ? 'text-blue-500' : ''}"></i>
                            </button>
                        </div>
                    `).join('')}
                </div>
            </div>

            <div>
                <label class="block text-sm font-semibold mb-2"><i class="fas fa-exclamation-triangle mr-1 text-red-500"></i>Signaler une anomalie</label>
                <div class="flex gap-2">
                    <input type="text" id="nouvelleAnomalie" class="input flex-1" placeholder="Description de l'anomalie...">
                    <button onclick="ajouterAnomalie(${id})" class="btn btn-danger"><i class="fas fa-plus"></i></button>
                </div>
                ${r.anomalies?.length ? `
                <div class="mt-2 space-y-1">
                    ${r.anomalies.map((a, i) => `
                        <div class="flex items-center gap-2 p-2 bg-red-50 dark:bg-red-900/30 rounded text-sm text-red-700 dark:text-red-400">
                            <i class="fas fa-exclamation-circle"></i>
                            <span class="flex-1">${a.description}</span>
                            <span class="text-xs">${formatTime(a.date)}</span>
                        </div>
                    `).join('')}
                </div>
                ` : ''}
            </div>
        </div>
    `, () => {
        closeModal();
        navigate('rondes');
    }, 'Fermer');
}

function validerPointControle(rondeId, pointIndex, valide) {
    const r = DB.rondes.find(x => x.id === rondeId);
    if (r && r.pointsControle[pointIndex]) {
        r.pointsControle[pointIndex].valide = valide;
        r.pointsControle[pointIndex].heureValidation = valide ? new Date().toISOString() : null;
        sauvegarderVersFirebase();

        // Rafra√Æchir le modal
        effectuerRonde(rondeId);
    }
}

function ajouterObservationPoint(rondeId, pointIndex) {
    const r = DB.rondes.find(x => x.id === rondeId);
    if (!r) return;

    const point = r.pointsControle[pointIndex];
    const obsActuelle = point.observation || '';

    showModal(`Observation - ${point.nom}`, `
        <div class="space-y-4">
            <textarea id="obsPoint" class="input" rows="4" placeholder="Observation pour ce point de contr√¥le...">${obsActuelle}</textarea>
        </div>
    `, () => {
        r.pointsControle[pointIndex].observation = document.getElementById('obsPoint').value;
        sauvegarderVersFirebase();
        closeModal();
        effectuerRonde(rondeId);
    });
}

function ajouterAnomalie(rondeId) {
    const r = DB.rondes.find(x => x.id === rondeId);
    if (!r) return;

    const description = document.getElementById('nouvelleAnomalie')?.value;
    if (!description) return showToast('D√©crivez l\'anomalie', 'error');

    if (!r.anomalies) r.anomalies = [];
    r.anomalies.push({
        id: genId(),
        description,
        date: new Date().toISOString(),
        agentId: currentUser?.id
    });

    const agent = DB.agents.find(a => a.id === currentUser?.id);
    addMainCourante('Anomalie Ronde', `${r.type} - ${r.zone || ''}: ${description}`, currentUser?.id);
    sauvegarderVersFirebase();
    showToast('‚ö†Ô∏è Anomalie signal√©e');
    effectuerRonde(rondeId);
}

function terminerRondeAvecDetails(id) {
    const r = DB.rondes.find(x => x.id === id);
    if (!r) return;

    const pointsValides = r.pointsControle?.filter(p => p.valide).length || 0;
    const totalPoints = r.pointsControle?.length || 0;
    const tousValides = pointsValides === totalPoints;

    showModal('Terminer la ronde', `
        <div class="space-y-4">
            <div class="bg-${tousValides ? 'green' : 'orange'}-50 dark:bg-${tousValides ? 'green' : 'orange'}-900/30 p-4 rounded-lg">
                <div class="font-bold text-${tousValides ? 'green' : 'orange'}-700 dark:text-${tousValides ? 'green' : 'orange'}-400">
                    ${tousValides ? '‚úÖ Tous les points valid√©s' : `‚ö†Ô∏è ${totalPoints - pointsValides} point(s) non valid√©(s)`}
                </div>
                <div class="text-sm mt-1">${pointsValides}/${totalPoints} points de contr√¥le</div>
            </div>

            ${r.anomalies?.length ? `
            <div class="bg-red-50 dark:bg-red-900/30 p-4 rounded-lg">
                <div class="font-bold text-red-700 dark:text-red-400 mb-2">‚ö†Ô∏è ${r.anomalies.length} anomalie(s) signal√©e(s)</div>
                <ul class="text-sm space-y-1">
                    ${r.anomalies.map(a => `<li>‚Ä¢ ${a.description}</li>`).join('')}
                </ul>
            </div>
            ` : ''}

            <div>
                <label class="block text-sm font-semibold mb-2">Observation de fin de ronde</label>
                <textarea id="obsFin" class="input" rows="3" placeholder="Observations finales, remarques...">${r.observationFin || ''}</textarea>
            </div>
        </div>
    `, () => {
        r.heureFin = new Date().toISOString();
        r.statut = 'Termin√©e';
        r.observationFin = document.getElementById('obsFin').value;

        const agent = DB.agents.find(a => a.id === r.agentId);
        const duree = Math.round((new Date(r.heureFin) - new Date(r.heureDebut)) / 60000);
        addMainCourante('Fin Ronde', `${r.type} - ${r.zone || ''} - ${agent.prenom} ${agent.nom} (${pointsValides}/${totalPoints} pts, ${duree} min${r.anomalies?.length ? `, ${r.anomalies.length} anomalie(s)` : ''})`, r.agentId);

        sauvegarderVersFirebase();
        closeModal();
        showToast('‚úÖ Ronde termin√©e');
        navigate('rondes');
    });
}

function voirRonde(id) {
    const r = DB.rondes.find(x => x.id === id);
    if (!r) return;

    const agent = DB.agents.find(a => a.id === r.agentId);
    const pointsValides = r.pointsControle?.filter(p => p.valide).length || 0;
    const totalPoints = r.pointsControle?.length || 0;
    const duree = r.heureFin ? Math.round((new Date(r.heureFin) - new Date(r.heureDebut)) / 60000) : null;

    showModal('D√©tails de la Ronde', `
        <div class="space-y-4">
            <div class="flex items-center justify-between">
                <h3 class="text-xl font-bold text-gray-800 dark:text-white">${r.nom || r.type}</h3>
                <span class="badge ${r.heureFin ? 'badge-success' : 'badge-warning'}">${r.heureFin ? 'Termin√©e' : 'En cours'}</span>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="bg-gray-50 dark:bg-slate-700 p-3 rounded-lg">
                    <div class="text-xs text-gray-500 uppercase mb-1">Type</div>
                    <div class="font-medium">${r.type}</div>
                </div>
                <div class="bg-gray-50 dark:bg-slate-700 p-3 rounded-lg">
                    <div class="text-xs text-gray-500 uppercase mb-1">Zone</div>
                    <div class="font-medium">${r.zone || '-'}</div>
                </div>
                <div class="bg-gray-50 dark:bg-slate-700 p-3 rounded-lg">
                    <div class="text-xs text-gray-500 uppercase mb-1">Agent</div>
                    <div class="font-medium">${agent?.prenom || ''} ${agent?.nom || ''}</div>
                </div>
                <div class="bg-gray-50 dark:bg-slate-700 p-3 rounded-lg">
                    <div class="text-xs text-gray-500 uppercase mb-1">Dur√©e</div>
                    <div class="font-medium">${duree ? duree + ' min' : 'En cours'}</div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="bg-gray-50 dark:bg-slate-700 p-3 rounded-lg">
                    <div class="text-xs text-gray-500 uppercase mb-1">D√©but</div>
                    <div class="font-medium">${formatDateTime(r.heureDebut)}</div>
                </div>
                <div class="bg-gray-50 dark:bg-slate-700 p-3 rounded-lg">
                    <div class="text-xs text-gray-500 uppercase mb-1">Fin</div>
                    <div class="font-medium">${r.heureFin ? formatDateTime(r.heureFin) : '-'}</div>
                </div>
            </div>

            ${totalPoints > 0 ? `
            <div>
                <div class="text-sm font-semibold mb-2">Points de contr√¥le (${pointsValides}/${totalPoints})</div>
                <div class="space-y-1 max-h-40 overflow-y-auto">
                    ${r.pointsControle.map(p => `
                        <div class="flex items-center gap-2 p-2 ${p.valide ? 'bg-green-50 dark:bg-green-900/30' : 'bg-red-50 dark:bg-red-900/30'} rounded">
                            <i class="fas ${p.valide ? 'fa-check-circle text-green-500' : 'fa-times-circle text-red-500'}"></i>
                            <span class="flex-1 text-sm">${p.nom}</span>
                            ${p.heureValidation ? `<span class="text-xs text-gray-500">${formatTime(p.heureValidation)}</span>` : ''}
                        </div>
                    `).join('')}
                </div>
            </div>
            ` : ''}

            ${r.anomalies?.length ? `
            <div class="bg-red-50 dark:bg-red-900/30 p-4 rounded-lg">
                <div class="font-bold text-red-700 dark:text-red-400 mb-2">‚ö†Ô∏è Anomalies signal√©es (${r.anomalies.length})</div>
                <ul class="text-sm space-y-1">
                    ${r.anomalies.map(a => `<li>‚Ä¢ ${a.description} <span class="text-xs text-gray-500">(${formatTime(a.date)})</span></li>`).join('')}
                </ul>
            </div>
            ` : ''}

            ${r.observation ? `
            <div class="bg-gray-50 dark:bg-slate-700 p-3 rounded-lg">
                <div class="text-xs text-gray-500 uppercase mb-1">Observation d√©part</div>
                <div class="text-sm">${r.observation}</div>
            </div>
            ` : ''}

            ${r.observationFin ? `
            <div class="bg-gray-50 dark:bg-slate-700 p-3 rounded-lg">
                <div class="text-xs text-gray-500 uppercase mb-1">Observation fin</div>
                <div class="text-sm">${r.observationFin}</div>
            </div>
            ` : ''}

            ${r.consignes ? `
            <div class="bg-blue-50 dark:bg-blue-900/30 p-3 rounded-lg">
                <div class="text-xs text-blue-500 uppercase mb-1">Consignes</div>
                <div class="text-sm">${r.consignes}</div>
            </div>
            ` : ''}
        </div>
    `, null, 'Fermer');
}

// ========== MAIN COURANTE ==========
function renderMainCourante() {
    return `
        <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
            <h1 class="text-2xl font-bold text-gray-800 dark:text-white"><i class="fas fa-clipboard-list mr-2 text-primary-500"></i>Main Courante</h1>
            <button onclick="window.print()" class="btn btn-secondary no-print"><i class="fas fa-print"></i> Imprimer</button>
        </div>

        <div class="card no-print mb-4">
            <div class="p-4 flex flex-wrap gap-4">
                <input type="text" id="mcSearch" class="input flex-1" placeholder="Rechercher..." oninput="filterMC()">
                <input type="date" id="mcDate" class="input w-auto" onchange="filterMC()">
                <select id="mcType" class="input w-auto" onchange="filterMC()">
                    <option value="">Tous les types</option>
                    <option>Prise de Poste</option>
                    <option>Fin de Poste</option>
                    <option>D√©part Ronde</option>
                    <option>Fin Ronde</option>
                    <option>Alarme Incendie</option>
                    <option>Secours √† personne</option>
                    <option>Incident</option>
                </select>
            </div>
        </div>

        <div class="card">
            <div class="gradient-header text-white p-4 font-semibold">√âv√©nements (${DB.mainCourante.length})</div>
            <div class="overflow-x-auto">
                <table class="table">
                    <thead><tr><th>Date/Heure</th><th>Type</th><th>Description</th><th>Agent</th><th class="no-print">Statut</th><th class="no-print">Action</th></tr></thead>
                    <tbody id="mcBody">${renderMCRows(DB.mainCourante)}</tbody>
                </table>
            </div>
        </div>
    `;
}

function renderMCRows(items) {
    if (!items.length) return '<tr><td colspan="6" class="text-center py-8 text-gray-500">Aucun √©v√©nement</td></tr>';
    const typeColors = { 'Prise de Poste': 'success', 'Fin de Poste': 'info', 'D√©part Ronde': 'purple', 'Fin Ronde': 'purple', 'Alarme Incendie': 'danger', 'Secours √† personne': 'danger', 'Suivi √©v√©nement': 'warning' };
    return items.map(m => {
        const evt = m.evenementId ? DB.evenements.find(e => e.id === m.evenementId) : null;
        return `
        <tr>
            <td class="whitespace-nowrap">${formatDateTime(m.date)}</td>
            <td><span class="badge badge-${typeColors[m.type] || 'info'}">${m.type}</span></td>
            <td>${m.description}</td>
            <td>${m.agent}</td>
            <td class="no-print">
                ${evt ? `<span class="status-dot ${getStatusColor(evt.statut)}" title="${evt.statut}"></span>` : ''}
            </td>
            <td class="no-print">
                ${evt ? `<button class="btn btn-icon btn-secondary btn-sm" onclick="voirEvenement(${evt.id})" title="Voir l'√©v√©nement"><i class="fas fa-eye"></i></button>` : ''}
            </td>
        </tr>
    `;
    }).join('');
}

function filterMC() {
    const search = document.getElementById('mcSearch')?.value.toLowerCase() || '';
    const date = document.getElementById('mcDate')?.value || '';
    const type = document.getElementById('mcType')?.value || '';
    const filtered = DB.mainCourante.filter(m => {
        const matchSearch = m.description.toLowerCase().includes(search) || m.agent.toLowerCase().includes(search);
        const matchDate = !date || m.date.startsWith(date);
        const matchType = !type || m.type === type;
        return matchSearch && matchDate && matchType;
    });
    document.getElementById('mcBody').innerHTML = renderMCRows(filtered);
}

// ========== √âV√âNEMENTS ==========
const typesEvt = ['Alarme Incendie', 'Secours √† personne', 'Probl√®me technique', 'Incident', 'Anomalie', 'Pr√©sence de tiers', 'Passage de contr√¥le'];

function renderEvenements() {
    const evtsActifs = DB.evenements.filter(e => e.statut !== 'Termin√©');
    const evtsTermines = DB.evenements.filter(e => e.statut === 'Termin√©');
    const isSsiap3 = currentUser?.qualification === 'SSIAP 3';

    return `
        <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
            <h1 class="text-2xl font-bold text-gray-800 dark:text-white"><i class="fas fa-exclamation-triangle mr-2 text-primary-500"></i>√âv√©nements</h1>
            ${isSsiap3 ? '' : '<button onclick="showModalEvenement()" class="btn btn-primary"><i class="fas fa-plus"></i> Nouvel √©v√©nement</button>'}
        </div>

        <div class="grid grid-cols-3 gap-4 mb-6">
            <div class="stat-card bg-red-50 dark:bg-red-900/30">
                <div class="flex items-center justify-center gap-2 mb-2"><span class="status-dot red"></span><span class="text-red-600 font-semibold">Alertes</span></div>
                <div class="value text-red-600">${DB.evenements.filter(e => e.statut === 'D√©but').length}</div>
            </div>
            <div class="stat-card bg-orange-50 dark:bg-orange-900/30">
                <div class="flex items-center justify-center gap-2 mb-2"><span class="status-dot orange"></span><span class="text-orange-600 font-semibold">En cours</span></div>
                <div class="value text-orange-600">${DB.evenements.filter(e => e.statut === 'En cours').length}</div>
            </div>
            <div class="stat-card bg-green-50 dark:bg-green-900/30">
                <div class="flex items-center justify-center gap-2 mb-2"><span class="status-dot green"></span><span class="text-green-600 font-semibold">Termin√©s</span></div>
                <div class="value text-green-600">${evtsTermines.length}</div>
            </div>
        </div>

        ${evtsActifs.length ? `
        <div class="card mb-6">
            <div class="gradient-danger text-white p-4 font-semibold">√âv√©nements actifs (${evtsActifs.length})</div>
            <div class="p-4 space-y-3">
                ${evtsActifs.map(e => renderEvenementCard(e)).join('')}
            </div>
        </div>
        ` : ''}

        <div class="card">
            <div class="gradient-success text-white p-4 font-semibold">√âv√©nements termin√©s (${evtsTermines.length})</div>
            <div class="p-4 space-y-3">
                ${evtsTermines.length ? evtsTermines.map(e => renderEvenementCard(e)).join('') : '<p class="text-gray-500 text-center py-4">Aucun √©v√©nement termin√©</p>'}
            </div>
        </div>
    `;
}

function renderEvenementCard(e) {
    const agent = DB.agents.find(a => a.id === e.agentId);
    const suiviCount = e.suivis?.length || 0;
    const isSsiap3 = currentUser?.qualification === 'SSIAP 3';
    return `
        <div class="flex flex-wrap items-center justify-between gap-4 p-4 bg-gray-50 dark:bg-slate-700 rounded-xl">
            <div class="flex items-center gap-4">
                <span class="status-dot ${getStatusColor(e.statut)}"></span>
                <div>
                    <div class="flex items-center gap-2 mb-1">
                        <span class="font-semibold text-gray-800 dark:text-white">${e.type}</span>
                        <span class="badge badge-${e.statut === 'Termin√©' ? 'success' : e.statut === 'En cours' ? 'warning' : 'danger'}">${e.statut}</span>
                    </div>
                    <div class="text-sm text-gray-500">${e.localisation || 'Non pr√©cis√©'} ‚Ä¢ ${formatDateTime(e.date)} ‚Ä¢ ${agent?.prenom} ${agent?.nom}</div>
                    ${suiviCount > 0 ? `<div class="text-xs text-primary-500 mt-1"><i class="fas fa-history"></i> ${suiviCount} action(s) de suivi</div>` : ''}
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="voirEvenement(${e.id})" class="btn btn-secondary btn-sm"><i class="fas fa-eye"></i> Voir</button>
                ${e.statut !== 'Termin√©' && !isSsiap3 ? `<button onclick="ajouterSuivi(${e.id})" class="btn btn-warning btn-sm"><i class="fas fa-plus"></i> Suivi</button>` : ''}
            </div>
        </div>
    `;
}

function showModalEvenement() {
    const agentsPoste = getAgentsEnPoste();
    showModal('Nouvel √âv√©nement', `
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-semibold mb-2">Type</label>
                <select id="evtType" class="input">${typesEvt.map(t => `<option>${t}</option>`).join('')}</select>
            </div>
            <div>
                <label class="block text-sm font-semibold mb-2">Agent</label>
                <select id="evtAgent" class="input">
                    ${agentsPoste.length ? agentsPoste.map(a => `<option value="${a.id}">${a.prenom} ${a.nom}</option>`).join('') : '<option value="">Aucun agent</option>'}
                </select>
            </div>
            <div>
                <label class="block text-sm font-semibold mb-2">Localisation</label>
                <input type="text" id="evtLoc" class="input" placeholder="Ex: Hall d'entr√©e">
            </div>
            <div>
                <label class="block text-sm font-semibold mb-2">Description</label>
                <textarea id="evtDesc" class="input" rows="3"></textarea>
            </div>
        </div>
    `, () => {
        const desc = document.getElementById('evtDesc').value;
        if (!desc) return showToast('Entrez une description', 'error');

        const agentId = parseInt(document.getElementById('evtAgent').value);
        const type = document.getElementById('evtType').value;
        const evt = {
            id: genId(),
            type,
            statut: 'D√©but',
            agentId,
            localisation: document.getElementById('evtLoc').value,
            description: desc,
            date: new Date().toISOString(),
            suivis: [],
            compteRendu: null
        };
        DB.evenements.unshift(evt);
        const loc = evt.localisation ? `${evt.localisation} - ` : '';
        addMainCourante(type, `${loc}D√âBUT: ${desc}`, agentId, { evenementId: evt.id });
        closeModal();
        showToast('√âv√©nement cr√©√©');
        navigate('evenements');
    });
}

function voirEvenement(id) {
    const e = DB.evenements.find(x => x.id === id);
    if (!e) return;
    const agent = DB.agents.find(a => a.id === e.agentId);

    let suiviHtml = '';
    if (e.suivis?.length) {
        suiviHtml = `
            <div class="mt-4 pt-4 border-t border-gray-200 dark:border-slate-600">
                <div class="font-semibold mb-3 flex items-center gap-2">
                    <i class="fas fa-history text-primary-500"></i> Historique des actions (${e.suivis.length})
                </div>
                <div class="timeline">
                    <div class="timeline-item first">
                        <div class="text-sm text-gray-500">${formatDateTime(e.date)}</div>
                        <div class="font-medium">${e.description}</div>
                        <div class="text-xs text-gray-400">${agent?.prenom} ${agent?.nom}</div>
                    </div>
                    ${e.suivis.map(s => {
                        const sAgent = DB.agents.find(a => a.id === s.agentId);
                        return `
                            <div class="timeline-item">
                                <div class="text-sm text-gray-500">${formatDateTime(s.date)}</div>
                                <div class="font-medium">${s.action}</div>
                                <div class="text-xs text-gray-400">${sAgent?.prenom} ${sAgent?.nom}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
    }

    let compteRenduHtml = '';
    if (e.compteRendu) {
        compteRenduHtml = `
            <div class="mt-4 pt-4 border-t border-gray-200 dark:border-slate-600">
                <div class="font-semibold mb-2 flex items-center gap-2">
                    <i class="fas fa-file-alt text-green-500"></i> Compte-rendu final
                </div>
                <div class="bg-green-50 dark:bg-green-900/30 p-4 rounded-xl">
                    <p class="text-gray-700 dark:text-gray-300">${e.compteRendu}</p>
                    <div class="text-xs text-gray-500 mt-2">Cl√¥tur√© le ${formatDateTime(e.dateCloture)}</div>
                </div>
            </div>
        `;
    }

    showModal('Fiche √âv√©nement', `
        <div class="space-y-4">
            <div class="flex items-center gap-4">
                <span class="status-dot ${getStatusColor(e.statut)}" style="width:20px;height:20px;"></span>
                <div>
                    <div class="text-xl font-bold text-gray-800 dark:text-white">${e.type}</div>
                    <span class="badge badge-${e.statut === 'Termin√©' ? 'success' : e.statut === 'En cours' ? 'warning' : 'danger'}">${e.statut}</span>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 text-sm">
                <div><strong>Date:</strong> ${formatDateTime(e.date)}</div>
                <div><strong>Agent:</strong> ${agent?.prenom} ${agent?.nom}</div>
                <div><strong>Localisation:</strong> ${e.localisation || 'Non pr√©cis√©'}</div>
            </div>

            <div class="bg-gray-50 dark:bg-slate-700 p-4 rounded-xl">
                <div class="font-semibold mb-2">Description initiale</div>
                <p class="text-gray-700 dark:text-gray-300">${e.description}</p>
            </div>

            ${suiviHtml}
            ${compteRenduHtml}

            ${e.statut !== 'Termin√©' && currentUser?.qualification !== 'SSIAP 3' ? `
                <div class="flex gap-2 pt-4 border-t border-gray-200 dark:border-slate-600">
                    <button onclick="closeModal(); ajouterSuivi(${e.id})" class="btn btn-warning flex-1"><i class="fas fa-plus"></i> Ajouter suivi</button>
                    <button onclick="closeModal(); terminerEvenement(${e.id})" class="btn btn-success flex-1"><i class="fas fa-check"></i> Terminer</button>
                </div>
            ` : ''}
        </div>
    `, null, 'Fermer');
}

function ajouterSuivi(id) {
    const e = DB.evenements.find(x => x.id === id);
    if (!e) return;
    const agentsPoste = getAgentsEnPoste();

    showModal('Ajouter un suivi', `
        <div class="space-y-4">
            <div class="bg-gray-50 dark:bg-slate-700 p-3 rounded-xl">
                <div class="text-sm text-gray-500">√âv√©nement</div>
                <div class="font-semibold">${e.type} - ${e.localisation || 'Non pr√©cis√©'}</div>
            </div>

            <div>
                <label class="block text-sm font-semibold mb-2">Nouveau statut</label>
                <select id="suiviStatut" class="input">
                    <option value="En cours">En cours</option>
                    <option value="Termin√©">Termin√©</option>
                </select>
            </div>

            <div>
                <label class="block text-sm font-semibold mb-2">Agent</label>
                <select id="suiviAgent" class="input">
                    ${agentsPoste.map(a => `<option value="${a.id}">${a.prenom} ${a.nom}</option>`).join('')}
                </select>
            </div>

            <div>
                <label class="block text-sm font-semibold mb-2">Action effectu√©e</label>
                <textarea id="suiviAction" class="input" rows="3" placeholder="Ex: Lev√©e de doute en cours, Feu √©teint, Secours appel√©s..."></textarea>
            </div>
        </div>
    `, () => {
        const evt = DB.evenements.find(x => x.id === id);
        if (!evt) return;

        const action = document.getElementById('suiviAction').value;
        if (!action) return showToast('D√©crivez l\'action effectu√©e', 'error');

        const agentId = parseInt(document.getElementById('suiviAgent').value);
        const newStatut = document.getElementById('suiviStatut').value;

        if (!evt.suivis) evt.suivis = [];
        evt.suivis.push({
            id: genId(),
            date: new Date().toISOString(),
            action,
            agentId
        });

        evt.statut = newStatut;

        const loc = evt.localisation ? `${evt.localisation} - ` : '';
        addMainCourante('Suivi √©v√©nement', `${loc}${evt.type}: ${action}`, agentId, { evenementId: evt.id });

        closeModal();
        showToast('Suivi ajout√©');
        navigate('evenements');
    });
}

function terminerEvenement(id) {
    const e = DB.evenements.find(x => x.id === id);
    if (!e) return;
    const agentsPoste = getAgentsEnPoste();

    showModal('Terminer l\'√©v√©nement', `
        <div class="space-y-4">
            <div class="bg-green-50 dark:bg-green-900/30 p-4 rounded-xl">
                <div class="flex items-center gap-2 mb-2">
                    <span class="status-dot green"></span>
                    <span class="font-semibold text-green-700 dark:text-green-400">Cl√¥ture de l'√©v√©nement</span>
                </div>
                <div class="text-sm text-gray-600 dark:text-gray-400">${e.type} - ${e.localisation || 'Non pr√©cis√©'}</div>
            </div>

            <div>
                <label class="block text-sm font-semibold mb-2">Agent</label>
                <select id="crAgent" class="input">
                    ${agentsPoste.map(a => `<option value="${a.id}">${a.prenom} ${a.nom}</option>`).join('')}
                </select>
            </div>

            <div>
                <label class="block text-sm font-semibold mb-2">Compte-rendu final</label>
                <textarea id="crTexte" class="input" rows="4" placeholder="R√©sum√© de l'intervention, mesures prises, suites √† donner..."></textarea>
            </div>
        </div>
    `, () => {
        const cr = document.getElementById('crTexte').value;
        if (!cr) return showToast('R√©digez le compte-rendu', 'error');

        const agentId = parseInt(document.getElementById('crAgent').value);

        e.statut = 'Termin√©';
        e.compteRendu = cr;
        e.dateCloture = new Date().toISOString();

        const agent = DB.agents.find(a => a.id === agentId);
        const loc = e.localisation ? `${e.localisation} - ` : '';
        addMainCourante('Suivi √©v√©nement', `${loc}${e.type} TERMIN√â: ${cr.substring(0, 100)}...`, agentId, { evenementId: e.id });

        closeModal();
        showToast('√âv√©nement cl√¥tur√©');
        navigate('evenements');
    });
}

// ========== MAT√âRIELS ==========
const typesMat = ['Extincteur', 'Porte Coupe-Feu', 'Alarme Incendie', '√âclairage de Secours', 'D√©senfumage', 'Sprinkler', 'Robinet Incendie', 'RIA', 'D√©tecteur', 'Signalisation', 'Autre'];
const statutsMat = ['Op√©rationnel', 'D√©faillant', 'En Maintenance', 'Hors Service'];

// Variables de filtres pour les mat√©riels
let filtreMatRecherche = '';
let filtreMatType = '';
let filtreMatStatut = '';
let filtreMatMaintenance = ''; // '', 'a_jour', 'en_retard', 'a_venir'
let filtreMatBatiment = '';
let filtreMatSecteur = '';
let filtreMatZone = '';

function renderMateriels() {
    const stats = { total: 0, ok: 0, defaillant: 0, hs: 0, maintenance: 0 };
    DB.materiels.forEach(m => {
        stats.total++;
        if (m.statut === 'Op√©rationnel') stats.ok++;
        else if (m.statut === 'D√©faillant') stats.defaillant++;
        else if (m.statut === 'Hors Service') stats.hs++;
        else if (m.statut === 'En Maintenance') stats.maintenance++;
    });

    // Version mobile pour SSIAP 1
    if (currentUser?.qualification === 'SSIAP 1') {
        return renderMaterielsMobile(stats);
    }

    const isSsiap2 = currentUser?.qualification === 'SSIAP 2';
    const isSsiap3 = currentUser?.qualification === 'SSIAP 3';
    const canModify = isSsiap2 || isSsiap3; // SSIAP 2 et 3 peuvent modifier
    const canCreate = isSsiap3; // Seul SSIAP 3 peut cr√©er
    const canDelete = isSsiap3; // Seul SSIAP 3 peut supprimer

    // Obtenir les secteurs du b√¢timent s√©lectionn√©
    const secteursFiltres = filtreMatBatiment ?
        (configEtablissement.batiments.find(b => b.id === filtreMatBatiment)?.secteurs || []) : [];

    // Obtenir les zones du secteur s√©lectionn√©
    const zonesFiltres = filtreMatSecteur ?
        (secteursFiltres.find(s => s.id === filtreMatSecteur)?.zones || []) : [];

    // Date d'aujourd'hui pour les filtres maintenance
    const aujourdHui = new Date();
    const dans30jours = new Date(aujourdHui);
    dans30jours.setDate(dans30jours.getDate() + 30);

    // Filtrer les mat√©riels
    const materielsFiltres = DB.materiels.filter(m => {
        const matchRecherche = !filtreMatRecherche ||
            m.nom.toLowerCase().includes(filtreMatRecherche.toLowerCase()) ||
            (m.localisation && m.localisation.toLowerCase().includes(filtreMatRecherche.toLowerCase())) ||
            (m.codeQR && m.codeQR.toLowerCase().includes(filtreMatRecherche.toLowerCase()));
        const matchType = !filtreMatType || m.type === filtreMatType;
        const matchStatut = !filtreMatStatut || m.statut === filtreMatStatut;

        // Filtre √©tat de maintenance
        let matchMaintenance = true;
        if (filtreMatMaintenance) {
            if (!m.prochaineMaint) {
                // Pas de date de maintenance programm√©e
                matchMaintenance = filtreMatMaintenance === 'non_defini';
            } else {
                const dateMaint = new Date(m.prochaineMaint);
                if (filtreMatMaintenance === 'en_retard') {
                    matchMaintenance = dateMaint < aujourdHui;
                } else if (filtreMatMaintenance === 'a_venir') {
                    matchMaintenance = dateMaint >= aujourdHui && dateMaint <= dans30jours;
                } else if (filtreMatMaintenance === 'a_jour') {
                    matchMaintenance = dateMaint > dans30jours;
                } else if (filtreMatMaintenance === 'non_defini') {
                    matchMaintenance = false;
                }
            }
        }

        // Filtres hi√©rarchiques de localisation
        let matchLoc = true;
        if (filtreMatBatiment) {
            const batiment = configEtablissement.batiments.find(b => b.id === filtreMatBatiment);
            if (batiment) {
                matchLoc = m.localisation && m.localisation.startsWith(batiment.nom);
                if (matchLoc && filtreMatSecteur) {
                    const secteur = batiment.secteurs.find(s => s.id === filtreMatSecteur);
                    if (secteur) {
                        matchLoc = m.localisation.includes(secteur.nom);
                        if (matchLoc && filtreMatZone) {
                            matchLoc = m.localisation.includes(filtreMatZone);
                        }
                    }
                }
            }
        }

        return matchRecherche && matchType && matchStatut && matchMaintenance && matchLoc;
    });

    return `
        <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
            <div>
                <h1 class="text-2xl font-bold text-gray-800 dark:text-white flex items-center gap-2">
                    <i class="fas fa-fire-extinguisher text-primary-500"></i>
                    Gestion des Mat√©riels
                </h1>
                <p class="text-gray-500 text-sm mt-1">${stats.total} mat√©riel(s) ‚Ä¢ ${stats.defaillant} d√©faillant(s)</p>
            </div>
            <div class="flex gap-2 flex-wrap">
                <button onclick="genererRapportMateriels()" class="btn btn-success btn-sm no-print"><i class="fas fa-file-alt"></i> Rapport</button>
                <button onclick="imprimerQRCodes()" class="btn btn-warning btn-sm no-print"><i class="fas fa-print"></i> Imprimer</button>
                ${canCreate ? '<button onclick="showModalMateriel()" class="btn btn-primary btn-sm"><i class="fas fa-plus"></i> Nouveau Mat√©riel</button>' : ''}
            </div>
        </div>

        <!-- Statistiques avec points color√©s -->
        <div class="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
            <div class="stat-card bg-white dark:bg-slate-800 flex items-center gap-4">
                <div class="w-4 h-4 rounded-full bg-blue-500"></div>
                <div>
                    <div class="text-xs text-gray-500 uppercase">Total</div>
                    <div class="text-2xl font-bold text-gray-800 dark:text-white">${stats.total}</div>
                </div>
            </div>
            <div class="stat-card bg-white dark:bg-slate-800 flex items-center gap-4">
                <div class="w-4 h-4 rounded-full bg-green-500"></div>
                <div>
                    <div class="text-xs text-gray-500 uppercase">Op√©rationnels</div>
                    <div class="text-2xl font-bold text-green-600">${stats.ok}</div>
                </div>
            </div>
            <div class="stat-card bg-white dark:bg-slate-800 flex items-center gap-4">
                <div class="w-4 h-4 rounded-full bg-red-500"></div>
                <div>
                    <div class="text-xs text-gray-500 uppercase">D√©faillants</div>
                    <div class="text-2xl font-bold text-red-600">${stats.defaillant}</div>
                </div>
            </div>
            <div class="stat-card bg-white dark:bg-slate-800 flex items-center gap-4">
                <div class="w-4 h-4 rounded-full bg-gray-800 dark:bg-gray-400"></div>
                <div>
                    <div class="text-xs text-gray-500 uppercase">Hors Service</div>
                    <div class="text-2xl font-bold text-gray-800 dark:text-gray-300">${stats.hs}</div>
                </div>
            </div>
            <div class="stat-card bg-white dark:bg-slate-800 flex items-center gap-4">
                <div class="w-4 h-4 rounded-full bg-orange-500"></div>
                <div>
                    <div class="text-xs text-gray-500 uppercase">Maintenance</div>
                    <div class="text-2xl font-bold text-orange-600">${stats.maintenance}</div>
                </div>
            </div>
        </div>

        <!-- Barre de recherche et filtres -->
        <div class="card mb-6">
            <div class="p-4">
                <!-- Premi√®re ligne : Recherche, Type, Statut, Maintenance -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                    <div>
                        <label class="block text-xs text-gray-500 mb-1"><i class="fas fa-search mr-1"></i>Rechercher</label>
                        <input type="text" id="matRecherche" class="input" placeholder="Nom, localisation, QR code..." value="${filtreMatRecherche}" oninput="filtrerMateriels()">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1"><i class="fas fa-fire-extinguisher mr-1"></i>Type</label>
                        <select id="matFiltreType" class="input" onchange="filtrerMateriels()">
                            <option value="">Tous les types</option>
                            ${typesMat.map(t => `<option value="${t}" ${filtreMatType === t ? 'selected' : ''}>${t}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1"><i class="fas fa-info-circle mr-1"></i>Statut</label>
                        <select id="matFiltreStatut" class="input" onchange="filtrerMateriels()">
                            <option value="">Tous les statuts</option>
                            ${statutsMat.map(s => `<option value="${s}" ${filtreMatStatut === s ? 'selected' : ''}>${s}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1"><i class="fas fa-wrench mr-1"></i>√âtat Maintenance</label>
                        <select id="matFiltreMaintenance" class="input" onchange="filtrerMateriels()">
                            <option value="">Tous</option>
                            <option value="a_jour" ${filtreMatMaintenance === 'a_jour' ? 'selected' : ''}>‚úÖ √Ä jour</option>
                            <option value="a_venir" ${filtreMatMaintenance === 'a_venir' ? 'selected' : ''}>‚è∞ Arrive √† terme (30j)</option>
                            <option value="en_retard" ${filtreMatMaintenance === 'en_retard' ? 'selected' : ''}>‚ö†Ô∏è En retard</option>
                            <option value="non_defini" ${filtreMatMaintenance === 'non_defini' ? 'selected' : ''}>‚ùì Non d√©fini</option>
                        </select>
                    </div>
                </div>

                <!-- Deuxi√®me ligne : Filtres hi√©rarchiques de localisation -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-xs text-gray-500 mb-1"><i class="fas fa-building mr-1"></i>B√¢timent</label>
                        <select id="matFiltreBatiment" class="input" onchange="filtrerMaterielsBatiment()">
                            <option value="">Tous les b√¢timents</option>
                            ${configEtablissement.batiments.map(b => `<option value="${b.id}" ${filtreMatBatiment === b.id ? 'selected' : ''}>${b.nom}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1"><i class="fas fa-layer-group mr-1"></i>Secteur</label>
                        <select id="matFiltreSecteur" class="input" onchange="filtrerMaterielsSecteur()" ${!filtreMatBatiment ? 'disabled' : ''}>
                            <option value="">Tous les secteurs</option>
                            ${secteursFiltres.map(s => `<option value="${s.id}" ${filtreMatSecteur === s.id ? 'selected' : ''}>${s.nom}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1"><i class="fas fa-map-marker-alt mr-1"></i>Zone</label>
                        <select id="matFiltreZone" class="input" onchange="filtrerMateriels()" ${!filtreMatSecteur ? 'disabled' : ''}>
                            <option value="">Toutes les zones</option>
                            ${zonesFiltres.map(z => `<option value="${z}" ${filtreMatZone === z ? 'selected' : ''}>${z}</option>`).join('')}
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button onclick="reinitialiserFiltresMateriels()" class="btn btn-secondary w-full"><i class="fas fa-undo mr-1"></i>R√©initialiser</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tableau des mat√©riels -->
        <div class="card">
            <div class="overflow-x-auto">
                <table class="table">
                    <thead>
                        <tr>
                            <th>NOM</th>
                            <th>LOCALISATION</th>
                            <th>√âTAT</th>
                            <th>ACTIONS</th>
                        </tr>
                    </thead>
                    <tbody id="tableMateriels">
                        ${materielsFiltres.length ? materielsFiltres.map(m => {
                            const sClass = { 'Op√©rationnel': 'success', 'D√©faillant': 'danger', 'En Maintenance': 'warning', 'Hors Service': 'danger' }[m.statut] || 'secondary';
                            return `
                                <tr class="hover:bg-gray-50 dark:hover:bg-slate-700">
                                    <td>
                                        <div class="font-semibold text-gray-800 dark:text-white">${m.nom}</div>
                                        <div class="text-sm text-gray-500">${m.type}</div>
                                    </td>
                                    <td class="text-gray-600 dark:text-gray-400">${m.localisation || '-'}</td>
                                    <td><span class="badge badge-${sClass}">${m.statut}</span></td>
                                    <td>
                                        <div class="flex gap-1">
                                            <button onclick="voirMateriel(${m.id})" class="btn btn-icon btn-sm" style="background:#10b981;color:white" title="Voir"><i class="fas fa-eye"></i></button>
                                            ${canModify ? `<button onclick="editMat(${m.id})" class="btn btn-icon btn-sm" style="background:#3b82f6;color:white" title="Modifier"><i class="fas fa-edit"></i></button>` : ''}
                                            ${canDelete ? `<button onclick="supprimerMateriel(${m.id})" class="btn btn-icon btn-sm" style="background:#ef4444;color:white" title="Supprimer"><i class="fas fa-trash"></i></button>` : ''}
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }).join('') : '<tr><td colspan="4" class="text-center text-gray-500 py-8">Aucun mat√©riel trouv√©</td></tr>'}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

// Version mobile optimis√©e des mat√©riels pour SSIAP 1
function renderMaterielsMobile(stats) {
    // Mat√©riels probl√©matiques en premier
    const defaillants = DB.materiels.filter(m => m.statut === 'D√©faillant');
    const horsService = DB.materiels.filter(m => m.statut === 'Hors Service');
    const enMaintenance = DB.materiels.filter(m => m.statut === 'En Maintenance');
    const operationnels = DB.materiels.filter(m => m.statut === 'Op√©rationnel');

    const getStatutIcon = (statut) => {
        switch(statut) {
            case 'Op√©rationnel': return 'fa-check-circle text-green-500';
            case 'D√©faillant': return 'fa-exclamation-triangle text-red-500';
            case 'Hors Service': return 'fa-ban text-gray-600';
            case 'En Maintenance': return 'fa-tools text-orange-500';
            default: return 'fa-question-circle text-gray-400';
        }
    };

    const getStatutBg = (statut) => {
        switch(statut) {
            case 'Op√©rationnel': return 'bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800';
            case 'D√©faillant': return 'bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-800';
            case 'Hors Service': return 'bg-gray-100 dark:bg-gray-800 border-gray-300 dark:border-gray-600';
            case 'En Maintenance': return 'bg-orange-50 dark:bg-orange-900/20 border-orange-200 dark:border-orange-800';
            default: return 'bg-gray-50 dark:bg-slate-700';
        }
    };

    const renderMaterielCard = (m) => `
        <div class="p-3 border rounded-xl ${getStatutBg(m.statut)}" onclick="voirMateriel(${m.id})">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-white dark:bg-slate-700 rounded-lg flex items-center justify-center shadow-sm">
                    <i class="fas ${getStatutIcon(m.statut)}"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="font-medium text-sm text-gray-800 dark:text-white truncate">${m.nom}</div>
                    <div class="text-xs text-gray-500 truncate"><i class="fas fa-map-marker-alt mr-1"></i>${m.localisation || '-'}</div>
                </div>
                <i class="fas fa-chevron-right text-gray-300"></i>
            </div>
        </div>
    `;

    return `
        <div class="space-y-4">
            <!-- Stats compactes -->
            <div class="grid grid-cols-4 gap-2">
                <div class="card p-3 text-center">
                    <div class="text-xl font-bold text-green-600">${stats.ok}</div>
                    <div class="text-xs text-gray-500">OK</div>
                </div>
                <div class="card p-3 text-center ${stats.defaillant > 0 ? 'ring-2 ring-red-500' : ''}">
                    <div class="text-xl font-bold text-red-600">${stats.defaillant}</div>
                    <div class="text-xs text-gray-500">D√©fail.</div>
                </div>
                <div class="card p-3 text-center">
                    <div class="text-xl font-bold text-gray-600 dark:text-gray-300">${stats.hs}</div>
                    <div class="text-xs text-gray-500">H.S.</div>
                </div>
                <div class="card p-3 text-center">
                    <div class="text-xl font-bold text-orange-600">${stats.maintenance}</div>
                    <div class="text-xs text-gray-500">Maint.</div>
                </div>
            </div>

            <!-- Recherche -->
            <div class="relative">
                <input type="text" id="matSearchMobile" class="input pl-10" placeholder="Rechercher un mat√©riel..." oninput="filtrerMaterielsMobile(this.value)">
                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            </div>

            <div id="materielsMobileList">
                ${defaillants.length ? `
                <div class="mb-4">
                    <h3 class="text-sm font-bold text-red-600 mb-2 flex items-center gap-2">
                        <i class="fas fa-exclamation-triangle"></i> D√©faillants (${defaillants.length})
                    </h3>
                    <div class="space-y-2">
                        ${defaillants.map(m => renderMaterielCard(m)).join('')}
                    </div>
                </div>
                ` : ''}

                ${horsService.length ? `
                <div class="mb-4">
                    <h3 class="text-sm font-bold text-gray-600 dark:text-gray-400 mb-2 flex items-center gap-2">
                        <i class="fas fa-ban"></i> Hors Service (${horsService.length})
                    </h3>
                    <div class="space-y-2">
                        ${horsService.map(m => renderMaterielCard(m)).join('')}
                    </div>
                </div>
                ` : ''}

                ${enMaintenance.length ? `
                <div class="mb-4">
                    <h3 class="text-sm font-bold text-orange-600 mb-2 flex items-center gap-2">
                        <i class="fas fa-tools"></i> En Maintenance (${enMaintenance.length})
                    </h3>
                    <div class="space-y-2">
                        ${enMaintenance.map(m => renderMaterielCard(m)).join('')}
                    </div>
                </div>
                ` : ''}

                <div class="mb-4">
                    <h3 class="text-sm font-bold text-green-600 mb-2 flex items-center gap-2">
                        <i class="fas fa-check-circle"></i> Op√©rationnels (${operationnels.length})
                    </h3>
                    <div class="space-y-2">
                        ${operationnels.slice(0, 10).map(m => renderMaterielCard(m)).join('')}
                        ${operationnels.length > 10 ? `
                        <button onclick="voirTousMateriels()" class="w-full text-center text-sm text-primary-500 py-2">
                            Voir les ${operationnels.length - 10} autres...
                        </button>
                        ` : ''}
                    </div>
                </div>
            </div>
        </div>
    `;
}

function filtrerMaterielsMobile(query) {
    const container = document.getElementById('materielsMobileList');
    if (!container) return;

    query = query.toLowerCase();
    const filtered = DB.materiels.filter(m =>
        m.nom.toLowerCase().includes(query) ||
        (m.localisation && m.localisation.toLowerCase().includes(query)) ||
        m.type.toLowerCase().includes(query)
    );

    const getStatutIcon = (statut) => {
        switch(statut) {
            case 'Op√©rationnel': return 'fa-check-circle text-green-500';
            case 'D√©faillant': return 'fa-exclamation-triangle text-red-500';
            case 'Hors Service': return 'fa-ban text-gray-600';
            case 'En Maintenance': return 'fa-tools text-orange-500';
            default: return 'fa-question-circle text-gray-400';
        }
    };

    const getStatutBg = (statut) => {
        switch(statut) {
            case 'Op√©rationnel': return 'bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800';
            case 'D√©faillant': return 'bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-800';
            case 'Hors Service': return 'bg-gray-100 dark:bg-gray-800 border-gray-300 dark:border-gray-600';
            case 'En Maintenance': return 'bg-orange-50 dark:bg-orange-900/20 border-orange-200 dark:border-orange-800';
            default: return 'bg-gray-50 dark:bg-slate-700';
        }
    };

    container.innerHTML = filtered.length ? `
        <div class="space-y-2">
            ${filtered.map(m => `
                <div class="p-3 border rounded-xl ${getStatutBg(m.statut)}" onclick="voirMateriel(${m.id})">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-white dark:bg-slate-700 rounded-lg flex items-center justify-center shadow-sm">
                            <i class="fas ${getStatutIcon(m.statut)}"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="font-medium text-sm text-gray-800 dark:text-white truncate">${m.nom}</div>
                            <div class="text-xs text-gray-500 truncate"><i class="fas fa-map-marker-alt mr-1"></i>${m.localisation || '-'}</div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-300"></i>
                    </div>
                </div>
            `).join('')}
        </div>
    ` : '<p class="text-center text-gray-500 py-8">Aucun mat√©riel trouv√©</p>';
}

function voirTousMateriels() {
    const operationnels = DB.materiels.filter(m => m.statut === 'Op√©rationnel');

    showModal('Mat√©riels Op√©rationnels', `
        <div class="space-y-2 max-h-96 overflow-y-auto">
            ${operationnels.map(m => `
                <div class="p-3 bg-green-50 dark:bg-green-900/20 rounded-lg flex items-center gap-3" onclick="closeModal(); voirMateriel(${m.id})">
                    <i class="fas fa-check-circle text-green-500"></i>
                    <div class="flex-1">
                        <div class="font-medium text-sm">${m.nom}</div>
                        <div class="text-xs text-gray-500">${m.localisation || '-'}</div>
                    </div>
                </div>
            `).join('')}
        </div>
    `, null, 'Fermer');
}

function filtrerMateriels() {
    filtreMatRecherche = document.getElementById('matRecherche')?.value || '';
    filtreMatType = document.getElementById('matFiltreType')?.value || '';
    filtreMatStatut = document.getElementById('matFiltreStatut')?.value || '';
    filtreMatMaintenance = document.getElementById('matFiltreMaintenance')?.value || '';
    filtreMatZone = document.getElementById('matFiltreZone')?.value || '';
    navigate('materiels');
}

function filtrerMaterielsBatiment() {
    filtreMatRecherche = document.getElementById('matRecherche')?.value || '';
    filtreMatType = document.getElementById('matFiltreType')?.value || '';
    filtreMatStatut = document.getElementById('matFiltreStatut')?.value || '';
    filtreMatMaintenance = document.getElementById('matFiltreMaintenance')?.value || '';
    filtreMatBatiment = document.getElementById('matFiltreBatiment')?.value || '';
    // R√©initialiser secteur et zone quand on change de b√¢timent
    filtreMatSecteur = '';
    filtreMatZone = '';
    navigate('materiels');
}

function filtrerMaterielsSecteur() {
    filtreMatRecherche = document.getElementById('matRecherche')?.value || '';
    filtreMatType = document.getElementById('matFiltreType')?.value || '';
    filtreMatStatut = document.getElementById('matFiltreStatut')?.value || '';
    filtreMatMaintenance = document.getElementById('matFiltreMaintenance')?.value || '';
    filtreMatBatiment = document.getElementById('matFiltreBatiment')?.value || '';
    filtreMatSecteur = document.getElementById('matFiltreSecteur')?.value || '';
    // R√©initialiser zone quand on change de secteur
    filtreMatZone = '';
    navigate('materiels');
}

function reinitialiserFiltresMateriels() {
    filtreMatRecherche = '';
    filtreMatType = '';
    filtreMatStatut = '';
    filtreMatMaintenance = '';
    filtreMatBatiment = '';
    filtreMatSecteur = '';
    filtreMatZone = '';
    navigate('materiels');
}

function genererRapportMateriels() {
    const stats = { total: 0, ok: 0, defaillant: 0, hs: 0, maintenance: 0 };
    DB.materiels.forEach(m => {
        stats.total++;
        if (m.statut === 'Op√©rationnel') stats.ok++;
        else if (m.statut === 'D√©faillant') stats.defaillant++;
        else if (m.statut === 'Hors Service') stats.hs++;
        else if (m.statut === 'En Maintenance') stats.maintenance++;
    });

    const defaillants = DB.materiels.filter(m => m.statut === 'D√©faillant');
    const horsService = DB.materiels.filter(m => m.statut === 'Hors Service');
    const maintenanceProche = DB.materiels.filter(m => {
        if (!m.prochaineMaint) return false;
        const prochaine = new Date(m.prochaineMaint);
        const maintenant = new Date();
        const diff = (prochaine - maintenant) / (1000 * 60 * 60 * 24);
        return diff <= 30 && diff >= 0;
    });

    showModal('Rapport des Mat√©riels', `
        <div class="space-y-4">
            <div class="bg-gray-50 dark:bg-slate-700 p-4 rounded-xl">
                <h3 class="font-bold mb-3">üìä Statistiques globales</h3>
                <div class="grid grid-cols-2 gap-2 text-sm">
                    <div>Total: <strong>${stats.total}</strong></div>
                    <div class="text-green-600">Op√©rationnels: <strong>${stats.ok}</strong></div>
                    <div class="text-red-600">D√©faillants: <strong>${stats.defaillant}</strong></div>
                    <div class="text-gray-800 dark:text-gray-300">Hors Service: <strong>${stats.hs}</strong></div>
                    <div class="text-orange-600">En Maintenance: <strong>${stats.maintenance}</strong></div>
                </div>
            </div>

            ${defaillants.length ? `
            <div class="bg-red-50 dark:bg-red-900/30 p-4 rounded-xl">
                <h3 class="font-bold mb-3 text-red-700 dark:text-red-400">‚ö†Ô∏è Mat√©riels d√©faillants (${defaillants.length})</h3>
                <ul class="text-sm space-y-1">
                    ${defaillants.map(m => `<li>‚Ä¢ ${m.nom} - ${m.localisation}</li>`).join('')}
                </ul>
            </div>
            ` : ''}

            ${horsService.length ? `
            <div class="bg-gray-100 dark:bg-gray-800 p-4 rounded-xl">
                <h3 class="font-bold mb-3 text-gray-800 dark:text-gray-300">üö´ Mat√©riels hors service (${horsService.length})</h3>
                <ul class="text-sm space-y-1">
                    ${horsService.map(m => `<li>‚Ä¢ ${m.nom} - ${m.localisation}</li>`).join('')}
                </ul>
            </div>
            ` : ''}

            ${maintenanceProche.length ? `
            <div class="bg-orange-50 dark:bg-orange-900/30 p-4 rounded-xl">
                <h3 class="font-bold mb-3 text-orange-700 dark:text-orange-400">üîß Maintenance √† pr√©voir (30 jours) - ${maintenanceProche.length}</h3>
                <ul class="text-sm space-y-1">
                    ${maintenanceProche.map(m => `<li>‚Ä¢ ${m.nom} - ${formatDate(m.prochaineMaint)}</li>`).join('')}
                </ul>
            </div>
            ` : '<div class="bg-green-50 dark:bg-green-900/30 p-4 rounded-xl text-green-700">‚úÖ Aucune maintenance pr√©vue dans les 30 prochains jours</div>'}

            <div class="text-xs text-gray-500 text-right">Rapport g√©n√©r√© le ${formatDateTime(new Date())}</div>
        </div>
    `, null, 'Fermer');
}

function showModalMateriel() {
    const codeQR = 'MAT-' + Date.now();
    const batimentsOptions = configEtablissement.batiments.map(b => `<option value="${b.id}">${b.nom}</option>`).join('');

    showModal('Nouveau Mat√©riel', `
        <div class="space-y-4">
            <!-- Localisation hi√©rarchique -->
            <div class="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-xl">
                <h3 class="font-semibold text-blue-800 dark:text-blue-300 mb-3"><i class="fas fa-map-marker-alt mr-2"></i>Localisation</h3>
                <div class="grid grid-cols-3 gap-3">
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">B√¢timent *</label>
                        <select id="matBatiment" class="input" onchange="updateSecteursMat()">
                            <option value="">Choisir...</option>
                            ${batimentsOptions}
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">Secteur *</label>
                        <select id="matSecteur" class="input" onchange="updateZonesMat()" disabled>
                            <option value="">Choisir...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">Zone *</label>
                        <select id="matZone" class="input" disabled>
                            <option value="">Choisir...</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-sm font-semibold mb-2">Type *</label><select id="matType" class="input" onchange="genererNomMateriel()"><option value="">S√©lectionner un type</option>${typesMat.map(t => `<option>${t}</option>`).join('')}</select></div>
                <div><label class="block text-sm font-semibold mb-2">Num√©ro *</label><input type="text" id="matNumero" class="input" placeholder="Ex: 001, 002..." oninput="genererNomMateriel()"></div>
            </div>

            <div><label class="block text-sm font-semibold mb-2">Nom du mat√©riel</label><input type="text" id="matNom" class="input bg-gray-50 dark:bg-slate-700" placeholder="G√©n√©r√© automatiquement" readonly></div>

            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-sm font-semibold mb-2">Statut *</label><select id="matStatut" class="input">${statutsMat.map(s => `<option>${s}</option>`).join('')}</select></div>
                <div><label class="block text-sm font-semibold mb-2">Code QR</label><input type="text" id="matCodeQR" class="input bg-gray-100 dark:bg-slate-700" value="${codeQR}" readonly></div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-sm font-semibold mb-2">Num√©ro de s√©rie</label><input type="text" id="matNumSerie" class="input" placeholder="Optionnel"></div>
                <div><label class="block text-sm font-semibold mb-2">Fabricant</label><input type="text" id="matFabricant" class="input" placeholder="Optionnel"></div>
            </div>
            <!-- Maintenance avec d√©lai automatique -->
            <div class="bg-green-50 dark:bg-green-900/30 p-4 rounded-xl">
                <h3 class="font-semibold text-green-800 dark:text-green-300 mb-3"><i class="fas fa-wrench mr-2"></i>Maintenance</h3>
                <div class="grid grid-cols-3 gap-3">
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">D√©lai de maintenance</label>
                        <select id="matDelai" class="input" onchange="calculerProchaineMaint()">
                            <option value="">Non d√©fini</option>
                            <option value="1">1 mois</option>
                            <option value="3">3 mois</option>
                            <option value="6">6 mois</option>
                            <option value="12">12 mois</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">Derni√®re maintenance</label>
                        <input type="date" id="matDernMaint" class="input" onchange="calculerProchaineMaint()">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">Prochaine maintenance</label>
                        <input type="date" id="matProchMaint" class="input bg-gray-100 dark:bg-slate-600" readonly>
                    </div>
                </div>
                <div class="mt-2 text-xs text-green-600 dark:text-green-400">
                    <i class="fas fa-info-circle mr-1"></i>La date de prochaine maintenance se calcule automatiquement (derni√®re + d√©lai)
                </div>
            </div>
            <div><label class="block text-sm font-semibold mb-2">Description</label><textarea id="matDesc" class="input" rows="2" placeholder="Informations compl√©mentaires..."></textarea></div>
        </div>
    `, () => {
        const batiment = document.getElementById('matBatiment').value;
        const secteur = document.getElementById('matSecteur').value;
        const zone = document.getElementById('matZone').value;
        const type = document.getElementById('matType').value;
        const numero = document.getElementById('matNumero').value;

        if (!batiment) return showToast('S√©lectionnez un b√¢timent', 'error');
        if (!secteur) return showToast('S√©lectionnez un secteur', 'error');
        if (!zone) return showToast('S√©lectionnez une zone', 'error');
        if (!type) return showToast('S√©lectionnez un type', 'error');
        if (!numero) return showToast('Entrez un num√©ro', 'error');

        // Construire le nom et la localisation
        const batimentNom = configEtablissement.batiments.find(b => b.id === batiment)?.nom || '';
        const secteurObj = configEtablissement.batiments.find(b => b.id === batiment)?.secteurs.find(s => s.id === secteur);
        const secteurNom = secteurObj?.nom || '';
        const zoneNom = zone;

        const localisation = `${batimentNom} > ${secteurNom} > ${zoneNom}`;
        const nom = document.getElementById('matNom').value || `${type} ${numero}`;

        DB.materiels.push({
            id: genId(),
            nom,
            type,
            numero,
            statut: document.getElementById('matStatut').value,
            // Localisation hi√©rarchique
            batimentId: batiment,
            batiment: batimentNom,
            secteurId: secteur,
            secteur: secteurNom,
            zone: zoneNom,
            localisation, // Format complet pour affichage
            codeQR: document.getElementById('matCodeQR').value,
            numeroSerie: document.getElementById('matNumSerie').value,
            fabricant: document.getElementById('matFabricant').value,
            delaiMaintenance: parseInt(document.getElementById('matDelai').value) || null,
            derniereMaint: document.getElementById('matDernMaint').value || null,
            prochaineMaint: document.getElementById('matProchMaint').value || null,
            description: document.getElementById('matDesc').value,
            dateCreation: new Date().toISOString(),
            creePar: currentUser ? `${currentUser.prenom} ${currentUser.nom}` : 'Syst√®me'
        });

        addMainCourante('Mat√©riel', `Cr√©ation: ${nom} (${localisation})`, currentUser?.id);
        sauvegarderVersFirebase();
        closeModal();
        showToast('Mat√©riel cr√©√©');
        navigate('materiels');
    });
}

// Fonctions pour les s√©lections en cascade
function updateSecteursMat() {
    const batimentId = document.getElementById('matBatiment').value;
    const secteurSelect = document.getElementById('matSecteur');
    const zoneSelect = document.getElementById('matZone');

    secteurSelect.innerHTML = '<option value="">Choisir...</option>';
    zoneSelect.innerHTML = '<option value="">Choisir...</option>';
    zoneSelect.disabled = true;

    if (!batimentId) {
        secteurSelect.disabled = true;
        return;
    }

    const batiment = configEtablissement.batiments.find(b => b.id === batimentId);
    if (batiment) {
        batiment.secteurs.forEach(s => {
            secteurSelect.innerHTML += `<option value="${s.id}">${s.nom}</option>`;
        });
        secteurSelect.disabled = false;
    }
    genererNomMateriel();
}

function updateZonesMat() {
    const batimentId = document.getElementById('matBatiment').value;
    const secteurId = document.getElementById('matSecteur').value;
    const zoneSelect = document.getElementById('matZone');

    zoneSelect.innerHTML = '<option value="">Choisir...</option>';

    if (!secteurId) {
        zoneSelect.disabled = true;
        return;
    }

    const batiment = configEtablissement.batiments.find(b => b.id === batimentId);
    const secteur = batiment?.secteurs.find(s => s.id === secteurId);

    if (secteur) {
        secteur.zones.forEach(z => {
            zoneSelect.innerHTML += `<option value="${z}">${z}</option>`;
        });
        zoneSelect.disabled = false;
    }
    genererNomMateriel();
}

function genererNomMateriel() {
    const type = document.getElementById('matType')?.value || '';
    const numero = document.getElementById('matNumero')?.value || '';
    const zone = document.getElementById('matZone')?.value || '';

    if (type && numero) {
        const nomGenere = `${type} ${numero}${zone ? ' - ' + zone : ''}`;
        document.getElementById('matNom').value = nomGenere;
    }
}

// Fonctions pour les s√©lections en cascade (modal Modification)
function updateSecteursMatEdit() {
    const batimentId = document.getElementById('editMatBatiment').value;
    const secteurSelect = document.getElementById('editMatSecteur');
    const zoneSelect = document.getElementById('editMatZone');

    secteurSelect.innerHTML = '<option value="">Choisir...</option>';
    zoneSelect.innerHTML = '<option value="">Choisir...</option>';
    zoneSelect.disabled = true;

    if (!batimentId) {
        secteurSelect.disabled = true;
        return;
    }

    const batiment = configEtablissement.batiments.find(b => b.id === batimentId);
    if (batiment) {
        batiment.secteurs.forEach(s => {
            secteurSelect.innerHTML += `<option value="${s.id}">${s.nom}</option>`;
        });
        secteurSelect.disabled = false;
    }
}

function updateZonesMatEdit() {
    const batimentId = document.getElementById('editMatBatiment').value;
    const secteurId = document.getElementById('editMatSecteur').value;
    const zoneSelect = document.getElementById('editMatZone');

    zoneSelect.innerHTML = '<option value="">Choisir...</option>';

    if (!secteurId) {
        zoneSelect.disabled = true;
        return;
    }

    const batiment = configEtablissement.batiments.find(b => b.id === batimentId);
    const secteur = batiment?.secteurs.find(s => s.id === secteurId);

    if (secteur) {
        secteur.zones.forEach(z => {
            zoneSelect.innerHTML += `<option value="${z}">${z}</option>`;
        });
        zoneSelect.disabled = false;
    }
}

function genQR(id) {
    const m = DB.materiels.find(x => x.id === id);
    showModal('QR Code', `<div class="text-center"><div id="qrBox" class="inline-block mb-4"></div><p class="font-medium">${m.nom}</p><p class="text-sm text-gray-500">${m.localisation}</p></div>`, null, 'Fermer');
    setTimeout(() => { if (typeof QRCode !== 'undefined') new QRCode(document.getElementById('qrBox'), { text: `MATERIEL:${m.id}`, width: 180, height: 180 }); }, 100);
}

// Calculer automatiquement la prochaine maintenance (Modal Cr√©ation)
function calculerProchaineMaint() {
    const delai = parseInt(document.getElementById('matDelai')?.value) || 0;
    const dernMaint = document.getElementById('matDernMaint')?.value;
    const prochMaintInput = document.getElementById('matProchMaint');

    if (!prochMaintInput) return;

    if (delai && dernMaint) {
        const dateMaint = new Date(dernMaint);
        dateMaint.setMonth(dateMaint.getMonth() + delai);
        prochMaintInput.value = dateMaint.toISOString().split('T')[0];
    } else {
        prochMaintInput.value = '';
    }
}

// Calculer automatiquement la prochaine maintenance (Modal Modification)
function calculerProchaineMaintEdit() {
    const delai = parseInt(document.getElementById('editMatDelai')?.value) || 0;
    const dernMaint = document.getElementById('editMatDernMaint')?.value;
    const prochMaintInput = document.getElementById('editMatProchMaint');

    if (!prochMaintInput) return;

    if (delai && dernMaint) {
        const dateMaint = new Date(dernMaint);
        dateMaint.setMonth(dateMaint.getMonth() + delai);
        prochMaintInput.value = dateMaint.toISOString().split('T')[0];
    } else {
        prochMaintInput.value = '';
    }
}

// V√©rifier les maintenances √† venir (J-30) et cr√©er des consignes automatiquement
function verifierMaintenances() {
    const aujourd_hui = new Date();
    const dans30jours = new Date(aujourd_hui);
    dans30jours.setDate(dans30jours.getDate() + 30);

    const materielsConcernes = DB.materiels.filter(m => {
        if (!m.prochaineMaint) return false;
        const dateMaint = new Date(m.prochaineMaint);
        // V√©rifier si la maintenance est dans les 30 prochains jours
        return dateMaint >= aujourd_hui && dateMaint <= dans30jours;
    });

    materielsConcernes.forEach(m => {
        // V√©rifier si une consigne de maintenance existe d√©j√† pour ce mat√©riel
        const consigneExistante = DB.consignes.find(c =>
            c.materielId === m.id &&
            c.typeMaintenance === true &&
            c.active === true
        );

        if (!consigneExistante) {
            const joursRestants = Math.ceil((new Date(m.prochaineMaint) - aujourd_hui) / (1000 * 60 * 60 * 24));

            const nouvelleConsigne = {
                id: genId(),
                titre: `üîß Maintenance √† pr√©voir: ${m.nom}`,
                niveau: 'Particuli√®re',
                destinataire: 'SSIAP 3',
                priorite: joursRestants <= 7 ? 'Haute' : 'Moyenne',
                contenu: `üìÖ MAINTENANCE PROGRAMM√âE\n\nMat√©riel: ${m.nom}\nType: ${m.type}\nLocalisation: ${m.localisation || '-'}\n\nDate de prochaine maintenance: ${formatDate(m.prochaineMaint)}\nJours restants: ${joursRestants}\n\n‚ö†Ô∏è Veuillez pr√©voir la maintenance de ce mat√©riel.`,
                dateDebut: new Date().toISOString().split('T')[0],
                dateFin: m.prochaineMaint,
                active: true,
                materielId: m.id,
                typeMaintenance: true,
                creePar: 'Syst√®me (Automatique)',
                dateCreation: new Date().toISOString()
            };

            DB.consignes.push(nouvelleConsigne);
            addMainCourante('Consigne', `Cr√©ation automatique: Rappel maintenance ${m.nom} (J-${joursRestants})`, null);
        }
    });

    // D√©sactiver les consignes de maintenance d√©pass√©es
    DB.consignes.forEach(c => {
        if (c.typeMaintenance && c.active && c.dateFin) {
            const dateFin = new Date(c.dateFin);
            if (dateFin < aujourd_hui) {
                c.active = false;
            }
        }
    });
}

function editMat(id) {
    const m = DB.materiels.find(x => x.id === id);
    if (!m) return;

    const isSsiap3 = currentUser?.qualification === 'SSIAP 3';
    const isSsiap2 = currentUser?.qualification === 'SSIAP 2';

    // SSIAP 2 : formulaire simplifi√© (statut + derni√®re maintenance seulement)
    if (isSsiap2) {
        const sClass = { 'Op√©rationnel': 'success', 'D√©faillant': 'warning', 'En Maintenance': 'info', 'Hors Service': 'danger' }[m.statut] || 'secondary';

        showModal('Mise √† jour Mat√©riel', `
            <div class="space-y-4">
                <!-- Infos mat√©riel (lecture seule) -->
                <div class="flex items-center gap-4 p-4 bg-gray-50 dark:bg-slate-700 rounded-xl">
                    <div id="editMatQRCode" class="flex-shrink-0"></div>
                    <div class="flex-1">
                        <div class="font-bold text-lg text-gray-800 dark:text-white">${m.nom}</div>
                        <div class="text-sm text-gray-500">${m.type}</div>
                        <div class="text-xs text-gray-400 mt-1">${m.localisation || '-'}</div>
                    </div>
                </div>

                <div class="bg-yellow-50 dark:bg-yellow-900/30 p-3 rounded-lg text-sm text-yellow-700 dark:text-yellow-300">
                    <i class="fas fa-info-circle mr-1"></i> En tant que SSIAP 2, vous pouvez modifier le statut et la date de maintenance uniquement.
                </div>

                <!-- Champs modifiables pour SSIAP 2 -->
                <div>
                    <label class="block text-sm font-semibold mb-2"><i class="fas fa-traffic-light mr-1"></i>Statut *</label>
                    <select id="editMatStatut" class="input">
                        ${statutsMat.map(s => `<option ${m.statut === s ? 'selected' : ''}>${s}</option>`).join('')}
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-2"><i class="fas fa-wrench mr-1"></i>Derni√®re maintenance</label>
                    <input type="date" id="editMatDernMaint" class="input" value="${m.derniereMaint || ''}">
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-2"><i class="fas fa-comment mr-1"></i>Observation / Note</label>
                    <textarea id="editMatObs" class="input" rows="3" placeholder="Note sur l'√©tat actuel du mat√©riel...">${m.observation || ''}</textarea>
                </div>
            </div>
        `, () => {
            const ancienStatut = m.statut;
            const nouveauStatut = document.getElementById('editMatStatut').value;
            const nouvelleMaint = document.getElementById('editMatDernMaint').value;
            const observation = document.getElementById('editMatObs').value;

            m.statut = nouveauStatut;
            m.derniereMaint = nouvelleMaint || null;
            // Recalculer la prochaine maintenance si d√©lai d√©fini
            if (nouvelleMaint && m.delaiMaintenance) {
                const dateMaint = new Date(nouvelleMaint);
                dateMaint.setMonth(dateMaint.getMonth() + m.delaiMaintenance);
                m.prochaineMaint = dateMaint.toISOString().split('T')[0];
            }
            m.observation = observation;
            m.dateModification = new Date().toISOString();
            m.modifiePar = currentUser ? `${currentUser.prenom} ${currentUser.nom}` : 'Syst√®me';

            // Cr√©ation automatique d'une consigne particuli√®re si mise Hors Service
            if (nouveauStatut === 'Hors Service' && ancienStatut !== 'Hors Service') {
                const nouvelleConsigne = {
                    id: genId(),
                    titre: `${m.nom} - HORS SERVICE`,
                    niveau: 'Particuli√®re',
                    destinataire: 'Tout le monde',
                    priorite: 'Haute',
                    contenu: `‚ö†Ô∏è MAT√âRIEL HORS SERVICE\n\nType: ${m.type}\nLocalisation: ${m.localisation}\n\n${observation ? 'Observations:\n' + observation : 'Aucune observation'}\n\nMis hors service le ${new Date().toLocaleDateString('fr-FR')} par ${currentUser ? currentUser.prenom + ' ' + currentUser.nom : 'Syst√®me'}`,
                    dateDebut: new Date().toISOString().split('T')[0],
                    dateFin: null,
                    active: true,
                    materielId: m.id,
                    creePar: currentUser ? `${currentUser.prenom} ${currentUser.nom}` : 'Syst√®me',
                    dateCreation: new Date().toISOString()
                };
                DB.consignes.push(nouvelleConsigne);
                addMainCourante('Consigne', `Cr√©ation automatique: ${nouvelleConsigne.titre} (Mat√©riel HS)`, currentUser?.id);
                showToast('‚ö†Ô∏è Consigne particuli√®re cr√©√©e automatiquement', 'warning');
            }

            addMainCourante('Mat√©riel', `Mise √† jour: ${m.nom} - Statut: ${nouveauStatut}`, currentUser?.id);
            sauvegarderVersFirebase();
            closeModal();
            showToast('Mat√©riel mis √† jour');
            navigate('materiels');
        });

        // G√©n√©rer le QR Code
        setTimeout(() => {
            const qrDiv = document.getElementById('editMatQRCode');
            if (qrDiv && typeof QRCode !== 'undefined') {
                new QRCode(qrDiv, { text: m.codeQR || `MATERIEL:${m.id}`, width: 80, height: 80 });
            }
        }, 100);
        return;
    }

    // SSIAP 3 : formulaire complet
    // Pr√©parer les options de b√¢timents
    const batimentsOptions = configEtablissement.batiments.map(b =>
        `<option value="${b.id}" ${m.batimentId === b.id ? 'selected' : ''}>${b.nom}</option>`
    ).join('');

    // Trouver le b√¢timent actuel pour les secteurs
    const batimentActuel = configEtablissement.batiments.find(b => b.id === m.batimentId);
    const secteursOptions = batimentActuel ? batimentActuel.secteurs.map(s =>
        `<option value="${s.id}" ${m.secteurId === s.id ? 'selected' : ''}>${s.nom}</option>`
    ).join('') : '';

    // Trouver le secteur actuel pour les zones
    const secteurActuel = batimentActuel?.secteurs.find(s => s.id === m.secteurId);
    const zonesOptions = secteurActuel ? secteurActuel.zones.map(z =>
        `<option value="${z}" ${m.zone === z ? 'selected' : ''}>${z}</option>`
    ).join('') : '';

    const delaiOptions = [
        { value: '', label: 'Non d√©fini' },
        { value: '1', label: '1 mois' },
        { value: '3', label: '3 mois' },
        { value: '6', label: '6 mois' },
        { value: '12', label: '12 mois' }
    ];

    showModal('Modifier Mat√©riel', `
        <div class="space-y-4">
            <!-- QR Code du mat√©riel -->
            <div class="flex items-center gap-4 p-4 bg-gray-50 dark:bg-slate-700 rounded-xl">
                <div id="editMatQRCode" class="flex-shrink-0"></div>
                <div>
                    <div class="font-bold text-lg text-gray-800 dark:text-white">${m.nom}</div>
                    <div class="text-sm text-gray-500">${m.type}</div>
                    <div class="text-xs text-gray-400 font-mono mt-1">${m.codeQR || 'Aucun code QR'}</div>
                </div>
            </div>

            <div><label class="block text-sm font-semibold mb-2">Nom du mat√©riel *</label><input type="text" id="editMatNom" class="input" value="${m.nom}"></div>

            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-sm font-semibold mb-2">Type *</label><select id="editMatType" class="input">${typesMat.map(t => `<option ${m.type === t ? 'selected' : ''}>${t}</option>`).join('')}</select></div>
                <div><label class="block text-sm font-semibold mb-2">Statut *</label><select id="editMatStatut" class="input">${statutsMat.map(s => `<option ${m.statut === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div>
            </div>

            <!-- Localisation hi√©rarchique -->
            <div class="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-xl">
                <h3 class="font-semibold text-blue-800 dark:text-blue-300 mb-3"><i class="fas fa-map-marker-alt mr-2"></i>Localisation</h3>
                <div class="grid grid-cols-3 gap-3">
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">B√¢timent *</label>
                        <select id="editMatBatiment" class="input" onchange="updateSecteursMatEdit()">
                            <option value="">Choisir...</option>
                            ${batimentsOptions}
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">Secteur *</label>
                        <select id="editMatSecteur" class="input" onchange="updateZonesMatEdit()" ${!m.batimentId ? 'disabled' : ''}>
                            <option value="">Choisir...</option>
                            ${secteursOptions}
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">Zone *</label>
                        <select id="editMatZone" class="input" ${!m.secteurId ? 'disabled' : ''}>
                            <option value="">Choisir...</option>
                            ${zonesOptions}
                        </select>
                    </div>
                </div>
            </div>

            <div><label class="block text-sm font-semibold mb-2">Code QR</label><input type="text" id="editMatCodeQR" class="input bg-gray-100 dark:bg-slate-600" value="${m.codeQR || ''}" readonly></div>

            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-sm font-semibold mb-2">Num√©ro de s√©rie</label><input type="text" id="editMatNumSerie" class="input" value="${m.numeroSerie || ''}"></div>
                <div><label class="block text-sm font-semibold mb-2">Fabricant</label><input type="text" id="editMatFabricant" class="input" value="${m.fabricant || ''}"></div>
            </div>

            <!-- Maintenance avec d√©lai -->
            <div class="bg-green-50 dark:bg-green-900/30 p-4 rounded-xl">
                <h3 class="font-semibold text-green-800 dark:text-green-300 mb-3"><i class="fas fa-wrench mr-2"></i>Maintenance</h3>
                <div class="grid grid-cols-3 gap-3">
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">D√©lai de maintenance</label>
                        <select id="editMatDelai" class="input" onchange="calculerProchaineMaintEdit()">
                            ${delaiOptions.map(d => `<option value="${d.value}" ${m.delaiMaintenance == d.value ? 'selected' : ''}>${d.label}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">Derni√®re maintenance</label>
                        <input type="date" id="editMatDernMaint" class="input" value="${m.derniereMaint || ''}" onchange="calculerProchaineMaintEdit()">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">Prochaine maintenance</label>
                        <input type="date" id="editMatProchMaint" class="input bg-gray-100 dark:bg-slate-600" value="${m.prochaineMaint || ''}" readonly>
                    </div>
                </div>
            </div>

            <div><label class="block text-sm font-semibold mb-2">Description</label><textarea id="editMatDesc" class="input" rows="2">${m.description || ''}</textarea></div>

            <div><label class="block text-sm font-semibold mb-2">Observation / Note</label><textarea id="editMatObs" class="input" rows="2" placeholder="Note sur l'√©tat actuel du mat√©riel...">${m.observation || ''}</textarea></div>
        </div>
    `, () => {
        const nom = document.getElementById('editMatNom').value;
        const batimentId = document.getElementById('editMatBatiment').value;
        const secteurId = document.getElementById('editMatSecteur').value;
        const zone = document.getElementById('editMatZone').value;

        if (!nom) return showToast('Entrez un nom', 'error');
        if (!batimentId) return showToast('S√©lectionnez un b√¢timent', 'error');
        if (!secteurId) return showToast('S√©lectionnez un secteur', 'error');
        if (!zone) return showToast('S√©lectionnez une zone', 'error');

        // Construire la localisation compl√®te
        const batiment = configEtablissement.batiments.find(b => b.id === batimentId);
        const secteur = batiment?.secteurs.find(s => s.id === secteurId);
        const batimentNom = batiment?.nom || '';
        const secteurNom = secteur?.nom || '';
        const localisation = `${batimentNom} > ${secteurNom} > ${zone}`;

        const ancienStatut = m.statut;
        const nouveauStatut = document.getElementById('editMatStatut').value;
        const observation = document.getElementById('editMatObs').value;

        m.nom = nom;
        m.type = document.getElementById('editMatType').value;
        m.statut = nouveauStatut;
        // Mise √† jour localisation hi√©rarchique
        m.batimentId = batimentId;
        m.batiment = batimentNom;
        m.secteurId = secteurId;
        m.secteur = secteurNom;
        m.zone = zone;
        m.localisation = localisation;
        m.numeroSerie = document.getElementById('editMatNumSerie').value;
        m.fabricant = document.getElementById('editMatFabricant').value;
        m.delaiMaintenance = parseInt(document.getElementById('editMatDelai').value) || null;
        m.derniereMaint = document.getElementById('editMatDernMaint').value || null;
        m.prochaineMaint = document.getElementById('editMatProchMaint').value || null;
        m.description = document.getElementById('editMatDesc').value;
        m.observation = observation;
        m.dateModification = new Date().toISOString();
        m.modifiePar = currentUser ? `${currentUser.prenom} ${currentUser.nom}` : 'Syst√®me';

        // Cr√©ation automatique d'une consigne particuli√®re si mise Hors Service
        if (nouveauStatut === 'Hors Service' && ancienStatut !== 'Hors Service') {
            const nouvelleConsigne = {
                id: genId(),
                titre: `${m.nom} - HORS SERVICE`,
                niveau: 'Particuli√®re',
                destinataire: 'Tout le monde',
                priorite: 'Haute',
                contenu: `‚ö†Ô∏è MAT√âRIEL HORS SERVICE\n\nType: ${m.type}\nLocalisation: ${m.localisation}\n\n${observation ? 'Observations:\n' + observation : 'Aucune observation'}\n\nMis hors service le ${new Date().toLocaleDateString('fr-FR')} par ${currentUser ? currentUser.prenom + ' ' + currentUser.nom : 'Syst√®me'}`,
                dateDebut: new Date().toISOString().split('T')[0],
                dateFin: null,
                active: true,
                materielId: m.id,
                creePar: currentUser ? `${currentUser.prenom} ${currentUser.nom}` : 'Syst√®me',
                dateCreation: new Date().toISOString()
            };
            DB.consignes.push(nouvelleConsigne);
            addMainCourante('Consigne', `Cr√©ation automatique: ${nouvelleConsigne.titre} (Mat√©riel HS)`, currentUser?.id);
            showToast('‚ö†Ô∏è Consigne particuli√®re cr√©√©e automatiquement', 'warning');
        }

        addMainCourante('Mat√©riel', `Modification: ${m.nom} (${m.type}) - Statut: ${nouveauStatut}`, currentUser?.id);
        sauvegarderVersFirebase();
        closeModal();
        showToast('Mat√©riel modifi√©');
        navigate('materiels');
    });

    // G√©n√©rer le QR Code apr√®s l'affichage du modal
    setTimeout(() => {
        const qrDiv = document.getElementById('editMatQRCode');
        if (qrDiv && typeof QRCode !== 'undefined') {
            new QRCode(qrDiv, {
                text: m.codeQR || `MATERIEL:${m.id}`,
                width: 80,
                height: 80
            });
        }
    }, 100);
}

function voirMateriel(id) {
    const m = DB.materiels.find(x => x.id === id);
    if (!m) return;

    const sClass = { 'Op√©rationnel': 'success', 'D√©faillant': 'warning', 'En Maintenance': 'info', 'Hors Service': 'danger' }[m.statut] || 'secondary';

    showModal(`Fiche Mat√©riel`, `
        <div class="space-y-4">
            <div class="flex items-center justify-between">
                <h3 class="text-xl font-bold text-gray-800 dark:text-white">${m.nom}</h3>
                <span class="badge badge-${sClass} text-sm">${m.statut}</span>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="bg-gray-50 dark:bg-slate-700 p-3 rounded-lg">
                    <div class="text-xs text-gray-500 uppercase mb-1">Type</div>
                    <div class="font-medium">${m.type}</div>
                </div>
                <div class="bg-gray-50 dark:bg-slate-700 p-3 rounded-lg">
                    <div class="text-xs text-gray-500 uppercase mb-1">Localisation</div>
                    <div class="font-medium">${m.localisation || '-'}</div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="bg-gray-50 dark:bg-slate-700 p-3 rounded-lg">
                    <div class="text-xs text-gray-500 uppercase mb-1">Code QR</div>
                    <div class="font-medium font-mono text-sm">${m.codeQR || '-'}</div>
                </div>
                <div class="bg-gray-50 dark:bg-slate-700 p-3 rounded-lg">
                    <div class="text-xs text-gray-500 uppercase mb-1">N¬∞ de s√©rie</div>
                    <div class="font-medium">${m.numeroSerie || '-'}</div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="bg-gray-50 dark:bg-slate-700 p-3 rounded-lg">
                    <div class="text-xs text-gray-500 uppercase mb-1">Fabricant</div>
                    <div class="font-medium">${m.fabricant || '-'}</div>
                </div>
                <div class="bg-gray-50 dark:bg-slate-700 p-3 rounded-lg">
                    <div class="text-xs text-gray-500 uppercase mb-1">Date cr√©ation</div>
                    <div class="font-medium">${m.dateCreation ? formatDate(m.dateCreation) : '-'}</div>
                </div>
            </div>

            <!-- Section Maintenance -->
            <div class="bg-green-50 dark:bg-green-900/30 p-4 rounded-xl">
                <h4 class="font-semibold text-green-800 dark:text-green-300 mb-3"><i class="fas fa-wrench mr-2"></i>Maintenance</h4>
                <div class="grid grid-cols-3 gap-3">
                    <div class="bg-white dark:bg-slate-700 p-3 rounded-lg">
                        <div class="text-xs text-gray-500 uppercase mb-1">D√©lai</div>
                        <div class="font-medium">${m.delaiMaintenance ? m.delaiMaintenance + ' mois' : 'Non d√©fini'}</div>
                    </div>
                    <div class="bg-white dark:bg-slate-700 p-3 rounded-lg">
                        <div class="text-xs text-green-600 uppercase mb-1">Derni√®re</div>
                        <div class="font-medium text-green-700 dark:text-green-400">${m.derniereMaint ? formatDate(m.derniereMaint) : '-'}</div>
                    </div>
                    <div class="bg-white dark:bg-slate-700 p-3 rounded-lg">
                        <div class="text-xs text-orange-600 uppercase mb-1">Prochaine</div>
                        <div class="font-medium text-orange-700 dark:text-orange-400">${m.prochaineMaint ? formatDate(m.prochaineMaint) : '-'}</div>
                    </div>
                </div>
                ${m.prochaineMaint ? (() => {
                    const joursRestants = Math.ceil((new Date(m.prochaineMaint) - new Date()) / (1000 * 60 * 60 * 24));
                    if (joursRestants <= 0) {
                        return '<div class="mt-2 text-sm text-red-600 dark:text-red-400 font-semibold"><i class="fas fa-exclamation-triangle mr-1"></i>Maintenance en retard !</div>';
                    } else if (joursRestants <= 7) {
                        return '<div class="mt-2 text-sm text-red-600 dark:text-red-400"><i class="fas fa-clock mr-1"></i>Maintenance dans ' + joursRestants + ' jour(s)</div>';
                    } else if (joursRestants <= 30) {
                        return '<div class="mt-2 text-sm text-orange-600 dark:text-orange-400"><i class="fas fa-clock mr-1"></i>Maintenance dans ' + joursRestants + ' jours</div>';
                    }
                    return '';
                })() : ''}
            </div>

            ${m.description ? `
                <div class="bg-gray-50 dark:bg-slate-700 p-3 rounded-lg">
                    <div class="text-xs text-gray-500 uppercase mb-1">Description</div>
                    <div class="text-sm">${m.description}</div>
                </div>
            ` : ''}

            ${m.observation ? `
                <div class="bg-yellow-50 dark:bg-yellow-900/30 p-3 rounded-lg">
                    <div class="text-xs text-yellow-600 uppercase mb-1">Observation</div>
                    <div class="text-sm">${m.observation}</div>
                </div>
            ` : ''}

            ${m.creePar ? `<div class="text-xs text-gray-400 text-right">Cr√©√© par: ${m.creePar}</div>` : ''}
        </div>
    `, null, 'Fermer');
}

function supprimerMateriel(id) {
    const m = DB.materiels.find(x => x.id === id);
    if (!m) return;

    showConfirm(`√ätes-vous s√ªr de vouloir supprimer "${m.nom}" ?`, () => {
        // Enregistrer l'horodatage et qui a supprim√©
        const dateSuppression = new Date().toISOString();
        const supprimePar = currentUser ? `${currentUser.prenom} ${currentUser.nom}` : 'Inconnu';

        // Ajouter √† la main courante
        addMainCourante('Mat√©riel', `üóëÔ∏è Suppression: ${m.nom} (${m.type}) - ${m.localisation}`, currentUser?.id);

        // Supprimer le mat√©riel
        const index = DB.materiels.findIndex(x => x.id === id);
        if (index > -1) {
            DB.materiels.splice(index, 1);
        }

        sauvegarderVersFirebase();
        showToast('Mat√©riel supprim√©');
        navigate('materiels');
    });
}

function imprimerQRCodes() {
    // Appliquer les m√™mes filtres que l'affichage
    const materielsFiltres = DB.materiels.filter(m => {
        const matchRecherche = !filtreMatRecherche ||
            m.nom.toLowerCase().includes(filtreMatRecherche.toLowerCase()) ||
            (m.localisation && m.localisation.toLowerCase().includes(filtreMatRecherche.toLowerCase())) ||
            (m.codeQR && m.codeQR.toLowerCase().includes(filtreMatRecherche.toLowerCase()));
        const matchType = !filtreMatType || m.type === filtreMatType;
        const matchStatut = !filtreMatStatut || m.statut === filtreMatStatut;
        const matchLoc = !filtreMatLocalisation || m.localisation === filtreMatLocalisation;
        return matchRecherche && matchType && matchStatut && matchLoc;
    });

    if (materielsFiltres.length === 0) {
        showToast('Aucun mat√©riel √† imprimer avec les filtres actuels', 'error');
        return;
    }

    // Construire le titre avec les filtres appliqu√©s
    let filtresAppliques = [];
    if (filtreMatType) filtresAppliques.push('Type: ' + filtreMatType);
    if (filtreMatStatut) filtresAppliques.push('Statut: ' + filtreMatStatut);
    if (filtreMatLocalisation) filtresAppliques.push('Localisation: ' + filtreMatLocalisation);
    if (filtreMatRecherche) filtresAppliques.push('Recherche: "' + filtreMatRecherche + '"');
    const sousTitre = filtresAppliques.length > 0 ? '<p style="text-align: center; color: #666; margin-bottom: 20px;">Filtres: ' + filtresAppliques.join(' | ') + '</p>' : '';

    const materielsHTML = materielsFiltres.map(m =>
        '<div class="qr-card">' +
            '<div class="qr-code" id="qr-' + m.id + '"></div>' +
            '<div style="font-weight: bold; margin: 10px 0;">' + m.nom + '</div>' +
            '<div style="font-size: 12px; color: #666;">' + m.type + '</div>' +
            '<div style="font-size: 12px; color: #666;">' + m.localisation + '</div>' +
            '<div style="font-size: 11px; color: #999; margin-top: 5px;">' + (m.statut || '') + '</div>' +
        '</div>'
    ).join('');

    const qrCodeScripts = materielsFiltres.map(m =>
        'new QRCode(document.getElementById(\'qr-' + m.id + '\'), { text: \'' + (m.codeQR || 'MATERIEL:' + m.id) + '\', width: 150, height: 150 });'
    ).join('\n');

    const content = '<!DOCTYPE html><html><head><meta charset="UTF-8">' +
        '<title>QR Codes Mat√©riels</title>' +
        '<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"><\/script>' +
        '<style>' +
        'body { font-family: Arial, sans-serif; padding: 20px; }' +
        '.qr-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }' +
        '.qr-card { padding: 15px; border: 2px solid #333; border-radius: 8px; text-align: center; page-break-inside: avoid; }' +
        '.qr-code { margin: 10px 0; }' +
        'h1 { text-align: center; }' +
        '.info { text-align: center; margin-bottom: 20px; color: #333; }' +
        '@media print { .no-print { display: none; } }' +
        '<\/style><\/head><body>' +
        '<h1>QR Codes - Mat√©riels de S√©curit√©<\/h1>' +
        sousTitre +
        '<p class="info">' + materielsFiltres.length + ' mat√©riel(s) - Imprim√© le ' + new Date().toLocaleDateString('fr-FR') + '<\/p>' +
        '<button class="no-print" onclick="window.print()" style="margin: 20px auto; display: block; padding: 10px 20px; background: #6366f1; color: white; border: none; border-radius: 8px; cursor: pointer;">Imprimer<\/button>' +
        '<div class="qr-grid">' + materielsHTML + '<\/div>' +
        '<script>' + qrCodeScripts + '<\/script>' +
        '<\/body><\/html>';

    const win = window.open('', '_blank');
    win.document.write(content);
    win.document.close();
}

// ========== CONSIGNES ==========
const niveauxConsigne = ['Courante', 'Particuli√®re'];
const destinataires = ['Tout le monde', 'Chef de poste', 'Chef de service'];
const priorites = ['Basse', 'Normale', 'Haute', 'Urgente'];

function renderConsignes() {
    const filteredConsignes = DB.consignes.filter(c => {
        if (c.destinataire === 'Tout le monde') return true;
        if (c.destinataire === 'Chef de poste' && currentUser?.qualification !== 'SSIAP 1') return true;
        if (c.destinataire === 'Chef de service' && currentUser?.qualification === 'SSIAP 3') return true;
        return false;
    });

    const isSsiap1 = currentUser?.qualification === 'SSIAP 1';

    return `
        <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
            <h1 class="text-2xl font-bold text-gray-800 dark:text-white"><i class="fas fa-file-alt mr-2 text-primary-500"></i>Consignes</h1>
            ${!isSsiap1 ? `<button onclick="showModalConsigne()" class="btn btn-primary"><i class="fas fa-plus"></i> Nouvelle consigne</button>` : ''}
        </div>

        <div class="grid lg:grid-cols-2 gap-6">
            <div class="card">
                <div class="gradient-warning text-white p-4 font-semibold">Consignes Particuli√®res</div>
                <div class="p-4 space-y-3">
                    ${filteredConsignes.filter(c => c.niveau === 'Particuli√®re').map(c => renderConsigneCard(c, isSsiap1)).join('') || '<p class="text-gray-500 text-center py-4">Aucune consigne particuli√®re</p>'}
                </div>
            </div>

            <div class="card">
                <div class="gradient-info text-white p-4 font-semibold">Consignes Courantes</div>
                <div class="p-4 space-y-3">
                    ${filteredConsignes.filter(c => c.niveau === 'Courante').map(c => renderConsigneCard(c, isSsiap1)).join('') || '<p class="text-gray-500 text-center py-4">Aucune consigne courante</p>'}
                </div>
            </div>
        </div>
    `;
}

function renderConsigneCard(c, readOnly) {
    return `
        <div class="p-4 bg-gray-50 dark:bg-slate-700 rounded-xl">
            <div class="flex flex-wrap items-center gap-2 mb-2">
                <span class="badge badge-${c.priorite === 'Haute' || c.priorite === 'Urgente' ? 'danger' : c.priorite === 'Normale' ? 'info' : 'success'}">${c.priorite}</span>
                <span class="badge badge-purple">${c.destinataire}</span>
                <span class="badge ${c.active ? 'badge-success' : 'badge-warning'}">${c.active ? 'Active' : 'Inactive'}</span>
            </div>
            <div class="font-semibold text-gray-800 dark:text-white">${c.titre}</div>
            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">${c.contenu}</p>
            <div class="text-xs text-gray-500 mt-2">
                Du ${formatDate(c.dateDebut)} ${c.dateFin ? 'au ' + formatDate(c.dateFin) : '(sans fin)'}
            </div>
            ${!readOnly ? `
                <div class="flex gap-2 mt-3">
                    <button onclick="toggleConsigne(${c.id})" class="btn btn-sm ${c.active ? 'btn-warning' : 'btn-success'}">
                        <i class="fas ${c.active ? 'fa-pause' : 'fa-play'}"></i> ${c.active ? 'D√©sactiver' : 'Activer'}
                    </button>
                </div>
            ` : ''}
        </div>
    `;
}

function showModalConsigne() {
    showModal('Nouvelle Consigne', `
        <div class="space-y-4">
            <div><label class="block text-sm font-semibold mb-2">Titre</label><input type="text" id="consTitre" class="input"></div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-semibold mb-2">Niveau</label>
                    <select id="consNiveau" class="input">${niveauxConsigne.map(n => `<option>${n}</option>`).join('')}</select>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Priorit√©</label>
                    <select id="consPrio" class="input">${priorites.map(p => `<option ${p === 'Normale' ? 'selected' : ''}>${p}</option>`).join('')}</select>
                </div>
            </div>
            <div>
                <label class="block text-sm font-semibold mb-2">Destinataire</label>
                <select id="consDest" class="input">${destinataires.map(d => `<option>${d}</option>`).join('')}</select>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-sm font-semibold mb-2">Date d√©but</label><input type="date" id="consDebut" class="input" value="${new Date().toISOString().split('T')[0]}"></div>
                <div><label class="block text-sm font-semibold mb-2">Date fin (optionnel)</label><input type="date" id="consFin" class="input"></div>
            </div>
            <div><label class="block text-sm font-semibold mb-2">Contenu</label><textarea id="consContenu" class="input" rows="4"></textarea></div>
        </div>
    `, () => {
        const titre = document.getElementById('consTitre').value;
        if (!titre) return showToast('Entrez un titre', 'error');
        const contenu = document.getElementById('consContenu').value;
        if (!contenu) return showToast('Entrez le contenu', 'error');

        DB.consignes.push({
            id: genId(),
            titre,
            niveau: document.getElementById('consNiveau').value,
            priorite: document.getElementById('consPrio').value,
            destinataire: document.getElementById('consDest').value,
            contenu,
            dateDebut: document.getElementById('consDebut').value,
            dateFin: document.getElementById('consFin').value || null,
            active: true
        });
        closeModal();
        showToast('Consigne cr√©√©e');
        navigate('consignes');
    });
}

function toggleConsigne(id) {
    const c = DB.consignes.find(x => x.id === id);
    c.active = !c.active;
    showToast(`Consigne ${c.active ? 'activ√©e' : 'd√©sactiv√©e'}`);
    navigate('consignes');
}

// ========== AGENTS ==========
function renderAgents() {
    return `
        <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
            <h1 class="text-2xl font-bold text-gray-800 dark:text-white"><i class="fas fa-users mr-2 text-primary-500"></i>Agents</h1>
            <button onclick="showModalAgent()" class="btn btn-primary"><i class="fas fa-plus"></i> Nouvel agent</button>
        </div>
        <div class="card">
            <div class="overflow-x-auto">
                <table class="table">
                    <thead><tr><th>Agent</th><th>Qualification</th><th>Entreprise</th><th>Statut</th><th>Actions</th></tr></thead>
                    <tbody>
                        ${DB.agents.map(a => `
                            <tr>
                                <td>
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-xl gradient-header flex items-center justify-center text-white font-semibold">${a.prenom[0]}${a.nom[0]}</div>
                                        <div class="font-medium">${a.prenom} ${a.nom}</div>
                                    </div>
                                </td>
                                <td><span class="badge badge-info">${a.qualification}</span></td>
                                <td>${a.entreprise}</td>
                                <td><span class="badge ${a.actif ? 'badge-success' : 'badge-danger'}">${a.actif ? 'Actif' : 'Inactif'}</span></td>
                                <td>
                                    <button onclick="voirAgent(${a.id})" class="btn btn-icon btn-secondary btn-sm" title="Voir la fiche">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

function voirAgent(id) {
    const a = DB.agents.find(x => x.id === id);
    if (!a) return;

    showModal('Fiche Agent', `
        <div class="space-y-4">
            <div class="flex items-center gap-4 mb-4">
                <div class="w-16 h-16 rounded-xl gradient-header flex items-center justify-center text-white text-2xl font-semibold">${a.prenom[0]}${a.nom[0]}</div>
                <div>
                    <div class="text-xl font-bold text-gray-800 dark:text-white">${a.prenom} ${a.nom}</div>
                    <span class="badge badge-info">${a.qualification}</span>
                    <span class="badge ${a.actif ? 'badge-success' : 'badge-danger'} ml-2">${a.actif ? 'Actif' : 'Inactif'}</span>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-sm font-semibold mb-2">Pr√©nom</label><input type="text" id="editAgentPrenom" class="input" value="${a.prenom}"></div>
                <div><label class="block text-sm font-semibold mb-2">Nom</label><input type="text" id="editAgentNom" class="input" value="${a.nom}"></div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-semibold mb-2">Qualification</label>
                    <select id="editAgentQualif" class="input">
                        <option ${a.qualification === 'SSIAP 1' ? 'selected' : ''}>SSIAP 1</option>
                        <option ${a.qualification === 'SSIAP 2' ? 'selected' : ''}>SSIAP 2</option>
                        <option ${a.qualification === 'SSIAP 3' ? 'selected' : ''}>SSIAP 3</option>
                    </select>
                </div>
                <div><label class="block text-sm font-semibold mb-2">Entreprise</label><input type="text" id="editAgentEntr" class="input" value="${a.entreprise}"></div>
            </div>

            <div><label class="block text-sm font-semibold mb-2">Email</label><input type="email" id="editAgentEmail" class="input" value="${a.email || ''}"></div>

            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-sm font-semibold mb-2">Date dipl√¥me</label><input type="date" id="editAgentDiplome" class="input" value="${a.dateDiplome || ''}"></div>
                <div><label class="block text-sm font-semibold mb-2">Date dernier recyclage</label><input type="date" id="editAgentRecyclage" class="input" value="${a.dateRecyclage || ''}"></div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-sm font-semibold mb-2">Date d√©but contrat</label><input type="date" id="editAgentDebutContrat" class="input" value="${a.dateDebutContrat || ''}"></div>
                <div><label class="block text-sm font-semibold mb-2">Date fin contrat</label><input type="date" id="editAgentFinContrat" class="input" value="${a.dateFinContrat || ''}"></div>
            </div>

            <div class="bg-gray-50 dark:bg-slate-700 p-4 rounded-xl">
                <label class="flex items-center gap-3 cursor-pointer">
                    <input type="checkbox" id="editAgentActif" class="w-5 h-5" ${a.actif ? 'checked' : ''}>
                    <span class="text-sm font-semibold">Agent actif</span>
                </label>
                <p class="text-xs text-gray-500 mt-2">Cochez pour activer l'agent, d√©cochez pour le d√©sactiver</p>
            </div>
        </div>
    `, () => {
        const prenom = document.getElementById('editAgentPrenom').value;
        const nom = document.getElementById('editAgentNom').value;
        const email = document.getElementById('editAgentEmail').value;
        if (!prenom || !nom) return showToast('Remplissez les champs obligatoires', 'error');

        a.prenom = prenom;
        a.nom = nom;
        a.qualification = document.getElementById('editAgentQualif').value;
        a.entreprise = document.getElementById('editAgentEntr').value;
        a.email = email;
        a.dateDiplome = document.getElementById('editAgentDiplome').value || null;
        a.dateRecyclage = document.getElementById('editAgentRecyclage').value || null;
        a.dateDebutContrat = document.getElementById('editAgentDebutContrat').value || null;
        a.dateFinContrat = document.getElementById('editAgentFinContrat').value || null;

        const nouveauStatut = document.getElementById('editAgentActif').checked;

        // V√©rifier si on active un agent avec recyclage expir√©
        if (nouveauStatut && !a.actif && a.dateRecyclage) {
            const maintenant = new Date();
            const troixAnsEnMs = 3 * 365 * 24 * 60 * 60 * 1000;
            const dateRecyclage = new Date(a.dateRecyclage);
            const diff = maintenant - dateRecyclage;

            if (diff > troixAnsEnMs) {
                showToast('Attention: le recyclage de cet agent est expir√©. Mettez √† jour la date de recyclage.', 'error');
                return;
            }
        }

        a.actif = nouveauStatut;

        sauvegarderVersFirebase();
        closeModal();
        showToast('Agent modifi√©');
        navigate('agents');
        initLogin();
    }, 'Enregistrer');
}

function showModalAgent() {
    showModal('Nouvel Agent', `
        <div class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-sm font-semibold mb-2">Pr√©nom</label><input type="text" id="agentPrenom" class="input"></div>
                <div><label class="block text-sm font-semibold mb-2">Nom</label><input type="text" id="agentNom" class="input"></div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-sm font-semibold mb-2">Qualification</label><select id="agentQualif" class="input"><option>SSIAP 1</option><option>SSIAP 2</option><option>SSIAP 3</option></select></div>
                <div><label class="block text-sm font-semibold mb-2">Entreprise</label><input type="text" id="agentEntr" class="input" value="SecuriPlus"></div>
            </div>
            <div><label class="block text-sm font-semibold mb-2">Email</label><input type="email" id="agentEmail" class="input" placeholder="nom@entreprise.fr"></div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-sm font-semibold mb-2">Date dipl√¥me</label><input type="date" id="agentDiplome" class="input"></div>
                <div><label class="block text-sm font-semibold mb-2">Date dernier recyclage</label><input type="date" id="agentRecyclage" class="input"></div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-sm font-semibold mb-2">Date d√©but contrat</label><input type="date" id="agentDebutContrat" class="input"></div>
                <div><label class="block text-sm font-semibold mb-2">Date fin contrat (optionnel)</label><input type="date" id="agentFinContrat" class="input"></div>
            </div>
        </div>
    `, () => {
        const prenom = document.getElementById('agentPrenom').value;
        const nom = document.getElementById('agentNom').value;
        const email = document.getElementById('agentEmail').value;
        if (!prenom || !nom || !email) return showToast('Remplissez les champs obligatoires', 'error');

        const nouvelAgent = {
            id: genId(),
            prenom,
            nom,
            qualification: document.getElementById('agentQualif').value,
            entreprise: document.getElementById('agentEntr').value,
            email,
            dateDiplome: document.getElementById('agentDiplome').value || null,
            dateRecyclage: document.getElementById('agentRecyclage').value || null,
            dateDebutContrat: document.getElementById('agentDebutContrat').value || null,
            dateFinContrat: document.getElementById('agentFinContrat').value || null,
            actif: true
        };

        DB.agents.push(nouvelAgent);
        verifierRecyclages();
        sauvegarderVersFirebase();
        closeModal();
        showToast('Agent cr√©√©');
        navigate('agents');
        initLogin();
    });
}


// ========== ADMINISTRATION (SSIAP 3 uniquement) ==========
let adminTab = 'etablissement'; // onglet actif: etablissement, typesRondes, qrcodes

function renderAdministration() {
    const totalZones = configEtablissement.batiments.reduce((acc, b) =>
        acc + b.secteurs.reduce((acc2, s) => acc2 + s.zones.length, 0), 0);
    const totalSecteurs = configEtablissement.batiments.reduce((acc, b) => acc + b.secteurs.length, 0);

    return `
        <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
            <div>
                <h1 class="text-2xl font-bold text-gray-800 dark:text-white">Administration</h1>
                <p class="text-gray-500">Configuration de l'√©tablissement et des rondes</p>
            </div>
        </div>

        <!-- Onglets -->
        <div class="flex gap-2 mb-6 overflow-x-auto pb-2">
            <button onclick="adminTab='etablissement'; navigate('administration')" class="btn ${adminTab === 'etablissement' ? 'btn-primary' : 'btn-secondary'} whitespace-nowrap">
                <i class="fas fa-building"></i> √âtablissement
            </button>
            <button onclick="adminTab='typesRondes'; navigate('administration')" class="btn ${adminTab === 'typesRondes' ? 'btn-primary' : 'btn-secondary'} whitespace-nowrap">
                <i class="fas fa-route"></i> Types de rondes
            </button>
            <button onclick="adminTab='qrcodes'; navigate('administration')" class="btn ${adminTab === 'qrcodes' ? 'btn-primary' : 'btn-secondary'} whitespace-nowrap">
                <i class="fas fa-qrcode"></i> QR Codes
            </button>
        </div>

        ${adminTab === 'etablissement' ? renderAdminEtablissement(totalZones, totalSecteurs) : ''}
        ${adminTab === 'typesRondes' ? renderAdminTypesRondes() : ''}
        ${adminTab === 'qrcodes' ? renderAdminQRCodes() : ''}
    `;
}

function renderAdminEtablissement(totalZones, totalSecteurs) {
    return `
        <!-- Stats -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="stat-card bg-white dark:bg-slate-800">
                <div class="icon bg-blue-100 dark:bg-blue-900 text-blue-600"><i class="fas fa-building"></i></div>
                <div class="value text-gray-800 dark:text-white">${configEtablissement.batiments.length}</div>
                <div class="label">B√¢timents</div>
            </div>
            <div class="stat-card bg-white dark:bg-slate-800">
                <div class="icon bg-purple-100 dark:bg-purple-900 text-purple-600"><i class="fas fa-layer-group"></i></div>
                <div class="value text-gray-800 dark:text-white">${totalSecteurs}</div>
                <div class="label">Secteurs</div>
            </div>
            <div class="stat-card bg-white dark:bg-slate-800">
                <div class="icon bg-green-100 dark:bg-green-900 text-green-600"><i class="fas fa-map-marker-alt"></i></div>
                <div class="value text-gray-800 dark:text-white">${totalZones}</div>
                <div class="label">Zones</div>
            </div>
            <div class="stat-card bg-white dark:bg-slate-800">
                <div class="icon bg-orange-100 dark:bg-orange-900 text-orange-600"><i class="fas fa-fire-extinguisher"></i></div>
                <div class="value text-gray-800 dark:text-white">${DB.materiels.length}</div>
                <div class="label">Mat√©riels</div>
            </div>
        </div>

        <!-- Nom √©tablissement -->
        <div class="card mb-6">
            <div class="p-4 border-b border-gray-100 dark:border-slate-700 flex items-center justify-between">
                <h3 class="font-semibold text-gray-800 dark:text-white">
                    <i class="fas fa-home text-blue-500 mr-2"></i>Nom de l'√©tablissement
                </h3>
                <button onclick="modifierNomEtablissement()" class="btn btn-sm btn-secondary">
                    <i class="fas fa-edit"></i> Modifier
                </button>
            </div>
            <div class="p-4">
                <span class="text-lg font-semibold text-gray-800 dark:text-white">${configEtablissement.nom}</span>
            </div>
        </div>

        <!-- Liste des b√¢timents -->
        <div class="card">
            <div class="p-4 border-b border-gray-100 dark:border-slate-700 flex items-center justify-between">
                <h3 class="font-semibold text-gray-800 dark:text-white">
                    <i class="fas fa-building text-blue-500 mr-2"></i>B√¢timents
                </h3>
                <button onclick="ajouterBatiment()" class="btn btn-sm btn-primary">
                    <i class="fas fa-plus"></i> Ajouter
                </button>
            </div>
            <div class="p-4 space-y-4">
                ${configEtablissement.batiments.map((bat, batIndex) => `
                    <div class="border border-gray-200 dark:border-slate-600 rounded-xl overflow-hidden">
                        <div class="p-4 bg-blue-50 dark:bg-blue-900/30 flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center text-white font-bold">
                                    ${batIndex + 1}
                                </div>
                                <div>
                                    <div class="font-semibold text-gray-800 dark:text-white">${bat.nom}</div>
                                    <div class="text-sm text-gray-500">${bat.secteurs.length} secteur(s)</div>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="modifierBatiment('${bat.id}')" class="btn btn-sm btn-secondary" title="Modifier">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="supprimerBatiment('${bat.id}')" class="btn btn-sm btn-danger" title="Supprimer">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Secteurs du b√¢timent -->
                        <div class="p-3 space-y-2">
                            ${bat.secteurs.map((sect, sectIndex) => `
                                <div class="bg-gray-50 dark:bg-slate-700 rounded-lg p-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="flex items-center gap-2">
                                            <i class="fas fa-layer-group text-purple-500"></i>
                                            <span class="font-medium text-gray-800 dark:text-white">${sect.nom}</span>
                                            <span class="badge badge-info text-xs">${sect.zones.length} zones</span>
                                        </div>
                                        <div class="flex gap-1">
                                            <button onclick="modifierSecteur('${bat.id}', '${sect.id}')" class="btn btn-sm btn-secondary" title="Modifier">
                                                <i class="fas fa-edit text-xs"></i>
                                            </button>
                                            <button onclick="supprimerSecteur('${bat.id}', '${sect.id}')" class="btn btn-sm btn-danger" title="Supprimer">
                                                <i class="fas fa-trash text-xs"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Zones du secteur -->
                                    <div class="flex flex-wrap gap-1 mt-2">
                                        ${sect.zones.map((zone, zoneIndex) => `
                                            <span class="inline-flex items-center gap-1 px-2 py-1 bg-white dark:bg-slate-800 rounded text-xs text-gray-700 dark:text-gray-300 border border-gray-200 dark:border-slate-600">
                                                ${zone}
                                                <button onclick="supprimerZone('${bat.id}', '${sect.id}', ${zoneIndex})" class="text-red-500 hover:text-red-700 ml-1" title="Supprimer">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </span>
                                        `).join('')}
                                        <button onclick="ajouterZone('${bat.id}', '${sect.id}')" class="inline-flex items-center gap-1 px-2 py-1 bg-green-100 dark:bg-green-900/50 text-green-700 dark:text-green-400 rounded text-xs hover:bg-green-200">
                                            <i class="fas fa-plus"></i> Zone
                                        </button>
                                    </div>
                                </div>
                            `).join('')}

                            <button onclick="ajouterSecteur('${bat.id}')" class="w-full p-2 border-2 border-dashed border-gray-300 dark:border-slate-600 rounded-lg text-gray-500 hover:border-purple-500 hover:text-purple-500 transition-colors text-sm">
                                <i class="fas fa-plus mr-1"></i> Ajouter un secteur
                            </button>
                        </div>
                    </div>
                `).join('')}

                ${configEtablissement.batiments.length === 0 ? `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-building text-4xl mb-3 opacity-50"></i>
                        <p>Aucun b√¢timent configur√©</p>
                        <button onclick="ajouterBatiment()" class="btn btn-primary mt-4">
                            <i class="fas fa-plus"></i> Cr√©er le premier b√¢timent
                        </button>
                    </div>
                ` : ''}
            </div>
        </div>
    `;
}

function renderAdminTypesRondes() {
    return `
        <div class="card">
            <div class="p-4 border-b border-gray-100 dark:border-slate-700 flex items-center justify-between">
                <h3 class="font-semibold text-gray-800 dark:text-white">
                    <i class="fas fa-route text-purple-500 mr-2"></i>Types de rondes
                </h3>
                <button onclick="ajouterTypeRonde()" class="btn btn-sm btn-primary">
                    <i class="fas fa-plus"></i> Ajouter
                </button>
            </div>
            <div class="p-4">
                <div class="space-y-2">
                    ${typesRondes.map((type, index) => `
                        <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-slate-700 rounded-lg">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 bg-purple-100 dark:bg-purple-900/50 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-route text-purple-600"></i>
                                </div>
                                <span class="font-medium text-gray-800 dark:text-white">${type}</span>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="modifierTypeRonde(${index})" class="btn btn-sm btn-secondary">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="supprimerTypeRonde(${index})" class="btn btn-sm btn-danger">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>

                ${typesRondes.length === 0 ? `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-route text-4xl mb-3 opacity-50"></i>
                        <p>Aucun type de ronde configur√©</p>
                    </div>
                ` : ''}
            </div>
        </div>
    `;
}

function renderAdminQRCodes() {
    // G√©n√©rer la liste de tous les points de contr√¥le avec le m√™me format que les rondes
    const pointsControle = [];
    configEtablissement.batiments.forEach(bat => {
        bat.secteurs.forEach(sect => {
            sect.zones.forEach(zone => {
                // Format unifi√© avec les rondes : ZONE-{batId}-{sectId}-{ZONE_NAME}
                const qrCode = `ZONE-${bat.id}-${sect.id}-${zone.replace(/\s+/g, '-').toUpperCase()}`.substring(0, 50);
                pointsControle.push({
                    id: `PC-${bat.id}-${sect.id}-${zone.replace(/[^a-zA-Z0-9]/g, '')}`,
                    qrCode: qrCode,
                    nom: zone,
                    localisation: `${bat.nom} > ${sect.nom}`,
                    batiment: bat.nom,
                    batimentId: bat.id,
                    secteur: sect.nom,
                    secteurId: sect.id
                });
            });
        });
    });

    return `
        <div class="card mb-6">
            <div class="p-4 border-b border-gray-100 dark:border-slate-700 flex flex-wrap items-center justify-between gap-4">
                <h3 class="font-semibold text-gray-800 dark:text-white">
                    <i class="fas fa-qrcode text-green-500 mr-2"></i>QR Codes des points de contr√¥le
                </h3>
                <div class="flex gap-2">
                    <button onclick="imprimerTousQRCodes()" class="btn btn-sm btn-success">
                        <i class="fas fa-print"></i> Imprimer tous
                    </button>
                </div>
            </div>
            <div class="p-4">
                <p class="text-gray-500 text-sm mb-4">
                    <i class="fas fa-info-circle mr-1"></i>
                    Ces QR codes peuvent √™tre imprim√©s et plac√©s aux points de contr√¥le. Les rondiers les scannent pour valider leur passage.
                </p>

                <!-- Filtres -->
                <div class="flex flex-wrap gap-2 mb-4">
                    <select id="filtreQRBatiment" onchange="filtrerQRCodes()" class="input" style="max-width: 200px;">
                        <option value="">Tous les b√¢timents</option>
                        ${configEtablissement.batiments.map(b => `<option value="${b.nom}">${b.nom}</option>`).join('')}
                    </select>
                </div>

                <div id="qrCodesGrid" class="qr-grid">
                    ${pointsControle.map(pc => `
                        <div class="qr-card" data-batiment="${pc.batiment}" data-qrcode="${pc.qrCode}">
                            <div id="qr-${pc.id}" class="mb-2 flex justify-center"></div>
                            <div class="font-semibold text-gray-800 dark:text-white text-sm">${pc.nom}</div>
                            <div class="text-xs text-gray-500">${pc.localisation}</div>
                            <div class="text-xs text-blue-600 dark:text-blue-400 font-mono mt-1 break-all">${pc.qrCode}</div>
                            <button onclick="imprimerQRCode('${pc.id}', '${pc.nom}', '${pc.localisation}', '${pc.qrCode}')" class="btn btn-sm btn-secondary mt-2 w-full">
                                <i class="fas fa-print"></i> Imprimer
                            </button>
                        </div>
                    `).join('')}
                </div>

                ${pointsControle.length === 0 ? `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-qrcode text-4xl mb-3 opacity-50"></i>
                        <p>Configurez d'abord les zones dans l'onglet √âtablissement</p>
                    </div>
                ` : ''}
            </div>
        </div>
    `;
}

// G√©n√©ration des QR codes apr√®s rendu
function genererQRCodesAdmin() {
    if (typeof QRCode === 'undefined') return;

    configEtablissement.batiments.forEach(bat => {
        bat.secteurs.forEach(sect => {
            sect.zones.forEach(zone => {
                const id = `PC-${bat.id}-${sect.id}-${zone.replace(/[^a-zA-Z0-9]/g, '')}`;
                // Format unifi√© avec les rondes
                const qrCode = `ZONE-${bat.id}-${sect.id}-${zone.replace(/\s+/g, '-').toUpperCase()}`.substring(0, 50);
                const container = document.getElementById(`qr-${id}`);
                if (container && container.children.length === 0) {
                    new QRCode(container, {
                        text: qrCode,
                        width: 100,
                        height: 100
                    });
                }
            });
        });
    });
}

function filtrerQRCodes() {
    const filtre = document.getElementById('filtreQRBatiment').value;
    const cards = document.querySelectorAll('#qrCodesGrid .qr-card');

    cards.forEach(card => {
        if (!filtre || card.dataset.batiment === filtre) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
}

function imprimerQRCode(id, nom, localisation, qrCodeText = '') {
    const qrContainer = document.getElementById(`qr-${id}`);
    if (!qrContainer) return;

    const qrImage = qrContainer.querySelector('img') || qrContainer.querySelector('canvas');
    if (!qrImage) return;

    const printWindow = window.open('', '_blank');
    const imgSrc = qrImage.tagName === 'IMG' ? qrImage.src : qrImage.toDataURL();

    printWindow.document.write(`
        <html>
        <head>
            <title>QR Code - ${nom}</title>
            <style>
                body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
                .qr-print { border: 2px solid #333; padding: 20px; display: inline-block; margin: 10px; }
                .qr-print img { width: 150px; height: 150px; }
                .qr-print h3 { margin: 10px 0 5px; font-size: 14px; }
                .qr-print p { margin: 0; font-size: 11px; color: #666; }
                .qr-print .code { font-family: monospace; font-size: 9px; color: #0066cc; margin-top: 5px; word-break: break-all; }
                @media print { body { margin: 0; } }
            </style>
        </head>
        <body>
            <div class="qr-print">
                <img src="${imgSrc}" />
                <h3>${nom}</h3>
                <p>${localisation}</p>
                ${qrCodeText ? `<p class="code">${qrCodeText}</p>` : ''}
                <p style="margin-top: 8px; font-size: 10px;">SSIAP Patrol - Point de contr√¥le</p>
            </div>
            <script>window.onload = function() { window.print(); }<\/script>
        </body>
        </html>
    `);
    printWindow.document.close();
}

function imprimerTousQRCodes() {
    const printWindow = window.open('', '_blank');
    let qrHtml = '';

    configEtablissement.batiments.forEach(bat => {
        bat.secteurs.forEach(sect => {
            sect.zones.forEach(zone => {
                const id = `PC-${bat.id}-${sect.id}-${zone.replace(/[^a-zA-Z0-9]/g, '')}`;
                const qrCode = `ZONE-${bat.id}-${sect.id}-${zone.replace(/\s+/g, '-').toUpperCase()}`.substring(0, 50);
                const qrContainer = document.getElementById(`qr-${id}`);
                if (qrContainer) {
                    const qrImage = qrContainer.querySelector('img') || qrContainer.querySelector('canvas');
                    if (qrImage) {
                        const imgSrc = qrImage.tagName === 'IMG' ? qrImage.src : qrImage.toDataURL();
                        qrHtml += `
                            <div class="qr-print">
                                <img src="${imgSrc}" >
                                <h3>${zone}</h3>
                                <p>${bat.nom} > ${sect.nom}</p>
                                <p class="code">${qrCode}</p>
                            </div>
                        `;
                    }
                }
            });
        });
    });

    printWindow.document.write(`
        <html>
        <head>
            <title>QR Codes - Points de contr√¥le</title>
            <style>
                body { font-family: Arial, sans-serif; }
                .qr-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; padding: 20px; }
                .qr-print { border: 2px solid #333; padding: 15px; text-align: center; page-break-inside: avoid; }
                .qr-print img { width: 120px; height: 120px; }
                .qr-print h3 { margin: 8px 0 4px; font-size: 12px; }
                .qr-print p { margin: 0; font-size: 10px; color: #666; }
                .qr-print .code { font-family: monospace; font-size: 8px; color: #0066cc; margin-top: 4px; word-break: break-all; }
                @media print {
                    body { margin: 0; }
                    .qr-grid { gap: 10px; }
                }
            </style>
        </head>
        <body>
            <h1 style="text-align: center; margin-bottom: 20px;">QR Codes - Points de contr√¥le</h1>
            <div class="qr-grid">${qrHtml}</div>
            <script>window.onload = function() { window.print(); }<\/script>
        </body>
        </html>
    `);
    printWindow.document.close();
}

// ========== Fonctions de gestion √âtablissement ==========

function modifierNomEtablissement() {
    showModal('Nom de l\'√©tablissement', `
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-semibold mb-2">Nom</label>
                <input type="text" id="nomEtablissement" class="input" value="${configEtablissement.nom}" placeholder="Nom de l'√©tablissement">
            </div>
        </div>
    `, () => {
        const nom = document.getElementById('nomEtablissement').value.trim();
        if (!nom) return showToast('Entrez un nom', 'error');

        configEtablissement.nom = nom;
        sauvegarderVersFirebase();
        closeModal();
        showToast('Nom modifi√©');
        navigate('administration');
    }, 'Enregistrer');
}

function ajouterBatiment() {
    if (configEtablissement.batiments.length >= 3) {
        return showToast('Maximum 3 b√¢timents autoris√©s', 'error');
    }

    showModal('Nouveau b√¢timent', `
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-semibold mb-2">Nom du b√¢timent</label>
                <input type="text" id="nomBatiment" class="input" placeholder="Ex: B√¢timent Principal">
            </div>
        </div>
    `, () => {
        const nom = document.getElementById('nomBatiment').value.trim();
        if (!nom) return showToast('Entrez un nom', 'error');

        const id = 'bat' + (configEtablissement.batiments.length + 1) + '-' + Date.now();
        configEtablissement.batiments.push({
            id: id,
            nom: nom,
            secteurs: []
        });

        sauvegarderVersFirebase();
        closeModal();
        showToast('B√¢timent ajout√©');
        navigate('administration');
    }, 'Cr√©er');
}

function modifierBatiment(batId) {
    const bat = configEtablissement.batiments.find(b => b.id === batId);
    if (!bat) return;

    showModal('Modifier le b√¢timent', `
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-semibold mb-2">Nom du b√¢timent</label>
                <input type="text" id="nomBatiment" class="input" value="${bat.nom}">
            </div>
        </div>
    `, () => {
        const nom = document.getElementById('nomBatiment').value.trim();
        if (!nom) return showToast('Entrez un nom', 'error');

        bat.nom = nom;
        sauvegarderVersFirebase();
        closeModal();
        showToast('B√¢timent modifi√©');
        navigate('administration');
    }, 'Enregistrer');
}

function supprimerBatiment(batId) {
    const bat = configEtablissement.batiments.find(b => b.id === batId);
    if (!bat) return;

    showConfirm(`Supprimer le b√¢timent "${bat.nom}" et tous ses secteurs/zones ?`, () => {
        configEtablissement.batiments = configEtablissement.batiments.filter(b => b.id !== batId);
        sauvegarderVersFirebase();
        showToast('B√¢timent supprim√©');
        navigate('administration');
    });
}

function ajouterSecteur(batId) {
    const bat = configEtablissement.batiments.find(b => b.id === batId);
    if (!bat) return;

    showModal('Nouveau secteur', `
        <div class="space-y-4">
            <div class="bg-blue-50 dark:bg-blue-900/30 p-3 rounded-lg text-sm text-blue-700 dark:text-blue-300">
                <i class="fas fa-building mr-1"></i> ${bat.nom}
            </div>
            <div>
                <label class="block text-sm font-semibold mb-2">Nom du secteur</label>
                <input type="text" id="nomSecteur" class="input" placeholder="Ex: RDC, 1er √©tage, Sous-sol...">
            </div>
        </div>
    `, () => {
        const nom = document.getElementById('nomSecteur').value.trim();
        if (!nom) return showToast('Entrez un nom', 'error');

        const id = batId + '-' + nom.toLowerCase().replace(/[^a-z0-9]/g, '') + '-' + Date.now();
        bat.secteurs.push({
            id: id,
            nom: nom,
            zones: []
        });

        sauvegarderVersFirebase();
        closeModal();
        showToast('Secteur ajout√©');
        navigate('administration');
    }, 'Cr√©er');
}

function modifierSecteur(batId, sectId) {
    const bat = configEtablissement.batiments.find(b => b.id === batId);
    const sect = bat?.secteurs.find(s => s.id === sectId);
    if (!sect) return;

    showModal('Modifier le secteur', `
        <div class="space-y-4">
            <div class="bg-blue-50 dark:bg-blue-900/30 p-3 rounded-lg text-sm text-blue-700 dark:text-blue-300">
                <i class="fas fa-building mr-1"></i> ${bat.nom}
            </div>
            <div>
                <label class="block text-sm font-semibold mb-2">Nom du secteur</label>
                <input type="text" id="nomSecteur" class="input" value="${sect.nom}">
            </div>
        </div>
    `, () => {
        const nom = document.getElementById('nomSecteur').value.trim();
        if (!nom) return showToast('Entrez un nom', 'error');

        sect.nom = nom;
        sauvegarderVersFirebase();
        closeModal();
        showToast('Secteur modifi√©');
        navigate('administration');
    }, 'Enregistrer');
}

function supprimerSecteur(batId, sectId) {
    const bat = configEtablissement.batiments.find(b => b.id === batId);
    const sect = bat?.secteurs.find(s => s.id === sectId);
    if (!sect) return;

    showConfirm(`Supprimer le secteur "${sect.nom}" et toutes ses zones ?`, () => {
        bat.secteurs = bat.secteurs.filter(s => s.id !== sectId);
        sauvegarderVersFirebase();
        showToast('Secteur supprim√©');
        navigate('administration');
    });
}

function ajouterZone(batId, sectId) {
    const bat = configEtablissement.batiments.find(b => b.id === batId);
    const sect = bat?.secteurs.find(s => s.id === sectId);
    if (!sect) return;

    showModal('Nouvelle zone', `
        <div class="space-y-4">
            <div class="bg-blue-50 dark:bg-blue-900/30 p-3 rounded-lg text-sm text-blue-700 dark:text-blue-300">
                <i class="fas fa-building mr-1"></i> ${bat.nom} > <i class="fas fa-layer-group ml-1 mr-1"></i> ${sect.nom}
            </div>
            <div>
                <label class="block text-sm font-semibold mb-2">Nom de la zone</label>
                <input type="text" id="nomZone" class="input" placeholder="Ex: Hall d'entr√©e, Bureau 101, Parking...">
            </div>
        </div>
    `, () => {
        const nom = document.getElementById('nomZone').value.trim();
        if (!nom) return showToast('Entrez un nom', 'error');

        if (sect.zones.includes(nom)) {
            return showToast('Cette zone existe d√©j√†', 'error');
        }

        sect.zones.push(nom);
        sauvegarderVersFirebase();
        closeModal();
        showToast('Zone ajout√©e');
        navigate('administration');
    }, 'Cr√©er');
}

function supprimerZone(batId, sectId, zoneIndex) {
    const bat = configEtablissement.batiments.find(b => b.id === batId);
    const sect = bat?.secteurs.find(s => s.id === sectId);
    if (!sect) return;

    const zoneName = sect.zones[zoneIndex];
    showConfirm(`Supprimer la zone "${zoneName}" ?`, () => {
        sect.zones.splice(zoneIndex, 1);
        sauvegarderVersFirebase();
        showToast('Zone supprim√©e');
        navigate('administration');
    });
}

// ========== Fonctions de gestion Types de Rondes ==========

function ajouterTypeRonde() {
    showModal('Nouveau type de ronde', `
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-semibold mb-2">Nom du type de ronde</label>
                <input type="text" id="nomTypeRonde" class="input" placeholder="Ex: Ronde de nuit, V√©rification SSI...">
            </div>
        </div>
    `, () => {
        const nom = document.getElementById('nomTypeRonde').value.trim();
        if (!nom) return showToast('Entrez un nom', 'error');

        if (typesRondes.includes(nom)) {
            return showToast('Ce type existe d√©j√†', 'error');
        }

        typesRondes.push(nom);
        sauvegarderVersFirebase();
        closeModal();
        showToast('Type de ronde ajout√©');
        navigate('administration');
    }, 'Cr√©er');
}

function modifierTypeRonde(index) {
    const type = typesRondes[index];

    showModal('Modifier le type de ronde', `
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-semibold mb-2">Nom du type de ronde</label>
                <input type="text" id="nomTypeRonde" class="input" value="${type}">
            </div>
        </div>
    `, () => {
        const nom = document.getElementById('nomTypeRonde').value.trim();
        if (!nom) return showToast('Entrez un nom', 'error');

        typesRondes[index] = nom;
        sauvegarderVersFirebase();
        closeModal();
        showToast('Type de ronde modifi√©');
        navigate('administration');
    }, 'Enregistrer');
}

function supprimerTypeRonde(index) {
    const type = typesRondes[index];

    showConfirm(`Supprimer le type "${type}" ?`, () => {
        typesRondes.splice(index, 1);
        sauvegarderVersFirebase();
        showToast('Type de ronde supprim√©');
        navigate('administration');
    });
}

// G√©n√©rer les QR codes quand on navigue vers l'onglet qrcodes
const originalNavigate = navigate;
navigate = function(view) {
    originalNavigate(view);
    if (view === 'administration' && adminTab === 'qrcodes') {
        setTimeout(genererQRCodesAdmin, 100);
    }
};

// ========== MODALS ==========
function showModal(title, content, onConfirm, confirmText = 'Confirmer') {
    modalConfirmCallback = onConfirm;
    document.getElementById('modalContainer').innerHTML = `
        <div class="modal-overlay" onclick="if(event.target===this)closeModal()">
            <div class="modal-content">
                <div class="modal-header"><h2 class="text-xl font-bold text-gray-800 dark:text-white">${title}</h2></div>
                <div class="modal-body">${content}</div>
                <div class="modal-footer">
                    <button onclick="closeModal()" class="btn btn-secondary">Annuler</button>
                    ${onConfirm ? `<button onclick="executeModalConfirm()" class="btn btn-primary">${confirmText}</button>` : `<button onclick="closeModal()" class="btn btn-primary">${confirmText}</button>`}
                </div>
            </div>
        </div>
    `;
}

async function executeModalConfirm() {
    if (modalConfirmCallback) {
        await modalConfirmCallback();
    }
}

function showConfirm(msg, onYes) {
    showModal('Confirmation', `<p class="text-gray-600 dark:text-gray-400">${msg}</p>`, () => { closeModal(); onYes(); });
}

function closeModal() {
    // Arr√™ter le scanner QR si actif
    if (html5QrScanner) {
        html5QrScanner.stop().catch(() => {});
        html5QrScanner = null;
    }
    document.getElementById('modalContainer').innerHTML = '';
}

function showToast(msg, type = 'success') {
    const t = document.createElement('div');
    t.className = `fixed bottom-4 right-4 px-5 py-3 rounded-xl text-white font-medium shadow-lg fade-in ${type === 'error' ? 'bg-red-500' : type === 'warning' ? 'bg-orange-500' : 'gradient-success'}`;
    t.style.zIndex = '9999';
    t.innerHTML = `<i class="fas ${type === 'error' ? 'fa-times-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-check-circle'} mr-2"></i>${msg}`;
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 3000);
}

// Fonctions pour la gestion des photos
function afficherApercu(input, containerId) {
    const container = document.getElementById(containerId);
    const img = container?.querySelector('img');

    if (input.files && input.files[0] && container && img) {
        const reader = new FileReader();
        reader.onload = function(e) {
            img.src = e.target.result;
            container.classList.remove('hidden');
        };
        reader.readAsDataURL(input.files[0]);
    }
}

function supprimerPhoto(inputId, containerId) {
    const input = document.getElementById(inputId);
    const container = document.getElementById(containerId);

    if (input) input.value = '';
    if (container) container.classList.add('hidden');
}

// Convertir un fichier image en base64 (avec compression)
function convertirEnBase64(file, maxWidth = 800) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                // Redimensionner si n√©cessaire
                let width = img.width;
                let height = img.height;

                if (width > maxWidth) {
                    height = Math.round(height * maxWidth / width);
                    width = maxWidth;
                }

                // Cr√©er un canvas pour compresser
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);

                // Convertir en JPEG compress√© (qualit√© 0.7)
                const base64 = canvas.toDataURL('image/jpeg', 0.7);
                resolve(base64);
            };
            img.onerror = reject;
            img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

// ========== SAUVEGARDE / CHARGEMENT ==========
function sauvegarderDonnees() {
    const saveData = {
        version: '1.0',
        date: new Date().toISOString(),
        data: {
            agents: DB.agents,
            materiels: DB.materiels,
            prisesPoste: DB.prisesPoste,
            rondes: DB.rondes,
            evenements: DB.evenements,
            mainCourante: DB.mainCourante,
            consignes: DB.consignes
        }
    };

    const json = JSON.stringify(saveData, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'ssiap-patrol-sauvegarde-' + new Date().toISOString().split('T')[0] + '.json';
    a.click();
    URL.revokeObjectURL(url);
    showToast('Sauvegarde t√©l√©charg√©e');
}

function chargerDonnees() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = e => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = event => {
            try {
                const saveData = JSON.parse(event.target.result);
                if (!saveData.data) {
                    return showToast('Fichier invalide', 'error');
                }

                showConfirm('√ätes-vous s√ªr de vouloir charger cette sauvegarde ? Les donn√©es actuelles seront remplac√©es.', () => {
                    DB.agents = saveData.data.agents || DB.agents;
                    DB.materiels = saveData.data.materiels || DB.materiels;
                    DB.prisesPoste = saveData.data.prisesPoste || [];
                    DB.rondes = saveData.data.rondes || [];
                    DB.evenements = saveData.data.evenements || [];
                    DB.mainCourante = saveData.data.mainCourante || [];
                    DB.consignes = saveData.data.consignes || DB.consignes;

                    showToast('Donn√©es charg√©es avec succ√®s');
                    initLogin();
                    if (currentUser) {
                        navigate(currentView);
                    }
                });
            } catch (err) {
                showToast('Erreur lors du chargement: ' + err.message, 'error');
            }
        };
        reader.readAsText(file);
    };
    input.click();
}

// ========== LOGIN RONDIER (Mobile) ==========
function detecterModeRondier() {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('mode') === 'rondier';
}

// G√©n√©rer le code d'acc√®s rondier du jour
function getCodeAccesRondier() {
    const today = new Date();
    return `SSIAP-${today.getFullYear()}${String(today.getMonth()+1).padStart(2,'0')}${String(today.getDate()).padStart(2,'0')}`;
}

// Acc√©der au mode rondier depuis l'√©cran de connexion
function accederModeRondier() {
    afficherLoginRondier(true);
}

// Afficher le code d'acc√®s rondier (depuis le tableau de bord)
function afficherCodeAccesRondier() {
    const codeAcces = getCodeAccesRondier();
    showModal('Code Acc√®s Rondier', `
        <div class="space-y-4 text-center">
            <div class="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-xl">
                <i class="fas fa-info-circle text-blue-500 text-2xl mb-2"></i>
                <p class="text-sm text-gray-600 dark:text-gray-400">
                    Ce code permet aux rondiers d'acc√©der √† l'application depuis n'importe quel appareil.
                </p>
            </div>

            <div class="bg-gradient-to-r from-primary-500 to-purple-500 text-white p-6 rounded-xl">
                <div class="text-sm opacity-80 mb-2">Code du jour</div>
                <div class="text-2xl font-mono font-bold tracking-wider">${codeAcces}</div>
            </div>

            <div class="bg-yellow-50 dark:bg-yellow-900/30 p-4 rounded-xl text-left">
                <h4 class="font-semibold text-yellow-700 dark:text-yellow-400 mb-2">
                    <i class="fas fa-walking mr-2"></i>Instructions pour les rondiers
                </h4>
                <ol class="text-sm text-gray-600 dark:text-gray-400 space-y-1 list-decimal list-inside">
                    <li>Ouvrir l'application SSIAP Patrol</li>
                    <li>Cliquer sur "Acc√®s Rondier Mobile"</li>
                    <li>S√©lectionner son nom dans la liste</li>
                    <li>Effectuer les rondes assign√©es</li>
                </ol>
            </div>

            <p class="text-xs text-gray-500">
                <i class="fas fa-shield-alt mr-1"></i>
                Le code change chaque jour √† minuit
            </p>
        </div>
    `, null, 'Fermer');
}

function afficherLoginRondier(forceReload = false) {
    // Cacher le login principal, afficher le login rondier
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('loginRondier').classList.remove('hidden');
    document.getElementById('mainApp').classList.add('hidden');

    if (forceReload) {
        // Afficher loading et recharger
        document.getElementById('rondierLoading').classList.remove('hidden');
        document.getElementById('rondierContent').classList.add('hidden');

        chargerDepuisFirebase(() => {
            console.log('üîÑ Donn√©es recharg√©es pour rondier');
            console.log('üìä Prises de poste:', DB.prisesPoste.length);
            afficherAgentsRondier();
        });
    } else {
        // Donn√©es d√©j√† charg√©es, afficher directement
        document.getElementById('rondierLoading').classList.add('hidden');
        document.getElementById('rondierContent').classList.remove('hidden');
        afficherAgentsRondier();
    }
}

function afficherAgentsRondier() {
    // Masquer loading, afficher contenu
    document.getElementById('rondierLoading').classList.add('hidden');
    document.getElementById('rondierContent').classList.remove('hidden');

    // DEBUG: Afficher les donn√©es brutes
    console.log('=== DEBUG RONDIER ===');
    console.log('DB.prisesPoste:', JSON.stringify(DB.prisesPoste));
    console.log('DB.agents:', DB.agents.length);

    // Toutes les prises de poste actives (sans fin de poste)
    const prisesActives = DB.prisesPoste.filter(p => !p.finPoste);
    console.log('Prises actives (sans finPoste):', prisesActives.length, JSON.stringify(prisesActives));

    // R√©cup√©rer tous les agents en poste
    const tousAgentsEnPoste = getAgentsEnPoste();
    console.log('Tous agents en poste:', tousAgentsEnPoste.length);

    // R√©cup√©rer seulement les agents SSIAP 1 qui sont en poste
    const agentsEnPoste = tousAgentsEnPoste.filter(a => a.qualification === 'SSIAP 1');
    console.log('Agents SSIAP 1 en poste:', agentsEnPoste.length);

    const listContainer = document.getElementById('rondierAgentsList');
    const noAgentContainer = document.getElementById('rondierNoAgent');

    if (agentsEnPoste.length === 0) {
        // Afficher info de d√©bogage dans l'UI
        listContainer.innerHTML = `
            <div class="bg-blue-50 dark:bg-blue-900/30 p-3 rounded-lg text-xs text-blue-700 dark:text-blue-300 mb-4">
                <div class="font-bold mb-1">üîç Debug Firebase:</div>
                <div>Prises de poste en DB: ${DB.prisesPoste.length}</div>
                <div>Prises actives (sans fin): ${prisesActives.length}</div>
                <div>Agents en poste total: ${tousAgentsEnPoste.length}</div>
                <div>Agents SSIAP 1 en poste: ${agentsEnPoste.length}</div>
                ${prisesActives.length > 0 ? `<div class="mt-1">IDs agents en poste: ${prisesActives.map(p => p.agentId).join(', ')}</div>` : ''}
            </div>
        `;
        noAgentContainer.classList.remove('hidden');
    } else {
        noAgentContainer.classList.add('hidden');
        listContainer.innerHTML = agentsEnPoste.map(a => `
            <button onclick="loginRondier(${a.id})" class="w-full p-4 bg-gray-50 dark:bg-slate-700 hover:bg-primary-50 dark:hover:bg-primary-900/30 rounded-xl flex items-center gap-4 transition-all border-2 border-transparent hover:border-primary-500">
                <div class="w-12 h-12 gradient-header rounded-full flex items-center justify-center text-white font-bold text-lg">
                    ${a.prenom.charAt(0)}${a.nom.charAt(0)}
                </div>
                <div class="flex-1 text-left">
                    <div class="font-semibold text-gray-800 dark:text-white">${a.prenom} ${a.nom}</div>
                    <div class="text-sm text-gray-500 flex items-center gap-2">
                        <span class="badge badge-purple text-xs">${a.qualification}</span>
                        <span>En poste depuis ${formatTime(a.heureDebut)}</span>
                    </div>
                </div>
                <i class="fas fa-chevron-right text-gray-400"></i>
            </button>
        `).join('');
    }
}

function rechargerAgentsRondier() {
    showToast('üîÑ Actualisation...', 'info');
    // Forcer le rechargement depuis Firebase
    afficherLoginRondier(true);
    showToast('‚úÖ Liste actualis√©e');
}

function loginRondier(agentId) {
    const agent = DB.agents.find(a => a.id === agentId);
    if (!agent) {
        showToast('Agent non trouv√©', 'error');
        return;
    }

    // V√©rifier que l'agent est bien en poste
    const prisePoste = DB.prisesPoste.find(p => p.agentId === agentId && !p.finPoste);
    if (!prisePoste) {
        showToast('Cet agent n\'est plus en poste', 'error');
        rechargerAgentsRondier();
        return;
    }

    // Connexion directe sans mot de passe pour les rondiers
    currentUser = { ...agent };

    document.getElementById('loginRondier').classList.add('hidden');
    document.getElementById('mainApp').classList.remove('hidden');
    document.getElementById('userBadge').innerHTML = `<span class="badge badge-purple">${currentUser.qualification}</span> ${currentUser.prenom} ${currentUser.nom}`;

    initApp();
    showToast(`Bienvenue ${currentUser.prenom} !`);
}

function afficherLoginPrincipal() {
    // Retirer le param√®tre mode=rondier de l'URL
    const url = new URL(window.location.href);
    url.searchParams.delete('mode');
    window.history.replaceState({}, document.title, url.toString());

    // Afficher le login principal
    document.getElementById('loginRondier').classList.add('hidden');
    document.getElementById('loginScreen').classList.remove('hidden');
    document.getElementById('mainApp').classList.add('hidden');

    // Recharger la liste des agents
    initLogin();
}


// ========== INIT ==========

// Initialisation selon le mode
function demarrerApplication() {
    // V√©rifier les recyclages APR√àS le chargement des donn√©es
    verifierRecyclages();

    if (detecterModeRondier()) {
        // Mode rondier (mobile via QR code)
        console.log('üî∏ Mode Rondier d√©tect√©');
        afficherLoginRondier();
    } else {
        // Mode normal (PC S√©curit√©)
        console.log('üî∏ Mode PC S√©curit√©');
        initLogin();
    }
}

// Charger Firebase puis d√©marrer l'application
if (firestoreEnabled) {
    console.log('‚è≥ Chargement des donn√©es Firebase...');
    chargerDepuisFirebase(() => {
        console.log('‚úÖ Donn√©es Firebase charg√©es');
        console.log('üìä Prises de poste:', DB.prisesPoste.length);
        console.log('üìä Agents en poste:', getAgentsEnPoste().length);

        // Activer la sync temps r√©el APR√àS le chargement initial
        activerSyncTempsReel();

        demarrerApplication();
    });
} else {
    // Pas de Firebase, d√©marrer directement
    donneesChargees = true;
    demarrerApplication();
}
</script>
</body>
</html>
