<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSIAP Patrol - Gestion S√©curit√© Incendie</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Poppins', 'sans-serif'] },
                    colors: {
                        primary: { 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca' },
                        accent: { 500: '#8b5cf6', 600: '#7c3aed' }
                    }
                }
            }
        }
    </script>
    <style>
        * { box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .gradient-header { background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 100%); }
        .card { background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); overflow: hidden; }
        .dark .card { background: #1e293b; }
        .sidebar { width: 280px; background: white; height: 100vh; position: fixed; left: 0; top: 0; z-index: 50; transition: transform 0.3s; }
        .dark .sidebar { background: #1e293b; }
        .nav-link { display: flex; align-items: center; gap: 12px; padding: 14px 20px; margin: 4px 12px; border-radius: 12px; color: #64748b; font-weight: 500; transition: all 0.2s; cursor: pointer; }
        .nav-link:hover { background: #f1f5f9; color: #6366f1; }
        .nav-link.active { background: linear-gradient(90deg, #6366f1, #8b5cf6); color: white; }
        .btn { padding: 10px 20px; border-radius: 10px; font-weight: 600; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; cursor: pointer; border: none; }
        .btn-primary { background: linear-gradient(90deg, #6366f1, #8b5cf6); color: white; }
        .btn-secondary { background: #f1f5f9; color: #475569; }
        .btn-danger { background: linear-gradient(90deg, #ef4444, #f87171); color: white; }
        .input { width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 15px; }
        .input:focus { outline: none; border-color: #6366f1; }
        .badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .badge-purple { background: #f3e8ff; color: #9333ea; }
        .badge-success { background: #dcfce7; color: #16a34a; }
        .badge-warning { background: #fef3c7; color: #d97706; }
        .badge-danger { background: #fee2e2; color: #dc2626; }
        .badge-info { background: #dbeafe; color: #2563eb; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @media (max-width: 1024px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-left: 0 !important; }
        }
    </style>
</head>
<body class="bg-gray-50">

<div id="loginScreen" class="gradient-bg min-h-screen flex items-center justify-center p-4">
    <div class="card p-8 w-full max-w-md fade-in">
        <div class="text-center mb-8">
            <div class="w-20 h-20 gradient-header rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
                <i class="fas fa-shield-alt text-white text-3xl"></i>
            </div>
            <h1 class="text-2xl font-bold text-gray-800">SSIAP Patrol</h1>
            <p class="text-gray-500 mt-1">Syst√®me de gestion des rondes</p>
        </div>
        <div class="space-y-5">
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Agent</label>
                <select id="loginAgent" class="input">
                    <option value="">S√©lectionner un agent...</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Code PIN</label>
                <input type="password" id="loginPassword" class="input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="6">
            </div>
            <div class="bg-gray-50 rounded-xl p-4 text-sm">
                <div class="font-semibold text-gray-700 mb-2">üîê Code PIN</div>
                <div class="space-y-1 text-gray-600">
                    <div>Administrateur ‚Üí 321518</div>
                    <div>SSIAP 1/2/3 ‚Üí Code bas√© sur date de contrat</div>
                </div>
            </div>
            <div id="loginError" class="text-red-500 text-sm font-medium hidden"></div>
            <button onclick="login()" class="btn btn-primary w-full justify-center py-3">
                <i class="fas fa-sign-in-alt"></i> Se connecter
            </button>
            <button onclick="accederModeRondier()" class="btn btn-secondary w-full justify-center">
                <i class="fas fa-mobile-alt"></i> Acc√®s Rondier Mobile
            </button>
        </div>
    </div>
</div>

<div id="loginRondier" class="gradient-bg min-h-screen flex items-center justify-center p-4 hidden">
    <div class="card p-6 w-full max-w-md fade-in">
        <div class="text-center mb-6">
            <div class="w-16 h-16 bg-orange-500 rounded-2xl flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-walking text-white text-2xl"></i>
            </div>
            <h1 class="text-xl font-bold text-gray-800">Connexion Rondier</h1>
        </div>
        <div id="rondierLoading" class="text-center py-8">
            <i class="fas fa-sync-alt fa-spin text-3xl text-primary-500 mb-4"></i>
            <p class="text-gray-500">Chargement...</p>
        </div>
        <div id="rondierContent" class="space-y-4 hidden">
            <div id="rondierAgentsList"></div>
            <div id="rondierNoAgent" class="text-center py-6 hidden">
                <p class="text-gray-600">Aucun rondier en poste</p>
                <button onclick="rechargerAgentsRondier()" class="btn btn-secondary mt-4">
                    <i class="fas fa-sync-alt"></i> Actualiser
                </button>
            </div>
            <button onclick="afficherLoginPrincipal()" class="btn btn-secondary w-full justify-center">
                <i class="fas fa-desktop"></i> Connexion PC
            </button>
        </div>
    </div>
</div>

<div id="mainApp" class="hidden">
    <aside class="sidebar" id="sidebar">
        <div class="p-6 border-b border-gray-100">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 gradient-header rounded-xl flex items-center justify-center">
                    <i class="fas fa-shield-alt text-white text-xl"></i>
                </div>
                <div>
                    <div class="font-bold text-lg text-gray-800">SSIAP Patrol</div>
                    <div class="text-xs text-gray-500" id="userBadge"></div>
                    <div class="text-xs" id="firebaseStatus"></div>
                </div>
            </div>
        </div>
        <nav class="py-4" id="navMenu"></nav>
        <div class="absolute bottom-0 left-0 right-0 p-4 border-t space-y-2 bg-white" id="sidebarActions"></div>
    </aside>
    
    <div id="sidebarOverlay" class="fixed inset-0 bg-black/50 z-40 hidden lg:hidden" onclick="toggleSidebar()"></div>
    
    <main class="main-content lg:ml-[280px] min-h-screen p-6">
        <div id="mainContent"></div>
    </main>
</div>

<script>
// DATABASE
const DB = {
    agents: [
        { id: 7, nom: 'Admin', prenom: 'Syst√®me', qualification: 'Administrateur', entreprise: 'SecuriPlus', actif: true, email: 'admin@securiplus.fr', telephone: '0600000000', codePin: '321518', dateDebutContrat: '2020-01-01', dateFinContrat: null },
        { id: 1, nom: 'Martin', prenom: 'Jean-Pierre', qualification: 'SSIAP 2', entreprise: 'SecuriPlus', actif: true, email: 'jp.martin@securiplus.fr', telephone: '0612345678', dateDebutContrat: '2020-06-01', dateFinContrat: null },
        { id: 2, nom: 'Dupont', prenom: 'Alain', qualification: 'SSIAP 1', entreprise: 'SecuriPlus', actif: true, email: 'a.dupont@securiplus.fr', telephone: '0623456789', dateDebutContrat: '2019-04-01', dateFinContrat: null },
        { id: 3, nom: 'Boyer', prenom: 'Michel', qualification: 'SSIAP 1', entreprise: 'SecuriPlus', actif: true, email: 'm.boyer@securiplus.fr', telephone: '0634567890', dateDebutContrat: '2018-12-01', dateFinContrat: null }
    ],
    materiels: [],
    prisesPoste: [],
    rondes: [],
    evenements: [],
    mainCourante: [],
    consignes: []
};

let currentUser = null;
let currentView = 'dashboard';
let donneesChargees = false;
let updateInProgress = false;
let lastKnownVersion = null;

// FIREBASE
const firebaseConfig = {
    apiKey: "AIzaSyBXK-4-9HBcTKCPQBdRzDSwTc55vRXWNOk",
    authDomain: "ssiap-patrol.firebaseapp.com",
    projectId: "ssiap-patrol",
    storageBucket: "ssiap-patrol.firebasestorage.app",
    messagingSenderId: "582750096370",
    appId: "1:582750096370:web:025f700bc1bf9194afb96b"
};

let db = null;
let firestoreEnabled = false;

try {
    if (typeof firebase !== 'undefined') {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        firestoreEnabled = true;
        console.log('‚úÖ Firebase OK');
        updateFirebaseStatus(true);
    }
} catch (e) {
    console.log('‚ùå Firebase KO');
    firestoreEnabled = false;
    updateFirebaseStatus(false);
}

function updateFirebaseStatus(connected) {
    setTimeout(() => {
        const el = document.getElementById('firebaseStatus');
        if (el) {
            el.innerHTML = connected ? 
                '<span class="text-green-600"><i class="fas fa-cloud"></i> Connect√©</span>' :
                '<span class="text-red-600"><i class="fas fa-cloud-slash"></i> Hors ligne</span>';
        }
    }, 100);
}

function sauvegarderVersFirebase() {
    if (!firestoreEnabled || !db || !donneesChargees || updateInProgress) return;
    
    const saveData = {
        version: '1.0',
        date: new Date().toISOString(),
        lastModifiedBy: currentUser ? `${currentUser.prenom} ${currentUser.nom}` : 'Syst√®me',
        agents: DB.agents,
        materiels: DB.materiels,
        prisesPoste: DB.prisesPoste,
        rondes: DB.rondes,
        evenements: DB.evenements,
        mainCourante: DB.mainCourante,
        consignes: DB.consignes
    };
    
    db.collection('ssiap-patrol').doc('data').set(saveData)
        .then(() => {
            console.log('üíæ Sauvegarde OK');
            lastKnownVersion = saveData.date;
        })
        .catch(err => console.error('‚ùå Erreur sauvegarde:', err));
}

function chargerDepuisFirebase(callback) {
    if (!firestoreEnabled || !db) {
        donneesChargees = true;
        if (callback) callback();
        return;
    }
    
    db.collection('ssiap-patrol').doc('data').get()
        .then(doc => {
            if (doc.exists) {
                const data = doc.data();
                DB.agents = data.agents || DB.agents;
                DB.materiels = data.materiels || [];
                DB.prisesPoste = data.prisesPoste || [];
                DB.rondes = data.rondes || [];
                DB.evenements = data.evenements || [];
                DB.mainCourante = data.mainCourante || [];
                DB.consignes = data.consignes || [];
                lastKnownVersion = data.date;
                console.log('‚úÖ Donn√©es charg√©es');
            }
            donneesChargees = true;
            if (callback) callback();
            else initLogin();
        })
        .catch(err => {
            console.error('‚ùå Erreur chargement:', err);
            donneesChargees = true;
            if (callback) callback();
            else initLogin();
        });
}

function activerSyncTempsReel() {
    if (!firestoreEnabled || !db) return;
    
    db.collection('ssiap-patrol').doc('data').onSnapshot(doc => {
        if (doc.exists) {
            const data = doc.data();
            const isExternalChange = lastKnownVersion && data.date !== lastKnownVersion;
            
            if (isExternalChange) console.log('üîÑ Changement externe');
            
            updateInProgress = true;
            DB.agents = data.agents || DB.agents;
            DB.materiels = data.materiels || [];
            DB.prisesPoste = data.prisesPoste || [];
            DB.rondes = data.rondes || [];
            DB.evenements = data.evenements || [];
            DB.mainCourante = data.mainCourante || [];
            DB.consignes = data.consignes || [];
            lastKnownVersion = data.date;
            updateInProgress = false;
            
            if (isExternalChange && currentUser && currentView) {
                showToast('üîÑ Donn√©es mises √† jour', 'info');
            }
        }
    });
}

// UTILITIES
const formatDate = d => d ? new Date(d).toLocaleDateString('fr-FR') : '-';
const formatTime = d => d ? new Date(d).toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'}) : '-';
const genId = () => Date.now() + Math.random();

function getAgentsEnPoste() {
    return DB.prisesPoste.filter(p => !p.finPoste).map(p => {
        const agent = DB.agents.find(a => a.id === p.agentId);
        return agent ? { ...agent, prisePosteId: p.id, heureDebut: p.heureDebut } : null;
    }).filter(Boolean);
}

function showToast(message, type = 'success') {
    const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        info: 'bg-blue-500'
    };
    const toast = document.createElement('div');
    toast.className = `fixed bottom-6 right-6 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 fade-in`;
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('open');
    document.getElementById('sidebarOverlay').classList.toggle('hidden');
}

// LOGIN
function initLogin() {
    const sel = document.getElementById('loginAgent');
    sel.innerHTML = '<option value="">S√©lectionner un agent...</option>' +
        DB.agents.filter(a => a.actif).map(a =>
            `<option value="${a.id}">${a.prenom} ${a.nom} - ${a.qualification}</option>`
        ).join('');
}

function genererCodePin(dateDebutContrat) {
    if (!dateDebutContrat) return '0000';
    const d = new Date(dateDebutContrat);
    const base = d.getFullYear() * 10000 + (d.getMonth() + 1) * 100 + d.getDate();
    return ((base * 9301 + 49297) % 10000).toString().padStart(4, '0');
}

function obtenirCodePin(agent) {
    return agent.qualification === 'Administrateur' ? 
        (agent.codePin || '321518') : genererCodePin(agent.dateDebutContrat);
}

function login() {
    const agentId = document.getElementById('loginAgent').value;
    const pwd = document.getElementById('loginPassword').value;
    
    if (!agentId) return showLoginError('S√©lectionnez un agent');
    
    const agent = DB.agents.find(a => String(a.id) === String(agentId));
    if (!agent) return showLoginError('Agent non trouv√©');
    
    if (pwd !== obtenirCodePin(agent)) return showLoginError('Code PIN incorrect');
    
    currentUser = { ...agent };
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('mainApp').classList.remove('hidden');
    document.getElementById('userBadge').innerHTML = 
        `<span class="badge badge-purple">${currentUser.qualification}</span> ${currentUser.prenom}`;
    
    chargerDepuisFirebase(() => {
        console.log('‚úÖ Connexion r√©ussie');
        initApp();
    });
}

function showLoginError(msg) {
    const el = document.getElementById('loginError');
    el.textContent = msg;
    el.classList.remove('hidden');
}

function logout() {
    currentUser = null;
    document.getElementById('mainApp').classList.add('hidden');
    document.getElementById('loginScreen').classList.remove('hidden');
    document.getElementById('loginRondier').classList.add('hidden');
    document.getElementById('loginPassword').value = '';
    document.getElementById('loginError').classList.add('hidden');
}

// RONDIER
function accederModeRondier() {
    afficherLoginRondier();
}

function afficherLoginRondier() {
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('loginRondier').classList.remove('hidden');
    document.getElementById('rondierLoading').classList.remove('hidden');
    document.getElementById('rondierContent').classList.add('hidden');
    
    updateInProgress = true;
    chargerDepuisFirebase(() => {
        updateInProgress = false;
        afficherAgentsRondier();
    });
}

function afficherAgentsRondier() {
    document.getElementById('rondierLoading').classList.add('hidden');
    document.getElementById('rondierContent').classList.remove('hidden');
    
    const agentsEnPoste = getAgentsEnPoste().filter(a => a.qualification === 'SSIAP 1');
    const listContainer = document.getElementById('rondierAgentsList');
    const noAgentContainer = document.getElementById('rondierNoAgent');
    
    if (agentsEnPoste.length === 0) {
        listContainer.innerHTML = '';
        noAgentContainer.classList.remove('hidden');
    } else {
        noAgentContainer.classList.add('hidden');
        listContainer.innerHTML = agentsEnPoste.map(a => `
            <button onclick="loginRondier(${a.id})" class="w-full p-4 bg-gray-50 hover:bg-primary-50 rounded-xl flex items-center gap-4 border-2 border-transparent hover:border-primary-500">
                <div class="w-12 h-12 gradient-header rounded-full flex items-center justify-center text-white font-bold">
                    ${a.prenom.charAt(0)}${a.nom.charAt(0)}
                </div>
                <div class="flex-1 text-left">
                    <div class="font-semibold text-gray-800">${a.prenom} ${a.nom}</div>
                    <div class="text-sm text-gray-500">
                        <span class="badge badge-purple text-xs">${a.qualification}</span>
                    </div>
                </div>
                <i class="fas fa-chevron-right text-gray-400"></i>
            </button>
        `).join('');
    }
}

function rechargerAgentsRondier() {
    afficherLoginRondier();
}

function loginRondier(agentId) {
    const agent = DB.agents.find(a => a.id === agentId);
    if (!agent) return showToast('Agent non trouv√©', 'error');
    
    const prisePoste = DB.prisesPoste.find(p => p.agentId === agentId && !p.finPoste);
    if (!prisePoste) {
        updateInProgress = true;
        chargerDepuisFirebase(() => {
            updateInProgress = false;
            const recheck = DB.prisesPoste.find(p => p.agentId === agentId && !p.finPoste);
            if (!recheck) {
                showToast('Agent non en poste', 'error');
                rechargerAgentsRondier();
            } else {
                connexionRondierOK(agent);
            }
        });
        return;
    }
    
    connexionRondierOK(agent);
}

function connexionRondierOK(agent) {
    currentUser = { ...agent };
    document.getElementById('loginRondier').classList.add('hidden');
    document.getElementById('mainApp').classList.remove('hidden');
    document.getElementById('userBadge').innerHTML = 
        `<span class="badge badge-purple">${currentUser.qualification}</span> ${currentUser.prenom}`;
    initApp();
    showToast(`‚úÖ Bienvenue ${currentUser.prenom} !`);
}

function afficherLoginPrincipal() {
    document.getElementById('loginRondier').classList.add('hidden');
    document.getElementById('loginScreen').classList.remove('hidden');
    initLogin();
}

// NAVIGATION
function navigate(view) {
    currentView = view;
    const c = document.getElementById('mainContent');
    if (c && views[view]) {
        c.innerHTML = '<div class="fade-in">' + views[view]() + '</div>';
    }
    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
    const activeLink = document.querySelector(`[data-view="${view}"]`);
    if (activeLink) activeLink.classList.add('active');
    if (window.innerWidth < 1024) toggleSidebar();
}

// VIEWS
const views = {
    dashboard: () => `
        <h1 class="text-2xl font-bold text-gray-800 mb-6">Tableau de bord</h1>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="card p-6 gradient-header text-white">
                <div class="text-3xl font-bold">${getAgentsEnPoste().length}</div>
                <div class="mt-2">Agents en poste</div>
            </div>
            <div class="card p-6 bg-green-500 text-white">
                <div class="text-3xl font-bold">${DB.rondes.filter(r => r.statut === 'En cours').length}</div>
                <div class="mt-2">Rondes en cours</div>
            </div>
            <div class="card p-6 bg-orange-500 text-white">
                <div class="text-3xl font-bold">${DB.evenements.filter(e => !e.dateFin).length}</div>
                <div class="mt-2">√âv√©nements actifs</div>
            </div>
        </div>
        <div class="card p-6 mt-6">
            <h3 class="font-bold text-lg mb-4">Derni√®res activit√©s</h3>
            ${DB.mainCourante.length === 0 ? 
                '<p class="text-gray-500">Aucune activit√© r√©cente</p>' :
                DB.mainCourante.slice(0, 5).map(m => `
                    <div class="border-l-4 border-primary-500 pl-4 py-2 mb-3">
                        <div class="font-medium">${m.type}</div>
                        <div class="text-sm text-gray-600">${m.description}</div>
                        <div class="text-xs text-gray-500 mt-1">${m.agent} - ${formatTime(m.date)}</div>
                    </div>
                `).join('')
            }
        </div>
    `,
    
    rondes: () => `
        <h1 class="text-2xl font-bold text-gray-800 mb-6">Rondes de s√©curit√©</h1>
        ${DB.rondes.length === 0 ? 
            '<div class="card p-8 text-center text-gray-500">Aucune ronde enregistr√©e</div>' :
            DB.rondes.map(r => `
                <div class="card p-4 mb-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="font-semibold">${r.type || 'Ronde'}</div>
                            <div class="text-sm text-gray-600">Agent: ${r.agent}</div>
                            <div class="text-sm text-gray-600">D√©but: ${formatTime(r.heureDebut)}</div>
                        </div>
                        <span class="badge badge-${r.statut === 'Termin√©' ? 'success' : 'warning'}">${r.statut}</span>
                    </div>
                </div>
            `).join('')
        }
    `,
    
    materiels: () => `
        <h1 class="text-2xl font-bold text-gray-800 mb-6">Mat√©riels incendie</h1>
        ${DB.materiels.length === 0 ?
            '<div class="card p-8 text-center text-gray-500">Aucun mat√©riel enregistr√©</div>' :
            '<div class="card p-6">' + DB.materiels.map(m => `
                <div class="border-b py-3">
                    <div class="font-semibold">${m.nom}</div>
                    <div class="text-sm text-gray-600">Type: ${m.type}</div>
                    <div class="text-sm text-gray-600">Statut: <span class="badge badge-success">${m.statut}</span></div>
                </div>
            `).join('') + '</div>'
        }
    `,
    
    consignes: () => `
        <h1 class="text-2xl font-bold text-gray-800 mb-6">Consignes de s√©curit√©</h1>
        ${DB.consignes.filter(c => c.active).length === 0 ?
            '<div class="card p-8 text-center text-gray-500">Aucune consigne active</div>' :
            DB.consignes.filter(c => c.active).map(c => `
                <div class="card p-6 mb-4">
                    <h3 class="font-bold text-lg mb-2">${c.titre}</h3>
                    <div class="mb-3">
                        <span class="badge badge-${c.priorite === 'Haute' ? 'danger' : 'warning'}">${c.priorite}</span>
                        <span class="badge badge-purple ml-2">${c.niveau}</span>
                    </div>
                    <div class="text-gray-700 whitespace-pre-line">${c.contenu}</div>
                </div>
            `).join('')
        }
    `
};

// INIT APP
function initApp() {
    activerSyncTempsReel();
    
    const navItems = [
        { icon: 'tachometer-alt', label: 'Tableau de bord', view: 'dashboard' },
        { icon: 'route', label: 'Rondes', view: 'rondes' },
        { icon: 'fire-extinguisher', label: 'Mat√©riels', view: 'materiels' },
        { icon: 'file-alt', label: 'Consignes', view: 'consignes' }
    ];
    
    document.getElementById('navMenu').innerHTML = navItems.map(item => `
        <div class="nav-link" data-view="${item.view}" onclick="navigate('${item.view}')">
            <i class="fas fa-${item.icon}"></i>
            <span>${item.label}</span>
        </div>
    `).join('');
    
    document.getElementById('sidebarActions').innerHTML = `
        <button onclick="sauvegarderVersFirebase(); showToast('Synchronis√© !')" class="btn btn-secondary w-full justify-center">
            <i class="fas fa-sync-alt"></i> Synchroniser
        </button>
        <button onclick="logout()" class="btn btn-danger w-full justify-center">
            <i class="fas fa-sign-out-alt"></i> D√©connexion
        </button>
    `;
    
    navigate('dashboard');
}

// INIT
document.addEventListener('DOMContentLoaded', () => {
    // Afficher imm√©diatement les agents disponibles
    initLogin();
    // Puis charger depuis Firebase
    chargerDepuisFirebase();
});
</script>
</body>
</html>
