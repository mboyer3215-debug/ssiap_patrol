<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSIAP Patrol - Gestion S√©curit√© Incendie</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Poppins', 'sans-serif'] },
                    colors: { primary: { 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca' }, accent: { 500: '#8b5cf6', 600: '#7c3aed' } }
                }
            }
        }
    </script>
    <style>
        * { box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .gradient-header { background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 100%); }
        .gradient-success { background: linear-gradient(90deg, #10b981 0%, #34d399 100%); }
        .gradient-warning { background: linear-gradient(90deg, #f59e0b 0%, #fbbf24 100%); }
        .gradient-danger { background: linear-gradient(90deg, #ef4444 0%, #f87171 100%); }
        .gradient-info { background: linear-gradient(90deg, #3b82f6 0%, #60a5fa 100%); }
        .card { background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); overflow: hidden; }
        .dark .card { background: #1e293b; }
        .sidebar { width: 280px; background: white; height: 100vh; position: fixed; left: 0; top: 0; z-index: 50; transition: transform 0.3s; }
        .dark .sidebar { background: #1e293b; }
        .nav-link { display: flex; align-items: center; gap: 12px; padding: 14px 20px; margin: 4px 12px; border-radius: 12px; color: #64748b; font-weight: 500; transition: all 0.2s; cursor: pointer; }
        .nav-link:hover { background: #f1f5f9; color: #6366f1; }
        .nav-link.active { background: linear-gradient(90deg, #6366f1, #8b5cf6); color: white; box-shadow: 0 4px 15px rgba(99,102,241,0.4); }
        .btn { padding: 10px 20px; border-radius: 10px; font-weight: 600; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; cursor: pointer; border: none; }
        .btn-primary { background: linear-gradient(90deg, #6366f1, #8b5cf6); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(99,102,241,0.4); }
        .btn-success { background: linear-gradient(90deg, #10b981, #34d399); color: white; }
        .btn-danger { background: linear-gradient(90deg, #ef4444, #f87171); color: white; }
        .btn-warning { background: linear-gradient(90deg, #f59e0b, #fbbf24); color: white; }
        .btn-secondary { background: #f1f5f9; color: #475569; }
        .dark .btn-secondary { background: #334155; color: #e2e8f0; }
        .btn-sm { padding: 6px 12px; font-size: 13px; }
        .btn-icon { width: 36px; height: 36px; padding: 0; display: flex; align-items: center; justify-content: center; border-radius: 10px; }
        .input { width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 15px; transition: all 0.2s; background: white; }
        .input:focus { outline: none; border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99,102,241,0.1); }
        .dark .input { background: #0f172a; border-color: #334155; color: white; }
        .badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .badge-success { background: #dcfce7; color: #16a34a; }
        .badge-warning { background: #fef3c7; color: #d97706; }
        .badge-danger { background: #fee2e2; color: #dc2626; }
        .badge-info { background: #dbeafe; color: #2563eb; }
        .badge-purple { background: #f3e8ff; color: #9333ea; }
        .badge-gray { background: #f1f5f9; color: #64748b; }
        .stat-card { padding: 20px; border-radius: 16px; text-align: center; }
        .stat-card .icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 12px; font-size: 20px; }
        .stat-card .value { font-size: 28px; font-weight: 700; }
        .stat-card .label { font-size: 13px; color: #64748b; margin-top: 4px; }
        .table { width: 100%; }
        .table th { padding: 14px 16px; text-align: left; font-weight: 600; color: #64748b; font-size: 13px; text-transform: uppercase; border-bottom: 2px solid #e2e8f0; }
        .table td { padding: 16px; border-bottom: 1px solid #f1f5f9; }
        .table tr:hover td { background: #f8fafc; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 100; padding: 20px; backdrop-filter: blur(4px); }
        .modal-content { background: white; border-radius: 20px; max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto; animation: modalIn 0.3s; }
        .dark .modal-content { background: #1e293b; }
        @keyframes modalIn { from { opacity: 0; transform: scale(0.95) translateY(-20px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        .modal-header { padding: 24px 24px 0; }
        .modal-body { padding: 24px; }
        .modal-footer { padding: 0 24px 24px; display: flex; gap: 12px; justify-content: flex-end; }
        .status-dot { width: 14px; height: 14px; border-radius: 50%; display: inline-block; animation: pulse 2s infinite; }
        .status-dot.red { background: #ef4444; box-shadow: 0 0 8px #ef4444; }
        .status-dot.orange { background: #f59e0b; box-shadow: 0 0 8px #f59e0b; }
        .status-dot.green { background: #10b981; box-shadow: 0 0 8px #10b981; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .qr-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
        .qr-card { padding: 15px; border: 2px solid #e2e8f0; border-radius: 12px; text-align: center; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .search-filters { display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 16px; padding: 16px; background: #f8fafc; border-radius: 12px; }
        .search-filters .input { max-width: 200px; }
        .photo-preview { max-width: 100%; max-height: 200px; border-radius: 8px; margin-top: 8px; }
        @media (max-width: 1024px) { .sidebar { transform: translateX(-100%); } .sidebar.open { transform: translateX(0); } .main-content { margin-left: 0 !important; } }
        @media print { .no-print { display: none !important; } .sidebar { display: none !important; } .main-content { margin-left: 0 !important; } }
        .mobile-nav-btn { transition: all 0.2s; }
        .mobile-nav-btn.active { color: #6366f1; }
        #qr-reader { width: 100%; min-height: 250px; }
        #qr-reader video { width: 100% !important; border-radius: 12px; }
    </style>
</head>
<body class="bg-gray-50 dark:bg-slate-900">

<div id="loginScreen" class="gradient-bg min-h-screen flex items-center justify-center p-4">
    <div class="card p-8 w-full max-w-md fade-in">
        <div class="text-center mb-8">
            <div class="w-20 h-20 gradient-header rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg"><i class="fas fa-shield-alt text-white text-3xl"></i></div>
            <h1 class="text-2xl font-bold text-gray-800">SSIAP Patrol</h1>
            <p class="text-gray-500 mt-1">Syst√®me de gestion des rondes</p>
        </div>
        <div class="space-y-5">
            <div><label class="block text-sm font-semibold text-gray-700 mb-2">Agent</label><select id="loginAgent" class="input"><option value="">S√©lectionner...</option></select></div>
            <div><label class="block text-sm font-semibold text-gray-700 mb-2">Code PIN</label><input type="password" id="loginPassword" class="input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="6" inputmode="numeric"></div>
            <div id="loginError" class="text-red-500 text-sm font-medium hidden"></div>
            <button onclick="login()" class="btn btn-primary w-full justify-center py-3"><i class="fas fa-sign-in-alt"></i> Se connecter</button>
            <div class="pt-4 border-t"><button onclick="accederModeRondier()" class="btn btn-secondary w-full justify-center"><i class="fas fa-mobile-alt"></i> Acc√®s Rondier</button></div>
        </div>
    </div>
</div>

<div id="loginRondier" class="gradient-bg min-h-screen flex items-center justify-center p-4 hidden">
    <div class="card p-6 w-full max-w-md fade-in">
        <div class="text-center mb-6"><div class="w-16 h-16 bg-orange-500 rounded-2xl flex items-center justify-center mx-auto mb-4"><i class="fas fa-walking text-white text-2xl"></i></div><h1 class="text-xl font-bold">Connexion Rondier</h1></div>
        <div id="rondierLoading" class="text-center py-8"><i class="fas fa-sync-alt fa-spin text-3xl text-primary-500 mb-4"></i><p class="text-gray-500">Chargement...</p></div>
        <div id="rondierContent" class="space-y-4 hidden"><div id="rondierAgentsList" class="space-y-2"></div><div id="rondierNoAgent" class="text-center py-6 hidden"><i class="fas fa-exclamation-triangle text-yellow-600 text-3xl mb-3"></i><p class="font-medium">Aucun rondier en poste</p><button onclick="rechargerAgentsRondier()" class="btn btn-secondary mt-4"><i class="fas fa-sync-alt"></i> Actualiser</button></div></div>
    </div>
</div>

<div id="mainApp" class="hidden">
    <aside class="sidebar no-print" id="sidebar">
        <div class="p-6 border-b border-gray-100">
            <div class="flex items-center gap-3"><div class="w-12 h-12 gradient-header rounded-xl flex items-center justify-center shadow-lg"><i class="fas fa-shield-alt text-white text-xl"></i></div><div><div class="font-bold text-lg">SSIAP Patrol</div><div class="text-xs text-gray-500" id="userBadge"></div><div class="text-xs" id="firebaseStatus"></div></div></div>
        </div>
        <nav class="py-4 pb-48 overflow-y-auto" id="navMenu"></nav>
        <div class="absolute bottom-0 left-0 right-0 p-4 border-t space-y-2 bg-white" id="sidebarActions"></div>
    </aside>
    <header id="mobileHeader" class="lg:hidden fixed top-0 left-0 right-0 bg-white shadow-md z-40 p-4 flex items-center justify-between no-print"><button onclick="toggleSidebar()" class="btn btn-icon btn-secondary"><i class="fas fa-bars"></i></button><div class="font-bold">SSIAP Patrol</div><button onclick="logout()" class="btn btn-icon btn-secondary"><i class="fas fa-sign-out-alt"></i></button></header>
    <header id="rondierHeader" class="lg:hidden fixed top-0 left-0 right-0 gradient-header text-white z-40 p-3 hidden no-print"><div class="flex items-center justify-between"><div class="flex items-center gap-3"><div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center"><i class="fas fa-walking"></i></div><div><div class="font-semibold text-sm" id="rondierHeaderName">Rondier</div><div class="text-xs opacity-80">En service</div></div></div><button onclick="logout()" class="btn btn-sm bg-white/20 text-white"><i class="fas fa-sign-out-alt"></i></button></div></header>
    <div id="sidebarOverlay" class="fixed inset-0 bg-black/50 z-40 hidden lg:hidden" onclick="toggleSidebar()"></div>
    <main class="main-content lg:ml-[280px] min-h-screen pt-20 lg:pt-0 pb-20 lg:pb-0"><div class="p-6" id="mainContent"></div></main>
    <nav id="mobileNavBar" class="lg:hidden fixed bottom-0 left-0 right-0 bg-white border-t z-50 hidden"><div class="flex justify-around items-center h-16"><button onclick="navigate('rondes')" id="mobileNavRondes" class="mobile-nav-btn flex flex-col items-center justify-center flex-1 h-full text-gray-500"><i class="fas fa-route text-xl mb-1"></i><span class="text-xs">Rondes</span></button><button onclick="navigate('materiels')" id="mobileNavMateriels" class="mobile-nav-btn flex flex-col items-center justify-center flex-1 h-full text-gray-500"><i class="fas fa-fire-extinguisher text-xl mb-1"></i><span class="text-xs">Mat√©riels</span></button><button onclick="navigate('consignes')" id="mobileNavConsignes" class="mobile-nav-btn flex flex-col items-center justify-center flex-1 h-full text-gray-500"><i class="fas fa-file-alt text-xl mb-1"></i><span class="text-xs">Consignes</span></button></div></nav>
</div>

<div id="modalContainer"></div>

<script>
// ===== CONFIGURATION =====
const AGENTS_PAR_DEFAUT = [
    { id: 7, nom: 'Admin', prenom: 'Syst√®me', qualification: 'Administrateur', entreprise: 'SecuriPlus', actif: true, codePin: '321518', dateDebutContrat: '2020-01-01' },
    { id: 1, nom: 'Martin', prenom: 'Jean-Pierre', qualification: 'SSIAP 2', entreprise: 'SecuriPlus', actif: true, dateDebutContrat: '2020-06-01' },
    { id: 2, nom: 'Dupont', prenom: 'Alain', qualification: 'SSIAP 1', entreprise: 'SecuriPlus', actif: true, dateDebutContrat: '2019-04-01' },
    { id: 3, nom: 'Boyer', prenom: 'Michel', qualification: 'SSIAP 1', entreprise: 'SecuriPlus', actif: true, dateDebutContrat: '2018-12-01' },
    { id: 5, nom: 'Garcia', prenom: 'Pierre', qualification: 'SSIAP 1', entreprise: 'SecuriPlus', actif: true, dateDebutContrat: '2020-10-01' },
    { id: 6, nom: 'Leroy', prenom: 'Fran√ßois', qualification: 'SSIAP 3', entreprise: 'SecuriPlus', actif: true, dateDebutContrat: '2017-08-01' }
];

const DB = {
    agents: JSON.parse(JSON.stringify(AGENTS_PAR_DEFAUT)),
    materiels: [
        { id: 1, nom: 'Extincteur CO2 5kg - Hall', type: 'Extincteur', localisation: 'B√¢timent Principal > RDC > Hall', statut: 'Op√©rationnel', codeQR: 'MAT-1' },
        { id: 2, nom: 'RIA DN25 - Couloir 2√®me', type: 'RIA', localisation: 'B√¢timent Principal > 2√®me √©tage > Couloir', statut: 'Op√©rationnel', codeQR: 'MAT-2' },
        { id: 5, nom: 'Extincteur Eau 6L - Cuisine', type: 'Extincteur', localisation: 'B√¢timent Annexe > 1er √©tage > R√©fectoire', statut: 'Op√©rationnel', codeQR: 'MAT-5' }
    ],
    prisesPoste: [],
    rondes: [],
    evenements: [],
    mainCourante: [],
    consignes: []
};

let currentUser = null;
let currentView = 'dashboard';
let modalConfirmCallback = null;
let html5QrScanner = null;

let filtresRondes = { texte: '', statut: '', type: '' };
let filtresMainCourante = { texte: '', type: '', dateDebut: '', dateFin: '' };
let filtresMateriels = { texte: '', type: '', statut: '' };
let filtresQRCodes = { type: '', batiment: '' };

let configEtablissement = {
    nom: "√âtablissement",
    batiments: [
        { id: 'bat1', nom: 'B√¢timent Principal', secteurs: [
            { id: 'bat1-rdc', nom: 'RDC', zones: ['Hall', 'Accueil', 'Couloir'] },
            { id: 'bat1-r1', nom: '1er √©tage', zones: ['Bureaux', 'Sanitaires'] },
            { id: 'bat1-r2', nom: '2√®me √©tage', zones: ['Bureaux', 'Couloir'] }
        ]},
        { id: 'bat2', nom: 'B√¢timent Annexe', secteurs: [
            { id: 'bat2-rdc', nom: 'RDC', zones: ['Entrep√¥t', 'Bureau logistique'] },
            { id: 'bat2-r1', nom: '1er √©tage', zones: ['Atelier', 'R√©fectoire'] }
        ]}
    ]
};

let typesRondes = ['Ronde de s√©curit√©', 'Ronde Extincteurs', 'Ronde RIA', 'Ouverture', 'Fermeture'];

// ===== FIREBASE =====
const firebaseConfig = {
    apiKey: "AIzaSyBXK-4-9HBcTKCPQBdRzDSwTc55vRXWNOk",
    authDomain: "ssiap-patrol.firebaseapp.com",
    projectId: "ssiap-patrol",
    storageBucket: "ssiap-patrol.firebasestorage.app",
    messagingSenderId: "582750096370",
    appId: "1:582750096370:web:025f700bc1bf9194afb96b"
};

let db = null;
let firestoreEnabled = false;
let unsubscribeSync = null;

try {
    firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
    firestoreEnabled = true;
    console.log('‚úÖ Firebase initialis√©');
} catch (e) {
    console.error('‚ùå Firebase init error:', e);
}

function updateFirebaseStatus(connected) {
    const el = document.getElementById('firebaseStatus');
    if (el) {
        el.innerHTML = connected ? 
            '<span class="text-green-600"><i class="fas fa-cloud"></i> Connect√©</span>' : 
            '<span class="text-red-600"><i class="fas fa-cloud-slash"></i> Hors ligne</span>';
    }
}

function sauvegarderVersFirebase() {
    if (!firestoreEnabled || !db) {
        console.log('‚ö†Ô∏è Firebase non disponible');
        return Promise.resolve();
    }
    
    console.log('üíæ Sauvegarde Firebase...');
    
    const saveData = {
        version: '1.0',
        date: new Date().toISOString(),
        agents: DB.agents,
        materiels: DB.materiels,
        prisesPoste: DB.prisesPoste,
        rondes: DB.rondes,
        evenements: DB.evenements,
        mainCourante: DB.mainCourante,
        consignes: DB.consignes,
        configEtablissement,
        typesRondes
    };
    
    return db.collection('ssiap-patrol').doc('data').set(saveData)
        .then(() => {
            console.log('‚úÖ Sauvegard√©! Rondes:', DB.rondes.length, 'MC:', DB.mainCourante.length);
            updateFirebaseStatus(true);
        })
        .catch(err => {
            console.error('‚ùå Erreur:', err);
            updateFirebaseStatus(false);
        });
}

function chargerDepuisFirebase(callback) {
    if (!firestoreEnabled || !db) { 
        console.log('‚ö†Ô∏è Firebase non disponible pour chargement');
        if (callback) callback(); 
        return; 
    }
    
    console.log('üì• Chargement Firebase...');
    
    db.collection('ssiap-patrol').doc('data').get()
        .then(doc => {
            if (doc.exists) {
                const data = doc.data();
                if (data.agents?.length) DB.agents = data.agents;
                if (data.materiels?.length) DB.materiels = data.materiels;
                DB.prisesPoste = data.prisesPoste || [];
                DB.rondes = data.rondes || [];
                DB.evenements = data.evenements || [];
                DB.mainCourante = data.mainCourante || [];
                if (data.consignes?.length) DB.consignes = data.consignes;
                if (data.configEtablissement) configEtablissement = data.configEtablissement;
                if (data.typesRondes) typesRondes = data.typesRondes;
                console.log('‚úÖ Charg√©! Rondes:', DB.rondes.length, 'MC:', DB.mainCourante.length);
                updateFirebaseStatus(true);
            }
            if (callback) callback();
        })
        .catch(err => {
            console.error('‚ùå Erreur chargement:', err);
            updateFirebaseStatus(false);
            if (callback) callback();
        });
}

function activerSyncTempsReel() {
    if (!firestoreEnabled || !db) return;
    
    console.log('üîÑ Activation sync temps r√©el...');
    
    // D√©sabonner l'ancien listener
    if (unsubscribeSync) {
        unsubscribeSync();
    }
    
    unsubscribeSync = db.collection('ssiap-patrol').doc('data').onSnapshot(
        (doc) => {
            if (doc.exists) {
                const data = doc.data();
                console.log('üì• Sync re√ßue - Rondes:', data.rondes?.length, 'MC:', data.mainCourante?.length);
                
                if (data.agents?.length) DB.agents = data.agents;
                if (data.materiels?.length) DB.materiels = data.materiels;
                DB.prisesPoste = data.prisesPoste || [];
                DB.rondes = data.rondes || [];
                DB.evenements = data.evenements || [];
                DB.mainCourante = data.mainCourante || [];
                if (data.consignes?.length) DB.consignes = data.consignes;
                if (data.configEtablissement) configEtablissement = data.configEtablissement;
                if (data.typesRondes) typesRondes = data.typesRondes;
                
                // Rafra√Æchir la vue
                if (currentUser && currentView && views[currentView]) {
                    const c = document.getElementById('mainContent');
                    if (c) c.innerHTML = '<div class="fade-in">' + views[currentView]() + '</div>';
                }
                
                updateFirebaseStatus(true);
            }
        },
        (error) => {
            console.error('‚ùå Erreur sync:', error);
            updateFirebaseStatus(false);
        }
    );
}

// ===== UTILITAIRES =====
const formatDate = d => d ? new Date(d).toLocaleDateString('fr-FR') : '-';
const formatTime = d => d ? new Date(d).toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'}) : '-';
const formatDateTime = d => d ? `${formatDate(d)} ${formatTime(d)}` : '-';
const genId = () => Date.now() + Math.floor(Math.random() * 1000);

function getAgentsEnPoste() {
    return DB.prisesPoste.filter(p => !p.finPoste).map(p => {
        const agent = DB.agents.find(a => a.id === p.agentId);
        return agent ? { ...agent, prisePosteId: p.id, poste: p.poste, heureDebut: p.heureDebut } : null;
    }).filter(Boolean);
}

function getChefDePoste() { 
    return getAgentsEnPoste().find(a => a.poste === 'Chef de poste'); 
}

function addMainCourante(type, description, agentId, extra = {}) {
    const agent = DB.agents.find(a => a.id === agentId);
    const entree = { 
        id: genId(), 
        date: new Date().toISOString(), 
        type, 
        description, 
        agent: agent ? `${agent.prenom} ${agent.nom}` : 'Syst√®me', 
        agentId, 
        ...extra 
    };
    DB.mainCourante.unshift(entree);
    console.log('üìù MC:', type, '-', description);
    return entree;
}

function getStatutCouleurRonde(ronde) {
    if (!ronde.anomalies?.length) return 'green';
    if (ronde.anomalies.some(a => a.horsService)) return 'red';
    return 'orange';
}

function getBadgeClassFromCouleur(c) { 
    return c === 'green' ? 'badge-success' : c === 'orange' ? 'badge-warning' : 'badge-danger'; 
}

function getMainCouranteBadgeClass(type) {
    if (['Alarme', 'Secours', 'Incident'].some(t => type.includes(t))) return 'badge-danger';
    if (['Termin√©'].some(t => type.includes(t))) return 'badge-success';
    if (['Prise', 'Fin', 'D√©part', 'Ronde'].some(t => type.includes(t))) return 'badge-warning';
    return 'badge-info';
}

// ===== LOGIN =====
function initLogin() {
    const sel = document.getElementById('loginAgent');
    if (!sel) return;
    sel.innerHTML = '<option value="">S√©lectionner...</option>' + 
        DB.agents.filter(a => a.actif).map(a => `<option value="${a.id}">${a.prenom} ${a.nom} - ${a.qualification}</option>`).join('');
}

function genererCodePin(dateDebutContrat) {
    if (!dateDebutContrat) return '0000';
    const d = new Date(dateDebutContrat);
    const base = d.getFullYear() * 10000 + (d.getMonth() + 1) * 100 + d.getDate();
    return ((base * 9301 + 49297) % 10000).toString().padStart(4, '0');
}

function obtenirCodePin(agent) {
    if (agent.qualification === 'Administrateur') return agent.codePin || '321518';
    return genererCodePin(agent.dateDebutContrat);
}

function login() {
    const agentId = document.getElementById('loginAgent').value;
    const pwd = document.getElementById('loginPassword').value;
    if (!agentId) return showLoginError('S√©lectionnez un agent');
    const agent = DB.agents.find(a => String(a.id) === agentId);
    if (!agent) return showLoginError('Agent non trouv√©');
    if (pwd !== obtenirCodePin(agent)) return showLoginError('Code PIN incorrect');
    
    currentUser = { ...agent };
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('mainApp').classList.remove('hidden');
    document.getElementById('userBadge').innerHTML = `<span class="badge badge-purple">${currentUser.qualification}</span> ${currentUser.prenom}`;
    initApp();
}

function showLoginError(msg) { 
    const el = document.getElementById('loginError'); 
    el.textContent = msg; 
    el.classList.remove('hidden'); 
}

function logout() {
    currentUser = null;
    if (unsubscribeSync) unsubscribeSync();
    document.getElementById('mainApp').classList.add('hidden');
    if (detecterModeRondier()) afficherLoginRondier(true);
    else { 
        document.getElementById('loginScreen').classList.remove('hidden'); 
        document.getElementById('loginRondier').classList.add('hidden'); 
    }
}

function detecterModeRondier() { 
    return new URLSearchParams(window.location.search).get('mode') === 'rondier'; 
}

function accederModeRondier() { afficherLoginRondier(true); }

function afficherLoginRondier(forceReload) {
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('loginRondier').classList.remove('hidden');
    document.getElementById('mainApp').classList.add('hidden');
    
    if (forceReload) {
        document.getElementById('rondierLoading').classList.remove('hidden');
        document.getElementById('rondierContent').classList.add('hidden');
        chargerDepuisFirebase(() => afficherAgentsRondier());
    } else {
        afficherAgentsRondier();
    }
}

function afficherAgentsRondier() {
    document.getElementById('rondierLoading').classList.add('hidden');
    document.getElementById('rondierContent').classList.remove('hidden');
    
    const agentsEnPoste = getAgentsEnPoste().filter(a => a.qualification === 'SSIAP 1');
    const listContainer = document.getElementById('rondierAgentsList');
    const noAgent = document.getElementById('rondierNoAgent');
    
    if (agentsEnPoste.length === 0) {
        listContainer.innerHTML = '';
        noAgent.classList.remove('hidden');
    } else {
        noAgent.classList.add('hidden');
        listContainer.innerHTML = agentsEnPoste.map(a => `
            <button onclick="loginRondier(${a.id})" class="w-full p-4 bg-gray-50 hover:bg-primary-50 rounded-xl flex items-center gap-4 border-2 border-transparent hover:border-primary-500">
                <div class="w-12 h-12 gradient-header rounded-full flex items-center justify-center text-white font-bold">${a.prenom[0]}${a.nom[0]}</div>
                <div class="flex-1 text-left">
                    <div class="font-semibold">${a.prenom} ${a.nom}</div>
                    <div class="text-sm text-gray-500">En poste depuis ${formatTime(a.heureDebut)}</div>
                </div>
            </button>
        `).join('');
    }
}

function rechargerAgentsRondier() { 
    showToast('üîÑ Actualisation...', 'info'); 
    afficherLoginRondier(true); 
}

function loginRondier(agentId) {
    const agent = DB.agents.find(a => a.id === agentId);
    if (!agent) return showToast('Agent non trouv√©', 'error');
    
    currentUser = { ...agent };
    document.getElementById('loginRondier').classList.add('hidden');
    document.getElementById('mainApp').classList.remove('hidden');
    document.getElementById('userBadge').innerHTML = `<span class="badge badge-purple">${currentUser.qualification}</span> ${currentUser.prenom}`;
    initApp();
    showToast(`Bienvenue ${currentUser.prenom} !`);
}

// ===== NAVIGATION =====
const menuItems = [
    { id: 'dashboard', icon: 'fa-tachometer-alt', label: 'Tableau de bord', roles: ['SSIAP 2', 'SSIAP 3', 'Administrateur'] },
    { id: 'prisePoste', icon: 'fa-user-clock', label: 'Prise de Poste', roles: ['SSIAP 2'] },
    { id: 'rondes', icon: 'fa-route', label: 'Rondes', roles: ['SSIAP 1', 'SSIAP 2', 'SSIAP 3', 'Administrateur'] },
    { id: 'mainCourante', icon: 'fa-clipboard-list', label: 'Main Courante', roles: ['SSIAP 2', 'SSIAP 3', 'Administrateur'] },
    { id: 'materiels', icon: 'fa-fire-extinguisher', label: 'Mat√©riels', roles: ['SSIAP 1', 'SSIAP 2', 'SSIAP 3', 'Administrateur'] },
    { id: 'consignes', icon: 'fa-file-alt', label: 'Consignes', roles: ['SSIAP 1', 'SSIAP 2', 'SSIAP 3', 'Administrateur'] },
    { id: 'administration', icon: 'fa-cogs', label: 'Administration', roles: ['SSIAP 3', 'Administrateur'] }
];

function initApp() { 
    renderNav(); 
    renderSidebarActions(); 
    updateMobileNav();
    activerSyncTempsReel();
    navigate(currentUser?.qualification === 'SSIAP 1' ? 'rondes' : 'dashboard'); 
}

function renderSidebarActions() {
    let html = '';
    if (currentUser?.qualification === 'Administrateur') {
        html += `<button onclick="sauvegarderVersFirebase()" class="btn btn-success w-full justify-center btn-sm"><i class="fas fa-cloud-upload-alt"></i> Sauvegarder</button>`;
    }
    html += `<button onclick="logout()" class="btn btn-secondary w-full justify-center"><i class="fas fa-sign-out-alt"></i> D√©connexion</button>`;
    document.getElementById('sidebarActions').innerHTML = html;
}

function renderNav() {
    document.getElementById('navMenu').innerHTML = menuItems
        .filter(m => m.roles.includes(currentUser?.qualification))
        .map(m => `<div class="nav-link ${currentView === m.id ? 'active' : ''}" onclick="navigate('${m.id}')"><i class="fas ${m.icon} w-5"></i><span>${m.label}</span></div>`).join('');
}

function navigate(view) {
    currentView = view;
    renderNav();
    updateMobileNav();
    const c = document.getElementById('mainContent');
    c.innerHTML = '<div class="fade-in">' + (views[view]?.() || '<p>Vue non disponible</p>') + '</div>';
    
    const sidebar = document.getElementById('sidebar');
    if (sidebar?.classList.contains('open')) {
        sidebar.classList.remove('open');
        document.getElementById('sidebarOverlay')?.classList.add('hidden');
    }
    
    if (view === 'dashboard') {
        setTimeout(() => {
            const qrDiv = document.getElementById('qrCodeAccess');
            if (qrDiv && typeof QRCode !== 'undefined') {
                qrDiv.innerHTML = '';
                new QRCode(qrDiv, { text: window.location.href.split('?')[0] + '?mode=rondier', width: 120, height: 120 });
            }
        }, 100);
    }
}

function toggleSidebar() { 
    document.getElementById('sidebar').classList.toggle('open'); 
    document.getElementById('sidebarOverlay').classList.toggle('hidden'); 
}

function updateMobileNav() {
    const mobileNav = document.getElementById('mobileNavBar');
    const mobileHeader = document.getElementById('mobileHeader');
    const rondierHeader = document.getElementById('rondierHeader');
    
    if (currentUser?.qualification === 'SSIAP 1') {
        mobileNav?.classList.remove('hidden');
        mobileHeader?.classList.add('hidden');
        rondierHeader?.classList.remove('hidden');
        document.getElementById('rondierHeaderName').textContent = `${currentUser.prenom} ${currentUser.nom}`;
        ['rondes', 'materiels', 'consignes'].forEach(id => {
            const btn = document.getElementById('mobileNav' + id.charAt(0).toUpperCase() + id.slice(1));
            if (btn) btn.classList.toggle('active', currentView === id);
        });
    } else {
        mobileNav?.classList.add('hidden');
        mobileHeader?.classList.remove('hidden');
        rondierHeader?.classList.add('hidden');
    }
}

// ===== VIEWS =====
const views = {
    dashboard: renderDashboard,
    prisePoste: renderPrisePoste,
    rondes: renderRondes,
    mainCourante: renderMainCourante,
    materiels: renderMateriels,
    consignes: renderConsignes,
    administration: renderAdministration
};

function renderDashboard() {
    const agentsPoste = getAgentsEnPoste();
    const chef = getChefDePoste();
    const rondesEnCours = DB.rondes.filter(r => !r.heureFin);
    const todayEvents = DB.mainCourante.filter(m => new Date(m.date).toDateString() === new Date().toDateString());

    return `
        <div class="gradient-header text-white p-6 rounded-2xl mb-6 shadow-lg flex flex-wrap items-center justify-between gap-4">
            <div>
                <h1 class="text-2xl font-bold">Tableau de bord SSIAP</h1>
                <p class="opacity-90">${new Date().toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}</p>
            </div>
            <div class="bg-white p-3 rounded-xl no-print">
                <div id="qrCodeAccess"></div>
                <p class="text-center text-xs text-gray-600 mt-2">Acc√®s Rondier</p>
            </div>
        </div>
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="stat-card bg-white"><div class="icon bg-green-100 text-green-600"><i class="fas fa-users"></i></div><div class="value">${agentsPoste.length}</div><div class="label">Agents en poste</div></div>
            <div class="stat-card bg-white"><div class="icon bg-blue-100 text-blue-600"><i class="fas fa-route"></i></div><div class="value">${rondesEnCours.length}</div><div class="label">Rondes en cours</div></div>
            <div class="stat-card bg-white"><div class="icon bg-purple-100 text-purple-600"><i class="fas fa-clipboard-list"></i></div><div class="value">${todayEvents.length}</div><div class="label">Actions aujourd'hui</div></div>
            <div class="stat-card bg-white"><div class="icon bg-orange-100 text-orange-600"><i class="fas fa-fire-extinguisher"></i></div><div class="value">${DB.materiels.length}</div><div class="label">Mat√©riels</div></div>
        </div>
        <div class="grid lg:grid-cols-2 gap-6">
            <div class="card">
                <div class="gradient-success text-white p-4 font-semibold">√âquipe en poste</div>
                <div class="p-4">
                    ${chef ? `<div class="flex items-center gap-3 p-3 bg-yellow-50 rounded-xl mb-3"><div class="w-10 h-10 bg-yellow-500 rounded-xl flex items-center justify-center text-white"><i class="fas fa-crown"></i></div><div><div class="font-semibold">Chef de Poste</div><div class="text-sm text-gray-600">${chef.prenom} ${chef.nom}</div></div></div>` : '<p class="text-gray-500 text-center py-2">Aucun chef de poste</p>'}
                    ${agentsPoste.filter(a => a.poste !== 'Chef de poste').map(a => `<div class="flex items-center gap-3 p-3 hover:bg-gray-50 rounded-xl"><div class="w-10 h-10 bg-primary-500 rounded-xl flex items-center justify-center text-white font-semibold">${a.prenom[0]}${a.nom[0]}</div><div><div class="font-medium">${a.prenom} ${a.nom}</div><div class="text-sm text-gray-500">${a.qualification}</div></div></div>`).join('') || ''}
                </div>
            </div>
            <div class="card">
                <div class="gradient-info text-white p-4 font-semibold">Derni√®res actions</div>
                <div class="p-4 space-y-2 max-h-64 overflow-y-auto">
                    ${todayEvents.slice(0, 10).map(m => `<div class="flex items-center gap-3 p-2 bg-gray-50 rounded-lg"><span class="badge ${getMainCouranteBadgeClass(m.type)}">${m.type}</span><span class="text-sm flex-1">${m.description.substring(0, 40)}...</span><span class="text-xs text-gray-400">${formatTime(m.date)}</span></div>`).join('') || '<p class="text-gray-500 text-center">Aucune action</p>'}
                </div>
            </div>
        </div>
    `;
}

function renderPrisePoste() {
    const agentsPoste = getAgentsEnPoste();
    return `
        <div class="flex items-center justify-between mb-6">
            <h1 class="text-2xl font-bold"><i class="fas fa-user-clock mr-2 text-primary-500"></i>Prise de Poste</h1>
            <button onclick="showModalPrisePoste()" class="btn btn-primary"><i class="fas fa-plus"></i> Nouvelle</button>
        </div>
        <div class="card">
            <div class="gradient-success text-white p-4 font-semibold">Agents en poste (${agentsPoste.length})</div>
            <div class="p-4">
                ${agentsPoste.length ? `<table class="table"><thead><tr><th>Agent</th><th>Poste</th><th>D√©but</th><th>Actions</th></tr></thead><tbody>
                    ${agentsPoste.map(a => `<tr><td>${a.prenom} ${a.nom}</td><td><span class="badge ${a.poste === 'Chef de poste' ? 'badge-warning' : 'badge-success'}">${a.poste}</span></td><td>${formatDateTime(a.heureDebut)}</td><td><button onclick="finPoste(${a.prisePosteId})" class="btn btn-danger btn-sm"><i class="fas fa-stop"></i></button></td></tr>`).join('')}
                </tbody></table>` : '<p class="text-gray-500 text-center py-8">Aucun agent</p>'}
            </div>
        </div>
    `;
}

function showModalPrisePoste() {
    const agentsActifs = DB.agents.filter(a => a.actif && !getAgentsEnPoste().find(p => p.id === a.id));
    const hasChef = getChefDePoste();
    
    showModal('Prise de Poste', `
        <div class="space-y-4">
            <div><label class="block text-sm font-semibold mb-2">Agent</label>
                <select id="ppAgent" class="input">${agentsActifs.map(a => `<option value="${a.id}">${a.prenom} ${a.nom} - ${a.qualification}</option>`).join('')}</select>
            </div>
            <div><label class="block text-sm font-semibold mb-2">Poste</label>
                <select id="ppPoste" class="input">
                    ${!hasChef ? '<option value="Chef de poste">Chef de poste</option>' : ''}
                    <option value="√âquipier">√âquipier</option>
                </select>
            </div>
        </div>
    `, () => {
        const agentId = parseInt(document.getElementById('ppAgent').value);
        const poste = document.getElementById('ppPoste').value;
        if (!agentId) return showToast('S√©lectionnez un agent', 'error');
        
        const pp = { id: genId(), agentId, poste, heureDebut: new Date().toISOString(), finPoste: null };
        DB.prisesPoste.push(pp);
        
        const agent = DB.agents.find(a => a.id === agentId);
        addMainCourante('Prise de Poste', `${poste} - ${agent.prenom} ${agent.nom}`, agentId);
        sauvegarderVersFirebase();
        
        closeModal();
        showToast('‚úÖ Prise de poste enregistr√©e');
        navigate('prisePoste');
    });
}

function finPoste(id) {
    showConfirm('Confirmer la fin de poste ?', () => {
        const pp = DB.prisesPoste.find(p => p.id === id);
        if (pp) {
            pp.finPoste = new Date().toISOString();
            const agent = DB.agents.find(a => a.id === pp.agentId);
            addMainCourante('Fin de Poste', `${agent.prenom} ${agent.nom}`, pp.agentId);
            sauvegarderVersFirebase();
            showToast('‚úÖ Fin de poste');
            navigate('prisePoste');
        }
    });
}

// ===== RONDES =====
const categoriesRonde = [
    { id: 'extincteurs', nom: 'Extincteurs', types: ['Extincteur'] },
    { id: 'ria', nom: 'RIA', types: ['RIA'] }
];

function renderRondes() {
    const isSsiap1 = currentUser?.qualification === 'SSIAP 1';
    const mesRondesEnCours = DB.rondes.filter(r => !r.heureFin && r.agentId === currentUser?.id);
    const stats = { total: DB.rondes.length, enCours: DB.rondes.filter(r => !r.heureFin).length, terminees: DB.rondes.filter(r => r.heureFin).length };
    
    if (isSsiap1) return renderRondesMobile(mesRondesEnCours, stats);
    
    let rondesFiltrees = DB.rondes.filter(r => {
        const matchTexte = !filtresRondes.texte || (r.nom || '').toLowerCase().includes(filtresRondes.texte.toLowerCase());
        const matchStatut = !filtresRondes.statut || (filtresRondes.statut === 'En cours' && !r.heureFin) || (filtresRondes.statut === 'Termin√©e' && r.heureFin);
        return matchTexte && matchStatut;
    });
    
    return `
        <div class="flex items-center justify-between mb-6">
            <div><h1 class="text-2xl font-bold"><i class="fas fa-route mr-2 text-primary-500"></i>Rondes</h1><p class="text-sm text-gray-500">${stats.total} rondes ‚Ä¢ ${stats.enCours} en cours</p></div>
            <button onclick="chargerDepuisFirebase(() => navigate('rondes'))" class="btn btn-secondary"><i class="fas fa-sync-alt"></i> Actualiser</button>
        </div>
        <div class="search-filters no-print">
            <input type="text" class="input" placeholder="üîç Rechercher..." value="${filtresRondes.texte}" onchange="filtresRondes.texte = this.value; navigate('rondes')">
            <select class="input" onchange="filtresRondes.statut = this.value; navigate('rondes')">
                <option value="">Tous</option>
                <option value="En cours" ${filtresRondes.statut === 'En cours' ? 'selected' : ''}>En cours</option>
                <option value="Termin√©e" ${filtresRondes.statut === 'Termin√©e' ? 'selected' : ''}>Termin√©e</option>
            </select>
        </div>
        <div class="grid grid-cols-3 gap-4 mb-6">
            <div class="stat-card bg-white"><div class="text-2xl font-bold text-blue-600">${stats.total}</div><div class="text-xs text-gray-500">Total</div></div>
            <div class="stat-card bg-white"><div class="text-2xl font-bold text-orange-600">${stats.enCours}</div><div class="text-xs text-gray-500">En cours</div></div>
            <div class="stat-card bg-white"><div class="text-2xl font-bold text-green-600">${stats.terminees}</div><div class="text-xs text-gray-500">Termin√©es</div></div>
        </div>
        <div class="card">
            <div class="p-4 space-y-3">
                ${rondesFiltrees.length ? rondesFiltrees.slice(0, 30).map(r => {
                    const agent = DB.agents.find(a => a.id === r.agentId);
                    const pts = r.pointsControle?.filter(p => p.valide).length || 0;
                    const total = r.pointsControle?.length || 0;
                    const pct = total > 0 ? Math.round((pts / total) * 100) : 0;
                    const couleur = getStatutCouleurRonde(r);
                    const hasHS = r.anomalies?.some(a => a.horsService);
                    return `
                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl ${hasHS ? 'border-l-4 border-red-500' : ''}">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="badge ${r.heureFin ? getBadgeClassFromCouleur(couleur) : 'badge-warning'}">${r.heureFin ? 'Termin√©e' : 'En cours'}</span>
                                    <span class="badge badge-info">${r.type}</span>
                                    ${hasHS ? '<span class="badge badge-danger">HS</span>' : ''}
                                </div>
                                <div class="font-medium">${r.nom || r.type}</div>
                                <div class="text-sm text-gray-500">${agent?.prenom || ''} ${agent?.nom || ''} ‚Ä¢ ${formatDateTime(r.heureDebut)}</div>
                                ${total > 0 ? `<div class="mt-2 flex items-center gap-2"><div class="flex-1 bg-gray-200 rounded-full h-2"><div class="bg-${couleur === 'green' ? 'green' : couleur === 'orange' ? 'orange' : 'red'}-500 h-2 rounded-full" style="width:${pct}%"></div></div><span class="text-xs">${pts}/${total}</span></div>` : ''}
                            </div>
                            <button onclick="voirRonde(${r.id})" class="btn btn-secondary btn-sm"><i class="fas fa-eye"></i></button>
                        </div>
                    `;
                }).join('') : '<p class="text-gray-500 text-center py-8">Aucune ronde</p>'}
            </div>
        </div>
    `;
}

function renderRondesMobile(mesRondesEnCours, stats) {
    if (mesRondesEnCours.length > 0) {
        const r = mesRondesEnCours[0];
        const pts = r.pointsControle?.filter(p => p.valide).length || 0;
        const total = r.pointsControle?.length || 0;
        const pct = total > 0 ? Math.round((pts / total) * 100) : 0;
        
        return `
            <div class="space-y-4">
                <div class="bg-gradient-to-r from-yellow-400 to-orange-500 text-white p-5 rounded-2xl shadow-lg">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center animate-pulse"><i class="fas fa-walking text-2xl"></i></div>
                        <div class="flex-1">
                            <div class="font-bold text-lg">${r.nom || r.type}</div>
                            <div class="text-sm opacity-90">${r.zone || ''}</div>
                        </div>
                    </div>
                    <div class="bg-white/20 rounded-full h-4 mb-2"><div class="bg-white h-4 rounded-full" style="width:${pct}%"></div></div>
                    <div class="text-sm text-center mb-4">${pts}/${total} points valid√©s</div>
                    <button onclick="scannerPointControle(${r.id})" class="w-full bg-white text-orange-600 font-bold py-5 rounded-xl flex items-center justify-center gap-3 mb-3">
                        <i class="fas fa-qrcode text-2xl"></i><span class="text-lg">Scanner un point</span>
                    </button>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="voirPointsRonde(${r.id})" class="bg-white/20 text-white font-bold py-3 rounded-xl"><i class="fas fa-list mr-2"></i>Points</button>
                        <button onclick="terminerRonde(${r.id})" class="bg-white/20 text-white font-bold py-3 rounded-xl border-2 border-white/50"><i class="fas fa-flag-checkered mr-2"></i>Terminer</button>
                    </div>
                </div>
            </div>
        `;
    }
    
    return `
        <div class="flex flex-col items-center justify-center min-h-[60vh] space-y-6">
            <button onclick="nouvelleRondeMobile()" class="w-full max-w-sm gradient-header text-white p-8 rounded-3xl shadow-2xl flex flex-col items-center gap-4">
                <div class="w-20 h-20 bg-white/20 rounded-full flex items-center justify-center"><i class="fas fa-play text-4xl"></i></div>
                <div class="text-center">
                    <div class="text-2xl font-bold">Nouvelle Ronde</div>
                    <div class="text-sm opacity-80">Appuyez pour commencer</div>
                </div>
            </button>
            <div class="grid grid-cols-2 gap-4 w-full max-w-sm">
                <div class="card p-4 text-center"><div class="text-3xl font-bold text-green-600">${stats.terminees}</div><div class="text-xs text-gray-500">Termin√©es</div></div>
                <div class="card p-4 text-center"><div class="text-3xl font-bold text-blue-600">${stats.total}</div><div class="text-xs text-gray-500">Total</div></div>
            </div>
        </div>
    `;
}

function nouvelleRondeMobile() {
    if (!DB.prisesPoste.find(p => p.agentId === currentUser?.id && !p.finPoste)) {
        showModal('‚ö†Ô∏è Prise de poste requise', '<p class="text-center">Effectuez votre prise de poste au PC S√©curit√©.</p>', null, 'Compris');
        return;
    }
    
    showModal('Nouvelle Ronde', `
        <div class="space-y-4">
            <button onclick="closeModal(); choisirZoneRonde()" class="w-full p-5 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-2xl flex items-center gap-4">
                <div class="w-14 h-14 bg-white/20 rounded-xl flex items-center justify-center"><i class="fas fa-building text-2xl"></i></div>
                <div class="text-left flex-1"><div class="font-bold text-lg">Ronde Globale</div><div class="text-sm opacity-80">Par zone/secteur</div></div>
            </button>
            <button onclick="closeModal(); choisirCategorieRonde()" class="w-full p-5 bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-2xl flex items-center gap-4">
                <div class="w-14 h-14 bg-white/20 rounded-xl flex items-center justify-center"><i class="fas fa-fire-extinguisher text-2xl"></i></div>
                <div class="text-left flex-1"><div class="font-bold text-lg">Ronde Sp√©cifique</div><div class="text-sm opacity-80">Par type mat√©riel</div></div>
            </button>
        </div>
    `, null, 'Annuler');
}

function choisirZoneRonde() {
    showModal('Choisir zone', `
        <div class="space-y-3">
            <button onclick="closeModal(); demarrerRondeZone('√âtablissement', null, null)" class="w-full p-4 bg-gradient-to-r from-purple-500 to-indigo-600 text-white rounded-xl">
                <i class="fas fa-building mr-2"></i>√âtablissement complet
            </button>
            ${configEtablissement.batiments.map(bat => `
                <button onclick="closeModal(); choisirSecteur('${bat.id}')" class="w-full p-4 bg-gray-50 rounded-xl flex items-center gap-3">
                    <i class="fas fa-building text-blue-600"></i>
                    <div class="flex-1 text-left"><div class="font-medium">${bat.nom}</div><div class="text-xs text-gray-500">${bat.secteurs.length} secteurs</div></div>
                    <i class="fas fa-chevron-right text-gray-300"></i>
                </button>
            `).join('')}
        </div>
    `, null, 'Retour');
}

function choisirSecteur(batimentId) {
    const bat = configEtablissement.batiments.find(b => b.id === batimentId);
    if (!bat) return;
    
    showModal(bat.nom, `
        <div class="space-y-3">
            <button onclick="closeModal(); demarrerRondeZone('${bat.nom}', '${batimentId}', null)" class="w-full p-4 bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-xl">
                <i class="fas fa-layer-group mr-2"></i>Tout le b√¢timent
            </button>
            ${bat.secteurs.map(s => `
                <button onclick="closeModal(); demarrerRondeZone('${bat.nom} > ${s.nom}', '${batimentId}', '${s.id}')" class="w-full p-4 bg-gray-50 rounded-xl flex items-center gap-3">
                    <i class="fas fa-layer-group text-green-600"></i>
                    <div class="flex-1 text-left"><div class="font-medium">${s.nom}</div><div class="text-xs text-gray-500">${s.zones.length} zones</div></div>
                </button>
            `).join('')}
        </div>
    `, null, 'Retour');
}

function demarrerRondeZone(nom, batimentId, secteurId) {
    let points = [];
    
    if (!batimentId) {
        // √âtablissement complet
        configEtablissement.batiments.forEach(bat => {
            bat.secteurs.forEach(sect => {
                sect.zones.forEach(zone => {
                    const qr = `ZONE-${bat.id}-${sect.id}-${zone.toUpperCase().replace(/[^A-Z0-9]/g, '')}`;
                    points.push({ id: genId(), nom: zone, chemin: `${bat.nom} > ${sect.nom}`, qrCode: qr, valide: false });
                });
            });
        });
    } else if (!secteurId) {
        // B√¢timent entier
        const bat = configEtablissement.batiments.find(b => b.id === batimentId);
        bat?.secteurs.forEach(sect => {
            sect.zones.forEach(zone => {
                const qr = `ZONE-${bat.id}-${sect.id}-${zone.toUpperCase().replace(/[^A-Z0-9]/g, '')}`;
                points.push({ id: genId(), nom: zone, chemin: `${bat.nom} > ${sect.nom}`, qrCode: qr, valide: false });
            });
        });
    } else {
        // Secteur sp√©cifique
        const bat = configEtablissement.batiments.find(b => b.id === batimentId);
        const sect = bat?.secteurs.find(s => s.id === secteurId);
        sect?.zones.forEach(zone => {
            const qr = `ZONE-${bat.id}-${sect.id}-${zone.toUpperCase().replace(/[^A-Z0-9]/g, '')}`;
            points.push({ id: genId(), nom: zone, chemin: `${bat.nom} > ${sect.nom}`, qrCode: qr, valide: false });
        });
    }
    
    if (points.length === 0) {
        showToast('Aucun point', 'error');
        return;
    }
    
    const ronde = {
        id: genId(),
        type: 'Ronde de s√©curit√©',
        nom: `Ronde ${nom}`,
        zone: nom,
        agentId: currentUser.id,
        heureDebut: new Date().toISOString(),
        heureFin: null,
        pointsControle: points,
        anomalies: []
    };
    
    DB.rondes.push(ronde);
    addMainCourante('D√©part Ronde', `${ronde.nom} - ${points.length} points`, currentUser.id);
    sauvegarderVersFirebase();
    
    showToast(`üöÄ Ronde d√©marr√©e ! ${points.length} points`);
    navigate('rondes');
}

function choisirCategorieRonde() {
    showModal('Type de mat√©riel', `
        <div class="space-y-2">
            ${categoriesRonde.map(cat => {
                const count = DB.materiels.filter(m => cat.types.some(t => m.type.includes(t))).length;
                return `
                    <button onclick="closeModal(); demarrerRondeMateriels('${cat.id}')" class="w-full p-4 bg-gray-50 rounded-xl flex items-center gap-3 ${count === 0 ? 'opacity-50' : ''}">
                        <i class="fas fa-fire-extinguisher text-orange-600"></i>
                        <div class="flex-1 text-left"><div class="font-medium">${cat.nom}</div><div class="text-xs text-gray-500">${count} mat√©riels</div></div>
                    </button>
                `;
            }).join('')}
        </div>
    `, null, 'Retour');
}

function demarrerRondeMateriels(catId) {
    const cat = categoriesRonde.find(c => c.id === catId);
    if (!cat) return;
    
    const materiels = DB.materiels.filter(m => cat.types.some(t => m.type.includes(t)));
    if (materiels.length === 0) {
        showToast('Aucun mat√©riel', 'error');
        return;
    }
    
    const points = materiels.map(m => ({
        id: genId(),
        nom: m.nom,
        materielId: m.id,
        localisation: m.localisation,
        qrCode: m.codeQR || `MAT-${m.id}`,
        valide: false
    }));
    
    const ronde = {
        id: genId(),
        type: `Ronde ${cat.nom}`,
        nom: `${cat.nom} - √âtablissement`,
        zone: '√âtablissement',
        agentId: currentUser.id,
        heureDebut: new Date().toISOString(),
        heureFin: null,
        pointsControle: points,
        anomalies: []
    };
    
    DB.rondes.push(ronde);
    addMainCourante('D√©part Ronde', `${ronde.nom} - ${points.length} points`, currentUser.id);
    sauvegarderVersFirebase();
    
    showToast(`üöÄ Ronde d√©marr√©e !`);
    navigate('rondes');
}

// ===== SCANNER QR =====
function scannerPointControle(rondeId) {
    const r = DB.rondes.find(x => x.id === rondeId);
    if (!r) return;
    
    const pointsRestants = r.pointsControle.filter(p => !p.valide);
    
    showModal('Scanner un point', `
        <div class="space-y-4">
            <div id="qr-reader"></div>
            <div id="qr-reader-results" class="text-center text-sm min-h-[24px]"></div>
            <div class="flex gap-2">
                <button onclick="demarrerScanQR(${rondeId})" id="btnStartScan" class="btn btn-primary flex-1"><i class="fas fa-camera"></i> D√©marrer</button>
                <button onclick="arreterScanQR()" id="btnStopScan" class="btn btn-danger flex-1 hidden"><i class="fas fa-stop"></i> Arr√™ter</button>
            </div>
            <div class="border-t pt-4">
                <label class="block text-sm font-semibold mb-2">Saisie manuelle</label>
                <div class="flex gap-2">
                    <input type="text" id="qrCodeManuel" class="input flex-1" placeholder="Code QR...">
                    <button onclick="validerQRManuel(${rondeId})" class="btn btn-success"><i class="fas fa-check"></i></button>
                </div>
            </div>
            <div class="border-t pt-4">
                <p class="text-sm font-semibold mb-2">Points restants (${pointsRestants.length})</p>
                <div class="space-y-2 max-h-40 overflow-y-auto">
                    ${pointsRestants.map(p => `
                        <button onclick="ouvrirValidationPoint(${rondeId}, ${p.id})" class="w-full p-2 bg-gray-50 rounded-lg flex items-center gap-3 text-left hover:bg-blue-50">
                            <i class="fas fa-circle text-gray-300 text-xs"></i>
                            <div class="flex-1"><div class="font-medium text-sm">${p.nom}</div><div class="text-xs text-gray-400">${p.chemin || p.localisation || ''}</div></div>
                            <i class="fas fa-chevron-right text-gray-300"></i>
                        </button>
                    `).join('')}
                </div>
            </div>
        </div>
    `, null, 'Fermer');
}

function demarrerScanQR(rondeId) {
    const qrReader = document.getElementById('qr-reader');
    const resultsDiv = document.getElementById('qr-reader-results');
    const btnStart = document.getElementById('btnStartScan');
    const btnStop = document.getElementById('btnStopScan');
    
    if (!qrReader) {
        console.error('Element qr-reader non trouv√©');
        return;
    }
    
    if (typeof Html5Qrcode === 'undefined') {
        resultsDiv.innerHTML = '<span class="text-red-500">Librairie QR non charg√©e</span>';
        return;
    }
    
    btnStart.classList.add('hidden');
    btnStop.classList.remove('hidden');
    resultsDiv.innerHTML = '<span class="text-blue-500"><i class="fas fa-spinner fa-spin mr-1"></i>D√©marrage...</span>';
    
    // Arr√™ter l'ancien scanner
    if (html5QrScanner) {
        try { html5QrScanner.stop(); } catch(e) {}
        html5QrScanner = null;
    }
    
    html5QrScanner = new Html5Qrcode("qr-reader");
    
    const config = {
        fps: 10,
        qrbox: { width: 250, height: 250 },
        aspectRatio: 1.0
    };
    
    html5QrScanner.start(
        { facingMode: "environment" },
        config,
        (decodedText) => {
            console.log('‚úÖ QR SCANN√â:', decodedText);
            resultsDiv.innerHTML = `<span class="text-green-600 font-bold"><i class="fas fa-check-circle mr-1"></i>${decodedText}</span>`;
            
            if (navigator.vibrate) navigator.vibrate(200);
            
            // Arr√™ter et valider
            html5QrScanner.stop().then(() => {
                html5QrScanner = null;
                btnStart.classList.remove('hidden');
                btnStop.classList.add('hidden');
                
                setTimeout(() => validerQRCode(rondeId, decodedText), 500);
            }).catch(() => {
                setTimeout(() => validerQRCode(rondeId, decodedText), 500);
            });
        },
        () => { /* erreurs silencieuses */ }
    ).then(() => {
        resultsDiv.innerHTML = '<span class="text-green-500"><i class="fas fa-camera mr-1"></i>Pointez vers un QR code</span>';
        console.log('üì∑ Scanner actif');
    }).catch((err) => {
        console.error('‚ùå Erreur cam√©ra:', err);
        resultsDiv.innerHTML = `<span class="text-red-500">${err}</span>`;
        btnStart.classList.remove('hidden');
        btnStop.classList.add('hidden');
    });
}

function arreterScanQR() {
    if (html5QrScanner) {
        html5QrScanner.stop().then(() => {
            html5QrScanner = null;
            document.getElementById('btnStartScan')?.classList.remove('hidden');
            document.getElementById('btnStopScan')?.classList.add('hidden');
        }).catch(() => {});
    }
}

function validerQRCode(rondeId, code) {
    console.log('=== VALIDATION QR ===');
    console.log('Code re√ßu:', code);
    
    const r = DB.rondes.find(x => x.id === rondeId);
    if (!r) {
        showToast('‚ùå Ronde non trouv√©e', 'error');
        return;
    }
    
    const codeNorm = code.trim().toUpperCase();
    console.log('Code normalis√©:', codeNorm);
    
    // Afficher tous les codes pour debug
    console.log('Codes disponibles:');
    r.pointsControle.forEach((p, i) => {
        console.log(`  ${i}: "${(p.qrCode || '').toUpperCase()}" - ${p.nom}`);
    });
    
    const point = r.pointsControle.find(p => {
        const qrNorm = (p.qrCode || '').trim().toUpperCase();
        return qrNorm === codeNorm;
    });
    
    if (!point) {
        showToast('‚ùå Code non reconnu', 'error');
        return;
    }
    
    if (point.valide) {
        showToast('‚ö†Ô∏è D√©j√† valid√©', 'warning');
        return;
    }
    
    console.log('‚úÖ Point trouv√©:', point.nom);
    closeModal();
    setTimeout(() => ouvrirValidationPoint(rondeId, point.id), 400);
}

function validerQRManuel(rondeId) {
    const code = document.getElementById('qrCodeManuel')?.value?.trim();
    if (!code) {
        showToast('Entrez un code', 'error');
        return;
    }
    validerQRCode(rondeId, code);
}

function ouvrirValidationPoint(rondeId, pointId) {
    closeModal();
    
    setTimeout(() => {
        const r = DB.rondes.find(x => x.id === rondeId);
        if (!r) return;
        const point = r.pointsControle.find(p => p.id === pointId);
        if (!point) return;
        
        showModal(`Point: ${point.nom}`, `
            <div class="space-y-4">
                <div class="bg-blue-50 p-4 rounded-xl">
                    <div class="font-semibold text-blue-800">${point.nom}</div>
                    <div class="text-sm text-gray-600">${point.chemin || point.localisation || ''}</div>
                    <div class="text-xs text-gray-400 mt-1">QR: ${point.qrCode}</div>
                </div>
                <div class="border-t pt-4">
                    <div class="font-semibold mb-3">√âtat du point</div>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="validerPoint(${rondeId}, ${pointId}, 'OK')" class="p-4 bg-green-100 rounded-xl text-center hover:ring-2 hover:ring-green-500">
                            <i class="fas fa-check-circle text-green-600 text-2xl mb-2"></i>
                            <div class="text-sm font-medium text-green-700">Conforme</div>
                        </button>
                        <button onclick="validerPoint(${rondeId}, ${pointId}, 'Anomalie')" class="p-4 bg-orange-100 rounded-xl text-center hover:ring-2 hover:ring-orange-500">
                            <i class="fas fa-exclamation-triangle text-orange-600 text-2xl mb-2"></i>
                            <div class="text-sm font-medium text-orange-700">Anomalie</div>
                        </button>
                        <button onclick="validerPoint(${rondeId}, ${pointId}, 'HS')" class="p-4 bg-red-100 rounded-xl text-center hover:ring-2 hover:ring-red-500">
                            <i class="fas fa-ban text-red-600 text-2xl mb-2"></i>
                            <div class="text-sm font-medium text-red-700">Hors Service</div>
                        </button>
                    </div>
                </div>
            </div>
        `, null, 'Annuler');
    }, 400);
}

function validerPoint(rondeId, pointId, statut) {
    const r = DB.rondes.find(x => x.id === rondeId);
    if (!r) return;
    const point = r.pointsControle.find(p => p.id === pointId);
    if (!point) return;
    
    if (statut === 'OK') {
        point.valide = true;
        point.heureValidation = new Date().toISOString();
        point.statut = 'OK';
        
        sauvegarderVersFirebase();
        closeModal();
        showToast(`‚úÖ ${point.nom} valid√© !`);
        if (navigator.vibrate) navigator.vibrate(200);
        navigate('rondes');
    } else {
        // Anomalie ou HS - demander description
        const horsService = statut === 'HS';
        const couleur = horsService ? 'red' : 'orange';
        
        closeModal();
        setTimeout(() => {
            showModal(horsService ? 'üö´ Hors Service' : '‚ö†Ô∏è Anomalie', `
                <div class="space-y-4">
                    <div class="bg-${couleur}-50 p-4 rounded-xl">
                        <div class="font-semibold text-${couleur}-700">${point.nom}</div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Description *</label>
                        <textarea id="anomalieDesc" class="input" rows="3" placeholder="D√©crivez..."></textarea>
                    </div>
                </div>
            `, () => {
                const desc = document.getElementById('anomalieDesc').value.trim();
                if (!desc) {
                    showToast('Description requise', 'error');
                    return;
                }
                
                point.valide = true;
                point.heureValidation = new Date().toISOString();
                point.statut = statut;
                
                if (!r.anomalies) r.anomalies = [];
                r.anomalies.push({
                    id: genId(),
                    pointId,
                    pointNom: point.nom,
                    description: desc,
                    horsService,
                    date: new Date().toISOString(),
                    agentId: currentUser.id
                });
                
                addMainCourante('Anomalie Ronde', `${horsService ? 'üî¥ HS' : 'üü†'} - ${point.nom}: ${desc}`, currentUser.id);
                sauvegarderVersFirebase();
                
                closeModal();
                showToast(horsService ? 'üö´ HS signal√©' : '‚ö†Ô∏è Anomalie signal√©e', horsService ? 'error' : 'warning');
                if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
                navigate('rondes');
            }, 'Enregistrer');
        }, 400);
    }
}

function voirPointsRonde(rondeId) {
    const r = DB.rondes.find(x => x.id === rondeId);
    if (!r) return;
    
    const valides = r.pointsControle.filter(p => p.valide);
    const nonValides = r.pointsControle.filter(p => !p.valide);
    
    showModal('Points de contr√¥le', `
        <div class="space-y-4 max-h-96 overflow-y-auto">
            ${nonValides.length ? `
                <div>
                    <h3 class="text-sm font-bold text-red-600 mb-2">√Ä valider (${nonValides.length})</h3>
                    <div class="space-y-2">
                        ${nonValides.map(p => `
                            <button onclick="ouvrirValidationPoint(${rondeId}, ${p.id})" class="w-full p-3 bg-red-50 rounded-lg flex items-center gap-3 text-left">
                                <i class="fas fa-times-circle text-red-400"></i>
                                <div class="flex-1"><div class="font-medium text-sm">${p.nom}</div></div>
                            </button>
                        `).join('')}
                    </div>
                </div>
            ` : ''}
            ${valides.length ? `
                <div>
                    <h3 class="text-sm font-bold text-green-600 mb-2">Valid√©s (${valides.length})</h3>
                    <div class="space-y-2">
                        ${valides.map(p => {
                            const a = r.anomalies?.find(x => x.pointId === p.id);
                            const c = a ? (a.horsService ? 'red' : 'orange') : 'green';
                            return `
                                <div class="p-3 bg-${c}-50 rounded-lg flex items-center gap-3">
                                    <i class="fas fa-${a?.horsService ? 'ban' : a ? 'exclamation-triangle' : 'check-circle'} text-${c}-500"></i>
                                    <div class="flex-1"><div class="font-medium text-sm">${p.nom}</div></div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            ` : ''}
        </div>
    `, null, 'Fermer');
}

function terminerRonde(rondeId) {
    const r = DB.rondes.find(x => x.id === rondeId);
    if (!r) return;
    
    const pts = r.pointsControle.filter(p => p.valide).length;
    const total = r.pointsControle.length;
    const hasHS = r.anomalies?.some(a => a.horsService);
    const hasAnomalies = r.anomalies?.length > 0;
    
    showModal('Terminer la ronde', `
        <div class="space-y-4">
            <div class="bg-${hasHS ? 'red' : hasAnomalies ? 'orange' : 'green'}-50 p-4 rounded-lg">
                <div class="font-bold">${hasHS ? 'üö´ HS signal√©' : hasAnomalies ? '‚ö†Ô∏è Anomalies' : '‚úÖ Tout OK'}</div>
                <div class="text-sm">${pts}/${total} points valid√©s</div>
            </div>
            <div>
                <label class="block text-sm font-semibold mb-2">Observation (optionnel)</label>
                <textarea id="obsFin" class="input" rows="3"></textarea>
            </div>
        </div>
    `, () => {
        r.heureFin = new Date().toISOString();
        r.observationFin = document.getElementById('obsFin').value;
        
        const duree = Math.round((new Date(r.heureFin) - new Date(r.heureDebut)) / 60000);
        addMainCourante('Fin Ronde', `${hasHS ? 'üî¥ HS' : hasAnomalies ? 'üü†' : 'üü¢ OK'} ${r.nom} (${pts}/${total}, ${duree}min)`, r.agentId);
        sauvegarderVersFirebase();
        
        closeModal();
        showToast('‚úÖ Ronde termin√©e');
        navigate('rondes');
    });
}

function voirRonde(id) {
    const r = DB.rondes.find(x => x.id === id);
    if (!r) return;
    
    const agent = DB.agents.find(a => a.id === r.agentId);
    const pts = r.pointsControle?.filter(p => p.valide).length || 0;
    const total = r.pointsControle?.length || 0;
    
    showModal('D√©tails Ronde', `
        <div class="space-y-4 max-h-[70vh] overflow-y-auto">
            <div class="flex items-center justify-between">
                <h3 class="text-xl font-bold">${r.nom || r.type}</h3>
                <span class="badge ${r.heureFin ? 'badge-success' : 'badge-warning'}">${r.heureFin ? 'Termin√©e' : 'En cours'}</span>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-gray-50 p-3 rounded-lg"><div class="text-xs text-gray-500">Agent</div><div class="font-medium">${agent?.prenom || ''} ${agent?.nom || ''}</div></div>
                <div class="bg-gray-50 p-3 rounded-lg"><div class="text-xs text-gray-500">Points</div><div class="font-medium">${pts}/${total}</div></div>
                <div class="bg-gray-50 p-3 rounded-lg"><div class="text-xs text-gray-500">D√©but</div><div class="font-medium">${formatDateTime(r.heureDebut)}</div></div>
                <div class="bg-gray-50 p-3 rounded-lg"><div class="text-xs text-gray-500">Fin</div><div class="font-medium">${r.heureFin ? formatDateTime(r.heureFin) : '-'}</div></div>
            </div>
            ${r.anomalies?.length ? `
                <div class="bg-orange-50 p-4 rounded-lg">
                    <div class="font-bold mb-2">‚ö†Ô∏è Anomalies (${r.anomalies.length})</div>
                    <ul class="text-sm space-y-1">
                        ${r.anomalies.map(a => `<li><i class="fas fa-${a.horsService ? 'ban text-red-500' : 'exclamation-triangle text-orange-500'} mr-1"></i>${a.pointNom}: ${a.description}</li>`).join('')}
                    </ul>
                </div>
            ` : ''}
        </div>
    `, null, 'Fermer');
}

// ===== MAIN COURANTE =====
function renderMainCourante() {
    let entrees = DB.mainCourante.filter(m => {
        const matchTexte = !filtresMainCourante.texte || m.description.toLowerCase().includes(filtresMainCourante.texte.toLowerCase());
        const matchType = !filtresMainCourante.type || m.type === filtresMainCourante.type;
        return matchTexte && matchType;
    });
    
    const types = [...new Set(DB.mainCourante.map(m => m.type))];
    
    return `
        <div class="flex items-center justify-between mb-6">
            <h1 class="text-2xl font-bold"><i class="fas fa-clipboard-list mr-2 text-primary-500"></i>Main Courante</h1>
            <button onclick="chargerDepuisFirebase(() => navigate('mainCourante'))" class="btn btn-secondary"><i class="fas fa-sync-alt"></i></button>
        </div>
        <div class="search-filters">
            <input type="text" class="input" placeholder="üîç Rechercher..." value="${filtresMainCourante.texte}" onchange="filtresMainCourante.texte = this.value; navigate('mainCourante')">
            <select class="input" onchange="filtresMainCourante.type = this.value; navigate('mainCourante')">
                <option value="">Tous</option>
                ${types.map(t => `<option value="${t}" ${filtresMainCourante.type === t ? 'selected' : ''}>${t}</option>`).join('')}
            </select>
        </div>
        <div class="card">
            <div class="gradient-header text-white p-4 font-semibold">√âv√©nements (${entrees.length})</div>
            <div class="overflow-x-auto">
                <table class="table">
                    <thead><tr><th>Date/Heure</th><th>Type</th><th>Description</th><th>Agent</th></tr></thead>
                    <tbody>
                        ${entrees.length ? entrees.slice(0, 100).map(m => `
                            <tr>
                                <td class="whitespace-nowrap">${formatDateTime(m.date)}</td>
                                <td><span class="badge ${getMainCouranteBadgeClass(m.type)}">${m.type}</span></td>
                                <td>${m.description}</td>
                                <td>${m.agent}</td>
                            </tr>
                        `).join('') : '<tr><td colspan="4" class="text-center py-8 text-gray-500">Aucun √©v√©nement</td></tr>'}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

// ===== MATERIELS =====
function renderMateriels() {
    const mats = DB.materiels.filter(m => {
        const matchTexte = !filtresMateriels.texte || m.nom.toLowerCase().includes(filtresMateriels.texte.toLowerCase());
        const matchType = !filtresMateriels.type || m.type === filtresMateriels.type;
        return matchTexte && matchType;
    });
    
    const types = [...new Set(DB.materiels.map(m => m.type))];
    
    return `
        <div class="flex items-center justify-between mb-6">
            <h1 class="text-2xl font-bold"><i class="fas fa-fire-extinguisher mr-2 text-primary-500"></i>Mat√©riels</h1>
        </div>
        <div class="search-filters">
            <input type="text" class="input" placeholder="üîç Rechercher..." value="${filtresMateriels.texte}" onchange="filtresMateriels.texte = this.value; navigate('materiels')">
            <select class="input" onchange="filtresMateriels.type = this.value; navigate('materiels')">
                <option value="">Tous types</option>
                ${types.map(t => `<option value="${t}" ${filtresMateriels.type === t ? 'selected' : ''}>${t}</option>`).join('')}
            </select>
        </div>
        <div class="card">
            <div class="overflow-x-auto">
                <table class="table">
                    <thead><tr><th>Mat√©riel</th><th>Type</th><th>Localisation</th><th>Statut</th><th>QR</th></tr></thead>
                    <tbody>
                        ${mats.map(m => `
                            <tr>
                                <td class="font-medium">${m.nom}</td>
                                <td><span class="badge badge-info">${m.type}</span></td>
                                <td class="text-sm text-gray-600">${m.localisation || '-'}</td>
                                <td><span class="badge ${m.statut === 'Op√©rationnel' ? 'badge-success' : 'badge-danger'}">${m.statut}</span></td>
                                <td class="text-xs font-mono text-gray-400">${m.codeQR || '-'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

// ===== CONSIGNES =====
function renderConsignes() {
    return `
        <div class="mb-6"><h1 class="text-2xl font-bold"><i class="fas fa-file-alt mr-2 text-primary-500"></i>Consignes</h1></div>
        <div class="card p-6">
            ${DB.consignes.length ? DB.consignes.map(c => `
                <div class="p-4 bg-orange-50 rounded-xl mb-3 border-l-4 border-orange-500">
                    <div class="font-semibold">${c.titre}</div>
                    <p class="text-sm text-gray-600 mt-1">${c.contenu}</p>
                </div>
            `).join('') : '<p class="text-gray-500 text-center">Aucune consigne</p>'}
        </div>
    `;
}

// ===== ADMINISTRATION =====
let adminTab = 'donnees';

function renderAdministration() {
    return `
        <div class="mb-6"><h1 class="text-2xl font-bold"><i class="fas fa-cogs mr-2 text-primary-500"></i>Administration</h1></div>
        <div class="card p-6 space-y-6">
            <div>
                <h2 class="text-lg font-bold mb-4">Synchronisation Firebase</h2>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="sauvegarderVersFirebase()" class="btn btn-success py-4"><i class="fas fa-cloud-upload-alt mr-2"></i>Sauvegarder</button>
                    <button onclick="chargerDepuisFirebase(() => { showToast('‚úÖ Charg√©'); navigate('administration'); })" class="btn btn-primary py-4"><i class="fas fa-cloud-download-alt mr-2"></i>Charger</button>
                </div>
            </div>
            <div class="border-t pt-6">
                <h2 class="text-lg font-bold mb-4">Statistiques</h2>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div class="bg-gray-50 p-3 rounded-lg">Agents: <strong>${DB.agents.length}</strong></div>
                    <div class="bg-gray-50 p-3 rounded-lg">Mat√©riels: <strong>${DB.materiels.length}</strong></div>
                    <div class="bg-gray-50 p-3 rounded-lg">Rondes: <strong>${DB.rondes.length}</strong></div>
                    <div class="bg-gray-50 p-3 rounded-lg">Main courante: <strong>${DB.mainCourante.length}</strong></div>
                </div>
            </div>
            <div class="border-t pt-6">
                <h2 class="text-lg font-bold mb-4 text-red-600">Zone danger</h2>
                <button onclick="reinitialiser()" class="btn btn-danger"><i class="fas fa-trash mr-2"></i>R√©initialiser les donn√©es</button>
            </div>
        </div>
    `;
}

function reinitialiser() {
    showConfirm('‚ö†Ô∏è Supprimer toutes les rondes et main courante ?', () => {
        DB.prisesPoste = [];
        DB.rondes = [];
        DB.mainCourante = [];
        DB.evenements = [];
        sauvegarderVersFirebase();
        showToast('üóëÔ∏è R√©initialis√©');
        navigate('administration');
    });
}

// ===== MODALS =====
function showModal(title, content, onConfirm, confirmText = 'Confirmer') {
    modalConfirmCallback = onConfirm;
    document.getElementById('modalContainer').innerHTML = `
        <div class="modal-overlay" onclick="if(event.target === this) closeModal()">
            <div class="modal-content">
                <div class="modal-header"><h2 class="text-xl font-bold">${title}</h2></div>
                <div class="modal-body">${content}</div>
                <div class="modal-footer">
                    <button onclick="closeModal()" class="btn btn-secondary">Annuler</button>
                    ${onConfirm ? `<button onclick="modalConfirmCallback?.()" class="btn btn-primary">${confirmText}</button>` : ''}
                </div>
            </div>
        </div>
    `;
}

function closeModal() { 
    document.getElementById('modalContainer').innerHTML = ''; 
    modalConfirmCallback = null; 
    arreterScanQR(); 
}

function showConfirm(msg, onConfirm) { 
    showModal('Confirmation', `<p class="text-gray-600">${msg}</p>`, onConfirm, 'Confirmer'); 
}

function showToast(msg, type = 'success') {
    const colors = { success: 'bg-green-500', error: 'bg-red-500', warning: 'bg-orange-500', info: 'bg-blue-500' };
    const toast = document.createElement('div');
    toast.className = `fixed top-20 left-1/2 transform -translate-x-1/2 ${colors[type]} text-white px-6 py-3 rounded-xl shadow-lg z-[200]`;
    toast.textContent = msg;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

// ===== INIT =====
document.addEventListener('DOMContentLoaded', () => {
    console.log('üöÄ D√©marrage SSIAP Patrol');
    
    chargerDepuisFirebase(() => {
        initLogin();
        
        if (detecterModeRondier()) {
            afficherLoginRondier(false);
        }
        
        updateFirebaseStatus(firestoreEnabled);
    });
});

document.addEventListener('keydown', e => { 
    if (e.key === 'Enter' && !document.getElementById('loginScreen')?.classList.contains('hidden')) login(); 
});
</script>
</body>
</html>
