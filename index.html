// ========== ADMINISTRATION ==========
let adminTab = 'etablissement';

function renderAdministration() {
    return `
        <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
            <h1 class="text-2xl font-bold"><i class="fas fa-cogs mr-2 text-primary-500"></i>Administration</h1>
        </div>

        <div class="flex flex-wrap gap-2 mb-6">
            <button onclick="adminTab='etablissement'; navigate('administration')" class="btn ${adminTab === 'etablissement' ? 'btn-primary' : 'btn-secondary'}">
                <i class="fas fa-building mr-1"></i>√âtablissement
            </button>
            <button onclick="adminTab='typesRondes'; navigate('administration')" class="btn ${adminTab === 'typesRondes' ? 'btn-primary' : 'btn-secondary'}">
                <i class="fas fa-route mr-1"></i>Types de Rondes
            </button>
            <button onclick="adminTab='qrcodes'; navigate('administration')" class="btn ${adminTab === 'qrcodes' ? 'btn-primary' : 'btn-secondary'}">
                <i class="fas fa-qrcode mr-1"></i>QR Codes
            </button>
            <button onclick="adminTab='donnees'; navigate('administration')" class="btn ${adminTab === 'donnees' ? 'btn-primary' : 'btn-secondary'}">
                <i class="fas fa-database mr-1"></i>Donn√©es
            </button>
        </div>

        <div class="card">
            <div class="p-6">
                ${adminTab === 'etablissement' ? renderAdminEtablissement() : ''}
                ${adminTab === 'typesRondes' ? renderAdminTypesRondes() : ''}
                ${adminTab === 'qrcodes' ? renderAdminQRCodes() : ''}
                ${adminTab === 'donnees' ? renderAdminDonnees() : ''}
            </div>
        </div>
    `;
}

// ========== ADMIN - √âTABLISSEMENT (B√¢timents, Secteurs, Zones) ==========
function renderAdminEtablissement() {
    return `
        <div class="space-y-6">
            <div class="flex items-center justify-between">
                <h2 class="text-xl font-bold"><i class="fas fa-building mr-2"></i>Configuration de l'√©tablissement</h2>
                <button onclick="ajouterBatiment()" class="btn btn-primary btn-sm"><i class="fas fa-plus mr-1"></i>Ajouter B√¢timent</button>
            </div>

            <div class="space-y-4">
                ${configEtablissement.batiments.map(bat => `
                    <div class="border-2 border-gray-200 dark:border-slate-600 rounded-xl overflow-hidden">
                        <!-- En-t√™te B√¢timent -->
                        <div class="bg-blue-50 dark:bg-blue-900/30 p-4 flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-building text-blue-600 text-xl"></i>
                                <div>
                                    <div class="font-bold text-lg">${bat.nom}</div>
                                    <div class="text-sm text-gray-500">${bat.secteurs.length} secteur(s)</div>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="ajouterSecteur('${bat.id}')" class="btn btn-success btn-sm" title="Ajouter un secteur">
                                    <i class="fas fa-layer-group mr-1"></i>+ Secteur
                                </button>
                                <button onclick="modifierBatiment('${bat.id}')" class="btn btn-secondary btn-sm" title="Modifier">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="supprimerBatiment('${bat.id}')" class="btn btn-danger btn-sm" title="Supprimer">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Secteurs du b√¢timent -->
                        <div class="p-4 space-y-3">
                            ${bat.secteurs.length ? bat.secteurs.map(sect => `
                                <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="flex items-center gap-2">
                                            <i class="fas fa-layer-group text-green-600"></i>
                                            <span class="font-semibold">${sect.nom}</span>
                                            <span class="badge badge-success">${sect.zones.length} zone(s)</span>
                                        </div>
                                        <div class="flex gap-1">
                                            <button onclick="ajouterZone('${bat.id}', '${sect.id}')" class="btn btn-warning btn-sm" title="Ajouter une zone">
                                                <i class="fas fa-map-marker-alt mr-1"></i>+ Zone
                                            </button>
                                            <button onclick="modifierSecteur('${bat.id}', '${sect.id}')" class="btn btn-secondary btn-sm" title="Modifier">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button onclick="supprimerSecteur('${bat.id}', '${sect.id}')" class="btn btn-danger btn-sm" title="Supprimer">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Zones du secteur -->
                                    ${sect.zones.length ? `
                                        <div class="flex flex-wrap gap-2 mt-2 pl-6">
                                            ${sect.zones.map(zone => `
                                                <div class="bg-yellow-100 dark:bg-yellow-900/30 px-3 py-1 rounded-full text-sm flex items-center gap-2">
                                                    <i class="fas fa-map-pin text-yellow-600 text-xs"></i>
                                                    <span>${zone}</span>
                                                    <button onclick="supprimerZone('${bat.id}', '${sect.id}', '${zone.replace(/'/g, "\\'")}')" class="text-red-500 hover:text-red-700 ml-1" title="Supprimer">
                                                        <i class="fas fa-times text-xs"></i>
                                                    </button>
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : `
                                        <div class="text-sm text-gray-500 italic pl-6">Aucune zone - <button onclick="ajouterZone('${bat.id}', '${sect.id}')" class="text-primary-500 underline">Ajouter une zone</button></div>
                                    `}
                                </div>
                            `).join('') : `
                                <div class="text-center text-gray-500 py-4">
                                    <i class="fas fa-layer-group text-3xl text-gray-300 mb-2"></i>
                                    <p>Aucun secteur dans ce b√¢timent</p>
                                    <button onclick="ajouterSecteur('${bat.id}')" class="btn btn-success btn-sm mt-2">
                                        <i class="fas fa-plus mr-1"></i>Ajouter un secteur
                                    </button>
                                </div>
                            `}
                        </div>
                    </div>
                `).join('')}

                ${configEtablissement.batiments.length === 0 ? `
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-building text-4xl text-gray-300 mb-4"></i>
                        <p class="mb-4">Aucun b√¢timent configur√©</p>
                        <button onclick="ajouterBatiment()" class="btn btn-primary">
                            <i class="fas fa-plus mr-1"></i>Ajouter un b√¢timent
                        </button>
                    </div>
                ` : ''}
            </div>
        </div>
    `;
}

// ========== FONCTIONS GESTION B√ÇTIMENTS ==========
function ajouterBatiment() {
    showModal('Nouveau B√¢timent', `
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-semibold mb-2"><i class="fas fa-building mr-1"></i>Nom du b√¢timent *</label>
                <input type="text" id="batNom" class="input" placeholder="Ex: B√¢timent A, Tour Nord...">
            </div>
            <div class="bg-blue-50 dark:bg-blue-900/30 p-3 rounded-lg text-sm text-blue-700 dark:text-blue-400">
                <i class="fas fa-info-circle mr-1"></i>
                Apr√®s avoir cr√©√© le b√¢timent, vous pourrez y ajouter des secteurs et des zones.
            </div>
        </div>
    `, () => {
        const nom = document.getElementById('batNom').value.trim();
        if (!nom) return showToast('Entrez un nom', 'error');

        const id = 'bat-' + Date.now();
        configEtablissement.batiments.push({
            id: id,
            nom: nom,
            secteurs: []
        });

        addMainCourante('Administration', `Cr√©ation b√¢timent: ${nom}`, currentUser?.id);
        sauvegarderVersFirebase();
        closeModal();
        showToast('‚úÖ B√¢timent cr√©√©');
        navigate('administration');
    });
}

function modifierBatiment(batimentId) {
    const bat = configEtablissement.batiments.find(b => b.id === batimentId);
    if (!bat) return;

    showModal('Modifier B√¢timent', `
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-semibold mb-2"><i class="fas fa-building mr-1"></i>Nom du b√¢timent *</label>
                <input type="text" id="batNomEdit" class="input" value="${bat.nom}">
            </div>
        </div>
    `, () => {
        const nom = document.getElementById('batNomEdit').value.trim();
        if (!nom) return showToast('Entrez un nom', 'error');

        const ancienNom = bat.nom;
        bat.nom = nom;

        addMainCourante('Administration', `Modification b√¢timent: ${ancienNom} ‚Üí ${nom}`, currentUser?.id);
        sauvegarderVersFirebase();
        closeModal();
        showToast('‚úÖ B√¢timent modifi√©');
        navigate('administration');
    });
}

function supprimerBatiment(batimentId) {
    const bat = configEtablissement.batiments.find(b => b.id === batimentId);
    if (!bat) return;

    const nbSecteurs = bat.secteurs.length;
    const nbZones = bat.secteurs.reduce((acc, s) => acc + s.zones.length, 0);

    showConfirm(`Supprimer "${bat.nom}" ?\n\nCela supprimera √©galement ${nbSecteurs} secteur(s) et ${nbZones} zone(s).`, () => {
        configEtablissement.batiments = configEtablissement.batiments.filter(b => b.id !== batimentId);
        addMainCourante('Administration', `Suppression b√¢timent: ${bat.nom}`, currentUser?.id);
        sauvegarderVersFirebase();
        showToast('üóëÔ∏è B√¢timent supprim√©');
        navigate('administration');
    });
}

// ========== FONCTIONS GESTION SECTEURS ==========
function ajouterSecteur(batimentId) {
    const bat = configEtablissement.batiments.find(b => b.id === batimentId);
    if (!bat) return;

    showModal(`Nouveau Secteur - ${bat.nom}`, `
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-semibold mb-2"><i class="fas fa-layer-group mr-1"></i>Nom du secteur *</label>
                <input type="text" id="sectNom" class="input" placeholder="Ex: RDC, 1er √©tage, Sous-sol...">
            </div>
            <div class="bg-green-50 dark:bg-green-900/30 p-3 rounded-lg text-sm text-green-700 dark:text-green-400">
                <i class="fas fa-info-circle mr-1"></i>
                Un secteur regroupe plusieurs zones (pi√®ces, couloirs, etc.)
            </div>
        </div>
    `, () => {
        const nom = document.getElementById('sectNom').value.trim();
        if (!nom) return showToast('Entrez un nom', 'error');

        const id = `${batimentId}-sect-${Date.now()}`;
        bat.secteurs.push({
            id: id,
            nom: nom,
            zones: []
        });

        addMainCourante('Administration', `Cr√©ation secteur: ${nom} dans ${bat.nom}`, currentUser?.id);
        sauvegarderVersFirebase();
        closeModal();
        showToast('‚úÖ Secteur cr√©√©');
        navigate('administration');
    });
}

function modifierSecteur(batimentId, secteurId) {
    const bat = configEtablissement.batiments.find(b => b.id === batimentId);
    const sect = bat?.secteurs.find(s => s.id === secteurId);
    if (!sect) return;

    showModal(`Modifier Secteur - ${bat.nom}`, `
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-semibold mb-2"><i class="fas fa-layer-group mr-1"></i>Nom du secteur *</label>
                <input type="text" id="sectNomEdit" class="input" value="${sect.nom}">
            </div>
        </div>
    `, () => {
        const nom = document.getElementById('sectNomEdit').value.trim();
        if (!nom) return showToast('Entrez un nom', 'error');

        const ancienNom = sect.nom;
        sect.nom = nom;

        addMainCourante('Administration', `Modification secteur: ${ancienNom} ‚Üí ${nom}`, currentUser?.id);
        sauvegarderVersFirebase();
        closeModal();
        showToast('‚úÖ Secteur modifi√©');
        navigate('administration');
    });
}

function supprimerSecteur(batimentId, secteurId) {
    const bat = configEtablissement.batiments.find(b => b.id === batimentId);
    const sect = bat?.secteurs.find(s => s.id === secteurId);
    if (!sect) return;

    showConfirm(`Supprimer le secteur "${sect.nom}" et ses ${sect.zones.length} zone(s) ?`, () => {
        bat.secteurs = bat.secteurs.filter(s => s.id !== secteurId);
        addMainCourante('Administration', `Suppression secteur: ${sect.nom}`, currentUser?.id);
        sauvegarderVersFirebase();
        showToast('üóëÔ∏è Secteur supprim√©');
        navigate('administration');
    });
}

// ========== FONCTIONS GESTION ZONES ==========
function ajouterZone(batimentId, secteurId) {
    const bat = configEtablissement.batiments.find(b => b.id === batimentId);
    const sect = bat?.secteurs.find(s => s.id === secteurId);
    if (!sect) return;

    showModal(`Nouvelle Zone - ${bat.nom} > ${sect.nom}`, `
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-semibold mb-2"><i class="fas fa-map-marker-alt mr-1"></i>Nom de la zone *</label>
                <input type="text" id="zoneNom" class="input" placeholder="Ex: Hall d'entr√©e, Bureau 101, Sanitaires...">
            </div>

            <div>
                <label class="block text-sm font-semibold mb-2"><i class="fas fa-plus-circle mr-1"></i>Ou ajouter plusieurs zones (une par ligne)</label>
                <textarea id="zonesMultiples" class="input" rows="4" placeholder="Hall d'entr√©e&#10;Accueil&#10;Salle de r√©union&#10;Sanitaires"></textarea>
            </div>

            <div class="bg-yellow-50 dark:bg-yellow-900/30 p-3 rounded-lg text-sm text-yellow-700 dark:text-yellow-400">
                <i class="fas fa-lightbulb mr-1"></i>
                Vous pouvez ajouter une seule zone ou plusieurs en m√™me temps.
            </div>
        </div>
    `, () => {
        const nomSimple = document.getElementById('zoneNom').value.trim();
        const zonesMultiples = document.getElementById('zonesMultiples').value.trim();

        let nouvZones = [];

        if (nomSimple) {
            nouvZones.push(nomSimple);
        }

        if (zonesMultiples) {
            const lignes = zonesMultiples.split('\n').map(l => l.trim()).filter(l => l.length > 0);
            nouvZones = nouvZones.concat(lignes);
        }

        if (nouvZones.length === 0) {
            return showToast('Entrez au moins un nom de zone', 'error');
        }

        // √âviter les doublons
        let ajoutees = 0;
        nouvZones.forEach(zone => {
            if (!sect.zones.includes(zone)) {
                sect.zones.push(zone);
                ajoutees++;
            }
        });

        if (ajoutees === 0) {
            return showToast('Ces zones existent d√©j√†', 'error');
        }

        addMainCourante('Administration', `Ajout de ${ajoutees} zone(s) dans ${bat.nom} > ${sect.nom}`, currentUser?.id);
        sauvegarderVersFirebase();
        closeModal();
        showToast(`‚úÖ ${ajoutees} zone(s) ajout√©e(s)`);
        navigate('administration');
    });
}

function supprimerZone(batimentId, secteurId, zoneNom) {
    const bat = configEtablissement.batiments.find(b => b.id === batimentId);
    const sect = bat?.secteurs.find(s => s.id === secteurId);
    if (!sect) return;

    showConfirm(`Supprimer la zone "${zoneNom}" ?`, () => {
        sect.zones = sect.zones.filter(z => z !== zoneNom);
        addMainCourante('Administration', `Suppression zone: ${zoneNom}`, currentUser?.id);
        sauvegarderVersFirebase();
        showToast('üóëÔ∏è Zone supprim√©e');
        navigate('administration');
    });
}

// ========== ADMIN - TYPES DE RONDES ==========
function renderAdminTypesRondes() {
    return `
        <div class="space-y-4">
            <div class="flex items-center justify-between">
                <h2 class="text-xl font-bold"><i class="fas fa-route mr-2"></i>Types de Rondes</h2>
                <button onclick="ajouterTypeRonde()" class="btn btn-primary btn-sm"><i class="fas fa-plus mr-1"></i>Ajouter</button>
            </div>

            <div class="space-y-2">
                ${typesRondes.map((t, i) => `
                    <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-slate-700 rounded-lg">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-route text-primary-500"></i>
                            <span class="font-medium">${t}</span>
                        </div>
                        <button onclick="supprimerTypeRonde(${i})" class="btn btn-danger btn-sm"><i class="fas fa-trash"></i></button>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
}

function ajouterTypeRonde() {
    showModal('Nouveau Type de Ronde', `
        <div><label class="block text-sm font-semibold mb-2">Nom</label><input type="text" id="typeRondeNom" class="input" placeholder="Ex: Ronde de nuit"></div>
    `, () => {
        const nom = document.getElementById('typeRondeNom').value.trim();
        if (!nom) return showToast('Entrez un nom', 'error');
        if (typesRondes.includes(nom)) return showToast('Ce type existe d√©j√†', 'error');

        typesRondes.push(nom);
        sauvegarderVersFirebase();
        closeModal();
        showToast('Type ajout√©');
        navigate('administration');
    });
}

function supprimerTypeRonde(index) {
    showConfirm('Supprimer ce type de ronde ?', () => {
        typesRondes.splice(index, 1);
        sauvegarderVersFirebase();
        showToast('Type supprim√©');
        navigate('administration');
    });
}

// ========== ADMIN - QR CODES ==========
function renderAdminQRCodes() {
    return `
        <div class="space-y-4">
            <h2 class="text-xl font-bold"><i class="fas fa-qrcode mr-2"></i>G√©n√©ration QR Codes</h2>

            <div class="grid grid-cols-2 gap-4">
                <button onclick="genererQRCodesZones()" class="btn btn-primary w-full py-4">
                    <i class="fas fa-building mr-2"></i>QR Codes Zones
                </button>
                <button onclick="genererQRCodesMateriels()" class="btn btn-success w-full py-4">
                    <i class="fas fa-fire-extinguisher mr-2"></i>QR Codes Mat√©riels
                </button>
            </div>

            <div id="qrCodesContainer" class="mt-6"></div>
        </div>
    `;
}

function genererQRCodesZones() {
    let html = '<h3 class="text-lg font-bold mb-4">QR Codes des Zones</h3><div class="qr-grid">';

    configEtablissement.batiments.forEach(bat => {
        bat.secteurs.forEach(sect => {
            sect.zones.forEach(zone => {
                const code = `ZONE-${bat.id}-${sect.id}-${zone.replace(/\s+/g, '-').toUpperCase()}`.substring(0, 50);
                html += `
                    <div class="qr-card">
                        <div id="qr-zone-${code.replace(/[^a-zA-Z0-9]/g, '')}" class="mb-2"></div>
                        <div class="font-bold text-sm">${zone}</div>
                        <div class="text-xs text-gray-500">${bat.nom} > ${sect.nom}</div>
                        <div class="text-xs text-gray-400 font-mono mt-1">${code}</div>
                    </div>
                `;
            });
        });
    });

    html += '</div><button onclick="window.print()" class="btn btn-primary mt-4 no-print"><i class="fas fa-print mr-2"></i>Imprimer</button>';

    document.getElementById('qrCodesContainer').innerHTML = html;

    setTimeout(() => {
        configEtablissement.batiments.forEach(bat => {
            bat.secteurs.forEach(sect => {
                sect.zones.forEach(zone => {
                    const code = `ZONE-${bat.id}-${sect.id}-${zone.replace(/\s+/g, '-').toUpperCase()}`.substring(0, 50);
                    const elemId = `qr-zone-${code.replace(/[^a-zA-Z0-9]/g, '')}`;
                    const elem = document.getElementById(elemId);
                    if (elem && typeof QRCode !== 'undefined') {
                        new QRCode(elem, { text: code, width: 120, height: 120 });
                    }
                });
            });
        });
    }, 100);
}

function genererQRCodesMateriels() {
    let html = '<h3 class="text-lg font-bold mb-4">QR Codes des Mat√©riels</h3><div class="qr-grid">';

    DB.materiels.forEach(m => {
        const code = m.codeQR || `MAT-${m.id}`;
        html += `
            <div class="qr-card">
                <div id="qr-mat-${m.id}" class="mb-2"></div>
                <div class="font-bold text-sm">${m.nom}</div>
                <div class="text-xs text-gray-500">${m.localisation || '-'}</div>
                <div class="text-xs text-gray-400 font-mono mt-1">${code}</div>
            </div>
        `;
    });

    html += '</div><button onclick="window.print()" class="btn btn-primary mt-4 no-print"><i class="fas fa-print mr-2"></i>Imprimer</button>';

    document.getElementById('qrCodesContainer').innerHTML = html;

    setTimeout(() => {
        DB.materiels.forEach(m => {
            const code = m.codeQR || `MAT-${m.id}`;
            const elem = document.getElementById(`qr-mat-${m.id}`);
            if (elem && typeof QRCode !== 'undefined') {
                new QRCode(elem, { text: code, width: 120, height: 120 });
            }
        });
    }, 100);
}

// ========== ADMIN - DONN√âES ==========
function renderAdminDonnees() {
    return `
        <div class="space-y-4">
            <h2 class="text-xl font-bold"><i class="fas fa-database mr-2"></i>Gestion des Donn√©es</h2>

            <div class="grid grid-cols-2 gap-4">
                <button onclick="sauvegarderDonnees()" class="btn btn-success w-full py-4">
                    <i class="fas fa-download mr-2"></i>Exporter (JSON)
                </button>
                <button onclick="chargerDonnees()" class="btn btn-primary w-full py-4">
                    <i class="fas fa-upload mr-2"></i>Importer (JSON)
                </button>
            </div>

            <div class="bg-red-50 dark:bg-red-900/30 p-4 rounded-lg mt-6">
                <h3 class="font-bold text-red-700 mb-2"><i class="fas fa-exclamation-triangle mr-2"></i>Zone Danger</h3>
                <button onclick="reinitialiserDonnees()" class="btn btn-danger">
                    <i class="fas fa-trash mr-2"></i>R√©initialiser toutes les donn√©es
                </button>
            </div>

            <div class="bg-gray-50 dark:bg-slate-700 p-4 rounded-lg mt-4">
                <h3 class="font-bold mb-2">Statistiques</h3>
                <div class="grid grid-cols-2 gap-2 text-sm">
                    <div>Agents: <strong>${DB.agents.length}</strong></div>
                    <div>Mat√©riels: <strong>${DB.materiels.length}</strong></div>
                    <div>Rondes: <strong>${DB.rondes.length}</strong></div>
                    <div>√âv√©nements: <strong>${DB.evenements.length}</strong></div>
                    <div>Main courante: <strong>${DB.mainCourante.length}</strong></div>
                    <div>Consignes: <strong>${DB.consignes.length}</strong></div>
                </div>
            </div>
        </div>
    `;
}

function sauvegarderDonnees() {
    const saveData = {
        version: '1.0',
        date: new Date().toISOString(),
        agents: DB.agents,
        materiels: DB.materiels,
        prisesPoste: DB.prisesPoste,
        rondes: DB.rondes,
        evenements: DB.evenements,
        mainCourante: DB.mainCourante,
        consignes: DB.consignes,
        configEtablissement: configEtablissement,
        typesRondes: typesRondes
    };

    const blob = new Blob([JSON.stringify(saveData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ssiap-patrol-backup-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showToast('üíæ Donn√©es export√©es');
}

function chargerDonnees() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = e => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = event => {
            try {
                const data = JSON.parse(event.target.result);
                if (data.agents) DB.agents = data.agents;
                if (data.materiels) DB.materiels = data.materiels;
                if (data.prisesPoste) DB.prisesPoste = data.prisesPoste;
                if (data.rondes) DB.rondes = data.rondes;
                if (data.evenements) DB.evenements = data.evenements;
                if (data.mainCourante) DB.mainCourante = data.mainCourante;
                if (data.consignes) DB.consignes = data.consignes;
                if (data.configEtablissement) configEtablissement = data.configEtablissement;
                if (data.typesRondes) typesRondes = data.typesRondes;

                sauvegarderVersFirebase();
                showToast('‚úÖ Donn√©es import√©es');
                initLogin();
                navigate(currentView);
            } catch (err) {
                showToast('‚ùå Fichier invalide', 'error');
            }
        };
        reader.readAsText(file);
    };
    input.click();
}

function reinitialiserDonnees() {
    showConfirm('‚ö†Ô∏è ATTENTION !\n\nCela supprimera TOUTES les donn√©es (rondes, √©v√©nements, main courante, prises de poste).\n\n√ätes-vous s√ªr ?', () => {
        DB.prisesPoste = [];
        DB.rondes = [];
        DB.evenements = [];
        DB.mainCourante = [];
        sauvegarderVersFirebase();
        showToast('üóëÔ∏è Donn√©es r√©initialis√©es');
        navigate('administration');
    });
}

// ========== MODALS ==========
function showModal(title, content, onConfirm, confirmText = 'Confirmer', confirmClass = 'btn-primary') {
    modalConfirmCallback = onConfirm;
    document.getElementById('modalContainer').innerHTML = `
        <div class="modal-overlay" onclick="if(event.target === this) closeModal()">
            <div class="modal-content">
                <div class="modal-header"><h2 class="text-xl font-bold text-gray-800 dark:text-white">${title}</h2></div>
                <div class="modal-body">${content}</div>
                <div class="modal-footer">
                    <button onclick="closeModal()" class="btn btn-secondary">Annuler</button>
                    ${onConfirm ? `<button onclick="modalConfirmCallback?.()" class="btn ${confirmClass}">${confirmText}</button>` : ''}
                </div>
            </div>
        </div>
    `;
}

function closeModal() {
    document.getElementById('modalContainer').innerHTML = '';
    modalConfirmCallback = null;
    arreterScanQR();
}

function showConfirm(message, onConfirm) {
    showModal('Confirmation', `<p class="text-gray-600 dark:text-gray-400 whitespace-pre-line">${message}</p>`, onConfirm, 'Confirmer', 'btn-danger');
}

function showToast(message, type = 'success') {
    const colors = { success: 'bg-green-500', error: 'bg-red-500', warning: 'bg-orange-500', info: 'bg-blue-500' };
    const toast = document.createElement('div');
    toast.className = `fixed top-20 left-1/2 transform -translate-x-1/2 ${colors[type]} text-white px-6 py-3 rounded-xl shadow-lg z-50 flex items-center gap-2`;
    toast.innerHTML = `<span>${message}</span>`;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

// ========== UTILITAIRES ==========
async function convertirEnBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

// ========== INITIALISATION ==========
document.addEventListener('DOMContentLoaded', () => {
    if (detecterModeRondier()) {
        chargerDepuisFirebase(() => {
            afficherLoginRondier(false);
        });
    } else {
        chargerDepuisFirebase(() => {
            initLogin();
            activerSyncTempsReel();
        });
    }
});

// Raccourci clavier pour login rapide (dev)
document.addEventListener('keydown', e => {
    if (e.key === 'Enter' && document.getElementById('loginScreen')?.classList.contains('hidden') === false) {
        login();
    }
});
</script>
</body>
</html>
